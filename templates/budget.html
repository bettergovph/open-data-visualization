<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Analysis - BetterGovPH</title>

    <!-- Google Fonts - Inter -->
    <!-- Tailwind CSS (Production) -->
    <link rel="stylesheet" href="/static/css/tailwind.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">


    <script src="/static/js/chart.js"></script>

    <!-- Cache Control -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="-1">

    <!-- BetterGovPH Metadata -->
    <meta name="description" content="Budget Analysis - Government Data Analysis Platform">
    <meta name="keywords" content="government data, budget analysis, flood control, public data, transparency">
    <meta name="author" content="BetterGovPH">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ og_url | default(value='https://visualizations.bettergov.ph/') }}">
    <meta property="og:title" content="Budget - BetterGovPH">
    <meta property="og:description" content="Government Data Analysis Platform for Budget and Flood Control Projects">
    <meta property="og:image" content="/static/images/gov_logo.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://visualizations.bettergov.ph/">
    <meta property="twitter:title" content="Budget - BetterGovPH">
    <meta property="twitter:description" content="Government Data Analysis Platform for Budget and Flood Control Projects">
    <meta property="twitter:image" content="/static/images/gov_logo.png">

    <style>
        body {
            font-family: 'Inter', sans-serif !important;
            margin: 0;
            padding: 0;
            background: white !important;
            color: black !important;
            min-height: 100vh;
        }
    </style>
</head>
<body>
<!-- Navigation - BetterGov Theme -->
<nav class="visualizations-nav py-4 px-6 bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
        <div class="flex items-center">
            <a href="https://bettergov.ph" class="flex items-center">
                <img src="https://raw.githubusercontent.com/bettergovph/logo/main/png/BetterGov_Horizontal-Black.png"
                     alt="BetterGov.ph"
                     class="h-12 mr-3">
            </a>
            <a href="/" class="text-xl font-bold text-black hover:text-gray-600">Data Visualizations</a>
        </div>
        <div class="hidden md:flex space-x-6">
            <a href="/" class="text-black hover:text-gray-600 font-medium transition">Home</a>
            <a href="/nep" class="text-black hover:text-gray-600 font-medium transition">NEP</a>
            <a href="/budget" class="text-black hover:text-gray-600 font-medium transition border-b-2 border-black">Budget</a>
            <a href="/flood" class="text-black hover:text-gray-600 font-medium transition">Flood Control</a>
            <a href="/dime" class="text-black hover:text-gray-600 font-medium transition">DIME</a>
            <a href="/map" class="text-black hover:text-gray-600 font-medium transition">Map</a>
            <a href="/budget-nep-correlation" class="text-black hover:text-gray-600 font-medium transition">NEP-Budget</a>
            <a href="/budget-flood-correlation" class="text-black hover:text-gray-600 font-medium transition">Budget-Flood</a>
            <a href="/flood-dime-correlation" class="text-black hover:text-gray-600 font-medium transition">Flood-DIME</a>
        </div>
        <div class="md:hidden">
            <button class="text-black focus:outline-none" onclick="toggleMobileMenu()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
        </div>
    </div>
    <!-- Mobile menu (hidden by default) -->
    <div id="mobileMenu" class="hidden mt-4 px-4 space-y-2">
        <a href="/" class="block text-black hover:text-gray-600 font-medium py-2">Home</a>
        <a href="/nep" class="block text-black hover:text-gray-600 font-medium py-2">NEP</a>
        <a href="/budget" class="block text-black hover:text-gray-600 font-medium py-2 border-b-2 border-black">Budget</a>
        <a href="/flood" class="block text-black hover:text-gray-600 font-medium py-2">Flood Control</a>
        <a href="/dime" class="block text-black hover:text-gray-600 font-medium py-2">DIME</a>
        <a href="/map" class="block text-black hover:text-gray-600 font-medium py-2">Map</a>
        <a href="/budget-nep-correlation" class="block text-black hover:text-gray-600 font-medium py-2">NEP-Budget</a>
        <a href="/budget-flood-correlation" class="block text-black hover:text-gray-600 font-medium py-2">Budget-Flood</a>
        <a href="/flood-dime-correlation" class="block text-black hover:text-gray-600 font-medium py-2">Flood-DIME</a>
    </div>
</nav>

<script>
function toggleMobileMenu() {
    const menu = document.getElementById('mobileMenu');
    menu.classList.toggle('hidden');
}
</script>

<!-- Budget Section -->
<div style="padding: 6rem;">
<section class="budget-section">
    <div class="budget-container">
        <div class="budget-header">
        </div>

        <div class="budget-content">
            <!-- Budget Tabs -->
            <div class="budget-tabs">
                <div class="budget-tab-nav">
                    <a href="#visual" class="budget-tab-btn active" data-tab="visual">üìä Visual</a>
                    <a href="#browser" class="budget-tab-btn" data-tab="browser">üìã Data Browser</a>
                    <a href="#analysis" class="budget-tab-btn" data-tab="analysis">üîç Analysis</a>
                    <a href="#trends" class="budget-tab-btn" data-tab="trends">üìà Trends</a>
                </div>
                
                <div class="budget-tab-content">
                    <!-- Visual Tab -->
                    <div id="tab-visual" class="budget-tab-panel active">
                        <h3 class="budget-section-title">üìä Budget Visual Analysis</h3>
                        <p class="budget-section-desc">Interactive charts and visualizations of budget data</p>
                        
                        <!-- Loading Spinner -->
                        <div id="visual-loading-spinner" class="loading-spinner" style="display: flex; justify-content: center; align-items: center; padding: 40px; margin: 20px 0;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 15px;">
                                <div class="spinner" style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #0038A8; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                <p style="color: #666; font-size: 14px; margin: 0;">Loading budget data...</p>
                            </div>
                        </div>
                        
                        <!-- Year Filter -->
                        <div class="year-filter-container" style="margin-bottom: 20px; text-align: right;">
                            <label for="year-filter" style="font-weight: bold; color: #333; margin-right: 10px;">Year:</label>
                            <select id="year-filter" style="padding: 8px 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; background: white; color: #333; cursor: pointer;">
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                                <option value="2022">2022</option>
                                <option value="2021">2021</option>
                                <option value="2020">2020</option>
                                <option value="all">All Years</option>
                            </select>
                        </div>
                        
                        <!-- Visual Statistics Cards -->
                        <div class="visual-stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
                                <h3 style="color: #0038A8; margin: 0 0 10px 0; font-size: 1.1em;">Total Budget Items</h3>
                                <p id="total-budget-items" style="font-size: 2em; font-weight: bold; color: #28a745; margin: 0;">Loading...</p>
                            </div>
                            <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; min-width: 280px;">
                                <h3 style="color: #0038A8; margin: 0 0 10px 0; font-size: 1.1em;">Total Budget Value</h3>
                                <p id="total-budget-value" style="font-size: 1.6em; font-weight: bold; color: #dc3545; margin: 0; word-break: break-all;">Loading...</p>
                            </div>
                            <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
                                <h3 style="color: #0038A8; margin: 0 0 10px 0; font-size: 1.1em;">Total Departments</h3>
                                <p id="total-departments" style="font-size: 2em; font-weight: bold; color: #6f42c1; margin: 0;">Loading...</p>
                            </div>
                            <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
                                <h3 style="color: #0038A8; margin: 0 0 10px 0; font-size: 1.1em;">Unique Agencies</h3>
                                <p id="unique-agencies" style="font-size: 2em; font-weight: bold; color: #fd7e14; margin: 0;">Loading...</p>
                            </div>
                        </div>
                        
                        <!-- Charts Section -->
                        <div class="charts-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <!-- Department Chart -->
                            <div class="chart-container" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                <h3 style="color: #0038A8; margin: 0 0 15px 0;">üèõÔ∏è Budget by Department</h3>
                                <canvas id="departmentsChart" width="400" height="300"></canvas>
                            </div>
                            
                            <!-- Expense Chart -->
                            <div class="chart-container" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                <h3 style="color: #0038A8; margin: 0 0 15px 0;">üí∞ Expense Categories</h3>
                                <canvas id="expenseCategoriesChart" width="400" height="300"></canvas>
                            </div>
                            
                            <!-- Region Chart -->
                            <div class="chart-container" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                <h3 style="color: #0038A8; margin: 0 0 15px 0;">üó∫Ô∏è Budget by Region</h3>
                                <canvas id="regionsChart" width="400" height="300"></canvas>
                            </div>
                            
                            <!-- Combined Overview Chart -->
                            <div class="chart-container" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); grid-column: 1 / -1;">
                                <h3 style="color: #0038A8; margin: 0 0 15px 0;">üìä Top Agencies by Budget</h3>
                                <canvas id="agenciesChart" width="1200" height="400"></canvas>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- Data Browser Tab -->
                    <div id="tab-browser" class="budget-tab-panel">
                        <h3 class="budget-section-title">üìä Budget Data Browser</h3>
                        <p class="budget-section-desc">Browse and sort budget data with pagination</p>
                
                <div class="data-browser-controls">
                    <!-- Year Filter -->
                    <div class="year-filter-row">
                        <div class="filter-group">
                            <label for="browser-year-filter">Year:</label>
                            <select id="browser-year-filter" class="year-select">
                                <option value="all">All Years</option>
                                <option value="2025" selected>2025</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                                <option value="2022">2022</option>
                                <option value="2021">2021</option>
                                <option value="2020">2020</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Filters Row - Only for columns with views -->
                    <div class="filters-row">
                        <div class="filter-group">
                            <label for="filter-uacs_dpt_dsc">Dept Description:</label>
                            <input type="text" id="filter-uacs_dpt_dsc" placeholder="Filter by dept description...">
                        </div>
                        <div class="filter-group">
                            <label for="filter-uacs_agy_dsc">Agency Description:</label>
                            <input type="text" id="filter-uacs_agy_dsc" placeholder="Filter by agency description...">
                        </div>
                        <div class="filter-group">
                            <label for="filter-dsc">Description:</label>
                            <input type="text" id="filter-dsc" placeholder="Filter by description...">
                        </div>
                        <div class="filter-group">
                            <label for="filter-uacs_fundsubcat_dsc">Fund Category:</label>
                            <input type="text" id="filter-uacs_fundsubcat_dsc" placeholder="Filter by fund category...">
                        </div>
                    </div>
                    
                    <div class="filters-row">
                        <div class="filter-group">
                            <label for="filter-uacs_exp_dsc">Expense Description:</label>
                            <input type="text" id="filter-uacs_exp_dsc" placeholder="Filter by expense description...">
                        </div>
                        <div class="filter-group">
                            <label for="filter-uacs_sobj_dsc">Object Description:</label>
                            <input type="text" id="filter-uacs_sobj_dsc" placeholder="Filter by object description...">
                        </div>
                        <div class="filter-group">
                            <label for="filter-uacs_div_dsc">Division:</label>
                            <input type="text" id="filter-uacs_div_dsc" placeholder="Filter by division...">
                        </div>
                        <div class="filter-group">
                            <label for="filter-uacs_reg_id">Region:</label>
                            <input type="text" id="filter-uacs_reg_id" placeholder="Filter by region...">
                        </div>
                    </div>
                    
                    <div class="filters-row">
                        <div class="filter-group">
                            <label for="filter-amt-min">Amount Min (‚Ç±):</label>
                            <input type="number" id="filter-amt-min" placeholder="Min amount in pesos...">
                        </div>
                        <div class="filter-group">
                            <label for="filter-amt-max">Amount Max (‚Ç±):</label>
                            <input type="number" id="filter-amt-max" placeholder="Max amount in pesos...">
                        </div>
                        <div class="filter-group">
                            <!-- Empty divs for layout -->
                        </div>
                        <div class="filter-group">
                            <!-- Empty divs for layout -->
                        </div>
                    </div>
                    
                    <div class="filters-row">
                        <div class="filter-group">
                            <label for="rows-per-page">Rows per page:</label>
                            <select id="rows-per-page" style="padding: 0.5rem; border: 1px solid #dee2e6; border-radius: 4px; font-size: 0.9rem;">
                                <option value="5" selected>5 rows</option>
                                <option value="10">10 rows</option>
                                <option value="15">15 rows</option>
                                <option value="20">20 rows</option>
                                <option value="25">25 rows</option>
                            </select>
                        </div>
                        <div class="filter-actions">
                            <button id="apply-filters-btn" class="btn btn-primary">Apply Filters</button>
                            <button id="clear-filters-btn" class="btn btn-secondary">Clear All</button>
                        </div>
                    </div>
            
                    <!-- Sort and Pagination Row -->
                    <div class="browser-controls-row">
                        <div class="sort-controls">
                            <label for="sort-select">Sort by:</label>
                            <select id="sort-select">
                                <option value="amt">Amount (Highest First)</option>
                                <option value="department">Department</option>
                                <option value="agency">Agency</option>
                                <option value="dsc">Description</option>
                                <option value="uacs_dpt_dsc">Department Description</option>
                                <option value="uacs_agy_dsc">Agency Description</option>
                                <option value="uacs_fundsubcat_dsc">Fund Category</option>
                                <option value="uacs_exp_dsc">Expense Description</option>
                                <option value="uacs_sobj_dsc">Object Description</option>
                            </select>
                            <button id="sort-order-btn" class="sort-order-btn" data-order="DESC">‚Üì</button>
                        </div>
                        <div class="pagination-controls">
                            <button id="prev-page-btn" class="page-btn" disabled>‚Üê Previous</button>
                            <span id="page-info">Page 1 of 1</span>
                            <button id="next-page-btn" class="page-btn" disabled>Next ‚Üí</button>
                    </div>
                </div>
            </div>
            
                <div id="data-browser-container" class="data-browser-container">
                    <div class="loading-spinner">Loading budget data...</div>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
/* Budget-specific styles preserved */
.budget-logo-img {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    margin-bottom: 1rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.budget-section-title {
    color: #333;
    margin-bottom: 0.25rem;
    margin-top: 0.5rem;
    font-size: 1.5rem;
    text-align: left;
}

.budget-section-desc {
    color: #666;
    margin-bottom: 1rem;
}

/* Collapsible Header Styles */
.collapsible-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    user-select: none;
    padding: 0.75rem 1rem;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 1rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    transition: all 0.3s ease;
}

.collapsible-header:hover {
    background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    border-color: #adb5bd;
}

.collapse-icon {
    font-size: 1.2rem;
    font-weight: bold;
    color: #6c757d;
    transition: transform 0.3s ease;
}

.collapse-icon.collapsed {
    transform: rotate(-90deg);
}

/* Duplicates and Anomalies Card Styles */
.budget-duplicates, .budget-anomalies {
    margin: 2rem 0;
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box;
    overflow-x: auto;
}

.duplicates-controls, .anomalies-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: center;
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
}

.duplicates-filter-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.duplicates-filter-group label {
    font-weight: 600;
    color: #333;
    font-size: 0.9rem;
}

.anomaly-type-selector {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.anomaly-type-selector label {
    font-weight: 600;
    color: #333;
    font-size: 0.9rem;
}

.anomaly-type-selector select {
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
    min-width: 200px;
}

.duplicates-stats, .anomalies-stats {
    display: flex;
    gap: 1.5rem;
    margin-left: auto;
}

.stat-item {
    background: #e3f2fd;
    color: #1976d2;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 500;
}

.duplicates-results, .anomalies-results {
    max-height: none;
    overflow-y: visible;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    background: white;
}

.duplicate-item, .anomaly-item {
    padding: 1rem;
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.2s ease;
}

.duplicate-item:hover, .anomaly-item:hover {
    background-color: #f8f9fa;
}

.duplicate-item:last-child, .anomaly-item:last-child {
    border-bottom: none;
}

.duplicate-header, .anomaly-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.duplicate-title, .anomaly-title {
    font-weight: 600;
    color: #333;
    font-size: 1.1rem;
}

.severity-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
}

.severity-high {
    background: #ffebee;
    color: #c62828;
}

.severity-medium {
    background: #fff3e0;
    color: #ef6c00;
}

.duplicate-details, .anomaly-details {
    color: #666;
    font-size: 0.9rem;
    line-height: 1.4;
}

.duplicate-amount, .anomaly-amount {
    font-weight: 600;
    color: #1976d2;
    font-size: 1.5rem;
}

.duplicate-score {
    font-size: 1.5rem;
    font-weight: bold;
}

.score-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 1.2rem;
    font-weight: bold;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

.comparison-rows {
    margin-top: 0.75rem;
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 4px;
    font-size: 0.85rem;
}

.comparison-row {
    display: flex;
    justify-content: space-between;
    padding: 0.25rem 0;
    border-bottom: 1px solid #e0e0e0;
}

.comparison-row:last-child {
    border-bottom: none;
}

.collapsible-header:hover {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: #667eea;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.collapse-icon {
    background: #667eea;
    color: white;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    font-weight: bold;
    transition: all 0.3s ease;
    box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
}

.collapsible-header:hover .collapse-icon {
    background: white;
    color: #667eea;
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(255, 255, 255, 0.3);
}

.collapse-icon.collapsed {
    transform: rotate(-90deg);
}

.collapsible-header:hover .collapse-icon.collapsed {
    transform: rotate(-90deg) scale(1.1);
}

.query-examples {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-top: 1rem;
}

.query-category {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    border-left: 4px solid #667eea;
}

.query-category h4 {
    color: #333;
    margin-bottom: 1rem;
}

.query-category ul {
    list-style: none;
    padding: 0;
}

.query-category li {
    background: white;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    border-radius: 5px;
    border: 1px solid #dee2e6;
    font-style: italic;
    color: #555;
}

.analysis-form {
    margin-top: 2rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #333;
}

.form-group textarea {
    width: 100%;
    padding: 1rem;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    font-size: 1rem;
    resize: vertical;
    transition: border-color 0.3s ease;
}

.form-group textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.btn {
    background: #2563eb !important; /* bg-blue-600 */
    color: white;
    border: none;
    padding: 1rem 2rem;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.btn:hover {
    background: #1d4ed8 !important; /* hover:bg-blue-700 */
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(37, 99, 235, 0.4);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
    background: #93c5fd !important; /* disabled blue */
    color: #666 !important;
    box-shadow: none !important;
}

.btn:disabled:hover {
    transform: none !important;
    box-shadow: none !important;
}

.btn-loading {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.analysis-result {
    margin-top: 2rem;
    padding: 1.5rem;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #28a745;
}

.analysis-result h3 {
    color: #333;
    margin-bottom: 1rem;
}

.result-content {
    color: #555;
    line-height: 1.6;
    white-space: pre-wrap;
}

/* Beautiful Results Styling */
.result-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 10px;
    margin-bottom: 2rem;
    text-align: center;
}

.result-header h4 {
    margin: 0 0 0.5rem 0;
    font-size: 1.5rem;
}

.query-text {
    margin: 0;
    font-style: italic;
    opacity: 0.9;
}

.year-info {
    margin: 0.5rem 0 0 0;
    font-size: 1rem;
    font-weight: 600;
    opacity: 0.95;
    background: rgba(255,255,255,0.2);
    padding: 0.5rem 1rem;
    border-radius: 6px;
    display: inline-block;
}

.summary-stats {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 10px;
    margin-bottom: 2rem;
    border-left: 4px solid #28a745;
}

.summary-stats h5 {
    color: #333;
    margin-bottom: 1rem;
    font-size: 1.2rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
}

.stat-item {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border: 1px solid #dee2e6;
}

.stat-number {
    display: block;
    font-size: 2rem;
    font-weight: bold;
    color: #667eea;
    margin-bottom: 0.25rem;
}

.stat-label {
    font-size: 0.9rem;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.documents-table {
    margin-bottom: 2rem;
}

.documents-table h5 {
    color: #333;
    margin-bottom: 1rem;
    font-size: 1.2rem;
}

.table-container {
    overflow-x: auto;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.results-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 10px;
    overflow: hidden;
}

.results-table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.results-table th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.results-table td {
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
    vertical-align: top;
}

.results-table tbody tr:hover {
    background: #f8f9fa;
}

.document-name {
    font-weight: 600;
    color: #333;
}

.year {
    background: #e3f2fd;
    color: #1976d2;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-weight: 600;
    font-size: 0.8rem;
}

.rows, .columns {
    font-weight: 600;
    color: #666;
}

.similarity {
    font-weight: bold;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.9rem;
}

.high-similarity {
    background: #d4edda;
    color: #155724;
}

.medium-similarity {
    background: #fff3cd;
    color: #856404;
}

.low-similarity {
    background: #f8d7da;
    color: #721c24;
}

.duplicates-section {
    background: #fff3cd;
    padding: 1.5rem;
    border-radius: 10px;
    margin-bottom: 2rem;
    border-left: 4px solid #ffc107;
}

.duplicates-section h5 {
    color: #856404;
    margin-bottom: 1rem;
    font-size: 1.2rem;
}

.duplicates-list {
    max-height: 300px;
    overflow-y: auto;
}

.duplicate-item {
    background: white;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    border-radius: 6px;
    border: 1px solid #ffeaa7;
    font-size: 0.9rem;
    color: #856404;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.duplicate-item:hover {
    background: #fff3cd;
}

.toggle-icon {
    font-size: 1.2rem;
    margin-left: 0.5rem;
}

.duplicate-details {
    background: #f8f9fa;
    padding: 1rem;
    margin-top: 0.5rem;
    border-radius: 6px;
    border: 1px solid #dee2e6;
}

.duplicate-lines {
    max-height: 400px;
    overflow-y: auto;
}

.duplicate-line {
    background: white;
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: 6px;
    border: 1px solid #dee2e6;
}

.line-header {
    font-weight: bold;
    color: #333;
    margin-bottom: 0.5rem;
    padding-bottom: 0.25rem;
    border-bottom: 1px solid #dee2e6;
}

.line-content {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
}

.line-field {
    background: #e3f2fd;
    padding: 0.5rem;
    border-radius: 4px;
    font-size: 0.85rem;
    color: #1976d2;
    display: flex;
    flex-direction: column;
    min-width: 200px;
}

.line-field strong {
    color: #0d47a1;
}

.amount-field {
    background: #e8f5e8 !important;
    color: #2e7d32 !important;
    border-left: 3px solid #4caf50;
}

.amount-field .field-label {
    color: #1b5e20 !important;
    font-weight: bold;
}

.amount-field .field-value {
    color: #2e7d32 !important;
    font-weight: bold;
    font-size: 1rem;
}

.desc-field {
    background: #fff3e0 !important;
    color: #ef6c00 !important;
    border-left: 3px solid #ff9800;
}

.desc-field .field-label {
    color: #e65100 !important;
    font-weight: bold;
}

.desc-field .field-value {
    color: #ef6c00 !important;
    font-style: italic;
}

.regular-field {
    background: #e3f2fd !important;
    color: #1976d2 !important;
    border-left: 3px solid #2196f3;
}

.regular-field .field-label {
    color: #0d47a1 !important;
    font-weight: bold;
}

.regular-field .field-value {
    color: #1976d2 !important;
}

.field-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.25rem;
}

.field-value {
    font-size: 0.9rem;
    word-break: break-word;
}

.shocking-duplicate {
    border: 3px solid #ff4444 !important;
    background: linear-gradient(135deg, #fff5f5 0%, #ffe6e6 100%) !important;
    box-shadow: 0 4px 12px rgba(255, 68, 68, 0.3) !important;
    animation: pulse-shock 2s infinite;
}

.shocking-duplicate .line-header {
    background: #ff4444 !important;
    color: white !important;
    font-weight: bold !important;
    text-transform: uppercase !important;
    letter-spacing: 1px !important;
}

@keyframes pulse-shock {
    0% { box-shadow: 0 4px 12px rgba(255, 68, 68, 0.3); }
    50% { box-shadow: 0 6px 20px rgba(255, 68, 68, 0.6); }
    100% { box-shadow: 0 4px 12px rgba(255, 68, 68, 0.3); }
}

.loading {
    text-align: center;
    color: #666;
    font-style: italic;
    padding: 1rem;
}

.error {
    color: #dc3545;
    text-align: center;
    padding: 1rem;
    background: #f8d7da;
    border-radius: 4px;
}

.year-duplicates {
    background: #fff8e1;
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: 8px;
    border-left: 4px solid #ff9800;
}

.year-duplicates h6 {
    color: #e65100;
    margin: 0 0 1rem 0;
    font-size: 1.1rem;
}

.duplicate-type {
    margin-bottom: 1rem;
}

.duplicate-type strong {
    color: #e65100;
    display: block;
    margin-bottom: 0.5rem;
}

.duplicate-desc {
    font-style: italic;
    color: #333;
    flex: 1;
}

.duplicate-amount {
    font-weight: bold;
    color: #1976d2;
    flex: 1;
}

.duplicate-count {
    background: #ffc107;
    color: #333;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: bold;
}

.total-amount {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 10px;
    text-align: center;
    margin-bottom: 2rem;
}

.total-amount h5 {
    margin: 0 0 0.5rem 0;
    font-size: 1.2rem;
}

.amount-display {
    font-size: 2.5rem;
    font-weight: bold;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.error-message {
    background: #f8d7da;
    color: #721c24;
    padding: 1rem;
    border-radius: 6px;
    border: 1px solid #f5c6cb;
    margin: 1rem 0;
}

@media (max-width: 768px) {
    .budget-title {
        font-size: 2rem;
    }
    
    .budget-content {
        padding: 1rem;
    }
    
    .query-examples {
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .results-table {
        font-size: 0.8rem;
    }
    
    .results-table th,
    .results-table td {
        padding: 0.5rem;
    }
    
    .amount-display {
        font-size: 2rem;
    }
}

/* Reference-only query styles */
.sample-query-reference {
    background: #f8f9fa;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    border-radius: 6px;
    border: 1px solid #dee2e6;
    font-size: 0.9rem;
    color: #666;
    cursor: default;
    pointer-events: none;
}

.sample-query-reference:hover {
    background: #f8f9fa;
    transform: none;
    box-shadow: none;
}

/* Total Budget Amount Styles */
.total-amount-container {
    margin: 1rem 0;
}

.total-amount-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    position: relative;
    overflow: hidden;
}

.total-amount-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 50%);
    pointer-events: none;
}

.amount-display {
    font-size: 3rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    position: relative;
    z-index: 1;
}

.amount-label {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    opacity: 0.9;
    position: relative;
    z-index: 1;
}

.amount-subtitle {
    font-size: 0.9rem;
    opacity: 0.8;
    position: relative;
    z-index: 1;
}

.error-amount {
    background: #f8d7da;
    color: #721c24;
    padding: 1.5rem;
    border-radius: 10px;
    border: 1px solid #f5c6cb;
}

/* Summary Statistics Styles */
.stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin: 1rem 0;
}

.stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    text-align: center;
    border-left: 4px solid #667eea;
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: #667eea;
    display: block;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: #666;
    font-size: 0.9rem;
    font-weight: 600;
}

/* Budget Tabs Styles */
.budget-tabs {
    margin: 1rem 0;
}

.budget-tab-nav {
    display: flex;
    border-bottom: 2px solid #e9ecef;
    margin-bottom: 1rem;
    gap: 0.5rem;
}

.budget-tab-btn {
    text-decoration: none;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-bottom: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px 8px 0 0;
    cursor: pointer;
    font-weight: 600;
    color: #666;
    transition: all 0.3s ease;
    position: relative;
    display: inline-block;
}

.budget-tab-btn:hover:not(.disabled) {
    background: #e9ecef;
    color: #333;
    text-decoration: none;
}

.budget-tab-btn.active {
    background: white;
    color: #667eea;
    border-color: #667eea;
    border-bottom: 2px solid white;
    margin-bottom: -2px;
    z-index: 1;
    text-decoration: none;
}

.budget-tab-btn.disabled {
    background: #f8f9fa;
    color: #ccc;
    cursor: not-allowed;
    opacity: 0.6;
}

.budget-tab-content {
    position: relative;
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box;
    overflow-x: auto;
    overflow-y: visible;
    padding: 0;
}

/* Analysis and Trends tabs now use standard tab panel containment */

/* Analysis and Trends cards now use standard tab panel containment */

/* Ensure Analysis tab content is properly contained */
#tab-analysis {
    overflow-x: auto;
    overflow-y: visible;
    max-width: 100%;
    box-sizing: border-box;
}

#tab-analysis .analysis-dashboard,
#tab-analysis .analysis-results {
    max-width: 100%;
    overflow-x: hidden;
    box-sizing: border-box;
}

#tab-analysis .dashboard-grid {
    max-width: 100%;
    overflow-x: hidden;
}

#tab-analysis .analysis-section {
    max-width: 100%;
    overflow-x: hidden;
    box-sizing: border-box;
}

/* New Analysis Tab Styles */

.trends-dashboard {
    margin-top: 0.5rem;
}

.trends-summary-cards {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
}

.trends-summary-cards .metric-card {
    flex: 1;
    min-width: 0;
}

.trends-section {
    margin-top: 2rem;
    padding: 1.5rem;
    background: #f8f9fa;
    border-radius: 12px;
    border: 1px solid #dee2e6;
}

.section-title {
    color: #0038A8;
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.section-description {
    color: #666;
    margin-bottom: 1.5rem;
    font-size: 0.9rem;
}

.trends-results {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid #dee2e6;
}

.department-trend-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    margin-bottom: 0.5rem;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    transition: all 0.2s ease;
}

.department-trend-item:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-color: #0038A8;
}

.department-name {
    font-weight: 600;
    color: #333;
    flex: 1;
}

.department-amounts {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.year-amount {
    text-align: center;
    min-width: 100px;
}

.year-label {
    font-size: 0.8rem;
    color: #666;
    margin-bottom: 0.25rem;
}

.amount-value {
    font-weight: 600;
    color: #0038A8;
    font-size: 1.1rem;
}

.percent-change {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-weight: 600;
}

.percent-change.positive {
    background: #d4edda;
    color: #155724;
}

.percent-change.negative {
    background: #f8d7da;
    color: #721c24;
}

.percent-change.neutral {
    background: #e2e3e5;
    color: #6c757d;
}

/* Column differences highlighting */
.column-item {
    transition: all 0.2s ease;
}

.column-different {
    background: #fff3cd !important;
    border-left: 4px solid #ffc107 !important;
    padding-left: 0.5rem !important;
    animation: pulse-highlight 2s ease-in-out infinite;
}

.column-normal {
    background: #f8f9fa;
}

.diff-indicator {
    font-size: 0.85rem;
    color: #dc3545;
    font-weight: 700;
    margin-left: 0.5rem;
    background: #fff3cd;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    border: 1px solid #ffc107;
}

@keyframes pulse-highlight {
    0%, 100% {
        background: #fff3cd;
    }
    50% {
        background: #ffe69c;
    }
}

.analysis-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    margin-top: 0.5rem;
    flex-wrap: wrap;
}

.year-filter-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.filter-label {
    font-weight: 600;
    color: #333;
    font-size: 1rem;
}

.analysis-dashboard {
    margin-bottom: 2rem;
}

.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.metric-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

.metric-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.metric-header h4 {
    color: #0038A8;
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
}

.metric-icon {
    font-size: 1.5rem;
    opacity: 0.7;
}

.metric-value {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
    min-height: 3rem;
    display: flex;
    align-items: center;
    justify-content: center;
}

.duplicates-card .metric-value {
    color: #dc3545;
}

.exact-amount-card .metric-value {
    color: #28a745;
}

.anomalies-card .metric-value {
    color: #ffc107;
}

.total-items-card .metric-value {
    color: #007bff;
}

.metric-description {
    font-size: 0.9rem;
    color: #6c757d;
    text-align: center;
    line-height: 1.4;
}

.analysis-results {
    margin-top: 2rem;
}

.analysis-section {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
    position: relative;
    z-index: 1;
}

/* Ensure analysis sections only appear in analysis tab */
#tab-visual .analysis-section,
#tab-browser .analysis-section,
#tab-trends .analysis-section {
    display: none !important;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e9ecef;
}

.section-header h4 {
    color: #0038A8;
    margin: 0;
    font-size: 1.2rem;
    font-weight: 600;
}

.analysis-content {
    margin-top: 1rem;
}

.analysis-filters {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    align-items: center;
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.filter-group label {
    font-weight: 500;
    color: #333;
    white-space: nowrap;
}

.filter-select {
    padding: 0.5rem 0.75rem;
    border: 2px solid #dee2e6;
    border-radius: 6px;
    background: white;
    color: #333;
    font-size: 0.9rem;
    min-width: 120px;
}

.filter-select:focus {
    border-color: #0038A8;
    outline: none;
    box-shadow: 0 0 0 3px rgba(0, 56, 168, 0.1);
}

.results-container {
    min-height: 200px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    background: #f8f9fa;
}

.loading-message {
    text-align: center;
    color: #6c757d;
    font-style: italic;
    padding: 2rem;
}

.column-comparison {
    margin-top: 1rem;
}

.comparison-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 1rem;
}

.year-column {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid #dee2e6;
}

.year-column h5 {
    color: #0038A8;
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
    font-weight: 600;
}

.column-info {
    margin-bottom: 1rem;
    font-size: 0.9rem;
    color: #6c757d;
}

.row-count {
    font-weight: bold;
    color: #0038A8;
}

.columns-list {
    max-height: 400px;
    overflow-y: auto;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 0.75rem;
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    line-height: 1.4;
}

.data-source-footer {
    background: #f8f9fa;
    padding: 1.5rem;
    margin-top: 2rem;
    border-top: 1px solid #dee2e6;
    border-radius: 8px;
}

.source-info {
    text-align: center;
    font-size: 0.9rem;
    color: #6c757d;
}

.source-info p {
    margin: 0.25rem 0;
}

.source-info strong {
    color: #0038A8;
}

/* Mobile Trends Padding Fixes */
@media (max-width: 768px) {
    .trends-dashboard {
        padding: 1rem 0.5rem;
    }

    .trends-summary-cards {
        flex-direction: column;
        gap: 0.75rem;
    }

    .trends-summary-cards .metric-card {
        padding: 1rem;
    }

    .trends-section {
        margin-top: 1rem;
        padding: 1rem;
    }

    .trends-results {
        padding: 0.75rem;
    }

    .budget-trends-section {
        margin: 1rem 0.5rem;
        padding: 1rem;
    }

    .trends-summary {
        grid-template-columns: 1fr;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .trends-summary .summary-card {
        padding: 1rem;
        margin-bottom: 0.5rem;
    }

    .department-trend-item {
        padding: 1rem 0.75rem;
        margin-bottom: 0.75rem;
    }

    .spending-trend-item {
        padding: 0.75rem;
        margin-bottom: 0.75rem;
    }
}

/* Extra small mobile devices */
@media (max-width: 480px) {
    .trends-dashboard {
        padding: 0.75rem 0.25rem;
    }

    .trends-section {
        padding: 0.75rem;
        margin-top: 0.75rem;
    }

    .trends-results {
        padding: 0.5rem;
    }

    .budget-trends-section {
        margin: 0.75rem 0.25rem;
        padding: 0.75rem;
    }

    .trends-summary-cards .metric-card {
        padding: 0.75rem;
    }

    .trends-summary .summary-card {
        padding: 0.75rem;
    }

    .department-trend-item {
        padding: 0.75rem 0.5rem;
        margin-bottom: 0.5rem;
    }

    .spending-trend-item {
        padding: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .duplicate-item {
        padding: 1rem 0.75rem;
        margin-bottom: 0.75rem;
    }
}

/* Responsive Design */
@media (max-width: 768px) {
    .dashboard-grid {
        grid-template-columns: 1fr;
    }

    .analysis-controls {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .analysis-filters {
        flex-direction: column;
        align-items: stretch;
    }
    
    .comparison-grid {
        grid-template-columns: 1fr;
    }
    
    .metric-value {
        font-size: 2rem;
    }
}

/* Ensure all tables and wide elements stay within tab boundaries */
.budget-tab-panel table,
.budget-tab-panel .data-table,
.budget-tab-panel .results-table,
.budget-tab-panel .infrastructure-table {
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box;
    table-layout: auto;
    word-wrap: break-word;
    overflow-x: auto;
}

/* Trends Tab Styling */
.budget-trends-section {
    margin: 2rem 0;
    background: white;
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
}

.trends-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.trends-summary .summary-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    text-align: center;
    border-left: 4px solid #667eea;
    color: #333;
}

.trends-summary .summary-card h4 {
    color: #0038A8;
    margin: 0 0 10px 0;
    font-size: 1.1rem;
    font-weight: 600;
}

.trends-summary .summary-card .value {
    font-size: 2em;
    font-weight: bold;
    margin: 0;
    color: #667eea;
}

.trends-summary .summary-card .label {
    font-size: 0.9rem;
    color: #666;
    margin: 0;
}

.trends-container {
    margin-top: 1rem;
}

.trends-results {
    min-height: 100px;
}

.duplicate-item {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1rem;
}

.duplicate-item.high-risk {
    background: #f8d7da;
    border-color: #f5c6cb;
}

.duplicate-item.medium-risk {
    background: #fff3cd;
    border-color: #ffeaa7;
}

.duplicate-item .risk-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.duplicate-item.high-risk .risk-badge {
    background: #dc3545;
    color: white;
}

.duplicate-item.medium-risk .risk-badge {
    background: #ffc107;
    color: #212529;
}

.duplicate-item .projects-comparison {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-top: 1rem;
}

.duplicate-item .project-card {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 1rem;
}

.duplicate-item .project-card h5 {
    color: #0038A8;
    margin: 0 0 0.5rem 0;
    font-size: 1rem;
}

.duplicate-item .project-card .amount {
    font-weight: bold;
    color: #28a745;
    font-size: 1.1rem;
}

.duplicate-item .project-card .keywords {
    margin-top: 0.5rem;
    font-size: 0.9rem;
    color: #6c757d;
}

/* Infrastructure Projects Table Styling */
.infrastructure-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.infrastructure-table thead {
    background: #f8f9fa;
}

.infrastructure-table th {
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: #495057;
    border-bottom: 2px solid #dee2e6;
}

.infrastructure-table td {
    padding: 12px;
    border-bottom: 1px solid #dee2e6;
    vertical-align: top;
}

.infrastructure-table tbody tr:hover {
    background: #f8f9fa;
}

.infrastructure-table tbody tr.high-risk {
    background: #fff5f5;
}

.infrastructure-table tbody tr.medium-risk {
    background: #fffbf0;
}

.risk-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
    color: white;
}

.risk-badge.high {
    background: #dc3545;
}

.risk-badge.medium {
    background: #ffc107;
    color: #212529;
}

.risk-badge.low {
    background: #28a745;
}

.similarity-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
    color: white;
}

.similarity-badge.high {
    background: #dc3545;
}

.similarity-badge.medium {
    background: #ffc107;
    color: #212529;
}

.similarity-badge.low {
    background: #28a745;
}

/* Mobile responsiveness for infrastructure table */
@media (max-width: 768px) {
    .infrastructure-table {
        font-size: 0.8rem;
    }
    
    .infrastructure-table th,
    .infrastructure-table td {
        padding: 8px 6px;
    }
    
    .infrastructure-table th:nth-child(6),
    .infrastructure-table td:nth-child(6) {
        display: none; /* Hide keywords column on mobile */
    }
    
    .infrastructure-table th:nth-child(7),
    .infrastructure-table td:nth-child(7) {
        display: none; /* Hide duplicate risk column on mobile */
    }
}

.duplicate-item .similarity-info {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #dee2e6;
    font-size: 0.9rem;
    color: #6c757d;
}

.duplicate-item .similarity-score {
    font-weight: bold;
    color: #dc3545;
}

.spending-trend-item {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.spending-trend-item .department-name {
    font-weight: 600;
    color: #0038A8;
}

.spending-trend-item .trend-values {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.spending-trend-item .year-value {
    text-align: center;
}

.spending-trend-item .year-value .amount {
    font-weight: bold;
    color: #28a745;
}

.spending-trend-item .year-value .label {
    font-size: 0.8rem;
    color: #6c757d;
}

.spending-trend-item .change-indicator {
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
}

.spending-trend-item .increase {
    background: #d4edda;
    color: #155724;
}

.spending-trend-item .decrease {
    background: #f8d7da;
    color: #721c24;
}

.spending-trend-item .stable {
    background: #d1ecf1;
    color: #0c5460;
}

.budget-tab-panel {
    display: none;
    animation: fadeIn 0.3s ease-in-out;
    overflow-x: auto;
    overflow-y: visible;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
}

.budget-tab-panel.active {
    display: block;
}

.budget-container {
    max-width: 100%;
    overflow-x: hidden;
    position: relative;
}

.budget-tab-content {
    max-width: 100%;
    overflow-x: auto;
    overflow-y: visible;
    position: relative;
    box-sizing: border-box;
}

.tab-placeholder {
    text-align: center;
    padding: 3rem;
    color: #666;
    font-style: italic;
    background: #f8f9fa;
    border-radius: 8px;
    border: 2px dashed #dee2e6;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Top Items Styles */
.top-items-container {
    margin: 1rem 0;
}

.top-item-card {
    background: white;
    padding: 1.5rem;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 1rem;
    border-left: 4px solid #ff6b6b;
}

.top-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.top-item-rank {
    background: #ff6b6b;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.9rem;
}

.top-item-columns {
    background: #e3f2fd;
    color: #1976d2;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.9rem;
}

.top-item-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.top-item-field {
    background: #f8f9fa;
    padding: 0.75rem;
    border-radius: 6px;
    border-left: 3px solid #667eea;
}

.top-item-field-label {
    font-weight: 600;
    color: #333;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.25rem;
}

.top-item-field-value {
    color: #666;
    font-size: 0.9rem;
}

/* Budget Columns Styles */
.budget-columns {
    margin: 2rem 0;
}

.columns-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
    max-width: 100%;
    box-sizing: border-box;
}

@media (max-width: 768px) {
    .columns-container {
        grid-template-columns: 1fr;
        gap: 0.5rem;
    }
}

.column-card {
    background: white;
    padding: 1.5rem;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-left: 4px solid #28a745;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.column-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.column-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.column-name {
    font-weight: bold;
    color: #333;
    font-size: 1.1rem;
}

.column-type {
    background: #e3f2fd;
    color: #1976d2;
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
}

.column-description {
    color: #666;
    font-size: 0.9rem;
    line-height: 1.4;
}

/* Sample Rows Styles */
.budget-sample-rows {
    margin: 2rem 0;
}

.sample-rows-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.sample-row-card {
    background: white;
    padding: 1.5rem;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-left: 4px solid #ffc107;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.sample-row-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.sample-row-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.sample-row-amount {
    font-size: 1.5rem;
    font-weight: bold;
    color: #28a745;
}

.sample-row-department {
    background: #fff3cd;
    color: #856404;
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 600;
}

.sample-row-details {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.sample-row-description {
    color: #333;
    font-weight: 500;
    font-size: 0.9rem;
    line-height: 1.4;
}

.sample-row-program {
    color: #666;
    font-size: 0.8rem;
    font-style: italic;
}

.sample-row-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid #eee;
}

.sample-row-fields {
    color: #28a745;
    font-size: 0.75rem;
    font-weight: 600;
    background: rgba(40, 167, 69, 0.1);
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
}

.sample-row-index {
    color: #6c757d;
    font-size: 0.75rem;
    font-weight: 500;
}

/* Sample Rows Table Styles */
.sample-rows-table-container {
    margin-top: 1rem;
    overflow-x: auto;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.sample-rows-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    font-size: 0.85rem;
}

.sample-rows-table th {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    padding: 0.75rem 0.5rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border: none;
}

.sample-rows-table th:first-child {
    border-top-left-radius: 10px;
}

.sample-rows-table th:last-child {
    border-top-right-radius: 10px;
}

.sample-rows-table td {
    padding: 0.6rem 0.5rem;
    border-bottom: 1px solid #eee;
    vertical-align: top;
}

.sample-rows-table tr:hover {
    background-color: #f8f9fa;
}

.sample-rows-table tr:last-child td {
    border-bottom: none;
}

.row-number {
    background: #f8f9fa;
    font-weight: 600;
    color: #495057;
    text-align: center;
    width: 50px;
}

.row-value {
    color: #333;
    word-break: break-word;
}

.table-info {
    background: #f8f9fa;
    padding: 0.5rem 1rem;
    border-bottom-left-radius: 10px;
    border-bottom-right-radius: 10px;
    text-align: center;
}

.table-stats {
    color: #6c757d;
    font-size: 0.8rem;
    font-weight: 500;
}

/* Flood Control Styles */
.budget-flood-control {
    margin: 2rem 0;
}

.flood-control-container {
    margin-top: 1rem;
}

.flood-control-card {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
    color: white;
    padding: 2rem;
    border-radius: 15px;
    box-shadow: 0 8px 25px rgba(23, 162, 184, 0.3);
    position: relative;
    overflow: hidden;
}

.flood-control-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 50%);
    pointer-events: none;
}

.flood-control-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    position: relative;
    z-index: 1;
}

.flood-control-amount {
    font-size: 2.5rem;
    font-weight: bold;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.flood-control-department {
    background: rgba(255,255,255,0.2);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
    backdrop-filter: blur(10px);
}

.flood-control-details {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    position: relative;
    z-index: 1;
}

.flood-control-description {
    font-size: 1.1rem;
    font-weight: 500;
    line-height: 1.4;
    opacity: 0.95;
}

.flood-control-program {
    font-size: 0.9rem;
    opacity: 0.8;
    font-style: italic;
}
</style>

<script>
console.log('üöÄ [BUDGET] JavaScript is loading... Version: 2025-10-07-01');

// Utility function to escape HTML and prevent XSS
function escapeHtml(str) {
    if (str === null || str === undefined) {
        return '';
    }
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

// Old budget analysis form code removed - functionality moved to main DOMContentLoaded

// Function to toggle duplicate details
function toggleDuplicateDetails(year, type, index) {
    const detailsId = `details-${year}-${type}-${index}`;
    const detailsDiv = document.getElementById(detailsId);
    
    if (detailsDiv.style.display === 'none') {
        // Show details and load data
        detailsDiv.style.display = 'block';
        loadDuplicateDetails(year, type, index);
        
        // Switch to Data Browser tab to show the duplicate data
        switchToTab('browser');
    } else {
        // Hide details
        detailsDiv.style.display = 'none';
    }
}

// Function to load duplicate line details
async function loadDuplicateDetails(year, type, index) {
    const detailsId = `details-${year}-${type}-${index}`;
    const detailsDiv = document.getElementById(detailsId);
    
    try {
        // Make API call to get duplicate line details
        const response = await fetch(`${getApiBaseUrl()}/api/budget/duplicate-details`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            body: JSON.stringify({ 
                year: year, 
                type: type, 
                index: index 
            })
            });

            if (response.ok) {
            const result = await response.json();
            if (result.success && result.duplicate_lines) {
                // Display the actual duplicate lines
                let html = '<div class="duplicate-lines">';
                html += `<h6>üìã Actual Duplicate Lines (${result.duplicate_lines.length} found):</h6>`;
                
                result.duplicate_lines.forEach((line, lineIndex) => {
                    // Highlight the most shocking duplicates
                    const isShocking = lineIndex < 2; // First 2 rows are most shocking
                    const shockClass = isShocking ? 'shocking-duplicate' : '';
                    const shockIcon = isShocking ? 'üö®' : 'üìã';
                    
                    html += `<div class="duplicate-line ${shockClass}">
                        <div class="line-header">${shockIcon} ${isShocking ? 'MOST SHOCKING' : 'Duplicate'} Line ${lineIndex + 1}</div>
                        <div class="line-content">`;
                    
                    // Display each column value with better formatting
                    Object.keys(line).forEach(key => {
                        if (line[key] !== null && line[key] !== '') {
                            const value = line[key];
                            const isAmount = key.toUpperCase().includes('AMT') || key.toUpperCase().includes('AMOUNT') || value.includes('‚Ç±');
                            const isDescription = key.toUpperCase().includes('DESC') || key.toUpperCase().includes('DESCRIPTION') || key.toUpperCase().includes('ITEM');
                            
                            html += `<div class="line-field ${isAmount ? 'amount-field' : isDescription ? 'desc-field' : 'regular-field'}">
                                <span class="field-label">${key}:</span>
                                <span class="field-value">${value}</span>
                            </div>`;
                        }
                    });
                    
                    html += `</div></div>`;
                });
                
                html += '</div>';
                detailsDiv.innerHTML = html;
            } else {
                detailsDiv.innerHTML = '<div class="error">No duplicate line details found.</div>';
            }
        } else {
            detailsDiv.innerHTML = '<div class="error">Error loading duplicate details.</div>';
            }
        } catch (error) {
        detailsDiv.innerHTML = '<div class="error">Error loading duplicate details.</div>';
    }
}

// Function to disable all clickable elements
function disableAllClickableElements() {
    // Disable form elements
    const textareas = document.querySelectorAll('textarea');
    const buttons = document.querySelectorAll('button');
    const sampleQueries = document.querySelectorAll('.sample-query');
    
    textareas.forEach(el => {
        el.disabled = true;
        el.style.opacity = '0.6';
        el.style.cursor = 'not-allowed';
    });
    
    buttons.forEach(el => {
        el.disabled = true;
        el.style.opacity = '0.6';
        el.style.cursor = 'not-allowed';
    });
    
    sampleQueries.forEach(el => {
        el.style.pointerEvents = 'none';
        el.style.opacity = '0.6';
        el.style.cursor = 'not-allowed';
    });
}

// Function to enable all clickable elements
function enableAllClickableElements() {
    // Re-enable form elements
    const textareas = document.querySelectorAll('textarea');
    const buttons = document.querySelectorAll('button');
    const sampleQueries = document.querySelectorAll('.sample-query');
    
    textareas.forEach(el => {
        el.disabled = false;
        el.style.opacity = '1';
        el.style.cursor = 'text';
    });
    
    buttons.forEach(el => {
        el.disabled = false;
        el.style.opacity = '1';
        el.style.cursor = 'pointer';
    });
    
    sampleQueries.forEach(el => {
        el.style.pointerEvents = 'auto';
        el.style.opacity = '1';
        el.style.cursor = 'pointer';
    });
}



// Function to extract year from filename
function extractYearFromFilename(filename) {
    const match = filename.match(/(\d{4})/);
    return match ? match[1] : 'Unknown';
}




// Function to display budget analysis results
function displayBudgetAnalysisResult(result) {
    const resultDiv = document.getElementById('budget-result');
    if (!resultDiv) return;
    
    let html = '<div class="analysis-result">';
    
    if (result.duplicates && result.duplicates.length > 0) {
        html += '<h4>üîç Duplicate Line Items Found:</h4>';
        html += '<div class="duplicates-list">';
        
        result.duplicates.forEach((dup, index) => {
            html += `
                <div class="duplicate-item">
                    <div class="duplicate-header">
                        <span class="duplicate-rank">#${index + 1}</span>
                        <span class="duplicate-columns">${dup.matching_columns || 0} columns match</span>
                    </div>
                    <div class="duplicate-content">
                        <div class="duplicate-field">
                            <strong>Description:</strong> ${dup.description || 'N/A'}
                        </div>
                        <div class="duplicate-field">
                            <strong>Amount:</strong> ‚Ç±${((dup.amount || 0) * 1000).toLocaleString('en-US')}
                        </div>
                        <div class="duplicate-field">
                            <strong>Duplicate Count:</strong> ${dup.duplicate_count || 0} times
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
    } else {
        html += '<div class="no-results">No duplicate line items found with this query.</div>';
    }
    
    if (result.summary_stats) {
        html += '<h4>üìä Summary Statistics:</h4>';
        html += '<div class="summary-stats">';
        Object.entries(result.summary_stats).forEach(([key, value]) => {
            html += `<div class="stat-item"><strong>${key}:</strong> ${value}</div>`;
        });
        html += '</div>';
    }
    
    html += '</div>';
    resultDiv.innerHTML = html;
}

// Function to display top 10 duplicates
function displayTopDuplicates(duplicates) {
    const container = document.getElementById('top-items-container');
    if (!container) return;
    
    if (duplicates.length === 0) {
        container.innerHTML = `
            <div class="top-item-card">
                <div class="top-item-header">
                    <div class="top-item-rank">#0</div>
                    <div class="top-item-columns">No Data</div>
                </div>
                <div class="top-item-details">
                    <div class="top-item-field">
                        <div class="top-item-field-label">Status</div>
                        <div class="top-item-field-value">No duplicates found</div>
                    </div>
                </div>
            </div>
        `;
        return;
    }
    
    let html = '';
    duplicates.forEach((duplicate, index) => {
        const rank = index + 1;
        const columnCount = duplicate.matching_columns || 0;
        const description = duplicate.description || 'Unknown';
        const amount = duplicate.amount || 0;
        
        html += `
            <div class="top-item-card">
                <div class="top-item-header">
                    <div class="top-item-rank">#${rank}</div>
                    <div class="top-item-columns">${columnCount} columns</div>
                </div>
                <div class="top-item-details">
                    <div class="top-item-field">
                        <div class="top-item-field-label">Description</div>
                        <div class="top-item-field-value">${description}</div>
                    </div>
                    <div class="top-item-field">
                        <div class="top-item-field-label">Amount</div>
                        <div class="top-item-field-value">‚Ç±${(amount * 1000).toLocaleString('en-US')}</div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Function to show error message for top duplicates
function showTopDuplicatesError(message) {
    const container = document.getElementById('top-items-container');
    if (container) {
        container.innerHTML = `
            <div class="top-item-card">
                <div class="top-item-header">
                    <div class="top-item-rank">#0</div>
                    <div class="top-item-columns">Error</div>
                </div>
                <div class="top-item-details">
                    <div class="top-item-field">
                        <div class="top-item-field-label">Status</div>
                        <div class="top-item-field-value">${message}</div>
                    </div>
                </div>
            </div>
        `;
    }
}

// Tab functionality
function initializeTabs() {
    console.log('üîç [Init] Initializing tabs...');
    const tabButtons = document.querySelectorAll('.budget-tab-btn');
    const tabPanels = document.querySelectorAll('.budget-tab-panel');
    console.log('üîç [Init] Found', tabButtons.length, 'tab buttons and', tabPanels.length, 'tab panels');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            if (this.disabled) return;

            const targetTab = this.getAttribute('data-tab');
            console.log('üîç [Tab] Tab clicked:', targetTab);
            switchToTab(targetTab);
        });
    });
}

// Visual charts functionality
function loadVisualCharts() {
    
    // Show loading spinner
    const spinner = document.getElementById('visual-loading-spinner');
    if (spinner) {
        spinner.style.display = 'flex';
    }
    
    // Load statistics first
    loadVisualStatistics();
    
    // Load charts with a small delay to ensure DOM is ready
    setTimeout(() => {
        loadDepartmentsChart();
        loadExpenseCategoriesChart();
        loadRegionsChart();
        loadAgenciesChart();
        
        // Hide loading spinner after charts are loaded
        if (spinner) {
            spinner.style.display = 'none';
        }
    }, 100);
}

async function loadVisualStatistics(year = null) {
    try {
        // Use year-specific stats if provided, otherwise get all-year stats
        let url = `${getApiBaseUrl()}/api/budget/overview/stats`;
        if (year && year !== 'all') {
            url += `?year=${year}`;
        }

        console.log(`üìä [Frontend] Loading visual statistics for year: ${year || 'all'}`);

        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success && result.stats) {
            const stats = result.stats;
            
            // Update all statistics cards from the materialized view
            document.getElementById('total-budget-items').textContent = stats.total_items?.toLocaleString('en-US') || '0';
            document.getElementById('total-budget-value').textContent = `‚Ç±${((stats.total_value || 0) * 1000).toLocaleString('en-US')}`;
            document.getElementById('total-departments').textContent = stats.unique_departments?.toLocaleString('en-US') || '0';
            document.getElementById('unique-agencies').textContent = stats.unique_agencies?.toLocaleString('en-US') || '0';
            
            console.log('‚úÖ [Frontend] Overview stats loaded from materialized view:', stats);
        } else {
            console.error('‚ùå [Frontend] Failed to load overview stats:', result.error);
            // Set fallback values
            document.getElementById('total-budget-items').textContent = '3.2M+';
            document.getElementById('total-budget-value').textContent = '‚Ç±49T+';
            document.getElementById('total-departments').textContent = '39';
            document.getElementById('unique-agencies').textContent = '135';
        }
        
        // Hide loading spinner when statistics are loaded
        const spinner = document.getElementById('visual-loading-spinner');
        if (spinner) {
            spinner.style.display = 'none';
        }
    } catch (error) {
        
        // Hide loading spinner even on error
        const spinner = document.getElementById('visual-loading-spinner');
        if (spinner) {
            spinner.style.display = 'none';
        }
    }
}

async function loadDepartmentsChart() {
    try {
        const apiYear = getApiYear();
        const response = await fetch(`/api/budget/departments?year=${apiYear}&limit=8`);
        const result = await response.json();
        
        if (result.success && result.data) {
            const departments = result.data;
            
            if (typeof Chart === 'undefined') {
                return;
            }
            
            const canvas = document.getElementById('departmentsChart');
            if (!canvas) {
                return;
            }
            
            // Clear any existing chart
            const existingChart = Chart.getChart(canvas);
            if (existingChart) {
                existingChart.destroy();
            }
            
            const ctx = canvas.getContext('2d');
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: departments.map(d => d.department_description || 'Unknown'),
                    datasets: [{
                        data: departments.map(d => (d.total_amount || 0) * 1000),
                        backgroundColor: [
                            '#0038A8', '#CE1126', '#28a745', '#ffc107',
                            '#dc3545', '#6f42c1', '#fd7e14', '#20c997'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1.2,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        } else {
        }
    } catch (error) {
    }
}

async function loadAgenciesChart() {
    try {
        const apiYear = getApiYear();
        const response = await fetch(`/api/budget/agencies?year=${apiYear}&limit=10`);
        const result = await response.json();
        
        if (result.success && result.data) {
            const agencies = result.data;
            const canvas = document.getElementById('agenciesChart');
            if (!canvas) {
                return;
            }
            
            // Clear any existing chart
            const existingChart = Chart.getChart(canvas);
            if (existingChart) {
                existingChart.destroy();
            }
            
            const ctx = canvas.getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: agencies.map(a => a.uacs_agy_dsc || 'Unknown'),
                    datasets: [{
                        label: 'Budget Amount (‚Ç±)',
                        data: agencies.map(a => (a.total_amount || 0) * 1000),
                        backgroundColor: 'rgba(0, 56, 168, 0.8)',
                        borderColor: 'rgba(0, 56, 168, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1.5,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000000000) {
                                        return '‚Ç±' + (value / 1000000000).toFixed(1) + 'B';
                                    } else if (value >= 1000000) {
                                        return '‚Ç±' + (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return '‚Ç±' + (value / 1000).toFixed(1) + 'K';
                                    }
                                    return '‚Ç±' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
    } catch (error) {
    }
}


async function loadExpenseCategoriesChart() {
    try {
        const apiYear = getApiYear();
        const response = await fetch(`/api/budget/expense-categories?year=${apiYear}&limit=8`);
        const result = await response.json();
        
        if (result.success && result.data) {
            const categories = result.data;
            const canvas = document.getElementById('expenseCategoriesChart');
            if (!canvas) {
                return;
            }
            
            // Clear any existing chart
            const existingChart = Chart.getChart(canvas);
            if (existingChart) {
                existingChart.destroy();
            }
            
            const ctx = canvas.getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categories.map(c => c.uacs_exp_dsc || 'Unknown'),
                    datasets: [{
                        label: 'Budget Amount (‚Ç±)',
                        data: categories.map(c => (c.total_amount || 0) * 1000),
                        backgroundColor: 'rgba(206, 17, 38, 0.8)',
                        borderColor: 'rgba(206, 17, 38, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1.5,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000000000) {
                                        return '‚Ç±' + (value / 1000000000).toFixed(1) + 'B';
                                    } else if (value >= 1000000) {
                                        return '‚Ç±' + (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return '‚Ç±' + (value / 1000).toFixed(1) + 'K';
                                    }
                                    return '‚Ç±' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
    } catch (error) {
    }
}

async function loadRegionsChart() {
    try {
        const apiYear = getApiYear();
        const response = await fetch(`/api/budget/regions?year=${apiYear}&limit=8`);
        const result = await response.json();
        
        if (result.success && result.data) {
            const regions = result.data;
            const canvas = document.getElementById('regionsChart');
            if (!canvas) {
                return;
            }
            
            // Clear any existing chart
            const existingChart = Chart.getChart(canvas);
            if (existingChart) {
                existingChart.destroy();
            }
            
            const ctx = canvas.getContext('2d');
            
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: regions.map(r => `Region ${r.uacs_reg_id}` || 'Unknown'),
                    datasets: [{
                        data: regions.map(r => (r.total_amount || 0) * 1000),
                        backgroundColor: [
                            '#0038A8', '#CE1126', '#28a745', '#ffc107',
                            '#dc3545', '#6f42c1', '#fd7e14', '#20c997'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1.2,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }
    } catch (error) {
    }
}

// Function to load budget columns comparison (2024 vs 2025)
async function loadBudgetColumns() {
    try {
        
        // Show loading state
        const container = document.getElementById('columns-container');
        if (container) {
            container.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #666;">
                    <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">üîÑ Loading...</div>
                    <div>Analyzing budget data structure for 2024 and 2025...</div>
                </div>
            `;
        }
        
        // Load columns for both years in parallel
        const [response2024, response2025] = await Promise.all([
            fetch(`${getApiBaseUrl()}/api/budget/columns?year=2024`),
            fetch(`${getApiBaseUrl()}/api/budget/columns?year=2025`)
        ]);
        
        
        if (response2024.ok && response2025.ok) {
            const [result2024, result2025] = await Promise.all([
                response2024.json(),
                response2025.json()
            ]);
            
            
            if (result2024.success && result2025.success) {
                // Column comparison removed as requested
            } else {
                // Column comparison removed as requested
            }
        } else {
            // Column comparison removed as requested
        }
    } catch (error) {
        // Column comparison removed as requested
    }
}





// Function to load flood control amount (renamed from loadSampleRows)
async function loadFloodControlAmount() {
    try {
        
        // Show loading state
        const container = document.getElementById('flood-control-container');
        if (container) {
            container.innerHTML = `
                <div class="sample-rows-table-container">
                    <table class="sample-rows-table">
                        <thead>
                            <tr>
                                <th>Row</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="row-number">1</td>
                                <td class="row-value">üîÑ Loading highest amount...</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="table-info">
                        <span class="table-stats">Analyzing budget data...</span>
                    </div>
                </div>
            `;
        }
        
        // Use data browser API instead of deprecated highest-flood-control
        const params = new URLSearchParams({
            year: '2025',
            page: '1',
            limit: '1',
            sort_by: 'amt',
            sort_order: 'DESC'
        });
        
        const response = await fetch(`/api/budget/data-browser?${params.toString()}`);
        
        if (response.ok) {
            const result = await response.json();
            
            if (result.success && result.rows && result.rows.length > 0) {
                displayFloodControlAmount(result.rows);
            } else {
                showFloodControlError(result.error || 'Failed to load highest amounts');
            }
        } else {
            showFloodControlError('Failed to load highest amount');
        }
    } catch (error) {
        showFloodControlError('Error loading highest amount');
    }
}


// Function to display sample rows
function displaySampleRows(rows) {
    const container = document.getElementById('sample-rows-container');
    if (!container) return;

    if (rows && rows.length > 0) {
        // Get all unique column names from all rows
        const allColumns = new Set();
        rows.forEach(row => {
            Object.keys(row).forEach(key => {
                if (row[key] !== null && row[key] !== '') {
                    allColumns.add(key);
                }
            });
        });
        
        const columns = Array.from(allColumns);
        
        let html = `
            <div class="sample-rows-table-container">
                <table class="sample-rows-table">
                    <thead>
                        <tr>
                            <th>Row</th>
                            ${columns.map(col => `<th>${col}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        rows.forEach((row, index) => {
            html += `
                <tr>
                    <td class="row-number">${index + 1}</td>
                    ${columns.map(col => {
                        let value = row[col] || '';
                        // Format amount columns
                        if (col.toLowerCase().includes('amount') && value && !isNaN(value)) {
                            value = `‚Ç±${parseFloat(value).toLocaleString('en-US')}`;
                        }
                        // Truncate long text
                        if (typeof value === 'string' && value.length > 50) {
                            value = value.substring(0, 50) + '...';
                        }
                        return `<td class="row-value">${value}</td>`;
                    }).join('')}
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
                <div class="table-info">
                    <span class="table-stats">${rows.length} rows √ó ${columns.length} columns</span>
                </div>
            </div>
        `;
        
        container.innerHTML = html;
    } else {
        container.innerHTML = '<div class="sample-row-card"><div class="sample-row-description">No sample rows found</div></div>';
    }
}

// Function to show sample rows error
function showSampleRowsError(message) {
    const container = document.getElementById('sample-rows-container');
    if (container) {
        container.innerHTML = `<div class="sample-row-card"><div class="sample-row-description">‚ùå ${message}</div></div>`;
    }
}


// Function to display flood control amount (using same table style as sample rows)
function displayFloodControlAmount(rows) {
    const container = document.getElementById('flood-control-container');
    if (!container) return;

    if (rows && rows.length > 0) {
        // Get all unique column names from all rows
        const allColumns = new Set();
        rows.forEach(row => {
            Object.keys(row).forEach(key => {
                if (row[key] !== null && row[key] !== '') {
                    allColumns.add(key);
                }
            });
        });
        
        const columns = Array.from(allColumns);
        
        let html = `
            <div class="sample-rows-table-container">
                <table class="sample-rows-table">
                    <thead>
                        <tr>
                            <th>Row</th>
                            ${columns.map(col => `<th>${col}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        rows.forEach((row, index) => {
            html += `
                <tr>
                    <td class="row-number">${index + 1}</td>
                    ${columns.map(col => {
                        let value = row[col] || '';
                        // Format amount columns with US-style number formatting (multiply by 1000 for GAA convention)
                        if (col.toLowerCase().includes('amt') && value && !isNaN(value)) {
                            value = `‚Ç±${(parseFloat(value) * 1000).toLocaleString('en-US')}`;
                        }
                        // Truncate long text
                        if (typeof value === 'string' && value.length > 50) {
                            value = value.substring(0, 50) + '...';
                        }
                        return `<td class="row-value">${value}</td>`;
                    }).join('')}
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
                <div class="table-info">
                    <span class="table-stats">${rows.length} rows √ó ${columns.length} columns - Top 100 Highest Budget Amounts</span>
                </div>
            </div>
        `;
        
        container.innerHTML = html;
    } else {
        container.innerHTML = `
            <div class="sample-rows-table-container">
                <table class="sample-rows-table">
                    <thead>
                        <tr>
                            <th>Row</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="row-number">1</td>
                            <td class="row-value">None</td>
                        </tr>
                    </tbody>
                </table>
                <div class="table-info">
                    <span class="table-stats">No data available</span>
                </div>
            </div>
        `;
    }
}

// Function to show flood control error (using same table style)
function showFloodControlError(message) {
    const container = document.getElementById('flood-control-container');
    if (container) {
        container.innerHTML = `
            <div class="sample-rows-table-container">
                <table class="sample-rows-table">
                    <thead>
                        <tr>
                            <th>Row</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="row-number">1</td>
                            <td class="row-value">‚ùå ${message}</td>
                        </tr>
                    </tbody>
                </table>
                <div class="table-info">
                    <span class="table-stats">Error loading data</span>
                </div>
            </div>
        `;
    }
}

// Data Browser Functions
let currentPage = 1;
let currentSortBy = 'amt';
let currentSortOrder = 'DESC';
let currentFilters = {};

// Duplicates Pagination Functions
let currentDuplicatesPage = 1;
let currentDuplicates = [];
let currentDuplicatesRowsPerPage = 5;
let currentDuplicatesSortBy = 'calculated_score';
let currentDuplicatesSortOrder = 'DESC';

// Column Duplicates Pagination Functions
let currentColumnDuplicatesPage = 1;
let currentColumnDuplicates = [];
let currentColumnDuplicatesRowsPerPage = 10;
let totalColumnDuplicates = 0;


// Helper function to get API year (converts 'all' to '2025')
function getApiYear() {
    // Use the Analysis tab's year filter for potential duplicates
    const selectedYear = document.getElementById('analysis-year-filter')?.value || '2025';
    return selectedYear === 'all' ? '2025' : selectedYear;
}

// Helper function to get Data Browser API year (allows 'all' for cross-year queries)
function getDataBrowserApiYear() {
    // Use the Data Browser tab's year filter
    const selectedYear = document.getElementById('browser-year-filter')?.value || '2025';
    return selectedYear; // Allow 'all' to be passed through
}

// Function to programmatically switch to a specific tab
function switchToTab(tabName, updateHash = true) {
    
    // Remove active class from all buttons and panels
    const tabButtons = document.querySelectorAll('.budget-tab-btn');
    const tabPanels = document.querySelectorAll('.budget-tab-panel');
    
    tabButtons.forEach(btn => btn.classList.remove('active'));
    tabPanels.forEach(panel => panel.classList.remove('active'));
    
    // Add active class to target button and panel
    const targetButton = document.querySelector(`[data-tab="${tabName}"]`);
    const targetPanel = document.getElementById(`tab-${tabName}`);
    
    if (targetButton && targetPanel) {
        targetButton.classList.add('active');
        targetPanel.classList.add('active');
        
        // Update URL hash (without triggering hashchange event)
        if (updateHash && window.location.hash !== `#${tabName}`) {
            history.replaceState(null, null, `#${tabName}`);
        }
        
        // Load data based on selected tab
        if (tabName === 'visual') {
            loadVisualCharts();
        } else if (tabName === 'browser') {
            loadDataBrowser();
        } else if (tabName === 'analysis') {
            // Analysis tab data is loaded when sections are expanded
        } else if (tabName === 'trends') {
            // Load trends data when tab is activated (v2.0 - 2025-01-05)
            loadDepartmentTrends();
        }
        
    } else {
    }
}

// Year filter event listeners (moved to main DOMContentLoaded)

// Load data browser on page load
async function loadDataBrowser() {
    try {
        
        const container = document.getElementById('data-browser-container');
        if (container) {
            container.innerHTML = '<div class="loading-spinner">Loading budget data...</div>';
        }
        
        // Get rows per page from selector
        const rowsPerPage = document.getElementById('rows-per-page')?.value || '5';
        
        // Get API year (handles 'all' case) - use Data Browser's year filter
        const apiYear = getDataBrowserApiYear();
        
        // Build query parameters
        const params = new URLSearchParams({
            year: apiYear,
            page: currentPage,
            limit: rowsPerPage,
            sort_by: currentSortBy,
            sort_order: currentSortOrder
        });
        
        // Add filters to query parameters
        Object.entries(currentFilters).forEach(([key, value]) => {
            if (value) {
                params.append(key, value);
            }
        });
        
        const response = await fetch(`/api/budget/data-browser?${params.toString()}`);
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                displayDataBrowser(result);
            } else {
                showDataBrowserError(result.error || 'Failed to load data');
            }
        } else {
            showDataBrowserError('Failed to load data');
        }
    } catch (error) {
        console.error('‚ùå [Data Browser] Error loading data:', error);
        showDataBrowserError('Error loading data');
    }
}

// Display data browser results
function displayDataBrowser(data) {
    const container = document.getElementById('data-browser-container');
    if (!container) return;

    if (data.rows && data.rows.length > 0) {
        // Get all unique column names from the first row to build dynamic headers
        const allColumns = Object.keys(data.rows[0]);
        
        // Exclude year, department, and agency columns
        const excludedColumns = ['year', 'department', 'agency'];
        const filteredColumns = allColumns.filter(col => !excludedColumns.includes(col));
        
        // Only show text columns and amt column - exclude all other numeric columns
        const textColumns = filteredColumns.filter(col => 
            (col.toLowerCase().includes('dsc') || 
             col.toLowerCase().includes('desc') ||
             col.toLowerCase().includes('description')) &&
            col !== 'uacs_oper_dsc' &&
            col !== 'uacs_div_dsc'
        );
        const amtColumns = filteredColumns.filter(col => 
            col.toLowerCase().includes('amt') || 
            col.toLowerCase().includes('amount')
        );
        
        // Exclude all numeric columns (codes, IDs, etc.) except amt and geolocation columns
        const excludedPatterns = [
            'cd', 'id', 'sorder', 'fundcd', 'operunit', 'prexc', 'uacs_dpt_cd', 
            'uacs_agy_cd', 'uacs_exp_cd', 'uacs_sobj_cd', 'department', 'agency', 
            'uacs_oper_dsc'
        ];
        
        // Special handling for geolocation columns - include them even though they're numeric
        const geolocationColumns = ['uacs_reg_id', 'uacs_div_dsc'];
        
        const otherColumns = filteredColumns.filter(col => 
            !textColumns.includes(col) && 
            !amtColumns.includes(col) &&
            !excludedPatterns.some(pattern => col.toLowerCase().includes(pattern))
        );
        
        // Add geolocation columns to otherColumns (they're numeric but important for display)
        geolocationColumns.forEach(geoCol => {
            if (filteredColumns.includes(geoCol) && !otherColumns.includes(geoCol)) {
                otherColumns.push(geoCol);
            }
        });
        
        // Order columns: dsc first, then other text columns, then others, then amt last
        const dscColumns = textColumns.filter(col => col === 'dsc');
        const otherTextColumns = textColumns.filter(col => col !== 'dsc');
        const orderedColumns = [...dscColumns, ...otherTextColumns, ...otherColumns, ...amtColumns];
        
        let html = `
            <table class="data-browser-table">
                <thead>
                    <tr>
                        ${orderedColumns.map(col => `<th>${col}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
        `;
        
        data.rows.forEach((row, index) => {
            const rowClass = index % 2 === 0 ? 'even-row' : 'odd-row';
            html += `
                <tr class="${rowClass}">
                    ${orderedColumns.map(col => {
                        let value = row[col] || 'N/A';
                        let cellClass = 'description-cell';
                        
                        // Determine cell class based on column name
                        if (col.toLowerCase().includes('amt') || col.toLowerCase().includes('amount')) {
                            cellClass = 'amount-cell';
                            // Format amount with US-style number formatting (multiply by 1000 for GAA convention)
                            value = `‚Ç±${(parseFloat(value) * 1000).toLocaleString('en-US')}`;
                        } else if (col.toLowerCase().includes('cd') || col.toLowerCase().includes('id') || col.toLowerCase().includes('year')) {
                            cellClass = 'code-cell';
                        } else if (col === 'dsc') {
                            cellClass = 'dsc-cell';
                        }
                        
                        return `<td class="${cellClass}">${value}</td>`;
                    }).join('')}
                </tr>
            `;
        });
        
        html += `
                </tbody>
            </table>
            <div class="table-info">
                <span class="table-stats">Page ${data.pagination.current_page} of ${data.pagination.total_pages} (${data.pagination.total_count} total records)</span>
            </div>
        `;
        
        container.innerHTML = html;
        
        // Update pagination controls
        updatePaginationControls(data.pagination);
    } else {
        container.innerHTML = '<div class="loading-spinner">No data found</div>';
    }
}

// Show data browser error
function showDataBrowserError(message) {
    const container = document.getElementById('data-browser-container');
    if (container) {
        container.innerHTML = `<div class="loading-spinner">‚ùå ${message}</div>`;
    }
}

// Update pagination controls
function updatePaginationControls(pagination) {
    const prevBtn = document.getElementById('prev-page-btn');
    const nextBtn = document.getElementById('next-page-btn');
    const pageInfo = document.getElementById('page-info');
    
    if (prevBtn) prevBtn.disabled = !pagination.has_prev;
    if (nextBtn) nextBtn.disabled = !pagination.has_next;
    if (pageInfo) pageInfo.textContent = `Page ${pagination.current_page} of ${pagination.total_pages}`;
}

// Initialize data browser event listeners
let dataBrowserInitialized = false;

function initializeDataBrowser() {
    // Prevent multiple initializations
    if (dataBrowserInitialized) {
        return;
    }
    
    console.log('üîç [Data Browser] Initializing...');
    dataBrowserInitialized = true;
    
    // Don't load filter options on page load - lazy load when user interacts with filters
    // This prevents unnecessary API calls and improves page load performance
    
    // Lazy load filter options when user first interacts with any filter input
    let filterOptionsLoaded = false;
    const filterInputs = document.querySelectorAll('[id^="filter-"]');
    filterInputs.forEach(input => {
        input.addEventListener('focus', () => {
            if (!filterOptionsLoaded) {
                filterOptionsLoaded = true;
                console.log('üîç [Data Browser] User interacted with filter, loading options...');
                loadFilterOptions().then(() => {
                    console.log('‚úÖ [Data Browser] Filter options loaded');
                }).catch(err => {
                    console.error('‚ùå [Data Browser] Error loading filter options:', err);
                });
            }
        }, { once: false }); // Don't use once:true so we can check the flag
    });
    
    // Apply filters button
    const applyBtn = document.getElementById('apply-filters-btn');
    if (applyBtn) {
        applyBtn.addEventListener('click', () => {
            currentPage = 1;
            currentFilters = getCurrentFilters();
            loadDataBrowser();
        });
    }
    
    // Clear filters button
    const clearBtn = document.getElementById('clear-filters-btn');
    if (clearBtn) {
        clearBtn.addEventListener('click', () => {
            clearAllFilters();
            currentPage = 1;
            currentFilters = {};
            loadDataBrowser();
        });
    }
    
    // Rows per page selector
    const rowsPerPageSelect = document.getElementById('rows-per-page');
    if (rowsPerPageSelect) {
        rowsPerPageSelect.addEventListener('change', () => {
            currentPage = 1;
            loadDataBrowser();
        });
    }
    
    // Duplicates rows per page selector
    const duplicatesRowsPerPageSelect = document.getElementById('duplicates-rows-per-page');
    if (duplicatesRowsPerPageSelect) {
        duplicatesRowsPerPageSelect.addEventListener('change', () => {
            currentDuplicatesRowsPerPage = parseInt(duplicatesRowsPerPageSelect.value);
            currentDuplicatesPage = 1;
            if (currentDuplicates.length > 0) {
                displayDuplicatesResults(currentDuplicates);
            }
        });
    }
    
    // Duplicates sorting controls
    const duplicatesSortBySelect = document.getElementById('duplicates-sort-by');
    const duplicatesSortOrderSelect = document.getElementById('duplicates-sort-order');
    
    if (duplicatesSortBySelect) {
        duplicatesSortBySelect.addEventListener('change', () => {
            currentDuplicatesSortBy = duplicatesSortBySelect.value;
            loadAnalysisDuplicatesPage(currentDuplicatesPage); // Reload with new sorting
        });
    }
    
    if (duplicatesSortOrderSelect) {
        duplicatesSortOrderSelect.addEventListener('change', () => {
            currentDuplicatesSortOrder = duplicatesSortOrderSelect.value;
            loadAnalysisDuplicatesPage(currentDuplicatesPage); // Reload with new sorting
        });
    }
    
    
    
    // Column duplicates rows per page selector
    const columnDuplicatesRowsPerPageSelect = document.getElementById('column-duplicates-rows-per-page');
    if (columnDuplicatesRowsPerPageSelect) {
        columnDuplicatesRowsPerPageSelect.addEventListener('change', () => {
            currentColumnDuplicatesRowsPerPage = parseInt(columnDuplicatesRowsPerPageSelect.value);
            currentColumnDuplicatesPage = 1;
            loadAnalysisColumnDuplicatesData(1);
        });
    }
    
    // Column duplicates pagination controls
    const columnDuplicatesPrevBtn = document.getElementById('column-duplicates-prev-page-btn');
    const columnDuplicatesNextBtn = document.getElementById('column-duplicates-next-page-btn');

    if (columnDuplicatesPrevBtn) {
        columnDuplicatesPrevBtn.addEventListener('click', () => {
            if (currentColumnDuplicatesPage > 1) {
                currentColumnDuplicatesPage--;
                loadAnalysisColumnDuplicatesData(currentColumnDuplicatesPage);
            }
        });
    }

    if (columnDuplicatesNextBtn) {
        columnDuplicatesNextBtn.addEventListener('click', () => {
            currentColumnDuplicatesPage++;
            loadAnalysisColumnDuplicatesData(currentColumnDuplicatesPage);
        });
    }
    
    // Auto-load potential duplicates (column duplicates now load only when expanded)
            loadAnalysisDuplicatesPage(1);
    
    // Sort controls
    const sortSelect = document.getElementById('sort-select');
    const sortOrderBtn = document.getElementById('sort-order-btn');
    
    if (sortSelect) {
        sortSelect.addEventListener('change', (e) => {
            currentSortBy = e.target.value;
            currentPage = 1;
            loadDataBrowser();
        });
    }
    
    if (sortOrderBtn) {
        sortOrderBtn.addEventListener('click', () => {
            currentSortOrder = currentSortOrder === 'ASC' ? 'DESC' : 'ASC';
            sortOrderBtn.textContent = currentSortOrder === 'ASC' ? '‚Üë' : '‚Üì';
            sortOrderBtn.setAttribute('data-order', currentSortOrder);
            currentPage = 1;
            loadDataBrowser();
        });
    }
    
    // Pagination controls
    const prevBtn = document.getElementById('prev-page-btn');
    const nextBtn = document.getElementById('next-page-btn');
    
    if (prevBtn) {
        prevBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                loadDataBrowser();
            }
        });
    }
    
    if (nextBtn) {
        nextBtn.addEventListener('click', () => {
            currentPage++;
            loadDataBrowser();
        });
    }
}

// Get current filter values
function getCurrentFilters() {
    const filters = {};
    
    const filterInputs = [
        'filter-uacs_dpt_dsc', 'filter-uacs_agy_dsc', 'filter-dsc', 
        'filter-uacs_fundsubcat_dsc', 'filter-uacs_exp_dsc', 'filter-uacs_sobj_dsc',
        'filter-uacs_reg_id', 'filter-uacs_div_dsc',
        'filter-amt-min', 'filter-amt-max'
    ];
    
    filterInputs.forEach(inputId => {
        const element = document.getElementById(inputId);
        if (element && element.value && element.value.trim()) {
            const filterName = inputId.replace('filter-', '').replace('-', '_');
            let value = element.value.trim();
            
            // Convert amount filters from display format to database format
            // Frontend displays amounts * 1000 (e.g., 1,000,000), backend stores amounts / 1000 (e.g., 1,000)
            // So we need to divide by 1000 when sending to backend
            if (filterName === 'amt_min' || filterName === 'amt_max') {
                const numValue = parseFloat(value);
                if (!isNaN(numValue)) {
                    value = (numValue / 1000).toString(); // Convert from display format (1,000,000) to DB format (1,000)
                }
            }
            
            // For division filter, use the ID if available (API expects ID, not description)
            if (filterName === 'uacs_div_dsc') {
                const selectedId = element.getAttribute('data-selected-id');
                if (selectedId) {
                    filters[filterName] = selectedId; // Use the ID for API calls
                } else {
                    filters[filterName] = value; // Fallback to description if no ID
                }
            } else {
                filters[filterName] = value;
            }
        }
    });
    
    return filters;
}

// Load filter options from views
async function loadFilterOptions() {
    console.log('üîç [Data Browser] loadFilterOptions() called');
    try {
        const apiYear = getDataBrowserApiYear();
        const apiUrl = `/api/budget/text-filters?year=${apiYear}`;
        console.log('üîç [Data Browser] API Year:', apiYear);
        console.log('üîç [Data Browser] Full API URL:', apiUrl);
        console.log('üîç [Data Browser] Fetching filter options...');
        const response = await fetch(apiUrl);
        console.log('üîç [Data Browser] Response received, status:', response.status, 'ok:', response.ok);
        
        if (response.ok) {
            const result = await response.json();
            
            if (result.success) {
                const optionsCount = Object.keys(result.filter_options || {}).length;
                console.log('‚úÖ [Data Browser] Loaded filter options for', optionsCount, 'columns');
                console.log('‚úÖ [Data Browser] Calling populateFilterDropdowns...');
                populateFilterDropdowns(result.filter_options);
                console.log('‚úÖ [Data Browser] populateFilterDropdowns completed');
            } else {
                console.error('‚ùå [Data Browser] Failed to load filter options:', result.error);
            }
        } else {
            console.error('‚ùå [Data Browser] HTTP error:', response.status);
        }
    } catch (error) {
        console.error('‚ùå [Data Browser] Error loading filter options:', error);
    }
}

// Populate filter inputs with autocomplete or dropdown based on known column types
function populateFilterDropdowns(filterOptions) {
    // Store filter options globally for autocomplete and mapping
    window.filterOptions = filterOptions;
    
    // Define which columns should use autocomplete vs dropdown
    // Based on actual PostgreSQL view counts - deterministic
    // NOTE: 'dsc' column excluded - too large (194K items, 18MB), use server-side search instead
    const autocompleteColumns = [
        // 'dsc',                  // EXCLUDED: 194,262 unique values (18MB) - too large for client-side
        'uacs_agy_dsc',           // 386 unique values  
        'uacs_fundsubcat_dsc',    // 75 unique values
        'uacs_sobj_dsc',          // 285 unique values
        'uacs_div_dsc'            // Division descriptions (autocomplete - many unique values)
    ];
    
    // Columns that should use dropdown (few unique values)
    const dropdownColumns = [
        'uacs_dpt_dsc',           // 39 unique values
        'uacs_exp_dsc',           // 4 unique values
        'uacs_reg_id'             // 15 unique values (Philippine regions 1-15)
    ];
    
    // Add autocomplete or dropdown to text inputs
    let autocompleteCount = 0;
    let dropdownCount = 0;
    
    Object.entries(filterOptions).forEach(([columnName, values]) => {
        const inputId = `filter-${columnName}`;
        const input = document.getElementById(inputId);
        
        if (input && values.length > 0) {
            if (autocompleteColumns.includes(columnName)) {
                // Use autocomplete for description columns (known to have many unique values)
                addAutocompleteToInput(input, values);
                autocompleteCount++;
                
                // Add change event listener to the input (still exists after autocomplete setup)
                input.addEventListener('change', () => {
                    console.log(`üîç [Data Browser] Filter changed: ${columnName}`);
                });
            } else if (dropdownColumns.includes(columnName)) {
                // Use dropdown for code columns (known to have few unique values)
                convertToDropdown(input, values, columnName);
                dropdownCount++;
                
                // Add change event listener to the NEW select element (after conversion)
                const select = document.getElementById(inputId);
                if (select) {
                    select.addEventListener('change', () => {
                        console.log(`üîç [Data Browser] Filter changed: ${columnName}`);
                    });
                }
            } else {
                // Default to dropdown for unknown columns
                convertToDropdown(input, values, columnName);
                dropdownCount++;
                
                // Add change event listener to the NEW select element (after conversion)
                const select = document.getElementById(inputId);
                if (select) {
                    select.addEventListener('change', () => {
                        console.log(`üîç [Data Browser] Filter changed: ${columnName}`);
                    });
                }
            }
        }
    });
    
    console.log(`‚úÖ [Data Browser] Setup complete: ${autocompleteCount} autocomplete, ${dropdownCount} dropdown filters`);
}

// Cascading filters disabled - keeping simple autocomplete/dropdown functionality

// Convert input to dropdown for small datasets
function convertToDropdown(input, values, columnName) {
    // Create select dropdown
    const select = document.createElement('select');
    select.id = input.id;
    select.className = input.className;
    select.style.width = '100%';
    
    // Add empty option
    const emptyOption = document.createElement('option');
    emptyOption.value = '';
    emptyOption.textContent = `All ${columnName}...`;
    select.appendChild(emptyOption);
    
    // Check if we have a mapping for this column (division filter)
    const mappingKey = `${columnName}_mapping`;
    const mapping = window.filterOptions && window.filterOptions[mappingKey] ? window.filterOptions[mappingKey] : null;
    
    // Sort values - all dropdowns in ascending order
    let sortedValues = [...values];
    if (columnName === 'uacs_reg_id') {
        // Sort regions numerically (1, 2, 3, ..., 15)
        sortedValues.sort((a, b) => {
            const numA = parseInt(a);
            const numB = parseInt(b);
            return numA - numB;
        });
    } else {
        // Sort all other dropdowns alphabetically
        sortedValues.sort((a, b) => a.localeCompare(b));
    }
    
    // Add value options
    sortedValues.forEach(value => {
        const option = document.createElement('option');
        // For division filter, use the ID as value but display the description
        if (mapping && mapping[value]) {
            option.value = mapping[value]; // Use ID as value
            option.textContent = value;    // Display description
        } else {
            option.value = value;
            option.textContent = value;
        }
        select.appendChild(option);
    });
    
    // Replace input with select
    input.parentNode.replaceChild(select, input);
}

// Cascading filters disabled - no global storage needed

// Add autocomplete functionality to input
function addAutocompleteToInput(input, options) {
    // Check if autocomplete is already set up for this input
    if (input.parentNode && input.parentNode.classList && input.parentNode.classList.contains('autocomplete-container')) {
        return;
    }
    
    let currentFocus = -1;
    let currentOptions = [...options]; // Store original options
    const columnName = input.id.replace('filter-', '');
    
    // Wrap input in autocomplete container
    const autocompleteContainer = document.createElement('div');
    autocompleteContainer.className = 'autocomplete-container';
    autocompleteContainer.style.position = 'relative';
    autocompleteContainer.style.width = '100%';
    
    // Insert container before input
    input.parentNode.insertBefore(autocompleteContainer, input);
    
    // Move input into container
    autocompleteContainer.appendChild(input);
    
    // Create suggestions list
    const suggestionsList = document.createElement('div');
    suggestionsList.className = 'autocomplete-suggestions';
    suggestionsList.style.display = 'none';
    autocompleteContainer.appendChild(suggestionsList);
    
    // Function to update options based on other filters (DISABLED)
    async function updateOptionsBasedOnFilters() {
        // Cascading filters disabled - always use all options
        currentOptions = [...options];
    }
    
    // Store the update function globally for cascading filters (DISABLED)
    // window.autocompleteUpdateFunctions[columnName] = updateOptionsBasedOnFilters;
    
    // Filter function
    async function filterOptions(value) {
        // Cascading filters disabled - no need to update options
        return currentOptions.filter(option => 
            option.toLowerCase().includes(value.toLowerCase())
        );
    }
    
    // Show suggestions
    async function showSuggestions(value) {
        const filtered = await filterOptions(value);
        suggestionsList.innerHTML = '';
        
        if (filtered.length === 0 || value.length < 3) {
            suggestionsList.style.display = 'none';
            return;
        }
        
        filtered.slice(0, 10).forEach((option, index) => {
            const item = document.createElement('div');
            item.className = 'autocomplete-item';
            item.innerHTML = option.replace(new RegExp(value, 'gi'), `<strong>$&</strong>`);
            item.addEventListener('click', () => {
                // For division filter, we need to handle the mapping
                if (columnName === 'uacs_div_dsc') {
                    const mappingKey = `${columnName}_mapping`;
                    const mapping = window.filterOptions && window.filterOptions[mappingKey] ? window.filterOptions[mappingKey] : null;
                    if (mapping && mapping[option]) {
                        // Store the ID as a data attribute for API calls
                        input.setAttribute('data-selected-id', mapping[option]);
                        input.value = option; // Display the description
                    } else {
                        input.value = option;
                    }
                } else {
                    input.value = option;
                }
                suggestionsList.style.display = 'none';
                currentFocus = -1;
            });
            suggestionsList.appendChild(item);
        });
        
        suggestionsList.style.display = 'block';
        currentFocus = -1;
    }
    
    // Input event listener
    input.addEventListener('input', async (e) => {
        const value = e.target.value;
        // Only show suggestions if user has typed at least 3 characters
        if (value.length >= 3) {
            await showSuggestions(value);
        } else {
            // Hide suggestions if less than 3 characters
            suggestionsList.style.display = 'none';
        }
    });
    
    // Focus event listener removed - don't auto-trigger autocomplete on focus
    
    // Blur event listener (hide suggestions)
    input.addEventListener('blur', () => {
        setTimeout(() => {
            suggestionsList.style.display = 'none';
        }, 200);
    });
    
    // Keyboard navigation
    input.addEventListener('keydown', (e) => {
        const items = suggestionsList.querySelectorAll('.autocomplete-item');
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            currentFocus = Math.min(currentFocus + 1, items.length - 1);
            updateActiveItem(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            currentFocus = Math.max(currentFocus - 1, -1);
            updateActiveItem(items);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (currentFocus >= 0 && items[currentFocus]) {
                input.value = items[currentFocus].textContent;
                suggestionsList.style.display = 'none';
                currentFocus = -1;
            }
        } else if (e.key === 'Escape') {
            suggestionsList.style.display = 'none';
            currentFocus = -1;
        }
    });
    
    function updateActiveItem(items) {
        items.forEach((item, index) => {
            if (index === currentFocus) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });
    }
}

// Clear all filters
function clearAllFilters() {
    const filterInputs = [
        'filter-uacs_dpt_dsc', 'filter-uacs_agy_dsc', 'filter-dsc', 
        'filter-uacs_fundsubcat_dsc', 'filter-uacs_exp_dsc', 'filter-uacs_sobj_dsc',
        'filter-uacs_div_dsc', 'filter-uacs_reg_id',
        'filter-amt-min', 'filter-amt-max'
    ];
    
    filterInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.value = '';
            
            // Remove highlighting
            input.style.borderColor = '';
            input.style.backgroundColor = '';
            
            // Remove warning text
            const filterContainer = input.closest('.filter-group');
            if (filterContainer) {
                const existingWarning = filterContainer.querySelector('.filter-warning');
                if (existingWarning) {
                    existingWarning.remove();
                }
            }
        }
    });
}

// Toggle columns section
function toggleColumnAnalysis() {
    const container = document.getElementById('columns-analysis-content');
    const icon = document.getElementById('columns-toggle-icon');
    
    if (container.style.display === 'none') {
        container.style.display = 'block';
        icon.textContent = '‚ñ≤';
        // Load data when expanded (with small delay to ensure DOM is ready)
        setTimeout(() => {
            loadColumnsData();
            loadColumnMapping();
        }, 100);
    } else {
        container.style.display = 'none';
        icon.textContent = '‚ñº';
    }
}

// Toggle duplicates section
function toggleAnalysisDuplicatesAnalysis() {
    const container = document.getElementById('duplicates-analysis-content');
    const icon = document.getElementById('duplicates-toggle-icon');
    
    if (container.style.display === 'none') {
        container.style.display = 'block';
        icon.textContent = '‚ñ≤';
        // Load first page when expanded
        currentDuplicatesPage = 1;
        loadAnalysisDuplicatesPage(1);
    } else {
        container.style.display = 'none';
        icon.textContent = '‚ñº';
    }
}

// Toggle column duplicates section
function toggleAnalysisColumnDuplicatesAnalysis() {
    const container = document.getElementById('column-duplicates-analysis-content');
    const icon = document.getElementById('column-duplicates-toggle-icon');

    if (container.style.display === 'none') {
        container.style.display = 'block';
        icon.textContent = '‚ñ≤';
        // Load column duplicates data when expanded
        currentColumnDuplicatesPage = 1;
        loadAnalysisColumnDuplicatesData(1);
    } else {
        container.style.display = 'none';
        icon.textContent = '‚ñº';
    }
}

// Load column duplicates data with pagination
async function loadAnalysisColumnDuplicatesData(page = 1) {
    try {
        const resultsContainer = document.getElementById('column-duplicates-results');
        if (resultsContainer) {
            resultsContainer.innerHTML = '<div class="loading-message">Loading column duplicates analysis...</div>';
        }

        // Disable pagination buttons during loading
        const columnDuplicatesPrevBtn = document.getElementById('column-duplicates-prev-page-btn');
        const columnDuplicatesNextBtn = document.getElementById('column-duplicates-next-page-btn');
        if (columnDuplicatesPrevBtn) columnDuplicatesPrevBtn.disabled = true;
        if (columnDuplicatesNextBtn) columnDuplicatesNextBtn.disabled = true;

        const selectedYear = getApiYear();
        const response = await fetch(`${getApiBaseUrl()}/api/budget/columns/issues?year=${selectedYear}&page=${page}&limit=${currentColumnDuplicatesRowsPerPage}`);
        const data = await response.json();
        
        if (data.success && data.issues && data.issues.length > 0) {
            displayColumnDuplicatesResults(data.issues);

            // Update pagination if available
            if (data.pagination) {
                updateColumnDuplicatesPagination(data.pagination);
                currentColumnDuplicatesPage = page;
            }
        } else {
            resultsContainer.innerHTML = '<div class="no-results">No column duplicates found (all descriptions have unique IDs)</div>';
        }

        // Re-enable pagination buttons after loading
        if (columnDuplicatesPrevBtn) columnDuplicatesPrevBtn.disabled = false;
        if (columnDuplicatesNextBtn) columnDuplicatesNextBtn.disabled = false;
        
    } catch (error) {
        const resultsContainer = document.getElementById('column-duplicates-results');
        if (resultsContainer) {
            resultsContainer.innerHTML = `<div class="error-message">‚ùå Error loading column duplicates: ${error.message}</div>`;
        }

        // Re-enable pagination buttons even on error
        const columnDuplicatesPrevBtn = document.getElementById('column-duplicates-prev-page-btn');
        const columnDuplicatesNextBtn = document.getElementById('column-duplicates-next-page-btn');
        if (columnDuplicatesPrevBtn) columnDuplicatesPrevBtn.disabled = false;
        if (columnDuplicatesNextBtn) columnDuplicatesNextBtn.disabled = false;
    }
}

// Display column duplicates results
function displayColumnDuplicatesResults(issues) {
    const resultsContainer = document.getElementById('column-duplicates-results');
    if (!resultsContainer) return;

    let html = '<div class="column-issues-list">';
    issues.forEach((issue, index) => {
        const severityColor = issue.severity === 'High' ? '#dc3545' : '#ffc107';
        const severityIcon = issue.severity === 'High' ? 'üî¥' : 'üü°';

        html += `
            <div class="column-issue-item" style="border: 1px solid #dee2e6; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: white;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <h5 style="margin: 0; color: #0038A8;">
                        ${severityIcon} ${issue.column_name || 'Unknown Column'}
                    </h5>
                    <span style="background: ${severityColor}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem;">
                        ${issue.severity || 'Medium'}
                    </span>
                </div>
                <p style="margin: 0.5rem 0; color: #333; font-weight: 500;">
                    <strong>Description:</strong> ${escapeHtml(issue.description || 'N/A')}
                </p>
                <p style="margin: 0.5rem 0; color: #666;">
                    <strong>Issue:</strong> ${issue.issue_type || 'Data inconsistency'}
                </p>
                <p style="margin: 0.5rem 0; color: #666;">
                    <strong>Different IDs:</strong> <code style="background: #f8f9fa; padding: 0.25rem 0.5rem; border-radius: 4px;">${escapeHtml(issue.different_ids || 'N/A')}</code>
                </p>
                <p style="margin: 0.5rem 0 0 0; color: #999; font-size: 0.875rem;">
                    <em>Found ${issue.id_count || 0} different IDs for the same description</em>
                </p>
            </div>
        `;
    });
    html += '</div>';
    resultsContainer.innerHTML = html;
}

// Update column duplicates pagination controls
function updateColumnDuplicatesPagination(pagination) {
    const paginationDiv = document.getElementById('column-duplicates-pagination');
    const pageInfo = document.getElementById('column-duplicates-page-info');
    const prevBtn = document.getElementById('column-duplicates-prev-page-btn');
    const nextBtn = document.getElementById('column-duplicates-next-page-btn');

    if (paginationDiv) {
        paginationDiv.style.display = pagination.total_pages > 1 ? 'flex' : 'none';
    }

    if (pageInfo) {
        pageInfo.textContent = `Page ${pagination.current_page} of ${pagination.total_pages}`;
    }

    if (prevBtn) {
        prevBtn.disabled = pagination.current_page <= 1;
    }

    if (nextBtn) {
        nextBtn.disabled = pagination.current_page >= pagination.total_pages;
    }
}

// Load columns data with differences highlighting
async function loadColumnsData() {
    
    const years = [2020, 2021, 2022, 2023, 2024, 2025];
    const containers = {};
    const counts = {};
    
    // Get all container and count elements
    for (const year of years) {
        containers[year] = document.getElementById(`${year}-columns-list`);
        counts[year] = document.getElementById(`${year}-row-count`);
        
        if (!containers[year] || !counts[year]) {
            console.warn(`Missing container or count element for year ${year}`);
            continue;
        }
        
        // Show loading state
        containers[year].innerHTML = `<div class="loading-spinner">üìä Loading ${year} columns...</div>`;
        counts[year].textContent = 'Loading...';
    }
    
    try {
        // Load column differences first
        const differencesResponse = await fetch(`${getApiBaseUrl()}/api/budget/columns/differences`);
        const differencesResult = await differencesResponse.json();
        
        let differences = {};
        if (differencesResult.success && differencesResult.differences) {
            differencesResult.differences.forEach(diff => {
                differences[diff.column_name] = diff;
            });
        }
        
        // Load columns for each year
        for (const year of years) {
            if (!containers[year] || !counts[year]) continue;
            
            try {
                const response = await fetch(`${getApiBaseUrl()}/api/budget/columns?year=${year}`);
                const result = await response.json();
                
                if (result.success && result.columns) {
                    counts[year].textContent = result.count || result.row_count || 'Unknown';
                    containers[year].innerHTML = result.columns.map(col => {
                        const colName = typeof col === 'string' ? col : col.name || col.column_name;
                        const colDesc = typeof col === 'object' ? (col.description || col.data_type || '') : '';
                        const diff = differences[colName];
                        const highlightClass = diff ? 'column-different' : 'column-normal';
                        const diffIndicator = diff ? ` <span class="diff-indicator">‚ö†Ô∏è ${diff.status_description}</span>` : '';
                        return `<div class="column-item ${highlightClass}" style="padding: 0.2rem 0; border-bottom: 1px solid #eee;">
                            <strong>${colName}</strong>${colDesc ? ` - ${colDesc}` : ''}${diffIndicator}
                        </div>`;
                    }).join('');
                } else {
                    containers[year].innerHTML = `<div style="color: #dc3545;">‚ùå Error loading ${year} columns</div>`;
                }
            } catch (error) {
                console.error(`Error loading ${year} columns:`, error);
                containers[year].innerHTML = `<div style="color: #dc3545;">‚ùå Error loading ${year} columns</div>`;
            }
        }
        
    } catch (error) {
        console.error('Error in loadColumnsData:', error);
        for (const year of years) {
            if (containers[year]) {
                containers[year].innerHTML = '<div style="color: #dc3545;">‚ùå Error loading columns data</div>';
            }
        }
    }
}


// Load 2020-2021 column mapping
async function loadColumnMapping() {
    try {
        const summaryCard = document.getElementById('mapping-summary-card');
        const tableBody = document.getElementById('mapping-table-body');
        
        if (!summaryCard || !tableBody) {
            console.warn('Column mapping elements not found');
            return;
        }
        
        // Show loading state
        summaryCard.innerHTML = '<div class="loading-message">Loading mapping summary...</div>';
        tableBody.innerHTML = '<tr><td colspan="7" style="padding: 2rem; text-align: center;"><div class="loading-message">Loading mapping data...</div></td></tr>';
        
        const response = await fetch(`${getApiBaseUrl()}/api/budget/column-mapping`);
        const data = await response.json();
        
        if (data.success && data.mappings && data.summary) {
            // Display summary
            const summary = data.summary;
            summaryCard.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #0038A8;">${summary.total_columns}</div>
                        <div style="color: #666; font-size: 0.875rem;">Total Columns</div>
                    </div>
                    <div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #28a745;">${summary.converted_columns}</div>
                        <div style="color: #666; font-size: 0.875rem;">Converted to Numeric</div>
                    </div>
                    <div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #CE1126;">${summary.avg_certainty_score}%</div>
                        <div style="color: #666; font-size: 0.875rem;">Avg Certainty Score</div>
                    </div>
                    <div>
                        <div style="font-size: 0.9rem; font-weight: bold; color: #0038A8;">${summary.data_stats}</div>
                        <div style="color: #666; font-size: 0.875rem;">Data Statistics</div>
                    </div>
                </div>
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                    <p style="margin: 0.5rem 0; color: #333; font-size: 0.875rem;">
                        <strong>Discovery Method:</strong> ${summary.discovery_method}
                    </p>
                    <p style="margin: 0.5rem 0; color: #28a745; font-size: 0.875rem;">
                        <strong>‚úÖ ${summary.validation_status}</strong>
                    </p>
                </div>
            `;
            
            // Display mapping table
            let tableHtml = '';
            data.mappings.forEach((mapping, index) => {
                const statusColor = mapping.status.includes('Converted') ? '#28a745' : 
                                  mapping.status.includes('Kept') ? '#ffc107' : '#17a2b8';
                const statusIcon = mapping.status.includes('Converted') ? '‚úÖ' : 
                                 mapping.status.includes('Kept') ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
                
                tableHtml += `
                    <tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
                        <td style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: center;">${mapping.mapping_id}</td>
                        <td style="padding: 0.75rem; border: 1px solid #dee2e6;">
                            <code style="background: #f8f9fa; padding: 0.25rem 0.5rem; border-radius: 4px; color: #dc3545;">
                                ${mapping.original_column}
                            </code>
                        </td>
                        <td style="padding: 0.75rem; border: 1px solid #dee2e6;">
                            <code style="background: #e3f2fd; padding: 0.25rem 0.5rem; border-radius: 4px; color: #0038A8; font-weight: bold;">
                                ${mapping.mapped_column}
                            </code>
                        </td>
                        <td style="padding: 0.75rem; border: 1px solid #dee2e6;">
                            <span style="background: #f0f0f0; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">
                                ${mapping.data_type}
                            </span>
                        </td>
                        <td style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: center;">
                            <span style="background: #28a745; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-weight: bold;">
                                ${mapping.certainty_score}%
                            </span>
                        </td>
                        <td style="padding: 0.75rem; border: 1px solid #dee2e6;">
                            <span style="color: ${statusColor};">${statusIcon} ${mapping.status}</span>
                        </td>
                        <td style="padding: 0.75rem; border: 1px solid #dee2e6; font-size: 0.875rem; color: #666;">
                            ${mapping.evidence}
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHtml;
            
            console.log(`‚úÖ Loaded ${data.mappings.length} column mappings`);
        } else {
            summaryCard.innerHTML = '<div style="color: #dc3545;">‚ùå Error loading mapping summary</div>';
            tableBody.innerHTML = '<tr><td colspan="7" style="padding: 2rem; text-align: center; color: #dc3545;">‚ùå Error loading mapping data</td></tr>';
        }
        
    } catch (error) {
        console.error('Error loading column mapping:', error);
        const summaryCard = document.getElementById('mapping-summary-card');
        const tableBody = document.getElementById('mapping-table-body');
        if (summaryCard) {
            summaryCard.innerHTML = '<div style="color: #dc3545;">‚ùå Error loading mapping summary</div>';
        }
        if (tableBody) {
            tableBody.innerHTML = '<tr><td colspan="7" style="padding: 2rem; text-align: center; color: #dc3545;">‚ùå Error loading mapping data</td></tr>';
        }
    }
}

// Load column-level duplicates analysis

// Load column-level duplicates analysis with focus on specific values
async function loadColumnDuplicatesWithFocus(focusValues) {
    
    const resultsContainer = document.getElementById('column-duplicates-results');
    
    try {
        // Get selected year from filter
        const apiYear = getApiYear();
        
        const focusValuesJson = encodeURIComponent(JSON.stringify(focusValues));
        const response = await fetch(`/api/budget/column-duplicates?year=${apiYear}&limit=20&focus_values=${focusValuesJson}`);
        const result = await response.json();
        
        if (result.success) {
            // Add a header to show this is focused results
            const header = document.createElement('div');
            header.className = 'focus-header';
            header.style.cssText = 'background: #fff3cd; color: #856404; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; font-size: 0.8rem; border: 1px solid #ffeaa7;';
            header.innerHTML = `üéØ <strong>Focused Analysis:</strong> Showing mapping inconsistencies for the highlighted filters`;
            
            resultsContainer.innerHTML = '';
            resultsContainer.appendChild(header);
            
            displayColumnDuplicates(result.column_duplicates);
        } else {
            resultsContainer.innerHTML = `<div class="error-message">‚ùå Error: ${result.error}</div>`;
        }
    } catch (error) {
        resultsContainer.innerHTML = `<div class="error-message">‚ùå Error loading focused column duplicates: ${error.message}</div>`;
    }
}

// Display column-level duplicates results
function displayColumnDuplicates(columnDuplicates) {
    const container = document.getElementById('column-duplicates-results');
    
    if (!columnDuplicates || columnDuplicates.length === 0) {
        container.innerHTML = '<div class="no-results">‚úÖ No mapping inconsistencies found! Your data looks clean.</div>';
        return;
    }
    
    let html = '';
    
    columnDuplicates.forEach(duplicate => {
        if (duplicate.type === 'mapping_inconsistency') {
            html += `
                <div class="column-duplicate-item">
                    <div class="column-duplicate-header">
                        <div class="column-duplicate-title">‚ö†Ô∏è ${duplicate.column_name}</div>
                        <div class="column-duplicate-count">${duplicate.duplicate_count} different IDs</div>
                    </div>
                    <div class="column-duplicate-details">
                        <strong>"${duplicate.value}"</strong> has ${duplicate.duplicate_count} different IDs
                    </div>
                    <div class="duplicate-values">
                        <strong>Details:</strong> ${duplicate.details}
                    </div>
                </div>
            `;
        } else {
            // Fallback for other types of duplicates
            html += `
                <div class="column-duplicate-item">
                    <div class="column-duplicate-header">
                        <div class="column-duplicate-title">${duplicate.column_name}</div>
                        <div class="column-duplicate-count">${duplicate.duplicate_count} duplicates</div>
                    </div>
                    <div class="column-duplicate-details">
                        Found ${duplicate.duplicate_count} entries with the same value: <strong>"${duplicate.value}"</strong>
                    </div>
                    <div class="duplicate-values">
                        <strong>Duplicate Value:</strong> 
                        <span class="duplicate-value">${duplicate.value}</span>
                    </div>
                </div>
            `;
        }
    });
    
    container.innerHTML = html;
}

// Update column duplicates pagination controls
function updateColumnDuplicatesPagination() {
    const totalPages = Math.ceil(totalColumnDuplicates / currentColumnDuplicatesRowsPerPage);
    const prevBtn = document.getElementById('column-duplicates-prev-page-btn');
    const nextBtn = document.getElementById('column-duplicates-next-page-btn');
    const pageInfo = document.getElementById('column-duplicates-page-info');
    
    if (prevBtn) {
        prevBtn.disabled = currentColumnDuplicatesPage <= 1;
    }
    
    if (nextBtn) {
        nextBtn.disabled = currentColumnDuplicatesPage >= totalPages;
    }
    
    if (pageInfo) {
        if (totalPages === 0) {
            pageInfo.textContent = 'No results';
        } else {
            pageInfo.textContent = `Page ${currentColumnDuplicatesPage} of ${totalPages}`;
        }
    }
}

// Filter data browser by duplicate group values
function filterByDuplicateGroup(duplicateIndex) {
    
    // Check if we have the duplicates data
    if (!currentDuplicates || !currentDuplicates[duplicateIndex]) {
        return;
    }
    
    const duplicate = currentDuplicates[duplicateIndex];
    
    // Clear existing filters first
    clearAllFilters();
    
    // Map duplicate data fields to filter names
    const filterMappings = [
        { field: 'dept_desc1', filter: 'uacs_dpt_dsc' },      // Department
        { field: 'agy_desc1', filter: 'uacs_agy_dsc' },       // Agency  
        { field: 'description', filter: 'dsc' },               // Description
        { field: 'fund_desc1', filter: 'uacs_fundsubcat_dsc' }, // Fund Category
        { field: 'exp_desc1', filter: 'uacs_exp_dsc' },       // Expense
        { field: 'obj_desc1', filter: 'uacs_sobj_dsc' },      // Object
        { field: 'oper_desc1', filter: 'uacs_oper_dsc' },     // Operation Unit
        { field: 'div_desc1', filter: 'uacs_div_dsc' },       // Division (Description to autocomplete)
        { field: 'uacs_reg_id', filter: 'uacs_reg_id' }       // Region (ID to ID)
    ];
    
    
    // Use strict filtering with ALL available columns to get exact duplicate group
    // This ensures we only get the exact duplicate rows, not similar ones
    
    // Apply filters for ALL available columns to ensure exact match
    const strictFilters = [
        { field: 'description', filter: 'dsc' },
        { field: 'agy_desc1', filter: 'uacs_agy_dsc' },
        { field: 'dept_desc1', filter: 'uacs_dpt_dsc' },
        { field: 'fund_desc1', filter: 'uacs_fundsubcat_dsc' },
        { field: 'exp_desc1', filter: 'uacs_exp_dsc' },
        { field: 'obj_desc1', filter: 'uacs_sobj_dsc' },
        { field: 'oper_desc1', filter: 'uacs_oper_dsc' },
        { field: 'div_desc1', filter: 'uacs_div_dsc' }
    ];
    
    let appliedFilters = 0;
    
    strictFilters.forEach(({ field, filter }) => {
        const value = duplicate[field];
        if (value && value !== 'N/A' && value !== '') {
            const input = document.getElementById(`filter-${filter}`);
            if (input) {
                input.value = value;
                appliedFilters++;
            } else {
            }
        } else {
        }
    });
    
    // Add region filter if available (most important for potential duplicates)
    if (duplicate.uacs_reg_id) {
        const regionInput = document.getElementById('filter-uacs_reg_id');
        if (regionInput) {
            regionInput.value = duplicate.uacs_reg_id;
            appliedFilters++;
        }
    }
    
    // Skip amount filtering to avoid x1000/1000 conversion confusion
    
    
    // Switch to Data Browser tab first
    switchToTab('browser');
    
    // Apply the filters and reload data browser first
    currentPage = 1;
    // Longer delay to ensure tab switch is complete and DOM is updated
    setTimeout(() => {
        currentFilters = getCurrentFilters();
        loadDataBrowser();
        
        // Also reload column duplicates with focus on the highlighted filters
        const focusValues = {};
        filterMappings.forEach(({ field, filter }) => {
            const value = duplicate[field];
            if (value && value !== 'N/A') {
                focusValues[filter] = value;
            }
        });
        
        if (Object.keys(focusValues).length > 0) {
            loadColumnDuplicatesWithFocus(focusValues);
        }
    }, 100);
    
    // Scroll to the data browser table (not the card header)
    const dataBrowserTable = document.querySelector('.data-browser-table');
    if (dataBrowserTable) {
        dataBrowserTable.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
        // Fallback to data browser container if table not found
        const dataBrowserContainer = document.getElementById('data-browser-container');
        if (dataBrowserContainer) {
            dataBrowserContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }
    
    // Show success message
    const resultsContainer = document.getElementById('duplicates-results');
    const successMessage = document.createElement('div');
    successMessage.className = 'success-message';
    successMessage.style.cssText = 'background: #d4edda; color: #155724; padding: 0.75rem; border-radius: 0.375rem; margin: 0.5rem 0; border: 1px solid #c3e6cb;';
    successMessage.innerHTML = `‚úÖ Applied filters from duplicate row. Scrolled to data browser.`;
    
    // Insert success message at the top of duplicates results
    resultsContainer.insertBefore(successMessage, resultsContainer.firstChild);
    
    // Remove success message after 3 seconds
    setTimeout(() => {
        if (successMessage.parentNode) {
            successMessage.parentNode.removeChild(successMessage);
        }
    }, 3000);
}

// Display duplicates results


// Load anomalies data
async function loadAnomalies() {
    
    const resultsContainer = document.getElementById('anomalies-results');
    const loadBtn = document.getElementById('load-anomalies-btn');
    const statsContainer = document.getElementById('anomalies-stats');
    const typeSelect = document.getElementById('anomaly-type-select');
    
    // Show loading state
    loadBtn.querySelector('.btn-text').style.display = 'none';
    loadBtn.querySelector('.btn-loading').style.display = 'inline';
    loadBtn.disabled = true;
    
    resultsContainer.innerHTML = '<div class="loading-spinner">üîç Analyzing data for anomalies...</div>';
    
    try {
        const anomalyType = typeSelect.value;
        const response = await fetch(`/api/budget/anomalies?anomaly_type=${anomalyType}`);
        const result = await response.json();
        
        if (result.success) {
            displayAnomalies(result.anomalies, result.summary);
            updateAnomaliesStats(result.summary);
            statsContainer.style.display = 'flex';
        } else {
            resultsContainer.innerHTML = `<div class="error-message">‚ùå Error: ${result.error}</div>`;
        }
    } catch (error) {
        resultsContainer.innerHTML = `<div class="error-message">‚ùå Error loading anomalies: ${error.message}</div>`;
    } finally {
        loadBtn.querySelector('.btn-text').style.display = 'inline';
        loadBtn.querySelector('.btn-loading').style.display = 'none';
        loadBtn.disabled = false;
    }
}

// Display anomalies results
function displayAnomalies(anomalies, summary) {
    const container = document.getElementById('anomalies-results');
    
    if (summary.total_anomalies === 0) {
        container.innerHTML = '<div class="no-results">‚úÖ No anomalies found! Your data looks clean.</div>';
        return;
    }
    
    let html = '';
    
    // Display each anomaly type
    Object.entries(anomalies).forEach(([type, anomalyList]) => {
        if (anomalyList.length > 0) {
            html += `<h4 style="color: #333; margin: 1rem 0 0.5rem 0; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">${getAnomalyTypeTitle(type)} (${anomalyList.length})</h4>`;
            
            anomalyList.forEach(anomaly => {
                html += `
                    <div class="anomaly-item">
                        <div class="anomaly-header">
                            <div class="anomaly-title">${anomaly.description || anomaly.type}</div>
                            <span class="severity-badge severity-${anomaly.severity}">${anomaly.severity}</span>
                        </div>
                        <div class="anomaly-details">
                            <div><strong>Type:</strong> ${getAnomalyTypeTitle(anomaly.type)}</div>
                            ${anomaly.department ? `<div><strong>Department:</strong> ${anomaly.department}</div>` : ''}
                            ${anomaly.amount ? `<div><strong>Amount:</strong> <span class="anomaly-amount">‚Ç±${anomaly.amount}</span></div>` : ''}
                            ${anomaly.count ? `<div><strong>Count:</strong> ${anomaly.count}</div>` : ''}
                            <div><strong>Reason:</strong> ${anomaly.reason}</div>
                        </div>
                    </div>
                `;
            });
        }
    });
    
    container.innerHTML = html;
}

// Get human-readable anomaly type title
function getAnomalyTypeTitle(type) {
    const titles = {
        'department_mismatches': 'Department Mismatches',
        'cross_domain_anomalies': 'Cross-Domain Issues',
        'amount_anomalies': 'Amount Anomalies',
        'duplicate_anomalies': 'Duplicate Anomalies'
    };
    return titles[type] || type;
}

// Update anomalies statistics
function updateAnomaliesStats(summary) {
    document.getElementById('total-anomalies').textContent = summary.total_anomalies;
    document.getElementById('high-severity-anomalies').textContent = summary.high_severity;
}

// Global year variable
let currentYear = '2025';

// Get current year from selector
function getCurrentYear() {
    const yearSelect = document.getElementById('year-select');
    return yearSelect ? yearSelect.value : '2025';
}

// Update year and reload data
function updateYear(newYear) {
    currentYear = newYear;
    
    // Reload all data with new year
    loadBudgetColumns()
        .then(() => loadFloodControlAmount())
        .then(() => loadDataBrowser())
        .then(() => loadAnalysisDuplicatesPage(1))
}

// Load department spending trends
async function loadDepartmentTrends() {
    console.log('üîç [Trends] Loading department trends...');
    
    try {
        const container = document.getElementById('department-trends-container');
        
        if (!container) {
            console.error('‚ùå [Trends] Container not found!');
            return;
        }
        
        console.log('‚úÖ [Trends] Container found:', container);
        container.innerHTML = '<div class="loading-message">‚è≥ Loading department trends...</div>';
        
        const apiUrl = `${getApiBaseUrl()}/api/budget/department-trends`;
        console.log('üîç [Trends] Fetching from:', apiUrl);
        
        const response = await fetch(apiUrl);
        console.log('üîç [Trends] Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('üîç [Trends] Data received:', data);
        
        if (data.success && data.departments && data.departments.length > 0) {
            console.log('‚úÖ [Trends] Displaying', data.departments.length, 'departments');
            displayDepartmentTrends(data.departments);
        } else {
            console.warn('‚ö†Ô∏è [Trends] No department data available');
            container.innerHTML = '<div class="no-results">No department trends data available</div>';
        }
        
    } catch (error) {
        console.error('‚ùå [Trends] Error:', error);
        const container = document.getElementById('department-trends-container');
        if (container) {
            container.innerHTML = `<div class="error-message">‚ùå Error: ${error.message}</div>`;
        }
    }
}

// Display department trends data as horizontal bar chart
let departmentTrendsChart = null;

function displayDepartmentTrends(departments) {
    console.log('üîç [Chart] displayDepartmentTrends called with', departments.length, 'departments');
    
    const container = document.getElementById('department-trends-container');
    if (!container) {
        console.error('‚ùå [Chart] Container not found in displayDepartmentTrends!');
        return;
    }
    
    console.log('‚úÖ [Chart] Container found:', container);
    
    // Sort departments by 2025 amount (descending) to show top spenders first
    const sortedDepartments = departments.sort((a, b) => (b.amount_2025 || 0) - (a.amount_2025 || 0));
    
    // Take top 15 departments for better readability
    const topDepartments = sortedDepartments.slice(0, 15);
    console.log('üìä [Chart] Top 15 departments:', topDepartments.map(d => d.department_name));
    
    // Prepare data for chart
    const labels = topDepartments.map(dept => dept.department_name);
    const data2020 = topDepartments.map(dept => (dept.amount_2020 || 0) / 1000000000); // Convert to billions
    const data2021 = topDepartments.map(dept => (dept.amount_2021 || 0) / 1000000000);
    const data2022 = topDepartments.map(dept => (dept.amount_2022 || 0) / 1000000000);
    const data2023 = topDepartments.map(dept => (dept.amount_2023 || 0) / 1000000000);
    const data2024 = topDepartments.map(dept => (dept.amount_2024 || 0) / 1000000000);
    const data2025 = topDepartments.map(dept => (dept.amount_2025 || 0) / 1000000000);
    
    // Create canvas element with proper height
    container.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 8px; min-height: 600px;">
            <canvas id="departmentTrendsChart" height="600"></canvas>
        </div>
    `;
    
    // Destroy existing chart if it exists
    if (departmentTrendsChart) {
        departmentTrendsChart.destroy();
    }
    
    // Create horizontal bar chart
    const ctx = document.getElementById('departmentTrendsChart');
    if (!ctx) {
        console.error('‚ùå [Chart] Canvas element not found!');
        return;
    }
    
    console.log('‚úÖ [Chart] Canvas found, creating chart...');
    
    departmentTrendsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: '2020',
                    data: data2020,
                    backgroundColor: 'rgba(153, 102, 255, 0.7)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1
                },
                {
                    label: '2021',
                    data: data2021,
                    backgroundColor: 'rgba(255, 99, 132, 0.7)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                },
                {
                    label: '2022',
                    data: data2022,
                    backgroundColor: 'rgba(255, 206, 86, 0.7)',
                    borderColor: 'rgba(255, 206, 86, 1)',
                    borderWidth: 1
                },
                {
                    label: '2023',
                    data: data2023,
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                },
                {
                    label: '2024',
                    data: data2024,
                    backgroundColor: 'rgba(255, 159, 64, 0.7)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 1
                },
                {
                    label: '2025',
                    data: data2025,
                    backgroundColor: 'rgba(75, 192, 192, 0.7)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        color: '#333',
                        font: { size: 12, weight: 'bold' },
                        padding: 15
                    }
                },
                title: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label || '';
                            const value = context.parsed.y || 0;
                            return `${label}: ‚Ç±${value.toFixed(2)}B`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: '#333',
                        font: { size: 9 },
                        maxRotation: 45,
                        minRotation: 45
                    },
                    title: {
                        display: true,
                        text: 'Department / Agency',
                        color: '#333',
                        font: { size: 13, weight: 'bold' }
                    },
                    grid: {
                        display: false
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#666',
                        font: { size: 11 },
                        callback: function(value) {
                            return '‚Ç±' + value.toFixed(0) + 'B';
                        }
                    },
                    title: {
                        display: true,
                        text: 'Amount (Billions PHP)',
                        color: '#333',
                        font: { size: 13, weight: 'bold' }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    });
    
    console.log('‚úÖ [Chart] Chart created successfully!');
}

// Load all data when page loads, but wait for documents to finish loading
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ [BUDGET] DOMContentLoaded fired!');
    
    // Check for hash in URL and switch to that tab
    const hash = window.location.hash.substring(1); // Remove the # character
    if (hash && ['visual', 'browser', 'analysis', 'trends'].includes(hash)) {
        switchToTab(hash, false); // Don't update hash since we're reading from it
    }
    
    // Listen for hash changes
    window.addEventListener('hashchange', function() {
        const newHash = window.location.hash.substring(1);
        if (newHash && ['visual', 'browser', 'analysis', 'trends'].includes(newHash)) {
            switchToTab(newHash, false);
        }
    });
    
    // Initialize data browser
    initializeDataBrowser();
    
    // Add year filter event listeners
    const yearFilter = document.getElementById('year-filter');
    if (yearFilter) {
        yearFilter.addEventListener('change', function() {
            currentPage = 1; // Reset to first page when year changes

            // Sync the analysis year filter to match the main year filter
            const analysisYearFilter = document.getElementById('analysis-year-filter');
            if (analysisYearFilter) {
                analysisYearFilter.value = this.value;
                // Reload analysis overview when year changes
                loadAnalysisOverview();
            }

            // Reload data browser
            loadDataBrowser();

            // Reload visual charts if we're on the visual tab
            const visualTab = document.getElementById('tab-visual');
            if (visualTab && visualTab.classList.contains('active')) {
                loadVisualCharts();
            }
        });
    }
    
    // Add event listener for Data Browser year filter
    const browserYearFilter = document.getElementById('browser-year-filter');
    if (browserYearFilter) {
        browserYearFilter.addEventListener('change', function() {
            currentPage = 1; // Reset to first page when year changes

            // Sync the main year filter to match the browser year filter
            const mainYearFilter = document.getElementById('year-filter');
            if (mainYearFilter) {
                mainYearFilter.value = this.value;
            }

            // Sync the analysis year filter to match the browser year filter
            const analysisYearFilter = document.getElementById('analysis-year-filter');
            if (analysisYearFilter) {
                analysisYearFilter.value = this.value;
                // Reload analysis overview when year changes
                loadAnalysisOverview();
            }

            // Reload dashboard statistics when year changes
            loadVisualStatistics(this.value);

            // Reload data browser
            loadDataBrowser();
        });
    }
    
    // Add event listener for main year filter
    const mainYearFilter = document.getElementById('year-filter');
    if (mainYearFilter) {
        mainYearFilter.addEventListener('change', function() {
            console.log(`üìÖ [BUDGET] Main year filter changed to: ${this.value}`);

            // Reload dashboard statistics when year changes
            loadVisualStatistics(this.value);
        });
    }

    // Add year selector event listener
    const yearSelect = document.getElementById('year-select');
    if (yearSelect) {
        yearSelect.addEventListener('change', function() {
            updateYear(this.value);
        });
    }
    
    // Load all data sequentially
    loadBudgetColumns()
        .then(() => {
            return loadFloodControlAmount();
        })
        .then(() => {
            return loadDataBrowser();
        })
        .then(() => {
            return loadAnalysisDuplicatesPage(1);
        })
        .then(() => {
            // Load visual charts after all other data is loaded
            loadVisualCharts();
        })
        .catch((duplicatesError) => {
        })
        .catch((error) => {
            
            // Fallback: Load cards anyway even if documents fail, but still sequentially
            return loadBudgetColumns()
                .then(() => {
                    return loadFloodControlAmount();
                })
                .then(() => {
                    return loadDataBrowser();
                })
                .then(() => {
                    return loadAnalysisDuplicatesPage(1);
                })
                .then(() => {
                    // Load visual charts after fallback loading
                    loadVisualCharts();
                })
                .catch((cardError) => {
                });
        });
    
    console.log('üöÄ [BUDGET] About to initialize tabs...');
    initializeTabs();
    
    // Load visual charts immediately since visual tab is active by default
    setTimeout(() => {
        console.log('üöÄ [BUDGET] Loading visual charts...');
        loadVisualCharts();
    }, 500);
    
    // Load analysis overview data
    loadAnalysisOverview();
    
    // Load total budget items count
    loadTotalBudgetItemsCount();
    
    // Add event listener for analysis year filter
    const analysisYearFilter = document.getElementById('analysis-year-filter');
    if (analysisYearFilter) {
        analysisYearFilter.addEventListener('change', async function() {
            // Sync the main year filter to match the analysis year filter
            const mainYearFilter = document.getElementById('year-filter');
            if (mainYearFilter) {
                mainYearFilter.value = this.value;
            }

            // Reload dashboard statistics when year changes
            loadVisualStatistics(this.value);

            // Load analysis overview data (counts)
            await loadAnalysisOverview();

            // Also refresh the duplicate detection results table
            await loadAnalysisDuplicatesPage(1);

            // Refresh column duplicates data when year changes
            // Reset pagination and prepare for loading when expanded
            currentColumnDuplicatesPage = 1;

            // If the section is currently expanded, refresh the data immediately
            const columnDuplicatesContent = document.getElementById('column-duplicates-analysis-content');
            if (columnDuplicatesContent && columnDuplicatesContent.style.display !== 'none') {
                await loadAnalysisColumnDuplicatesData(1);
            }
        });
    }
    
    // Add event listeners for duplicates pagination
    const duplicatesPrevBtn = document.getElementById('duplicates-prev-page-btn');
    const duplicatesNextBtn = document.getElementById('duplicates-next-page-btn');
    
    if (duplicatesPrevBtn) {
        duplicatesPrevBtn.addEventListener('click', function() {
            loadAnalysisDuplicatesPage(currentDuplicatesPage - 1);
        });
    }
    
    if (duplicatesNextBtn) {
        duplicatesNextBtn.addEventListener('click', function() {
            loadAnalysisDuplicatesPage(currentDuplicatesPage + 1);
        });
    }
    
    // Add event listeners for sort controls
    const duplicatesSortBy = document.getElementById('duplicates-sort-by');
    const duplicatesSortOrder = document.getElementById('duplicates-sort-order');
    
    if (duplicatesSortBy) {
        duplicatesSortBy.addEventListener('change', function() {
            currentDuplicatesPage = 1;
            loadAnalysisDuplicatesPage(1);
        });
    }
    
    if (duplicatesSortOrder) {
        duplicatesSortOrder.addEventListener('change', function() {
            currentDuplicatesPage = 1;
            loadAnalysisDuplicatesPage(1);
        });
    }
    
    
    // Add Trends tab event listeners
    const trendsYearFilter = document.getElementById('trends-year-filter');
    const refreshTrendsBtn = document.getElementById('refresh-trends-btn');
    
    if (trendsYearFilter) {
        trendsYearFilter.addEventListener('change', function() {
            loadTrendsOverview();
        });
    }
    
    if (refreshTrendsBtn) {
        refreshTrendsBtn.addEventListener('click', function() {
            loadTrendsOverview();
        });
    }
    
});

// Pagination variables (using existing currentDuplicatesPage from line 3552)
let totalDuplicatesPages = 1;
const duplicatesPerPage = 10;

// Analysis Overview Functions
async function loadAnalysisOverview() {
    
    try {
        // Get selected year from filter
        const selectedYear = getApiYear();
        
        // Load available metrics
        await Promise.all([
            loadDuplicatesCount(selectedYear),
            loadExactAmountCount(selectedYear)
        ]);
        
    } catch (error) {
    }
}



// Load exact amount count for overview (using existing anomalies endpoint as placeholder)
async function loadExactAmountCount(year) {
    try {
        const response = await fetch(`/api/budget/anomalies/count?year=${year}`);
        const data = await response.json();
        
        const countElement = document.getElementById('exact-amount-count');
        if (countElement) {
            countElement.innerHTML = data.count || 0;
        }
    } catch (error) {
        const countElement = document.getElementById('exact-amount-count');
        if (countElement) {
            countElement.innerHTML = 'Error';
        }
    }
}

// Load duplicates with pagination
async function loadAnalysisDuplicatesPage(page = 1) {
    try {
        const selectedYear = getApiYear();
        const sortBy = document.getElementById('duplicates-sort-by')?.value || 'calculated_score';
        const sortOrder = document.getElementById('duplicates-sort-order')?.value || 'DESC';
        
        
        // Show loading spinner
        const resultsContainer = document.getElementById('duplicates-results');
        if (resultsContainer) {
            resultsContainer.innerHTML = '<div class="loading-spinner" style="text-align: center; padding: 2rem;"><div class="spinner" style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #0038A8; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div><p style="margin-top: 1rem; color: #666;">Loading duplicates...</p></div>';
        }
        
        // Disable pagination buttons during loading
        let duplicatesPrevBtn = document.getElementById('duplicates-prev-page-btn');
        let duplicatesNextBtn = document.getElementById('duplicates-next-page-btn');
        if (duplicatesPrevBtn) duplicatesPrevBtn.disabled = true;
        if (duplicatesNextBtn) duplicatesNextBtn.disabled = true;
        
        const response = await fetch(`/api/budget/duplicates?year=${selectedYear}&page=${page}&limit=${duplicatesPerPage}&sort_by=${sortBy}&sort_order=${sortOrder}`);
        const data = await response.json();
        
        
        
        if (data.success && data.duplicates && Array.isArray(data.duplicates)) {
            displayAnalysisDuplicatesResults(data.duplicates);
            if (data.pagination) {
                updateAnalysisDuplicatesPagination(data.pagination);
            }
        } else {
            document.getElementById('duplicates-results').innerHTML = `<div class="error-message">‚ùå Error: ${data.error || 'No duplicates found'}</div>`;
        }
        
        // Re-enable pagination buttons after loading
        duplicatesPrevBtn = document.getElementById('duplicates-prev-page-btn');
        duplicatesNextBtn = document.getElementById('duplicates-next-page-btn');
        if (duplicatesPrevBtn) duplicatesPrevBtn.disabled = false;
        if (duplicatesNextBtn) duplicatesNextBtn.disabled = false;
        
    } catch (error) {
        document.getElementById('duplicates-results').innerHTML = `<div class="error-message">‚ùå Error loading duplicates: ${error.message}</div>`;
        
        // Re-enable pagination buttons even on error
        duplicatesPrevBtn = document.getElementById('duplicates-prev-page-btn');
        duplicatesNextBtn = document.getElementById('duplicates-next-page-btn');
        if (duplicatesPrevBtn) duplicatesPrevBtn.disabled = false;
        if (duplicatesNextBtn) duplicatesNextBtn.disabled = false;
    }
}

// Display duplicates results - v3 (2025-10-05 - fixed escapeHtml with String conversion)
function displayAnalysisDuplicatesResults(duplicatesData) {
    const resultsContainer = document.getElementById('duplicates-results');
    
    if (!duplicatesData || !Array.isArray(duplicatesData) || duplicatesData.length === 0) {
        resultsContainer.innerHTML = '<div class="no-results">No duplicates found</div>';
        return;
    }
    
    try {
        // Helper function to escape HTML - defined once outside loop for performance
        const escapeHtml = (str) => {
            if (str === null || str === undefined) return '';
            const strValue = String(str);
            return strValue.replace(/'/g, "&#39;").replace(/"/g, "&quot;");
        };
        
        // Create proper table with separate columns (v2 - fixed escapeHtml)
        let html = `
            <div class="table-responsive" style="overflow-x: auto;">
                <table class="duplicates-table" style="width: 100%; border-collapse: collapse; background: white; font-size: 0.9rem;">
                    <thead>
                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                            <th style="padding: 0.75rem; text-align: left; font-weight: 600; white-space: nowrap;">Score</th>
                            <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Description</th>
                            <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Department</th>
                            <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Agency</th>
                            <th style="padding: 0.75rem; text-align: right; font-weight: 600; white-space: nowrap;">Amount</th>
                            <th style="padding: 0.75rem; text-align: center; font-weight: 600; white-space: nowrap;">Count</th>
                            <th style="padding: 0.75rem; text-align: center; font-weight: 600; white-space: nowrap;">Matching</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        duplicatesData.forEach((dup, index) => {
            
            html += `
                <tr style="border-bottom: 1px solid #dee2e6; cursor: pointer; transition: background-color 0.2s;" 
                    onmouseover="this.style.backgroundColor='#f8f9fa'" 
                    onmouseout="this.style.backgroundColor='white'"
                    onclick="navigateToDataBrowserWithDuplicateFilters('${escapeHtml(dup.description)}', '${escapeHtml(dup.dept_desc1)}', '${escapeHtml(dup.agy_desc1)}', '${escapeHtml(dup.fund_desc1)}', '${escapeHtml(dup.exp_desc1)}', '${escapeHtml(dup.obj_desc1)}', '${escapeHtml(dup.oper_desc1)}', '${escapeHtml(dup.div_desc1)}', '${escapeHtml(dup.reg_id1)}')">
                    <td style="padding: 0.75rem; white-space: nowrap;">
                        <span style="background: #dc3545; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">
                            ${dup.calculated_score.toFixed(1)}%
                        </span>
                    </td>
                    <td style="padding: 0.75rem; max-width: 300px;">
                        <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${dup.description || 'No description'}">
                            ${dup.description || 'No description'}
                        </div>
                    </td>
                    <td style="padding: 0.75rem; max-width: 200px;">
                        <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${dup.dept_desc1 || 'Unknown'}">
                            ${dup.dept_desc1 || 'Unknown'}
                        </div>
                    </td>
                    <td style="padding: 0.75rem; max-width: 200px;">
                        <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${dup.agy_desc1 || 'Unknown'}">
                            ${dup.agy_desc1 || 'Unknown'}
                        </div>
                    </td>
                    <td style="padding: 0.75rem; text-align: right; white-space: nowrap; font-weight: 500;">
                        ‚Ç±${parseFloat(dup.amount || 0).toLocaleString('en-PH')}
                    </td>
                    <td style="padding: 0.75rem; text-align: center; white-space: nowrap;">
                        <span style="background: #007bff; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem;">
                            ${dup.duplicate_count}
                        </span>
                    </td>
                    <td style="padding: 0.75rem; text-align: center; white-space: nowrap; color: #6c757d;">
                        ${dup.matching_columns}
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        resultsContainer.innerHTML = html;
    } catch (error) {
        resultsContainer.innerHTML = '<div class="error-message">‚ùå Error displaying duplicates: ' + error.message + '</div>';
    }
}

// Navigate to data browser with duplicate filters
function navigateToDataBrowserWithDuplicateFilters(description, department, agency, fund, expense, object, operation, division, region) {
    // Switch to data browser tab
    const dataBrowserTab = document.getElementById('tab-browser');
    const dataBrowserButton = document.querySelector('[data-tab="browser"]');
    
    if (dataBrowserTab && dataBrowserButton) {
        // Remove active class from all tabs
        document.querySelectorAll('.budget-tab-panel').forEach(panel => panel.classList.remove('active'));
        document.querySelectorAll('.budget-tab-btn').forEach(button => button.classList.remove('active'));
        
        // Activate data browser tab
        dataBrowserTab.classList.add('active');
        dataBrowserButton.classList.add('active');
        
        // Get the current year from Analysis tab filter
        const analysisYearFilter = document.getElementById('analysis-year-filter');
        const currentYear = analysisYearFilter ? analysisYearFilter.value : '2025';
        
        // IMPORTANT: Set the Data Browser year filter to match the Analysis year
        const browserYearFilter = document.getElementById('browser-year-filter');
        if (browserYearFilter) {
            // Always set the year, even if it's 'all'
            browserYearFilter.value = currentYear === 'all' ? '2025' : currentYear;
        } else {
        }
        
        // Set filters in data browser
        setDataBrowserFilters({
            dsc: description,
            uacs_dpt_dsc: department,
            uacs_agy_dsc: agency,
            uacs_fundsubcat_dsc: fund,
            uacs_exp_dsc: expense,
            uacs_sobj_dsc: object,
            uacs_oper_dsc: operation,
            uacs_div_dsc: division,
            uacs_reg_id: region
        });
        
        // Load data browser with filters (don't re-initialize, autocomplete is already set up)
        setTimeout(() => {
            currentFilters = getCurrentFilters();
            loadDataBrowser();
        }, 100);
        
    } else {
    }
}

// Set filters in data browser
function setDataBrowserFilters(filters) {
    
    // Set each filter field
    Object.entries(filters).forEach(([field, value]) => {
        if (value && value.trim() !== '') {
            // Ensure we're using the correct input ID format
            const inputId = field.startsWith('filter-') ? field : `filter-${field}`;
            const input = document.getElementById(inputId);
            if (input) {
                input.value = value;
            }
        }
    });
}

// Update pagination controls
function updateAnalysisDuplicatesPagination(pagination) {
    // Safety check for undefined pagination object
    if (!pagination) {
        currentDuplicatesPage = 1;
        totalDuplicatesPages = 1;
    } else {
        currentDuplicatesPage = pagination.current_page || 1;
        totalDuplicatesPages = pagination.total_pages || 1;
    }
    
    const prevBtn = document.getElementById('duplicates-prev-page-btn');
    const nextBtn = document.getElementById('duplicates-next-page-btn');
    const pageInfo = document.getElementById('duplicates-page-info');
    const paginationDiv = document.getElementById('duplicates-pagination');
    
    if (prevBtn) prevBtn.disabled = currentDuplicatesPage <= 1;
    if (nextBtn) nextBtn.disabled = currentDuplicatesPage >= totalDuplicatesPages;
    if (pageInfo) pageInfo.textContent = `Page ${currentDuplicatesPage} of ${totalDuplicatesPages}`;
    if (paginationDiv) paginationDiv.style.display = totalDuplicatesPages > 1 ? 'block' : 'none';
}

async function loadDuplicatesCount(year = null) {
    try {
        const yearParam = year || document.getElementById('analysis-year-filter')?.value || '2025';
        const response = await fetch(`${getApiBaseUrl()}/api/budget/duplicates/count?year=${yearParam}`);
        const result = await response.json();
        
        const countElement = document.getElementById('potential-duplicates-count');
        if (countElement) {
            if (result.success && result.count !== undefined) {
                countElement.innerHTML = result.count.toLocaleString('en-PH');
                countElement.style.color = result.count > 0 ? '#dc3545' : '#28a745';
            } else {
                countElement.innerHTML = 'Error';
                countElement.style.color = '#dc3545';
            }
        }
    } catch (error) {
        const countElement = document.getElementById('potential-duplicates-count');
        if (countElement) {
            countElement.innerHTML = 'Error';
            countElement.style.color = '#dc3545';
        }
    }
}

// Load total budget items count for footer (v3.0 - 2025-01-05 17:45)
async function loadTotalBudgetItemsCount() {
    try {
        
        const countElement = document.getElementById('total-budget-items-count');
        
        // Add cache-busting timestamp to API call
        const timestamp = new Date().getTime();
        const apiUrl = `${getApiBaseUrl()}/api/budget/total-items/count?_t=${timestamp}`;
        
        const response = await fetch(apiUrl, {
            cache: 'no-store',
            headers: {
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache',
                'Expires': '0'
            }
        });
        
        const data = await response.json();
        
        let totalCount = 0;
        if (data.success && data.count !== undefined) {
            totalCount = data.count;
        }
        
        if (countElement) {
            if (totalCount > 0) {
                const formattedCount = totalCount.toLocaleString('en-PH');
                countElement.textContent = formattedCount;
                countElement.setAttribute('data-loaded', 'true');
                countElement.setAttribute('data-version', 'v3.0');
            } else {
                countElement.textContent = '1M+';
            }
        } else {
        }
        
    } catch (error) {
        const countElement = document.getElementById('total-budget-items-count');
        if (countElement) {
            countElement.textContent = '1M+';
        }
    }
}

async function loadAnomaliesCount(year = null) {
    try {
        const yearParam = year || document.getElementById('analysis-year-filter')?.value || '2025';
        const response = await fetch(`${getApiBaseUrl()}/api/budget/anomalies/count?year=${yearParam}`);
        const result = await response.json();
        
        const countElement = document.getElementById('anomalies-count');
        if (countElement) {
            if (result.success && result.count !== undefined) {
                countElement.textContent = result.count.toLocaleString('en-PH');
                countElement.style.color = result.count > 0 ? '#ffc107' : '#28a745';
            } else {
                countElement.textContent = 'Error';
                countElement.style.color = '#dc3545';
            }
        }
    } catch (error) {
        const countElement = document.getElementById('anomalies-count');
        if (countElement) {
            countElement.textContent = 'Error';
            countElement.style.color = '#dc3545';
        }
    }
}

async function loadColumnIssuesCount(year = null) {
    try {
        const yearParam = year || document.getElementById('analysis-year-filter')?.value || '2025';
        const response = await fetch(`${getApiBaseUrl()}/api/budget/columns/issues/count?year=${yearParam}`);
        const result = await response.json();
        
        const countElement = document.getElementById('column-issues-count');
        if (countElement) {
            if (result.success && result.count !== undefined) {
                countElement.textContent = result.count.toLocaleString('en-PH');
                countElement.style.color = result.count > 0 ? '#17a2b8' : '#28a745';
            } else {
                countElement.textContent = 'Error';
                countElement.style.color = '#dc3545';
            }
        }
    } catch (error) {
        const countElement = document.getElementById('column-issues-count');
        if (countElement) {
            countElement.textContent = 'Error';
            countElement.style.color = '#dc3545';
        }
    }
}

// Trends Analysis Functions
let trendsData = null;

// Helper function to get API base URL
function getApiBaseUrl() {
    // Check if we're in production (has BetterGov domains)
    if (window.location.hostname.includes('visualizations.bettergov.ph') ||
        window.location.hostname.includes('10.27.79.7')) {
        return window.location.origin; // Use same origin for production/staging
    } else {
        // Local development - use the current origin for API calls
        return window.location.origin;
    }
}


// Display trends summary cards
function displayTrendsSummary(data) {
    const summaryContainer = document.getElementById('trends-summary');
    
    // Check for enhanced analysis first
    if (data.enhanced_analysis && data.enhanced_analysis.executive_summary) {
        const summary = data.enhanced_analysis.executive_summary;
        
        summaryContainer.innerHTML = `
            <div class="summary-card">
                <h4>üö® Total Duplicates</h4>
                <div class="value">${summary.total_duplicates_found}</div>
                <div class="label">Cross-year matches</div>
            </div>
            <div class="summary-card">
                <h4>üèõÔ∏è Departments</h4>
                <div class="value">${summary.departments_affected}</div>
                <div class="label">With duplicates</div>
            </div>
            <div class="summary-card">
                <h4>üèóÔ∏è Infrastructure</h4>
                <div class="value">${summary.infrastructure_projects_at_risk}</div>
                <div class="label">Projects at risk</div>
            </div>
            <div class="summary-card">
                <h4>üí∞ Amount at Risk</h4>
                <div class="value">‚Ç±${(summary.total_amount_at_risk * 1000 / 1000000).toFixed(1)}M</div>
                <div class="label">${summary.risk_percentage_of_budget.toFixed(2)}% of budget</div>
            </div>
            <div class="summary-card">
                <h4>üéØ Confidence</h4>
                <div class="value">${summary.analysis_confidence}</div>
                <div class="label">${summary.average_calculated_score.toFixed(1)}% similarity</div>
            </div>
        `;
    } else if (data.cross_year_duplicates && data.cross_year_duplicates.summary) {
        // Fallback to original data structure
        const summary = data.cross_year_duplicates.summary;
        
        summaryContainer.innerHTML = `
            <div class="summary-card">
                <h4>üö® Potential Duplicates</h4>
                <div class="value">${summary.total_duplicates}</div>
                <div class="label">Cross-year duplicates found</div>
            </div>
            <div class="summary-card">
                <h4>üí∞ 2023 Duplicate Amount</h4>
                <div class="value">‚Ç±${(summary.potential_duplicate_amount_2023 * 1000 / 1000000).toFixed(1)}M</div>
                <div class="label">${summary.duplicate_percentage_2023.toFixed(1)}% of total budget</div>
            </div>
            <div class="summary-card">
                <h4>üí∞ 2024 Duplicate Amount</h4>
                <div class="value">‚Ç±${(summary.potential_duplicate_amount_2024 * 1000 / 1000000).toFixed(1)}M</div>
                <div class="label">${summary.duplicate_percentage_2024.toFixed(1)}% of total budget</div>
            </div>
            <div class="summary-card">
                <h4>üí∞ 2025 Duplicate Amount</h4>
                <div class="value">‚Ç±${(summary.potential_duplicate_amount_2025 * 1000 / 1000000).toFixed(1)}M</div>
                <div class="label">${summary.duplicate_percentage_2025.toFixed(1)}% of total budget</div>
            </div>
        `;
    } else {
        summaryContainer.innerHTML = '<div class="alert alert-warning">No trends data available</div>';
    }
}

// Toggle trends sections
function toggleTrendsSection(section) {
    const container = document.getElementById(`${section}-container`);
    const icon = document.getElementById(`${section}-collapse-icon`);
    
    if (container && icon) {
        if (container.style.display === 'none' || container.style.display === '') {
        container.style.display = 'block';
        icon.classList.remove('collapsed');
            icon.textContent = '‚ñ≤';
        
        // Load section data when expanded
            if (section === 'columns') {
                loadColumnsData();
            } else if (section === 'spending') {
                // Load spending trends data
            } else if (section === 'duplicates') {
                // Load cross-year duplicates data
        }
    } else {
        container.style.display = 'none';
        icon.classList.add('collapsed');
            icon.textContent = '‚ñº';
        }
    }
}




// Display cross-year duplicates
// Global pagination state for cross-year duplicates
let crossYearCurrentPage = 1;
let currentCategory = 'potential'; // 'potential' or 'exact'
let allPotentialDuplicates = [];
let allExactAmountDuplicates = [];

function displayCrossYearDuplicates(duplicatesData) {
    const resultsContainer = document.getElementById('cross-year-duplicates-results');
    
    if (!duplicatesData || !duplicatesData.potential_duplicates || duplicatesData.potential_duplicates.length === 0) {
        resultsContainer.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #28a745;">
                <div style="font-size: 24px; margin-bottom: 10px;">‚úÖ</div>
                <div>No potential duplicates found across years</div>
            </div>
        `;
        return;
    }
    
    // Separate duplicates by type
    allPotentialDuplicates = duplicatesData.potential_duplicates.filter(d => 
        d.classification && d.classification.type === 'POTENTIAL_DUPLICATE'
    );
    
    allExactAmountDuplicates = duplicatesData.potential_duplicates.filter(d => 
        d.classification && d.classification.type === 'EXACT_AMOUNT_SIMILAR_PROJECT'
    );
    
    // Sort by similarity score descending
    allPotentialDuplicates.sort((a, b) => b.calculated_score - a.calculated_score);
    allExactAmountDuplicates.sort((a, b) => b.calculated_score - a.calculated_score);
    
    crossYearCurrentPage = 1;
    currentCategory = 'potential'; // Start with potential duplicates
    
    renderDuplicatesPage();
}

function renderDuplicatesPage() {
    const resultsContainer = document.getElementById('cross-year-duplicates-results');
    
    // Get current category data
    let currentData, itemsPerPage, categoryName, categoryColor;
    
    if (currentCategory === 'potential') {
        currentData = allPotentialDuplicates;
        itemsPerPage = 20;
        categoryName = 'Potential Duplicates';
        categoryColor = '#dc3545';
    } else {
        currentData = allExactAmountDuplicates;
        itemsPerPage = 10;
        categoryName = 'Exact Amount Similar';
        categoryColor = '#ffc107';
    }
    
    const startIndex = (crossYearCurrentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageDuplicates = currentData.slice(startIndex, endIndex);
    const totalPages = Math.ceil(currentData.length / itemsPerPage);
    
    let html = `
        <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="color: ${categoryColor}; margin: 0;">üö® ${categoryName}</h4>
                <div style="display: flex; gap: 10px;">
                    <button onclick="switchCategory('potential')" 
                            style="padding: 8px 16px; border: 1px solid #dc3545; background: ${currentCategory === 'potential' ? '#dc3545' : 'white'}; color: ${currentCategory === 'potential' ? 'white' : '#dc3545'}; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        Potential (${allPotentialDuplicates.length})
                    </button>
                    <button onclick="switchCategory('exact')" 
                            style="padding: 8px 16px; border: 1px solid #ffc107; background: ${currentCategory === 'exact' ? '#ffc107' : 'white'}; color: ${currentCategory === 'exact' ? '#212529' : '#ffc107'}; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        Exact Amount (${allExactAmountDuplicates.length})
                    </button>
                </div>
            </div>
            <p style="color: #6c757d; font-size: 0.9rem; margin: 0;">
                ${currentCategory === 'potential' ? 
                    'Projects with moderate similarity requiring manual review (20 per page)' : 
                    'Projects with exact amounts and similar descriptions (10 per page)'
                }
            </p>
        </div>
        
        <div style="display: grid; gap: 15px; margin-bottom: 20px;">
    `;
    
    if (pageDuplicates.length === 0) {
        html += `
            <div style="text-align: center; padding: 40px; color: #6c757d;">
                <div style="font-size: 24px; margin-bottom: 10px;">üìã</div>
                <div>No ${categoryName.toLowerCase()} found</div>
            </div>
        `;
    } else {
        pageDuplicates.forEach((duplicate, index) => {
            const globalIndex = startIndex + index + 1;
            
            // Determine if this is suspicious (infrastructure projects with same description but different amounts)
            const isSuspicious = duplicate.calculated_score === 100.0 && 
                                duplicate.project1.amt !== duplicate.project2.amt &&
                                (duplicate.project1.dsc.toLowerCase().includes('construction') || 
                                 duplicate.project1.dsc.toLowerCase().includes('infrastructure') ||
                                 duplicate.project1.dsc.toLowerCase().includes('building') ||
                                 duplicate.project1.dsc.toLowerCase().includes('facility'));
            
            const riskClass = isSuspicious ? 'high-risk' : 'medium-risk';
            const riskColor = isSuspicious ? '#dc3545' : '#ffc107';
            
            html += `
                <div class="duplicate-item ${riskClass}" style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid ${riskColor};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="background: ${riskColor}; color: ${isSuspicious ? 'white' : '#212529'}; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold;">
                                ${isSuspicious ? 'üö® SUSPICIOUS' : '‚ö†Ô∏è POTENTIAL'}
                            </span>
                            <span style="background: #e9ecef; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; color: #495057;">
                                #${globalIndex}
                            </span>
                            <span style="background: #e3f2fd; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; color: #1976d2;">
                                ${duplicate.classification.type.replace(/_/g, ' ')}
                            </span>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: ${riskColor};">
                                ${duplicate.calculated_score.toFixed(1)}%
                            </div>
                            <div style="font-size: 0.8rem; color: #6c757d;">Similarity</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: start;">
                        <div class="project-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <h5 style="margin: 0 0 10px 0; color: #495057; font-size: 1rem;">${duplicate.year1} - Department ${duplicate.project1.department}</h5>
                            <div style="font-size: 1.1rem; font-weight: bold; color: #dc3545; margin-bottom: 10px;">
                                ‚Ç±${(duplicate.project1.amt / 1000000).toFixed(2)}M
                            </div>
                            <div style="font-size: 0.9rem; color: #6c757d; line-height: 1.4;">
                                ${duplicate.project1.dsc}
                            </div>
                        </div>
                        
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
                            <div style="background: #e9ecef; padding: 8px; border-radius: 50%; margin-bottom: 10px;">
                                <span style="font-size: 1.2rem;">‚ÜîÔ∏è</span>
                            </div>
                            <div style="font-size: 0.8rem; color: #6c757d; text-align: center;">
                                ${duplicate.year1} ‚Üí ${duplicate.year2}
                            </div>
                        </div>
                        
                        <div class="project-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <h5 style="margin: 0 0 10px 0; color: #495057; font-size: 1rem;">${duplicate.year2} - Department ${duplicate.project2.department}</h5>
                            <div style="font-size: 1.1rem; font-weight: bold; color: #dc3545; margin-bottom: 10px;">
                                ‚Ç±${(duplicate.project2.amt / 1000000).toFixed(2)}M
                            </div>
                            <div style="font-size: 0.9rem; color: #6c757d; line-height: 1.4;">
                                ${duplicate.project2.dsc}
                            </div>
                        </div>
                    </div>
                    
                    ${isSuspicious ? `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; padding: 10px; margin-top: 15px;">
                        <div style="color: #721c24; font-size: 0.9rem; font-weight: bold;">‚ö†Ô∏è Suspicious Pattern:</div>
                        <div style="color: #721c24; font-size: 0.8rem;">Same infrastructure project description with different amounts across years</div>
                    </div>
                    ` : ''}
                </div>
            `;
        });
    }
    
    html += `</div>`;
    
    // Add pagination controls
    if (totalPages > 1) {
        html += `
            <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px;">
                <button onclick="changePage(${crossYearCurrentPage - 1})" ${crossYearCurrentPage === 1 ? 'disabled' : ''} 
                        style="padding: 8px 16px; border: 1px solid #dee2e6; background: white; border-radius: 4px; cursor: pointer; ${crossYearCurrentPage === 1 ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                    ‚Üê Previous
                </button>
                
                       <span style="padding: 8px 16px; background: #e9ecef; border-radius: 4px; font-size: 0.9rem;">
                           Page ${crossYearCurrentPage} of ${totalPages}
                       </span>
                
                <button onclick="changePage(${crossYearCurrentPage + 1})" ${crossYearCurrentPage === totalPages ? 'disabled' : ''}
                        style="padding: 8px 16px; border: 1px solid #dee2e6; background: white; border-radius: 4px; cursor: pointer; ${crossYearCurrentPage === totalPages ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                    Next ‚Üí
                </button>
            </div>
        `;
    }
    
    resultsContainer.innerHTML = html;
}

function switchCategory(category) {
    currentCategory = category;
    crossYearCurrentPage = 1;
    renderDuplicatesPage();
}

function changePage(newPage) {
    const currentData = currentCategory === 'potential' ? allPotentialDuplicates : allExactAmountDuplicates;
    const itemsPerPage = currentCategory === 'potential' ? 20 : 10;
    const totalPages = Math.ceil(currentData.length / itemsPerPage);
    
    if (newPage >= 1 && newPage <= totalPages) {
        crossYearCurrentPage = newPage;
        renderDuplicatesPage();
    }
}

// Display spending trends
function displaySpendingTrends(trendsData) {
    const resultsContainer = document.getElementById('spending-results');
    
    
    if (!trendsData || !trendsData.trends_data) {
        resultsContainer.innerHTML = '<div class="alert alert-warning">No spending trends data available</div>';
        return;
    }
    
    const data2020 = trendsData.trends_data['2020'] || [];
    const data2021 = trendsData.trends_data['2021'] || [];
    const data2022 = trendsData.trends_data['2022'] || [];
    const data2023 = trendsData.trends_data['2023'] || [];
    const data2024 = trendsData.trends_data['2024'] || [];
    const data2025 = trendsData.trends_data['2025'] || [];
    
    
    // Create a combined view
    const departments = new Set();
    data2020.forEach(d => departments.add(d.department));
    data2021.forEach(d => departments.add(d.department));
    data2022.forEach(d => departments.add(d.department));
    data2023.forEach(d => departments.add(d.department));
    data2024.forEach(d => departments.add(d.department));
    data2025.forEach(d => departments.add(d.department));
    
    let html = `
        <div style="margin-bottom: 20px;">
            <h4 style="color: #0038A8; margin-bottom: 15px;">üìä Department Spending Comparison</h4>
            <p style="color: #6c757d; font-size: 0.9rem;">Comparing total spending across 2020, 2021, 2022, 2023, 2024, and 2025</p>
        </div>
        <div style="display: grid; gap: 10px;">
    `;
    
    // Calculate percentage changes for all departments and sort by percentage
    const departmentsWithChanges = Array.from(departments).map(dept => {
        const dept2020 = data2020.find(d => d.department === dept);
        const dept2021 = data2021.find(d => d.department === dept);
        const dept2022 = data2022.find(d => d.department === dept);
        const dept2023 = data2023.find(d => d.department === dept);
        const dept2024 = data2024.find(d => d.department === dept);
        const dept2025 = data2025.find(d => d.department === dept);
        
        const amount2020 = dept2020 ? parseFloat(dept2020.total_amount) * 1000 : 0;
        const amount2021 = dept2021 ? parseFloat(dept2021.total_amount) * 1000 : 0;
        const amount2022 = dept2022 ? parseFloat(dept2022.total_amount) * 1000 : 0;
        const amount2023 = dept2023 ? parseFloat(dept2023.total_amount) * 1000 : 0;
        const amount2024 = dept2024 ? parseFloat(dept2024.total_amount) * 1000 : 0;
        const amount2025 = dept2025 ? parseFloat(dept2025.total_amount) * 1000 : 0;
        
        // Calculate year-over-year percentage changes and overall 2020 to 2025 change
        let change2020to2021 = 0;
        let change2021to2022 = 0;
        let change2022to2023 = 0;
        let change2023to2024 = 0;
        let change2024to2025 = 0;
        let change2020to2025 = 0;
        
        // 2020 to 2021 change
        if (amount2020 > 0 && amount2021 > 0) {
            change2020to2021 = ((amount2021 - amount2020) / amount2020) * 100;
        } else if (amount2020 === 0 && amount2021 > 0) {
            change2020to2021 = 100; // New department
        } else if (amount2020 > 0 && amount2021 === 0) {
            change2020to2021 = -100; // Discontinued department
        }
        
        // 2021 to 2022 change
        if (amount2021 > 0 && amount2022 > 0) {
            change2021to2022 = ((amount2022 - amount2021) / amount2021) * 100;
        } else if (amount2021 === 0 && amount2022 > 0) {
            change2021to2022 = 100; // New department
        } else if (amount2021 > 0 && amount2022 === 0) {
            change2021to2022 = -100; // Discontinued department
        }
        
        // 2022 to 2023 change
        if (amount2022 > 0 && amount2023 > 0) {
            change2022to2023 = ((amount2023 - amount2022) / amount2022) * 100;
        } else if (amount2022 === 0 && amount2023 > 0) {
            change2022to2023 = 100; // New department
        } else if (amount2022 > 0 && amount2023 === 0) {
            change2022to2023 = -100; // Discontinued department
        }
        
        // 2023 to 2024 change
        if (amount2023 > 0 && amount2024 > 0) {
            change2023to2024 = ((amount2024 - amount2023) / amount2023) * 100;
        } else if (amount2023 === 0 && amount2024 > 0) {
            change2023to2024 = 100; // New department
        } else if (amount2023 > 0 && amount2024 === 0) {
            change2023to2024 = -100; // Discontinued department
        }
        
        // 2024 to 2025 change
        if (amount2024 > 0 && amount2025 > 0) {
            change2024to2025 = ((amount2025 - amount2024) / amount2024) * 100;
        } else if (amount2024 === 0 && amount2025 > 0) {
            change2024to2025 = 100; // New department
        } else if (amount2024 > 0 && amount2025 === 0) {
            change2024to2025 = -100; // Discontinued department
        }
        
        // 2020 to 2025 change (overall)
        if (amount2020 > 0 && amount2025 > 0) {
            change2020to2025 = ((amount2025 - amount2020) / amount2020) * 100;
        } else if (amount2020 === 0 && amount2025 > 0) {
            change2020to2025 = 100; // New department
        } else if (amount2020 > 0 && amount2025 === 0) {
            change2020to2025 = -100; // Discontinued department
        }
        
        return {
            dept,
            amount2020,
            amount2021,
            amount2022,
            amount2023,
            amount2024,
            amount2025,
            change2020to2021,
            change2021to2022,
            change2022to2023,
            change2023to2024,
            change2024to2025,
            change2020to2025
        };
    });
    
    // Sort by 2020 to 2025 percentage change (highest to lowest)
    departmentsWithChanges.sort((a, b) => b.change2020to2025 - a.change2020to2025);
    
    // Helper function to format percentage
    function formatPercentage(percent) {
        if (percent > 10) {
            return `+${percent.toFixed(1)}%`;
        } else if (percent < -10) {
            return `${percent.toFixed(1)}%`;
        } else {
            return `${percent.toFixed(1)}%`;
        }
    }
    
    // Take top 20 and display
    departmentsWithChanges.slice(0, 20).forEach(({ dept, amount2020, amount2021, amount2022, amount2023, amount2024, amount2025, change2020to2021, change2021to2022, change2022to2023, change2023to2024, change2024to2025, change2020to2025 }) => {
        html += `
            <div class="spending-trend-item">
                <div class="department-name">${dept || 'Unknown Department'}</div>
                <div class="trend-values">
                    <div class="year-value">
                        <div class="amount">‚Ç±${(amount2020 / 1000000).toFixed(1)}M</div>
                        <div class="change-indicator">${formatPercentage(change2020to2021)}</div>
                        <div class="label">2020</div>
                    </div>
                    <div class="year-value">
                        <div class="amount">‚Ç±${(amount2021 / 1000000).toFixed(1)}M</div>
                        <div class="change-indicator">${formatPercentage(change2021to2022)}</div>
                        <div class="label">2021</div>
                    </div>
                    <div class="year-value">
                        <div class="amount">‚Ç±${(amount2022 / 1000000).toFixed(1)}M</div>
                        <div class="change-indicator">${formatPercentage(change2022to2023)}</div>
                        <div class="label">2022</div>
                    </div>
                    <div class="year-value">
                        <div class="amount">‚Ç±${(amount2023 / 1000000).toFixed(1)}M</div>
                        <div class="change-indicator">${formatPercentage(change2023to2024)}</div>
                        <div class="label">2023</div>
                    </div>
                    <div class="year-value">
                        <div class="amount">‚Ç±${(amount2024 / 1000000).toFixed(1)}M</div>
                        <div class="change-indicator">${formatPercentage(change2024to2025)}</div>
                        <div class="label">2024</div>
                    </div>
                    <div class="year-value">
                        <div class="amount">‚Ç±${(amount2025 / 1000000).toFixed(1)}M</div>
                        <div class="change-indicator">${formatPercentage(change2020to2025)}</div>
                        <div class="label">2025</div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    resultsContainer.innerHTML = html;
}

function showTrendsError(message) {
    // Update dashboard cards to show error state
    const potentialDuplicatesElement = document.getElementById('trends-potential-duplicates');
    const exactAmountElement = document.getElementById('trends-exact-amount-similar');
    
    if (potentialDuplicatesElement) {
        potentialDuplicatesElement.innerHTML = '<div class="error-message">Error</div>';
    }
    
    if (exactAmountElement) {
        exactAmountElement.innerHTML = '<div class="error-message">Error</div>';
    }
}

// Function to show project type details in a modal
function showProjectTypeDetails(projectType, duplicateCount) {
    
    // Create modal HTML
    const modalHTML = `
        <div id="projectTypeModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 90%; max-height: 90%; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="color: #495057; margin: 0;">üìä ${projectType} Project Details</h3>
                    <button onclick="closeProjectTypeModal()" style="background: #dc3545; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 16px;">√ó</button>
                </div>
                <div id="projectTypeDetailsContent">
                    <div class="loading-spinner">üîç Loading detailed line items for ${projectType}...</div>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Load detailed data
    loadProjectTypeDetails(projectType, duplicateCount);
}

// Function to load detailed project type data
async function loadProjectTypeDetails(projectType, duplicateCount) {
    try {
        
        // Query the budget analysis API for this specific project type
        const response = await fetch(`${getApiBaseUrl()}/api/budget/analyze`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                query: `Show me all ${projectType} infrastructure projects with duplicate line items`
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.table_data && data.table_data.length > 0) {
            displayProjectTypeDetails(projectType, data.table_data, data.potential_duplicates || []);
        } else {
            showProjectTypeDetailsError(`No detailed data found for ${projectType} projects`);
        }
        
    } catch (error) {
        showProjectTypeDetailsError(`Failed to load details for ${projectType}: ${error.message}`);
    }
}

// Function to display project type details in the modal
function displayProjectTypeDetails(projectType, tableData, potentialDuplicates) {
    const contentDiv = document.getElementById('projectTypeDetailsContent');
    if (!contentDiv) return;
    
    let html = `
        <div style="margin-bottom: 1.5rem;">
            <h4 style="color: #495057; margin-bottom: 1rem;">üìã Line Items for ${projectType} Projects</h4>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                <strong>Total Items Found:</strong> ${tableData.length}<br>
                <strong>Project Type:</strong> ${projectType}<br>
                <strong>Analysis Date:</strong> ${new Date().toLocaleDateString()}
            </div>
        </div>
    `;
    
    if (tableData.length > 0) {
        html += `
            <div style="overflow-x: auto; margin-bottom: 1.5rem;">
                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <thead style="background: #007bff; color: white;">
                        <tr>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #0056b3;">Description</th>
                            <th style="padding: 12px; text-align: right; border-bottom: 2px solid #0056b3;">Amount</th>
                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #0056b3;">Year</th>
                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #0056b3;">Department</th>
                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #0056b3;">Similarity</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        tableData.forEach((item, index) => {
            const similarity = item.similarity ? `${(item.similarity * 100).toFixed(1)}%` : 'N/A';
            const amount = item.amount ? `‚Ç±${parseFloat(item.amount).toLocaleString('en-US')}` : 'N/A';
            const year = item.year || 'Unknown';
            const department = item.department || 'Unknown';
            
            html += `
                <tr style="border-bottom: 1px solid #dee2e6; ${index % 2 === 0 ? 'background: #f8f9fa;' : 'background: white;'}">
                    <td style="padding: 12px; max-width: 300px; word-wrap: break-word;">${item.description || 'No description'}</td>
                    <td style="padding: 12px; text-align: right; font-weight: bold; color: #28a745;">${amount}</td>
                    <td style="padding: 12px; text-align: center;">${year}</td>
                    <td style="padding: 12px; text-align: center;">${department}</td>
                    <td style="padding: 12px; text-align: center; color: ${parseFloat(similarity) > 80 ? '#dc3545' : '#6c757d'};">
                        ${similarity}
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
    }
    
    if (potentialDuplicates && potentialDuplicates.length > 0) {
        html += `
            <div style="margin-top: 1.5rem;">
                <h4 style="color: #dc3545; margin-bottom: 1rem;">üö® Potential Duplicates Found</h4>
                <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <ul style="margin: 0; padding-left: 1.5rem;">
        `;
        
        potentialDuplicates.slice(0, 10).forEach(duplicate => {
            html += `<li style="margin-bottom: 0.5rem;">${duplicate}</li>`;
        });
        
        html += `
                    </ul>
                </div>
            </div>
        `;
    }
    
    contentDiv.innerHTML = html;
}

// Function to show error in project type details modal
function showProjectTypeDetailsError(message) {
    const contentDiv = document.getElementById('projectTypeDetailsContent');
    if (contentDiv) {
        contentDiv.innerHTML = `
            <div style="background: #f8d7da; color: #721c24; padding: 1rem; border-radius: 8px; border-left: 4px solid #dc3545;">
                <strong>Error:</strong> ${message}
            </div>
        `;
    }
}

// Function to close the project type modal
function closeProjectTypeModal() {
    const modal = document.getElementById('projectTypeModal');
    if (modal) {
        modal.remove();
    }
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('projectTypeModal');
    if (modal && event.target === modal) {
        closeProjectTypeModal();
    }
});
</script>


<style>

/* Data Browser Styles */
.data-browser-controls {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 10px;
    margin-bottom: 1.5rem;
    border: 1px solid #dee2e6;
}

.year-filter-row {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    border: 2px solid #0038A8;
}

.filters-row {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    align-items: end;
}

.filter-group {
    flex: 1;
    min-width: 200px;
}

.year-select {
    padding: 0.5rem;
    border: 1px solid #0038A8;
    border-radius: 4px;
    font-size: 1rem;
    font-weight: 600;
    color: #0038A8;
    background: white;
    min-width: 150px;
}

.year-select:focus {
    outline: none;
    border-color: #CE1126;
    box-shadow: 0 0 0 2px rgba(206, 17, 38, 0.1);
}

.filter-group label {
    display: block;
    font-weight: 600;
    color: #333;
    margin-bottom: 0.25rem;
    font-size: 0.9rem;
}

.filter-group input {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    font-size: 0.9rem;
}

.filter-group input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
}

.filter-actions {
    display: flex;
    gap: 0.5rem;
    align-items: end;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.browser-controls-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
}

.sort-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.sort-controls label {
    font-weight: 600;
    color: #333;
}

.sort-controls select {
    padding: 0.5rem;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    font-size: 0.9rem;
}

.sort-order-btn {
    background: #667eea;
    color: white;
    border: none;
    padding: 0.5rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
    min-width: 40px;
}

.sort-order-btn:hover {
    background: #5a6fd8;
}

.pagination-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.page-btn {
    background: #667eea;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
}

.page-btn:hover:not(:disabled) {
    background: #5a6fd8;
}

.page-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
}

#page-info {
    font-weight: 600;
    color: #333;
    white-space: nowrap;
}

/* Duplicates Controls Styling */
.duplicates-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.duplicates-filter-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.duplicates-filter-group label {
    font-weight: 600;
    color: #333;
    font-size: 0.9rem;
}

.duplicates-pagination-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
}

#duplicates-page-info {
    font-weight: 600;
    color: #333;
    white-space: nowrap;
    font-size: 0.9rem;
}

/* Column Duplicates Card Styling */
.budget-column-duplicates {
    margin: 2rem 0;
    background: white;
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box;
    overflow-x: auto;
}


.column-duplicates-results {
    min-height: 100px;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.3rem;
}

.column-duplicate-item {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 3px;
    padding: 0.3rem 0.4rem;
}

.column-duplicate-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.1rem;
}

.column-duplicate-title {
    font-weight: 600;
    color: #333;
    font-size: 0.65rem;
}

.column-duplicate-count {
    background: #dc3545;
    color: white;
    padding: 0.05rem 0.25rem;
    border-radius: 6px;
    font-size: 0.55rem;
    font-weight: 600;
}

.column-duplicate-details {
    color: #666;
    font-size: 0.6rem;
    margin-bottom: 0.1rem;
    line-height: 1.2;
}

.duplicate-values {
    font-size: 0.55rem;
    color: #555;
    line-height: 1.2;
}

.duplicate-value {
    display: inline-block;
    background: #e9ecef;
    color: #495057;
    padding: 0.05rem 0.2rem;
    border-radius: 2px;
    margin: 0.05rem 0.1rem 0.05rem 0;
    font-size: 0.55rem;
}


.data-browser-container {
    background: white;
    border-radius: 10px;
    overflow: visible;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.data-browser-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.8rem;
}

.data-browser-table th {
    background: #f8f9fa;
    color: #333;
    font-weight: 600;
    padding: 0.5rem 0.75rem;
    text-align: left;
    border-bottom: 2px solid #dee2e6;
    position: sticky;
    top: 0;
    z-index: 10;
    font-size: 0.75rem;
    white-space: nowrap;
}

.data-browser-table td {
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid #dee2e6;
    vertical-align: top;
    font-size: 0.8rem;
}

.data-browser-table tr:hover {
    background: #f8f9fa;
}

.data-browser-table .even-row {
    background-color: #ffffff;
}

.data-browser-table .odd-row {
    background-color: #f8f9fa;
}

.data-browser-table .even-row:hover,
.data-browser-table .odd-row:hover {
    background-color: #e9ecef;
}

.data-browser-table .amount-cell {
    text-align: right;
    font-weight: 700;
    color: #1b5e20;
    white-space: nowrap;
    width: 140px;
    background-color: #e8f5e8;
    border-left: 3px solid #4caf50;
    padding: 8px 12px;
    font-size: 0.9rem;
}

.data-browser-table .description-cell {
    max-width: 250px;
    word-wrap: break-word;
    width: 200px;
}

.data-browser-table .dsc-cell {
    max-width: 1200px;
    word-wrap: break-word;
    width: 1100px;
    background-color: #e3f2fd;
    color: #0d47a1;
    font-weight: 700;
    border-left: 4px solid #2196f3;
    padding: 8px 12px;
    font-size: 0.9rem;
    line-height: 1.4;
}

.data-browser-table .code-cell {
    font-family: monospace;
    font-size: 0.75rem;
    color: #666;
    white-space: nowrap;
    width: 60px;
}

.loading-spinner {
    text-align: center;
    padding: 2rem;
    color: #666;
    font-style: italic;
}

/* Autocomplete styles for speed and efficiency */
.autocomplete-container {
    position: relative;
    display: inline-block;
    width: 100%;
}

.autocomplete-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ccc;
    border-top: none;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.autocomplete-item {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
    font-size: 0.8rem;
}

.autocomplete-item:hover,
.autocomplete-item.active {
    background-color: #f0f0f0;
}

.autocomplete-item:last-child {
    border-bottom: none;
}

.autocomplete-item strong {
    font-weight: bold;
    color: #007bff;
}

/* Duplicates Card Styles */
.duplicate-badges {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.score-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
}

/* Column highlighting styles */
.matching-column {
    background-color: #e8f5e8;
    color: #1b5e20;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    font-weight: 600;
    border: 1px solid #4caf50;
}

.mismatch-column {
    background-color: #fff3e0;
    color: #e65100;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    font-weight: 600;
    border: 1px solid #ff9800;
    animation: pulse-mismatch 2s infinite;
}

@keyframes pulse-mismatch {
    0% { background-color: #fff3e0; }
    50% { background-color: #ffecb3; }
    100% { background-color: #fff3e0; }
}

/* Clickable count styles */
.clickable-count {
    color: #007bff;
    cursor: pointer;
    text-decoration: underline;
    font-weight: bold;
    transition: all 0.2s ease;
}

.clickable-count:hover {
    color: #0056b3;
    background-color: #e3f2fd;
    padding: 2px 4px;
    border-radius: 4px;
    text-decoration: none;
}

/* Potential Duplicates table styles */
.data-table th {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.5rem 0.25rem;
    text-align: center;
    white-space: nowrap;
}

.data-table td {
    font-size: 0.8rem;
    padding: 0.5rem 0.25rem;
}
</style>

                    </div>
                    
                    <!-- Analysis Tab -->
                    <div id="tab-analysis" class="budget-tab-panel">
                        <h3 class="budget-section-title">üîç AI-Powered Budget Analysis</h3>
                        <p class="budget-section-desc">Advanced analysis with intelligent duplicate detection and anomaly identification</p>
                        
                        <!-- Analysis Year Filter -->
                        <div class="analysis-controls">
                            <div class="year-filter-group">
                                <label for="analysis-year-filter" class="filter-label">üìÖ Analysis Year:</label>
                                <select id="analysis-year-filter" class="year-select">
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                    <option value="2022">2022</option>
                                    <option value="2021">2021</option>
                                    <option value="2020">2020</option>
                                    <option value="all">All Years</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Analysis Overview Dashboard -->
                        
                        <!-- Analysis Results Section -->
                        <div class="analysis-results">
                            <!-- Duplicates Analysis -->
                            <div class="analysis-section">
                                <div class="section-header">
                                    <h4>üîç Duplicate Detection Results</h4>
                                    <button class="btn btn-outline" onclick="toggleAnalysisDuplicatesAnalysis()">
                                        <span id="duplicates-toggle-icon">‚ñº</span> View Details
                                    </button>
                                </div>
                                <div id="duplicates-analysis-content" class="analysis-content" style="display: none;">
                                    <div class="analysis-filters">
                                    <div class="filter-group">
                                        <label for="duplicates-sort-by">Sort by:</label>
                                            <select id="duplicates-sort-by" class="filter-select">
                                                <option value="calculated_score">Similarity Score</option>
                                            <option value="total_amount">Total Amount</option>
                                            <option value="count">Count</option>
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <label for="duplicates-sort-order">Order:</label>
                                            <select id="duplicates-sort-order" class="filter-select">
                                            <option value="DESC">Descending</option>
                                            <option value="ASC">Ascending</option>
                                        </select>
                                    </div>
                                </div>
                                    <div id="duplicates-results" class="results-container">
                                        <div class="loading-message">Duplicate analysis will be displayed here</div>
                                    </div>
                                    <div id="duplicates-pagination" class="pagination" style="display: none;">
                                        <button id="duplicates-prev-page-btn" class="btn btn-sm" disabled>Previous</button>
                                        <span id="duplicates-page-info">Page 1 of 1</span>
                                        <button id="duplicates-next-page-btn" class="btn btn-sm" disabled>Next</button>
                                    </div>
                                </div>
                            </div>
                        
                            <!-- Column Analysis -->
                            <div class="analysis-section">
                                <div class="section-header">
                                    <h4>üìä Column-Level Analysis</h4>
                                    <button class="btn btn-outline" onclick="toggleColumnAnalysis()">
                                        <span id="columns-toggle-icon">‚ñº</span> View Details
                                    </button>
                                </div>
                                <div id="columns-analysis-content" class="analysis-content" style="display: none;">
                                    <div class="column-comparison">
                                        <div class="comparison-grid">
                                            <!-- 2020 Budget Data -->
                                            <div class="year-column">
                                                <h5>üìÖ 2020 Budget Data</h5>
                                                <div class="column-info">
                                                    <span id="2020-row-count" class="row-count">Loading...</span> rows
                                                </div>
                                                <div id="2020-columns-list" class="columns-list">
                                                    <div class="loading-message">Loading columns...</div>
                                                </div>
                                            </div>
                        
                                            <!-- 2021 Budget Data -->
                                            <div class="year-column">
                                                <h5>üìÖ 2021 Budget Data</h5>
                                                <div class="column-info">
                                                    <span id="2021-row-count" class="row-count">Loading...</span> rows
                                                </div>
                                                <div id="2021-columns-list" class="columns-list">
                                                    <div class="loading-message">Loading columns...</div>
                                                </div>
                                            </div>
                        
                                            <!-- 2022 Budget Data -->
                                            <div class="year-column">
                                                <h5>üìÖ 2022 Budget Data</h5>
                                                <div class="column-info">
                                                    <span id="2022-row-count" class="row-count">Loading...</span> rows
                                                </div>
                                                <div id="2022-columns-list" class="columns-list">
                                                    <div class="loading-message">Loading columns...</div>
                                                </div>
                                            </div>
                        
                                            <!-- 2023 Budget Data -->
                                            <div class="year-column">
                                                <h5>üìÖ 2023 Budget Data</h5>
                                                <div class="column-info">
                                                    <span id="2023-row-count" class="row-count">Loading...</span> rows
                                                </div>
                                                <div id="2023-columns-list" class="columns-list">
                                                    <div class="loading-message">Loading columns...</div>
                                                </div>
                                            </div>
                        
                                            <!-- 2024 Budget Data -->
                                            <div class="year-column">
                                                <h5>üìÖ 2024 Budget Data</h5>
                                                <div class="column-info">
                                                    <span id="2024-row-count" class="row-count">Loading...</span> rows
                                                </div>
                                                <div id="2024-columns-list" class="columns-list">
                                                    <div class="loading-message">Loading columns...</div>
                                                </div>
                                            </div>
                                    
                                            <!-- 2025 Budget Data -->
                                            <div class="year-column">
                                                <h5>üìÖ 2025 Budget Data</h5>
                                                <div class="column-info">
                                                    <span id="2025-row-count" class="row-count">Loading...</span> rows
                                                </div>
                                                <div id="2025-columns-list" class="columns-list">
                                                    <div class="loading-message">Loading columns...</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 2020-2021 Column Mapping Analysis -->
                                    <div class="column-mapping-section" style="margin-top: 2rem; padding: 1.5rem; background: white; border-radius: 8px; border: 2px solid #0038A8;">
                                        <h5 style="color: #0038A8; margin-bottom: 1rem;">
                                            üîç 2020-2021 Column Mapping Analysis (100% Certainty)
                                        </h5>
                                        
                                        <!-- Summary Card -->
                                        <div id="mapping-summary-card" style="background: #e3f2fd; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;">
                                            <div class="loading-message">Loading mapping summary...</div>
                                        </div>
                                        
                                        <!-- Mapping Table -->
                                        <div style="overflow-x: auto;">
                                            <table id="column-mapping-table" style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                                                <thead style="background: #0038A8; color: white;">
                                                    <tr>
                                                        <th style="padding: 0.75rem; text-align: left; border: 1px solid #dee2e6;">#</th>
                                                        <th style="padding: 0.75rem; text-align: left; border: 1px solid #dee2e6;">Original Column</th>
                                                        <th style="padding: 0.75rem; text-align: left; border: 1px solid #dee2e6;">Mapped Column</th>
                                                        <th style="padding: 0.75rem; text-align: left; border: 1px solid #dee2e6;">Data Type</th>
                                                        <th style="padding: 0.75rem; text-align: center; border: 1px solid #dee2e6;">Certainty</th>
                                                        <th style="padding: 0.75rem; text-align: left; border: 1px solid #dee2e6;">Status</th>
                                                        <th style="padding: 0.75rem; text-align: left; border: 1px solid #dee2e6;">Evidence</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="mapping-table-body">
                                                    <tr>
                                                        <td colspan="7" style="padding: 2rem; text-align: center;">
                                                            <div class="loading-message">Loading column mapping data...</div>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                                
                            <!-- Column Duplicates Analysis -->
                            <div class="analysis-section">
                                <div class="section-header">
                                    <h4>üîç Column Duplicates Analysis</h4>
                                    <button class="btn btn-outline" onclick="toggleAnalysisColumnDuplicatesAnalysis()">
                                        <span id="column-duplicates-toggle-icon">‚ñº</span> View Details
                                    </button>
                                </div>
                                <div id="column-duplicates-analysis-content" class="analysis-content" style="display: none;">
                                    <div id="column-duplicates-results" class="results-container">
                                        <div class="loading-message">Column duplicates analysis will be displayed here</div>
                                    </div>
                                    <div id="column-duplicates-pagination" class="pagination" style="display: none;">
                                        <button id="column-duplicates-prev-page-btn" class="btn btn-sm" disabled>Previous</button>
                                        <span id="column-duplicates-page-info">Page 1 of 1</span>
                                        <button id="column-duplicates-next-page-btn" class="btn btn-sm" disabled>Next</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                                
                        
                    </div>
                    
                    <!-- Trends Tab -->
                    <div id="tab-trends" class="budget-tab-panel">
                        <h3 class="budget-section-title">üìà Budget Trends Analysis</h3>
                        <p class="budget-section-desc">Cross-year analysis of potential duplications and spending trends</p>
                        
                        <!-- Trends Dashboard -->
                        <div class="trends-dashboard">
                            <div class="trends-summary-cards">
                                <div class="metric-card">
                                    <div class="metric-icon">‚ö†Ô∏è</div>
                                    <div class="metric-content">
                                        <div class="metric-value">46</div>
                                        <div class="metric-label">Potential Duplicates</div>
                                        <div class="metric-description">Budget items with similar descriptions and amounts</div>
                            </div>
                        </div>
                        
                                <div class="metric-card">
                                    <div class="metric-icon">üéØ</div>
                                    <div class="metric-content">
                                        <div class="metric-value">572</div>
                                        <div class="metric-label">Exact Amount Similar</div>
                                        <div class="metric-description">Items with identical amounts across departments</div>
                            </div>
                                </div>
                                </div>
                            </div>
                            
                            <!-- Department Spending Trends -->
                            <div class="trends-section">
                                <h4 class="section-title">üèõÔ∏è Department Spending Trends</h4>
                                <p class="section-description">Budget allocation trends across departments for 2020-2025</p>
                                
                                <div id="department-trends-container" class="trends-results">
                                    <!-- Static placeholder chart that shows immediately -->
                                    <div style="background: white; padding: 20px; border-radius: 8px; min-height: 600px;">
                                        <canvas id="departmentTrendsChartStatic" height="600"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <script>
                            // Initialize static placeholder chart immediately
                            (function() {
                                console.log('üé® [STATIC] Initializing static department trends chart...');
                                const ctx = document.getElementById('departmentTrendsChartStatic');
                                if (ctx && typeof Chart !== 'undefined') {
                                    new Chart(ctx, {
                                        type: 'bar',
                                        data: {
                                            labels: [
                                                'Department of Education',
                                                'Department of Public Works and Highways',
                                                'Department of Health',
                                                'Department of Interior and Local Government',
                                                'Department of National Defense',
                                                'Department of Social Welfare and Development',
                                                'Department of Agriculture',
                                                'Department of Transportation',
                                                'Department of Energy',
                                                'National Economic and Development Authority'
                                            ],
                                            datasets: [
                                                {
                                                    label: '2020',
                                                    data: [620, 500, 250, 170, 220, 160, 75, 65, 25, 22],
                                                    backgroundColor: 'rgba(255, 99, 132, 0.7)',
                                                    borderColor: 'rgba(255, 99, 132, 1)',
                                                    borderWidth: 1
                                                },
                                                {
                                                    label: '2021',
                                                    data: [650, 530, 265, 180, 230, 168, 78, 68, 27, 23],
                                                    backgroundColor: 'rgba(153, 102, 255, 0.7)',
                                                    borderColor: 'rgba(153, 102, 255, 1)',
                                                    borderWidth: 1
                                                },
                                                {
                                                    label: '2022',
                                                    data: [680, 555, 275, 188, 240, 174, 82, 72, 28, 24],
                                                    backgroundColor: 'rgba(255, 206, 86, 0.7)',
                                                    borderColor: 'rgba(255, 206, 86, 1)',
                                                    borderWidth: 1
                                                },
                                                {
                                                    label: '2023',
                                                    data: [710, 580, 290, 195, 250, 180, 85, 75, 30, 25],
                                                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                                    borderColor: 'rgba(54, 162, 235, 1)',
                                                    borderWidth: 1
                                                },
                                                {
                                                    label: '2024',
                                                    data: [765, 620, 310, 210, 265, 195, 92, 82, 35, 28],
                                                    backgroundColor: 'rgba(255, 159, 64, 0.7)',
                                                    borderColor: 'rgba(255, 159, 64, 1)',
                                                    borderWidth: 1
                                                },
                                                {
                                                    label: '2025',
                                                    data: [826, 668, 334, 227, 286, 210, 99, 88, 38, 30],
                                                    backgroundColor: 'rgba(75, 192, 192, 0.7)',
                                                    borderColor: 'rgba(75, 192, 192, 1)',
                                                    borderWidth: 1
                                                }
                                            ]
                                        },
                                        options: {
                                            indexAxis: 'x', // Explicitly set vertical bars (x-axis = categories, y-axis = values)
                                            responsive: true,
                                            maintainAspectRatio: false,
                                            plugins: {
                                                legend: {
                                                    position: 'top',
                                                    display: true,
                                                    labels: {
                                                        color: '#333',
                                                        font: { size: 12, weight: 'bold' },
                                                        padding: 15,
                                                        usePointStyle: false,
                                                        boxWidth: 40,
                                                        boxHeight: 12
                                                    },
                                                    maxHeight: 100
                                                },
                                                title: {
                                                    display: false
                                                },
                                                tooltip: {
                                                    callbacks: {
                                                        label: function(context) {
                                                            const label = context.dataset.label || '';
                                                            const value = context.parsed.y || 0;
                                                            return `${label}: ‚Ç±${value.toFixed(2)}T`;
                                                        }
                                                    }
                                                }
                                            },
                                            scales: {
                                                x: {
                                                    ticks: {
                                                        color: '#333',
                                                        font: { size: 10 },
                                                        autoSkip: false,
                                                        maxRotation: 45,
                                                        minRotation: 45
                                                    },
                                                    title: {
                                                        display: true,
                                                        text: 'Department / Agency',
                                                        color: '#333',
                                                        font: { size: 13, weight: 'bold' }
                                                    },
                                                    grid: {
                                                        display: false
                                                    }
                                                },
                                                y: {
                                                    beginAtZero: true,
                                                    ticks: {
                                                        color: '#666',
                                                        font: { size: 11 },
                                                        callback: function(value) {
                                                            return '‚Ç±' + value.toFixed(0) + 'T';
                                                        }
                                                    },
                                                    title: {
                                                        display: true,
                                                        text: 'Amount (Trillions PHP)',
                                                        color: '#333',
                                                        font: { size: 13, weight: 'bold' }
                                                    },
                                                    grid: {
                                                        color: 'rgba(0, 0, 0, 0.05)'
                                                    }
                                                }
                                            }
                                        }
                                    });
                                    console.log('‚úÖ [STATIC] Static chart created successfully!');
                                } else {
                                    console.error('‚ùå [STATIC] Canvas or Chart.js not found!');
                                }
                            })();
                            </script>
                        </div>
                        
                    </div>
                </div>
            </div>
    </div>
    
    <!-- Global Data Source Footer -->
    <div class="data-source-footer">
        <div class="source-info">
            <p><strong>üìä Source:</strong> Department of Budget and Management (DBM) General Appropriations Act (GAA)</p>
            <p><strong>üìà Total Budget Items:</strong> <span id="total-budget-items-count">Loading...</span> budget line items nationwide</p>
            <p><strong>üìÖ Data Range:</strong> 2020-2025 government budget allocations</p>
            <p class="github-footnote text-center text-gray-600 text-sm mt-2">@<a href="https://github.com/joebertj" target="_blank" rel="noopener noreferrer">https://github.com/joebertj</a></p>
        </div>
    </div>
</section>
</div>

</body>
</html>
