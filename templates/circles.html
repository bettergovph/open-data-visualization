<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coordinate Skewers - Data Quality Analysis | BetterGovPH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
        }
        .skewer-canvas {
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-8 mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-3">
                üç¢ Coordinate Skewers
            </h1>
            <p class="text-xl text-gray-600 mb-2">Data Quality Anomaly Detection</p>
            <p class="text-gray-500">Impossible vertical alignments in project coordinates</p>
        </div>

        <!-- Warning Box -->
        <div class="bg-red-50 border-l-4 border-red-500 rounded-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-red-800 mb-3">‚ö†Ô∏è Data Quality Issue Detected</h2>
            <p class="text-red-700 text-lg mb-2">
                Multiple projects separated by <strong>up to 708 kilometers</strong> share the <strong>EXACT same longitude</strong>.
            </p>
            <p class="text-red-600">
                These projects are "skewered" on the same vertical line like meat on a kebab stick - spanning from Zamboanga to Marinduque, geometrically impossible without coordinate errors.
            </p>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="text-4xl mb-2">üéØ</div>
                <div class="text-3xl font-bold text-blue-600" id="total-alignments">10</div>
                <div class="text-gray-600">Vertical Alignments</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="text-4xl mb-2">üìè</div>
                <div class="text-3xl font-bold text-orange-600" id="max-distance">708</div>
                <div class="text-gray-600">Max Distance (km)</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="text-4xl mb-2">üî¥</div>
                <div class="text-3xl font-bold text-red-600" id="affected-projects">21</div>
                <div class="text-gray-600">Affected Projects</div>
            </div>
        </div>

        <!-- Map Visualization -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üó∫Ô∏è Skewer Visualization</h2>
            <p class="text-gray-600 mb-4">
                Thick red vertical lines are "skewers" with blue circles representing projects impossibly aligned on the same longitude
            </p>
            <canvas id="map" class="skewer-canvas w-full" width="1200" height="800"></canvas>
            <div class="mt-4 text-sm text-gray-600 space-y-1">
                <p><span class="inline-block w-1 h-6 bg-red-600 mr-2"></span> Thick red lines = "Skewers" extending above/below projects (same longitude)</p>
                <p><span class="inline-block w-3 h-3 rounded-full bg-blue-500 mr-2"></span> Large blue circles = Project locations (like meat on kebab)</p>
                <p>üç¢ The skewer extends 3x the project range to show the vertical alignment clearly</p>
            </div>
        </div>

        <!-- Top Alignments List -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üìç Top Impossible Alignments</h2>
            <div id="alignments-list" class="space-y-4">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Explanation -->
        <div class="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-blue-800 mb-4">üìö What This Means</h2>
            <div class="text-gray-700 space-y-3">
                <p>
                    <strong>What are "Coordinate Skewers"?</strong><br>
                    When multiple projects that are kilometers apart share the exact same longitude (to 5-6 decimal places), 
                    they appear as perfectly vertically aligned on a map - like food on a skewer stick.
                </p>
                <p>
                    <strong>Why is this a problem?</strong><br>
                    The probability of two projects 20km apart sharing the exact same longitude is astronomically low. 
                    This indicates systematic data quality issues.
                </p>
                <p>
                    <strong>Root Causes:</strong>
                </p>
                <ul class="list-disc list-inside ml-4 space-y-1">
                    <li>Low-precision geocoding systems</li>
                    <li>Copy-paste errors in data entry</li>
                    <li>Using municipality/city center coordinates for all projects in that area</li>
                    <li>Coordinate rounding or truncation during data import</li>
                </ul>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="bg-green-50 border-l-4 border-green-500 rounded-lg p-6">
            <h2 class="text-2xl font-bold text-green-800 mb-4">‚úÖ Recommended Actions</h2>
            <div class="text-gray-700 space-y-2">
                <p>‚Üí Re-geocode affected projects using high-precision geocoding services</p>
                <p>‚Üí Implement coordinate validation to detect impossible alignments</p>
                <p>‚Üí Use project-specific addresses instead of municipality centers</p>
                <p>‚Üí Require minimum 6 decimal places for coordinates (‚âà11cm precision)</p>
                <p>‚Üí Flag projects with duplicate/aligned coordinates for manual review</p>
            </div>
        </div>
    </div>

    <script>
        const alignmentData = [
            { longitude: 121.90806, projectCount: 2, distanceKm: 708.0, projects: [
                { lat: 7.101111111, lng: 121.9080556, city: 'ZAMBOANGA CITY', name: 'Construction of Flood Mitigation Structure, Barangay Labuan' },
                { lat: 13.479208, lng: 121.908064, city: 'MOGPOG (MARINDUQUE)', name: 'Construction of Flood Control Structure along Mogpog River' },
            ]},
            { longitude: 124.14895, projectCount: 2, distanceKm: 654.1, projects: [
                { lat: 7.864048, lng: 124.148948, city: 'BACOLOD-KALAWI', name: 'Construction of Flood (Slope Protection) Bacolod Kalawi Section' },
                { lat: 13.756505, lng: 124.148948, city: 'CARAMORAN (CATANDUANES)', name: 'Construction of Obi River Flood Control Structure System' },
            ]},
            { longitude: 122.00944, projectCount: 2, distanceKm: 589.9, projects: [
                { lat: 6.929306, lng: 122.009436, city: 'ZAMBOANGA CITY', name: 'Construction of Shoreline Protection at Sinunuc Section' },
                { lat: 12.243333, lng: 122.009444, city: 'LOOC, ROMBLON', name: 'Construction of Seawall at Poblacion' },
            ]},
            { longitude: 124.585, projectCount: 3, distanceKm: 499.8, projects: [
                { lat: 6.622222222, lng: 124.585, city: 'ISULAN (SULTAN KUDARAT)', name: 'Construction of Flood Control Structure, Ala River' },
                { lat: 8.1505556, lng: 124.585, city: 'TALAKAG (BUKIDNON)', name: 'Construction of Flood Control Structure along CDO City' },
                { lat: 11.124643, lng: 124.585002, city: 'KANANGA (LEYTE)', name: 'Construction of Bao Flood Control (Downstream)' },
            ]},
            { longitude: 123.00818, projectCount: 2, distanceKm: 425.5, projects: [
                { lat: 10.24562, lng: 123.00818, city: 'ISABELA (NEGROS OCCIDENTAL)', name: 'Construction of Binalbagan River Bank Slope Protection' },
                { lat: 14.07856111, lng: 123.0081806, city: 'BASUD (CAMARINES NORTE)', name: 'Construction of Flood Mitigation Structure along Malagonot River' },
            ]},
            { longitude: 121.01483, projectCount: 2, distanceKm: 422.8, projects: [
                { lat: 14.7349131786108, lng: 121.014831381282, city: 'CALOOCAN CITY', name: 'Construction of Drainage System, Union Workers, Barangay 167' },
                { lat: 18.54417, lng: 121.01483, city: 'SANTA PRAXEDES (CAGAYAN)', name: 'Construction of River Control Structure along Sitio Surngot' },
            ]},
            { longitude: 123.3234, projectCount: 2, distanceKm: 418.5, projects: [
                { lat: 9.64769, lng: 123.323401, city: 'MALABUYOC (CEBU)', name: 'Construction of Revetment Wall, Phase 2, Barangay Uno' },
                { lat: 13.4183, lng: 123.3234, city: 'NABUA (CAMARINES SUR)', name: 'Rehabilitation of Bicol River Basin Flood Control Structure' },
            ]},
            { longitude: 120.76099, projectCount: 2, distanceKm: 397.0, projects: [
                { lat: 14.818283, lng: 120.760985, city: 'HAGONOY (BULACAN)', name: 'Construction of Revetment at Sta. Elena - San Pedro along Angat River' },
                { lat: 18.395268, lng: 120.760986, city: 'VINTAR (ILOCOS NORTE)', name: 'Construction of Flood Mitigating Facilities along Bacarra-Vintar River' },
            ]},
            { longitude: 122.95141, projectCount: 2, distanceKm: 365.8, projects: [
                { lat: 10.8496629, lng: 122.9514145, city: 'SILAY CITY (NEGROS OCCIDENTAL)', name: 'Construction of Flood Mitigation Structure, Silay City' },
                { lat: 14.144894, lng: 122.951413, city: 'TALISAY (CAMARINES NORTE)', name: 'Construction of Flood Control Structure, Brgy. San Nicolas' },
            ]},
            { longitude: 120.61286, projectCount: 2, distanceKm: 344.4, projects: [
                { lat: 15.173196, lng: 120.61286, city: 'ANGELES CITY (PAMPANGA)', name: 'Construction of Slope Protection along Pulung Cacutud Creek' },
                { lat: 18.275643, lng: 120.612862, city: 'BACARRA (ILOCOS NORTE)', name: 'Construction of Flood Control Structure, Barangay Teppang' },
            ]},
        ];

        // Draw map with skewers
        async function drawSkewerMap() {
            const canvas = document.getElementById('map');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Load Philippine GeoJSON
            try {
                const response = await fetch('/static/data/philippines-regions.json');
                const geoJsonData = await response.json();
                
                // Calculate bounds
                let minLat = Infinity, maxLat = -Infinity;
                let minLng = Infinity, maxLng = -Infinity;
                
                geoJsonData.features.forEach(feature => {
                    if (feature.geometry.type === 'MultiPolygon') {
                        feature.geometry.coordinates.forEach(polygon => {
                            polygon.forEach(ring => {
                                ring.forEach(coord => {
                                    const [lng, lat] = coord;
                                    minLat = Math.min(minLat, lat);
                                    maxLat = Math.max(maxLat, lat);
                                    minLng = Math.min(minLng, lng);
                                    maxLng = Math.max(maxLng, lng);
                                });
                            });
                        });
                    }
                });
                
                // Calculate scale
                const scaleX = (width - 80) / (maxLng - minLng);
                const scaleY = (height - 80) / (maxLat - minLat);
                const scale = Math.min(scaleX, scaleY);
                const offsetX = (width - (maxLng - minLng) * scale) / 2 - minLng * scale;
                const offsetY = (height - (maxLat - minLat) * scale) / 2 - minLat * scale;
                
                const toCanvasCoords = (lng, lat) => ({
                    x: lng * scale + offsetX,
                    y: height - (lat * scale + offsetY)
                });
                
                // Clear and draw background
                ctx.fillStyle = '#f0f9ff';
                ctx.fillRect(0, 0, width, height);
                
                // Draw Philippines map
                geoJsonData.features.forEach(feature => {
                    if (feature.geometry.type === 'MultiPolygon') {
                        feature.geometry.coordinates.forEach(polygon => {
                            polygon.forEach(ring => {
                                ctx.beginPath();
                                ring.forEach((coord, i) => {
                                    const {x, y} = toCanvasCoords(coord[0], coord[1]);
                                    if (i === 0) ctx.moveTo(x, y);
                                    else ctx.lineTo(x, y);
                                });
                                ctx.closePath();
                                ctx.fillStyle = '#d1fae5';
                                ctx.fill();
                                ctx.strokeStyle = '#059669';
                                ctx.lineWidth = 1;
                                ctx.stroke();
                            });
                        });
                    }
                });
                
                // Draw skewers
                drawSkewersOnMap(ctx, toCanvasCoords);
                
            } catch (error) {
                console.error('Error loading Philippines map:', error);
                ctx.fillStyle = '#fee2e2';
                ctx.fillRect(0, 0, width, height);
                ctx.fillStyle = '#dc2626';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Error loading map', width/2, height/2);
            }
        }
        
        function drawSkewersOnMap(ctx, toCanvasCoords) {
            // Filter skewers to avoid latitude overlap
            // Sort by number of projects (more meat = priority)
            const sortedAlignments = [...alignmentData].sort((a, b) => b.projectCount - a.projectCount);
            
            const selectedSkewers = [];
            const usedLatRanges = [];
            
            // Check if latitude ranges overlap
            const rangesOverlap = (range1, range2) => {
                return !(range1.max < range2.min || range2.max < range1.min);
            };
            
            sortedAlignments.forEach(alignment => {
                const projects = alignment.projects.sort((a, b) => a.lat - b.lat);
                const minLat = projects[0].lat;
                const maxLat = projects[projects.length - 1].lat;
                const latRange = maxLat - minLat;
                
                // Include extension in overlap check
                const extension = latRange * 3;
                const newRange = {
                    min: minLat - extension,
                    max: maxLat + extension
                };
                
                // Check if this range overlaps with any already selected
                const overlaps = usedLatRanges.some(range => rangesOverlap(range, newRange));
                
                if (!overlaps) {
                    selectedSkewers.push(alignment);
                    usedLatRanges.push(newRange);
                }
            });
            
            console.log(`Selected ${selectedSkewers.length} skewers out of ${alignmentData.length} (no latitude overlap)`);
            
            // Draw selected skewers
            selectedSkewers.forEach((alignment, idx) => {
                const projects = alignment.projects.sort((a, b) => a.lat - b.lat);
                const lng = alignment.longitude;
                
                const minProjectLat = projects[0].lat;
                const maxProjectLat = projects[projects.length - 1].lat;
                const latRange = maxProjectLat - minProjectLat;
                
                // Extend skewer line above and below projects (much shorter extension)
                const extension = latRange * 0.5;
                const skewerTop = maxProjectLat + extension;
                const skewerBottom = minProjectLat - extension;
                
                const topCoords = toCanvasCoords(lng, skewerTop);
                const bottomCoords = toCanvasCoords(lng, skewerBottom);
                
                // Draw skewer line (very thin red solid vertical line)
                ctx.strokeStyle = '#dc2626';
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                ctx.moveTo(topCoords.x, topCoords.y);
                ctx.lineTo(bottomCoords.x, bottomCoords.y);
                ctx.stroke();
                
                // Draw project circles (very small)
                projects.forEach((project, pidx) => {
                    const coords = toCanvasCoords(project.lng, project.lat);
                    
                    // Circle (like meat on kebab) - just right
                    ctx.fillStyle = '#3b82f6';
                    ctx.strokeStyle = '#1e3a8a';
                    ctx.lineWidth = 0.6;
                    ctx.beginPath();
                    ctx.arc(coords.x, coords.y, 2.2, 0, 2 * Math.PI);
                    ctx.fill();
                    ctx.stroke();
                });
                
                // Label at top
                ctx.fillStyle = '#dc2626';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${alignment.projectCount} projects`, topCoords.x, topCoords.y - 10);
                ctx.font = '12px Arial';
                ctx.fillText(`${alignment.distanceKm}km`, topCoords.x, topCoords.y - 25);
            });
        }

        // Render alignments list
        function renderAlignments() {
            const container = document.getElementById('alignments-list');
            container.innerHTML = alignmentData.map((alignment, idx) => `
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <span class="text-2xl font-bold text-gray-800">#${idx + 1}</span>
                            <span class="ml-3 text-lg">Longitude: ${alignment.longitude}</span>
                        </div>
                        <div class="text-right">
                            <div class="text-red-600 font-bold text-xl">${alignment.distanceKm} km apart</div>
                            <div class="text-gray-500 text-sm">${alignment.projectCount} projects aligned</div>
                        </div>
                    </div>
                    <div class="space-y-2">
                        ${alignment.projects.map(p => `
                            <div class="bg-gray-50 rounded p-3 text-sm border-l-4 border-blue-500">
                                <div class="font-mono text-green-700">Lat: ${p.lat.toFixed(6)}, Lng: ${p.lng.toFixed(6)}</div>
                                <div class="text-blue-600 font-semibold">${p.city}</div>
                                <div class="text-gray-700">${p.name}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Initialize
        drawSkewerMap();
        renderAlignments();
    </script>
</body>
</html>
