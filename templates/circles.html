<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coordinate Skewers - Data Quality Analysis | BetterGovPH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
        }
        .skewer-canvas {
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-8 mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-3">
                üç¢ Coordinate Skewers
            </h1>
            <p class="text-xl text-gray-600 mb-2">Data Quality Anomaly Detection</p>
            <p class="text-gray-500">Impossible vertical alignments in project coordinates</p>
        </div>

        <!-- Warning Box -->
        <div class="bg-red-50 border-l-4 border-red-500 rounded-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-red-800 mb-3">‚ö†Ô∏è Data Quality Issue Detected</h2>
            <p class="text-red-700 text-lg mb-2">
                Multiple projects separated by <strong>up to 654 kilometers</strong> share the <strong>EXACT same longitude</strong>.
            </p>
            <p class="text-red-600">
                These projects are "skewered" on the same vertical line like meat on a kebab stick - spanning from Mindanao to Luzon, geometrically impossible without coordinate errors.
            </p>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="text-4xl mb-2">üéØ</div>
                <div class="text-3xl font-bold text-blue-600" id="total-alignments">10</div>
                <div class="text-gray-600">Vertical Alignments</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="text-4xl mb-2">üìè</div>
                <div class="text-3xl font-bold text-orange-600" id="max-distance">654</div>
                <div class="text-gray-600">Max Distance (km)</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="text-4xl mb-2">üî¥</div>
                <div class="text-3xl font-bold text-red-600" id="affected-projects">21</div>
                <div class="text-gray-600">Affected Projects</div>
            </div>
        </div>

        <!-- Map Visualization -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üó∫Ô∏è Skewer Visualization</h2>
            <p class="text-gray-600 mb-4">
                Thick red vertical lines are "skewers" with blue circles representing projects impossibly aligned on the same longitude
            </p>
            <canvas id="map" class="skewer-canvas w-full" width="1200" height="800"></canvas>
            <div class="mt-4 text-sm text-gray-600 space-y-1">
                <p><span class="inline-block w-1 h-6 bg-red-600 mr-2"></span> Thick red lines = "Skewers" extending above/below projects (same longitude)</p>
                <p><span class="inline-block w-3 h-3 rounded-full bg-blue-500 mr-2"></span> Large blue circles = Project locations (like meat on kebab)</p>
                <p>üç¢ The skewer extends 3x the project range to show the vertical alignment clearly</p>
            </div>
        </div>

        <!-- Top Alignments List -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üìç Top Impossible Alignments</h2>
            <div id="alignments-list" class="space-y-4">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Explanation -->
        <div class="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-blue-800 mb-4">üìö What This Means</h2>
            <div class="text-gray-700 space-y-3">
                <p>
                    <strong>What are "Coordinate Skewers"?</strong><br>
                    When multiple projects that are kilometers apart share the exact same longitude (to 5-6 decimal places), 
                    they appear as perfectly vertically aligned on a map - like food on a skewer stick.
                </p>
                <p>
                    <strong>Why is this a problem?</strong><br>
                    The probability of two projects 20km apart sharing the exact same longitude is astronomically low. 
                    This indicates systematic data quality issues.
                </p>
                <p>
                    <strong>Root Causes:</strong>
                </p>
                <ul class="list-disc list-inside ml-4 space-y-1">
                    <li>Low-precision geocoding systems</li>
                    <li>Copy-paste errors in data entry</li>
                    <li>Using municipality/city center coordinates for all projects in that area</li>
                    <li>Coordinate rounding or truncation during data import</li>
                </ul>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="bg-green-50 border-l-4 border-green-500 rounded-lg p-6">
            <h2 class="text-2xl font-bold text-green-800 mb-4">‚úÖ Recommended Actions</h2>
            <div class="text-gray-700 space-y-2">
                <p>‚Üí Re-geocode affected projects using high-precision geocoding services</p>
                <p>‚Üí Implement coordinate validation to detect impossible alignments</p>
                <p>‚Üí Use project-specific addresses instead of municipality centers</p>
                <p>‚Üí Require minimum 6 decimal places for coordinates (‚âà11cm precision)</p>
                <p>‚Üí Flag projects with duplicate/aligned coordinates for manual review</p>
            </div>
        </div>
    </div>

    <script>
        const alignmentData = [
            { longitude: 124.148948, projectCount: 2, distanceKm: 654.1, projects: [
                { lat: 7.864048, lng: 124.148948, city: 'BACOLOD-KALAWI (LANAO DEL SUR)', name: 'Construction of Flood (Slope Protection) Bacolod Kalawi Section' },
                { lat: 13.756505, lng: 124.148948, city: 'CARAMORAN (CATANDUANES)', name: 'Construction of Obi River Flood Control Structure System' },
            ]},
            { longitude: 120.70287, projectCount: 2, distanceKm: 323.7, projects: [
                { lat: 15.36632, lng: 120.70287, city: 'TARLAC', name: 'Rehabilitation of Existing Dike along Tinang River' },
                { lat: 18.28285, lng: 120.70287, city: 'VINTAR (ILOCOS NORTE)', name: 'Construction of Flood Control Structures along Bislak River' },
            ]},
            { longitude: 120.719052, projectCount: 2, distanceKm: 301.3, projects: [
                { lat: 15.004732, lng: 120.719052, city: 'SANTO TOMAS (PAMPANGA)', name: 'Construction of Flood Control Works Upstream Portion of Dalaquitan' },
                { lat: 17.718971, lng: 120.719052, city: 'SAN JUAN (ABRA)', name: 'Construction of Quidaoen - Cabcaburao Flood Control Structure' },
            ]},
            { longitude: 123.463, projectCount: 3, distanceKm: 235.9, projects: [
                { lat: 7.847, lng: 123.463, city: 'PAGADIAN CITY (ZAMBOANGA DEL SUR)', name: 'Construction of River Control Structure with Access Road' },
                { lat: 9.972412, lng: 123.463, city: 'RONDA (CEBU)', name: 'Construction of Dike Strucures along Talaba River' },
                { lat: 9.972412, lng: 123.463, city: 'RONDA (CEBU)', name: 'Construction of Revetment Wall at Barangay Vive - Barangay Tupas' },
            ]},
            { longitude: 124.585, projectCount: 2, distanceKm: 169.6, projects: [
                { lat: 6.622222222, lng: 124.585, city: 'ISULAN (SULTAN KUDARAT)', name: 'Construction of Flood Control Structure, Ala River' },
                { lat: 8.1505556, lng: 124.585, city: 'TALAKAG (BUKIDNON)', name: 'Construction of Flood Control Structure along CDO City' },
            ]},
            { longitude: 120.6024, projectCount: 2, distanceKm: 164.1, projects: [
                { lat: 14.9159, lng: 120.6024, city: 'LUBAO (PAMPANGA)', name: 'Construction of Slope Protection along Sapang Gumi' },
                { lat: 16.3943, lng: 120.6024, city: 'BAGUIO CITY (BENGUET)', name: 'Construction of Flood Mitigation Facilities/Drainage System' },
            ]},
            { longitude: 121.458056, projectCount: 3, distanceKm: 157.9, projects: [
                { lat: 12.854444, lng: 121.458056, city: 'BANSUD (ORIENTAL MINDORO)', name: 'Construction of Bansud River Control, Sta. 0+000 - Sta. 0+670' },
                { lat: 12.854722, lng: 121.458056, city: 'BANSUD (ORIENTAL MINDORO)', name: 'Construction of Bansud River Control, Poblacion Section' },
                { lat: 14.276944, lng: 121.458056, city: 'PAGSANJAN (LAGUNA)', name: 'Bank Improvement along Pagsanjan River' },
            ]},
            { longitude: 120.5455, projectCount: 2, distanceKm: 130.2, projects: [
                { lat: 14.81694, lng: 120.5455, city: 'ORANI (BATAAN)', name: 'Construction of Flood Control Structure along Pulo-Kabalutan River' },
                { lat: 15.9895, lng: 120.5455, city: 'CITY OF URDANETA (PANGASINAN)', name: 'Construction of Flood Mitigation Structure along Sinucalan River' },
            ]},
            { longitude: 120.445, projectCount: 2, distanceKm: 119.8, projects: [
                { lat: 16.093652, lng: 120.445, city: 'CURRIMAO (ILOCOS NORTE)', name: 'Rehabilitation of Flood Control Structure along Poblacion River' },
                { lat: 17.17277778, lng: 120.445, city: 'CITY OF CANDON (ILOCOS SUR)', name: 'Construction of Calaoan-Paras Flood Control' },
            ]},
            { longitude: 120.5964, projectCount: 2, distanceKm: 98.0, projects: [
                { lat: 15.1573, lng: 120.5964, city: 'ANGELES CITY (PAMPANGA)', name: 'Construction of Retaining Wall along Abacan Road Dike' },
                { lat: 16.04, lng: 120.5964, city: 'BINALONAN (PANGASINAN)', name: 'Construction of Flood Control Structure along Tagamusing River' },
            ]},
        ];

        // Draw map with skewers
        async function drawSkewerMap() {
            const canvas = document.getElementById('map');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Load Philippine GeoJSON
            try {
                const response = await fetch('/static/data/philippines-regions.json');
                const geoJsonData = await response.json();
                
                // Calculate bounds
                let minLat = Infinity, maxLat = -Infinity;
                let minLng = Infinity, maxLng = -Infinity;
                
                geoJsonData.features.forEach(feature => {
                    if (feature.geometry.type === 'MultiPolygon') {
                        feature.geometry.coordinates.forEach(polygon => {
                            polygon.forEach(ring => {
                                ring.forEach(coord => {
                                    const [lng, lat] = coord;
                                    minLat = Math.min(minLat, lat);
                                    maxLat = Math.max(maxLat, lat);
                                    minLng = Math.min(minLng, lng);
                                    maxLng = Math.max(maxLng, lng);
                                });
                            });
                        });
                    }
                });
                
                // Calculate scale
                const scaleX = (width - 80) / (maxLng - minLng);
                const scaleY = (height - 80) / (maxLat - minLat);
                const scale = Math.min(scaleX, scaleY);
                const offsetX = (width - (maxLng - minLng) * scale) / 2 - minLng * scale;
                const offsetY = (height - (maxLat - minLat) * scale) / 2 - minLat * scale;
                
                const toCanvasCoords = (lng, lat) => ({
                    x: lng * scale + offsetX,
                    y: height - (lat * scale + offsetY)
                });
                
                // Clear and draw background
                ctx.fillStyle = '#f0f9ff';
                ctx.fillRect(0, 0, width, height);
                
                // Draw Philippines map
                geoJsonData.features.forEach(feature => {
                    if (feature.geometry.type === 'MultiPolygon') {
                        feature.geometry.coordinates.forEach(polygon => {
                            polygon.forEach(ring => {
                                ctx.beginPath();
                                ring.forEach((coord, i) => {
                                    const {x, y} = toCanvasCoords(coord[0], coord[1]);
                                    if (i === 0) ctx.moveTo(x, y);
                                    else ctx.lineTo(x, y);
                                });
                                ctx.closePath();
                                ctx.fillStyle = '#d1fae5';
                                ctx.fill();
                                ctx.strokeStyle = '#059669';
                                ctx.lineWidth = 1;
                                ctx.stroke();
                            });
                        });
                    }
                });
                
                // Draw skewers
                drawSkewersOnMap(ctx, toCanvasCoords);
                
            } catch (error) {
                console.error('Error loading Philippines map:', error);
                ctx.fillStyle = '#fee2e2';
                ctx.fillRect(0, 0, width, height);
                ctx.fillStyle = '#dc2626';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Error loading map', width/2, height/2);
            }
        }
        
        function drawSkewersOnMap(ctx, toCanvasCoords) {
            // Filter skewers to avoid latitude overlap
            // Sort by number of projects (more meat = priority)
            const sortedAlignments = [...alignmentData].sort((a, b) => b.projectCount - a.projectCount);
            
            const selectedSkewers = [];
            const usedLatRanges = [];
            
            // Check if latitude ranges overlap
            const rangesOverlap = (range1, range2) => {
                return !(range1.max < range2.min || range2.max < range1.min);
            };
            
            sortedAlignments.forEach(alignment => {
                const projects = alignment.projects.sort((a, b) => a.lat - b.lat);
                const minLat = projects[0].lat;
                const maxLat = projects[projects.length - 1].lat;
                const latRange = maxLat - minLat;
                
                // Include extension in overlap check
                const extension = latRange * 3;
                const newRange = {
                    min: minLat - extension,
                    max: maxLat + extension
                };
                
                // Check if this range overlaps with any already selected
                const overlaps = usedLatRanges.some(range => rangesOverlap(range, newRange));
                
                if (!overlaps) {
                    selectedSkewers.push(alignment);
                    usedLatRanges.push(newRange);
                }
            });
            
            console.log(`Selected ${selectedSkewers.length} skewers out of ${alignmentData.length} (no latitude overlap)`);
            
            // Draw selected skewers
            selectedSkewers.forEach((alignment, idx) => {
                const projects = alignment.projects.sort((a, b) => a.lat - b.lat);
                const lng = alignment.longitude;
                
                const minProjectLat = projects[0].lat;
                const maxProjectLat = projects[projects.length - 1].lat;
                const latRange = maxProjectLat - minProjectLat;
                
                // Extend skewer line above and below projects (much shorter extension)
                const extension = latRange * 0.5;
                const skewerTop = maxProjectLat + extension;
                const skewerBottom = minProjectLat - extension;
                
                const topCoords = toCanvasCoords(lng, skewerTop);
                const bottomCoords = toCanvasCoords(lng, skewerBottom);
                
                // Draw skewer line (very thin red solid vertical line)
                ctx.strokeStyle = '#dc2626';
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                ctx.moveTo(topCoords.x, topCoords.y);
                ctx.lineTo(bottomCoords.x, bottomCoords.y);
                ctx.stroke();
                
                // Draw project circles (very small)
                projects.forEach((project, pidx) => {
                    const coords = toCanvasCoords(project.lng, project.lat);
                    
                    // Circle (like meat on kebab) - just right
                    ctx.fillStyle = '#3b82f6';
                    ctx.strokeStyle = '#1e3a8a';
                    ctx.lineWidth = 0.6;
                    ctx.beginPath();
                    ctx.arc(coords.x, coords.y, 2.2, 0, 2 * Math.PI);
                    ctx.fill();
                    ctx.stroke();
                });
                
                // Label at top
                ctx.fillStyle = '#dc2626';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${alignment.projectCount} projects`, topCoords.x, topCoords.y - 10);
                ctx.font = '12px Arial';
                ctx.fillText(`${alignment.distanceKm}km`, topCoords.x, topCoords.y - 25);
            });
        }

        // Render alignments list
        function renderAlignments() {
            const container = document.getElementById('alignments-list');
            container.innerHTML = alignmentData.map((alignment, idx) => `
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <span class="text-2xl font-bold text-gray-800">#${idx + 1}</span>
                            <span class="ml-3 text-lg">Longitude: ${alignment.longitude}</span>
                        </div>
                        <div class="text-right">
                            <div class="text-red-600 font-bold text-xl">${alignment.distanceKm} km apart</div>
                            <div class="text-gray-500 text-sm">${alignment.projectCount} projects aligned</div>
                        </div>
                    </div>
                    <div class="space-y-2">
                        ${alignment.projects.map(p => `
                            <div class="bg-gray-50 rounded p-3 text-sm border-l-4 border-blue-500">
                                <div class="font-mono text-green-700">Lat: ${p.lat.toFixed(6)}, Lng: ${p.lng.toFixed(6)}</div>
                                <div class="text-blue-600 font-semibold">${p.city}</div>
                                <div class="text-gray-700">${p.name}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Initialize
        drawSkewerMap();
        renderAlignments();
    </script>
</body>
</html>
