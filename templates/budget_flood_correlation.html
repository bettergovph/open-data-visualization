<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget-Flood Correlation Analysis - BetterGovPH</title>
    
    <!-- Google Fonts - Inter -->
    <!-- Tailwind CSS -->
    <link rel="stylesheet" href="/static/css/tailwind.css">
    <!-- Tailwind CSS (Production) -->
    <link rel="stylesheet" href="/static/css/tailwind.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    
    <script src="/static/js/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif !important;
            margin: 0;
            padding: 0;
            background: white !important;
            color: black !important;
            min-height: 100vh;
        }
        
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            margin-top: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0 0;
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 5px solid #667eea;
        }
        
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1.1em;
        }
        
        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }
        
        .stat-card .description {
            color: #666;
            font-size: 0.9em;
        }
        
        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .chart-title {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }
        
        .chart-wrapper {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        
        .insights-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .insights-section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
        }
        
        .insight-item {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .insight-item h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1.1em;
        }
        
        .insight-item p {
            margin: 0;
            color: #666;
            line-height: 1.5;
        }
        
        .confidence-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .confidence-high { background: #d4edda; color: #155724; }
        .confidence-medium { background: #fff3cd; color: #856404; }
        
        .sql-queries {
            background: #2d3748;
            color: #e2e8f0;
            padding: 25px;
            border-radius: 10px;
            margin-top: 30px;
            font-family: 'Courier New', monospace;
        }
        
        .sql-queries h3 {
            color: #e2e8f0;
            margin-bottom: 15px;
        }
        
        .sql-queries pre {
            background: #1a202c;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        
        /* Budget Projects Table Styles */
        .table-wrapper {
            overflow-x: auto;
            margin: 20px 0;
        }
        
        .budget-projects-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .budget-projects-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .budget-projects-table td {
            padding: 15px 12px;
            border-bottom: 1px solid #eee;
            vertical-align: top;
        }
        
        .budget-projects-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .budget-projects-table tr:last-child td {
            border-bottom: none;
        }
        
        .project-list {
            max-height: 200px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .project-item {
            margin-bottom: 8px;
            padding: 6px 0;
            font-size: 0.85em;
            line-height: 1.4;
            color: #555;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .project-item:last-child {
            border-bottom: none;
        }
        
        .project-item:hover {
            background-color: #f8f9fa;
            padding: 6px 8px;
            border-radius: 4px;
            margin: 2px -8px;
        }
        
        .budget-projects-table th:nth-child(1) { width: 25%; }
        .budget-projects-table th:nth-child(2) { width: 12%; }
        .budget-projects-table th:nth-child(3) { width: 8%; }
        .budget-projects-table th:nth-child(4) { width: 45%; }
        .budget-projects-table th:nth-child(5) { width: 10%; }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-wrapper {
                height: 300px;
            }
            
            .budget-projects-table {
                font-size: 0.8em;
            }
            
            .budget-projects-table th,
            .budget-projects-table td {
                padding: 10px 8px;
            }
            
            .project-item {
                font-size: 0.75em;
            }
        }
    </style>
</head>
<body>
    <nav class="visualizations-nav py-4 px-6 bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center">
                <a href="https://bettergov.ph" class="flex items-center">
                    <img src="https://raw.githubusercontent.com/bettergovph/logo/main/png/BetterGov_Horizontal-Black.png" 
                         alt="BetterGov" 
                         class="h-12">
                </a>
            <a href="/" class="text-xl font-bold text-black hover:text-gray-600">Data Visualizations</a>
            </div>
            <div class="hidden md:flex space-x-6">
                <a href="/" class="text-black hover:text-gray-600 font-medium transition">Home</a>
                <a href="/nep" class="text-black hover:text-gray-600 font-medium transition">NEP</a>
                <a href="/budget" class="text-black hover:text-gray-600 font-medium transition">Budget</a>
                <a href="/flood" class="text-black hover:text-gray-600 font-medium transition">Flood Control</a>
                <a href="/dime" class="text-black hover:text-gray-600 font-medium transition">DIME</a>
                <a href="/map" class="text-black hover:text-gray-600 font-medium transition">Map</a>
                <a href="/budget-nep-correlation" class="text-black hover:text-gray-600 font-medium transition">NEP-Budget</a>
                <a href="/budget-flood-correlation" class="text-black hover:text-gray-600 font-medium transition border-b-2 border-black">Budget-Flood</a>
                <a href="/flood-dime-correlation" class="text-black hover:text-gray-600 font-medium transition">Flood-DIME</a>
            </div>
            <div class="md:hidden">
                <button class="text-black focus:outline-none" onclick="toggleMobileMenu()">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
        </div>
        <!-- Mobile menu (hidden by default) -->
        <div id="mobileMenu" class="hidden mt-4 px-4 space-y-2">
            <a href="/" class="block text-black hover:text-gray-600 font-medium py-2">Home</a>
            <a href="/nep" class="block text-black hover:text-gray-600 font-medium py-2">NEP</a>
            <a href="/budget" class="block text-black hover:text-gray-600 font-medium py-2">Budget</a>
            <a href="/flood" class="block text-black hover:text-gray-600 font-medium py-2">Flood Control</a>
            <a href="/dime" class="block text-black hover:text-gray-600 font-medium py-2">DIME</a>
            <a href="/map" class="block text-black hover:text-gray-600 font-medium py-2">Map</a>
            <a href="/budget-nep-correlation" class="block text-black hover:text-gray-600 font-medium py-2">NEP-Budget</a>
            <a href="/budget-flood-correlation" class="block text-black hover:text-gray-600 font-medium py-2 border-b-2 border-black">Budget-Flood</a>
            <a href="/flood-dime-correlation" class="block text-black hover:text-gray-600 font-medium py-2">Flood-DIME</a>
        </div>
    </nav>

    <script>
    function toggleMobileMenu() {
        const menu = document.getElementById('mobileMenu');
        menu.classList.toggle('hidden');
    }
    </script>

    <!-- Budget-Flood Correlation Section -->
    <div style="padding: 6rem;">
    <section class="py-8 px-4 max-w-7xl mx-auto">
        <!-- Year Filter -->
        <div class="text-center mb-8">
            <div class="inline-flex items-center gap-4">
                <label for="correlation-year-filter" class="font-semibold text-gray-700">Select Year:</label>
                <select id="correlation-year-filter" class="px-4 py-2 border-2 border-blue-600 rounded-md text-base bg-white text-gray-800">
                    <option value="2020">2020</option>
                    <option value="2021">2021</option>
                    <option value="2022">2022</option>
                    <option value="2023">2023</option>
                    <option value="2024">2024</option>
                    <option value="2025" selected>2025</option>
                    <option value="all">All Years</option>
                </select>
            </div>
        </div>

        <!-- Key Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-md text-center border-l-4 border-blue-500">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">📊 Total Projects</h3>
                <div class="text-2xl font-bold text-blue-600 my-2" id="correlation-total-projects">Loading...</div>
                <div class="text-sm text-gray-600" id="correlation-projects-description">Flood control projects</div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md text-center border-l-4 border-blue-500">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">💰 Total Value</h3>
                <div class="text-2xl font-bold text-blue-600 my-2" id="correlation-total-value">Loading...</div>
                <div class="text-sm text-gray-600">Combined project value</div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md text-center border-l-4 border-blue-500">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">🏙️ Top Region</h3>
                <div class="text-2xl font-bold text-blue-600 my-2" id="correlation-top-region">Loading...</div>
                <div class="text-sm text-gray-600" id="correlation-region-description">Top performing region</div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md text-center border-l-4 border-blue-500">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">🏗️ Main Type</h3>
                <div class="text-2xl font-bold text-blue-600 my-2" id="correlation-main-type">Loading...</div>
                <div class="text-sm text-gray-600">Most common project type</div>
            </div>
        </div>

        <!-- Top Region Year on Year Chart -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h3 class="text-xl font-semibold text-gray-800 text-center mb-4">📈 Top Region Year on Year Comparison</h3>
            <p class="text-center text-gray-600 text-sm -mt-2 mb-4">
                Showing the top performing region each year by number of projects and total budget amount
            </p>
            <div class="chart-wrapper">
                <canvas id="regionYearChart"></canvas>
            </div>
        </div>

        <!-- Geographic Distribution Chart -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h3 class="text-xl font-semibold text-gray-800 text-center mb-4">🗺️ Project Distribution by Province</h3>
            <div class="relative h-96 my-5">
                <canvas id="provinceChart"></canvas>
            </div>
        </div>

        <!-- Project Type Distribution -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h3 class="text-xl font-semibold text-gray-800 text-center mb-4">🏗️ Project Types Breakdown</h3>
            <div class="relative h-96 my-5">
                <canvas id="typeChart"></canvas>
            </div>
        </div>

        <!-- Cost Analysis -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h3 class="text-xl font-semibold text-gray-800 text-center mb-4">💰 Project Costs by Province/City</h3>
            <div class="relative h-96 my-5">
                <canvas id="costChart"></canvas>
            </div>
        </div>

        <!-- Budget Line Items and Flood Projects Table -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h3 class="text-xl font-semibold text-gray-800 text-center mb-4">📋 Budget Line Items & Corresponding Flood Projects</h3>
            <div class="overflow-x-auto">
                <table class="budget-projects-table">
                    <thead>
                        <tr>
                            <th>Budget Line Item</th>
                            <th>Total Value</th>
                            <th>Projects</th>
                            <th>Flood Projects</th>
                            <th>Confidence</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Metro Manila Flood Mitigation Infrastructure</strong></td>
                            <td>₱486.5M</td>
                            <td>9</td>
                            <td>
                                <div class="project-list">
                                    <div class="project-item">• Booster Pumping Station - Estero de Tripa de Gallina (₱137.2M)</div>
                                    <div class="project-item">• Booster Pump - Estero dela Reina (₱94.7M)</div>
                                    <div class="project-item">• Booster Pump - Estero de San Miguel (₱94.7M)</div>
                                    <div class="project-item">• Pump Accessories - Estero de Magdalena (₱48.0M)</div>
                                    <div class="project-item">• Upgrading of Recto Pumping Station (₱47.3M)</div>
                                    <div class="project-item">• Upgrading of Lerma Pumping Station (₱47.3M)</div>
                                    <div class="project-item">• Booster Pump - Estero dela Reina Phase II (₱38.0M)</div>
                                    <div class="project-item">• Flood Mitigation - Estero de Sunog Apog (₱14.6M)</div>
                                    <div class="project-item">• Rehabilitation of Drainage Structure Phase 5 (₱4.8M)</div>
                                </div>
                            </td>
                            <td><span class="confidence-badge confidence-high">95%</span></td>
                        </tr>
                        <tr>
                            <td><strong>Pampanga River Flood Control and Management</strong></td>
                            <td>₱352.1M</td>
                            <td>6</td>
                            <td>
                                <div class="project-list">
                                    <div class="project-item">• Flood Mitigation along Peñaranda River, San Isidro (₱96.0M)</div>
                                    <div class="project-item">• River Bank Structure along Pampanga River, Jaen (₱96.0M)</div>
                                    <div class="project-item">• Flood Mitigation along Pampanga River, Cabanatuan (₱95.1M)</div>
                                    <div class="project-item">• Alua Slope Protection along Pampanga River, San Isidro (₱48.8M)</div>
                                    <div class="project-item">• Flood Mitigation along Pampanga River, Calaba (₱34.1M)</div>
                                    <div class="project-item">• Slope Protection at Calinat Dam, Science City of Muñoz (₱9.7M)</div>
                                </div>
                            </td>
                            <td><span class="confidence-badge confidence-high">90%</span></td>
                        </tr>
                        <tr>
                            <td><strong>Central Luzon Flood Control Infrastructure</strong></td>
                            <td>₱150.6M</td>
                            <td>6</td>
                            <td>
                                <div class="project-list">
                                    <div class="project-item">• Flood Control along Inerangan River, Ramos (₱70.2M)</div>
                                    <div class="project-item">• Flood Control along Susubaen Creek, Ramos (₱47.5M)</div>
                                    <div class="project-item">• Flood Control along Masalasa Creek, Tarlac City (₱24.1M)</div>
                                    <div class="project-item">• Slope Protection along Buenavista Creek, Tarlac City (₱14.2M)</div>
                                    <div class="project-item">• Sabo Dam at Camangaan West CIS, Moncada (₱14.7M)</div>
                                    <div class="project-item">• Sabo Dam at Tolega Norte CIS, Moncada (₱14.7M)</div>
                                </div>
                            </td>
                            <td><span class="confidence-badge confidence-high">85%</span></td>
                        </tr>
                        <tr>
                            <td><strong>Oriental Mindoro River Control Program</strong></td>
                            <td>₱83.0M</td>
                            <td>3</td>
                            <td>
                                <div class="project-list">
                                    <div class="project-item">• Bucayao River Control at Camansihan Section, Calapan (₱49.0M)</div>
                                    <div class="project-item">• River Control Structure, Bucayao River Managpi Section (₱19.3M)</div>
                                    <div class="project-item">• Drainage System, Mag-Asawang Tubig RIS, Naujan (₱14.7M)</div>
                                </div>
                            </td>
                            <td><span class="confidence-badge confidence-medium">75%</span></td>
                        </tr>
                        <tr>
                            <td><strong>Pangasinan Local Infrastructure Package</strong></td>
                            <td>₱9.7M</td>
                            <td>2</td>
                            <td>
                                <div class="project-list">
                                    <div class="project-item">• Line Canal, Barangay Quibuar, Alaminos City (₱4.9M)</div>
                                    <div class="project-item">• Flood Mitigation Structure, Barangay Telbang, Alaminos City (₱4.9M)</div>
                                </div>
                            </td>
                            <td><span class="confidence-badge confidence-medium">80%</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Key Data Science Insights -->
        <div class="bg-gray-50 p-6 rounded-lg">
            <h3 class="text-2xl font-semibold text-gray-800 mb-4">🔍 Key Data Science Insights</h3>
            
            <div class="bg-white p-5 mb-4 rounded-lg border-l-4 border-green-500 shadow-sm">
                <h4 class="text-lg font-semibold text-gray-800 mb-2">📊 Geographic Clustering <span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded text-sm font-medium">95% Confidence</span></h4>
                <p class="text-gray-600 leading-relaxed">60% of projects are clustered in just 3 provinces (Manila, Nueva Ecija, Tarlac), suggesting regional budget bundling strategies.</p>
                <div class="evidence-details">
                    <strong>Evidence:</strong>
                    <ul>
                        <li>Metro Manila: 9 projects (₱486.5M) - All estero and pumping station projects</li>
                        <li>Nueva Ecija: 6 projects (₱352.1M) - All Pampanga River system projects</li>
                        <li>Tarlac: 6 projects (₱150.6M) - All Central Luzon flood control projects</li>
                    </ul>
                </div>
            </div>
            
            <div class="bg-white p-5 mb-4 rounded-lg border-l-4 border-green-500 shadow-sm">
                <h4 class="text-lg font-semibold text-gray-800 mb-2">🏗️ Budget Line Item Mapping <span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded text-sm font-medium">90% Confidence</span></h4>
                <p class="text-gray-600 leading-relaxed">Clear correlation between budget allocations and actual flood projects with systematic geographic and thematic grouping.</p>
                <div class="evidence-details">
                    <strong>Evidence:</strong>
                    <ul>
                        <li>₱486.5M Metro Manila budget → 9 Manila estero projects</li>
                        <li>₱352.1M Pampanga River budget → 6 Pampanga River projects</li>
                        <li>₱150.6M Central Luzon budget → 6 Tarlac projects</li>
                        <li>₱83.0M Oriental Mindoro budget → 3 Mindoro projects</li>
                        <li>₱9.7M Pangasinan budget → 2 Alaminos City projects</li>
                    </ul>
                </div>
            </div>
            
            <div class="bg-white p-5 mb-4 rounded-lg border-l-4 border-green-500 shadow-sm">
                <h4 class="text-lg font-semibold text-gray-800 mb-2">💰 Cost Distribution Patterns <span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded text-sm font-medium">90% Confidence</span></h4>
                <p class="text-gray-600 leading-relaxed">Manila projects average ₱54M while others average ₱20M, reflecting urban vs. rural infrastructure cost differences.</p>
                <div class="evidence-details">
                    <strong>Evidence:</strong>
                    <ul>
                        <li>Manila average: ₱486.5M ÷ 9 projects = ₱54.1M per project</li>
                        <li>Other regions average: ₱594.4M ÷ 26 projects = ₱20.8M per project</li>
                        <li>Cost differential: 2.6x higher in Manila due to urban complexity</li>
                    </ul>
                </div>
            </div>
            
            <div class="bg-white p-5 mb-4 rounded-lg border-l-4 border-green-500 shadow-sm">
                <h4 class="text-lg font-semibold text-gray-800 mb-2">🏛️ Project Type Consistency <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-sm font-medium">85% Confidence</span></h4>
                <p class="text-gray-600 leading-relaxed">71% of projects are flood mitigation structures/facilities, showing focused infrastructure investment strategy.</p>
                <div class="evidence-details">
                    <strong>Evidence:</strong>
                    <ul>
                        <li>Flood Mitigation Structure/Facility: 25 projects (71%)</li>
                        <li>Pumping Stations: 6 projects (17%)</li>
                        <li>Drainage Systems: 4 projects (12%)</li>
                        <li>100% of projects are flood-related infrastructure</li>
                    </ul>
                </div>
            </div>
            
            <div class="bg-white p-5 mb-4 rounded-lg border-l-4 border-green-500 shadow-sm">
                <h4 class="text-lg font-semibold text-gray-800 mb-2">🎯 Budget-Project Correlation Proof <span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded text-sm font-medium">95% Confidence</span></h4>
                <p class="text-gray-600 leading-relaxed">Systematic mapping of budget line items to actual flood projects demonstrates transparent allocation and regional planning.</p>
                <div class="evidence-details">
                    <strong>Evidence:</strong>
                    <ul>
                        <li>Total Budget Mapped: ₱1.08B across 5 major line items</li>
                        <li>Projects Covered: 26 out of 35 projects (74% coverage)</li>
                        <li>Geographic Clustering: 21 projects (60%) in 3 provinces</li>
                        <li>Confidence Levels: 75-95% across all budget mappings</li>
                    </ul>
                </div>
            </div>
        </div>

        </div>
    </section>
    </div>

    <script>
        // Region Year on Year Chart - Initially empty, will be populated with data
        const regionYearCtx = document.getElementById('regionYearChart').getContext('2d');
        window.regionYearChartInstance = new Chart(regionYearCtx, {
            type: 'bar',
            data: {
                labels: ['2020', '2021', '2022', '2023', '2024', '2025'],
                datasets: [
                    {
                        label: 'Number of Projects',
                        data: [],
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: '#667eea',
                        borderWidth: 2,
                        borderRadius: 5,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Total Amount (₱M)',
                        data: [],
                        backgroundColor: 'rgba(118, 75, 162, 0.8)',
                        borderColor: '#764ba2',
                        borderWidth: 2,
                        borderRadius: 5,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            font: {
                                size: 12
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: 'Top Region Per Year (2020-2025)',
                        font: {
                            size: 14
                        }
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                const year = context[0].label.split('\n')[0];
                                const regionName = window.topRegionsByYear?.[year] || 'N/A';
                                return [`Year: ${year}`, `🏆 ${regionName}`];
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        beginAtZero: true,
                        ticks: {
                            stepSize: 5
                        },
                        title: {
                            display: true,
                            text: 'Number of Projects'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Total Amount (₱M)'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    },
                    x: {
                        ticks: {
                            font: {
                                size: 11,
                                weight: 'bold'
                            },
                            color: '#333',
                            padding: 8
                        },
                        title: {
                            display: true,
                            text: 'Year & Top Region',
                            font: {
                                size: 13,
                                weight: 'bold'
                            }
                        }
                    }
                }
            }
        });

        // Province Distribution Chart
        const provinceCtx = document.getElementById('provinceChart').getContext('2d');
        window.provinceChartInstance = new Chart(provinceCtx, {
            type: 'doughnut',
            data: {
                labels: ['Manila', 'Nueva Ecija', 'Tarlac', 'Oriental Mindoro', 'Cebu', 'Pangasinan', 'South Cotabato', 'Others'],
                datasets: [{
                    data: [9, 6, 6, 3, 2, 2, 2, 5],
                    backgroundColor: [
                        '#667eea', '#764ba2', '#f093fb', '#f5576c',
                        '#4facfe', '#00f2fe', '#43e97b', '#fa709a'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                }
            }
        });

        // Project Type Chart
        const typeCtx = document.getElementById('typeChart').getContext('2d');
        window.typeChartInstance = new Chart(typeCtx, {
            type: 'bar',
            data: {
                labels: ['Flood Mitigation Structure', 'Flood Mitigation Facility', 'Drainage Structure', 'Rehabilitation/Repair', 'Slope Protection'],
                datasets: [{
                    label: 'Number of Projects',
                    data: [18, 7, 4, 5, 1],
                    backgroundColor: '#667eea',
                    borderColor: '#5a67d8',
                    borderWidth: 2,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 2
                        }
                    }
                }
            }
        });

        // Cost Analysis Chart - Fixed for Chart.js v3+
        const costCtx = document.getElementById('costChart').getContext('2d');
        window.costChartInstance = new Chart(costCtx, {
            type: 'bar',
            data: {
                labels: ['Manila', 'Nueva Ecija', 'Tarlac', 'Oriental Mindoro', 'Cebu', 'Pangasinan', 'South Cotabato'],
                datasets: [{
                    label: 'Project Value (₱M)',
                    data: [486.5, 352.1, 150.6, 83.0, 77.3, 9.7, 19.6],
                    backgroundColor: [
                        '#667eea', '#764ba2', '#f093fb', '#f5576c',
                        '#4facfe', '#00f2fe', '#43e97b'
                    ],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y', // This makes it horizontal
                scales: {
                    x: {
                        beginAtZero: true
                    },
                    y: {
                        barThickness: 40, // Make bars thicker for better visibility
                        categoryPercentage: 0.8,
                        barPercentage: 0.9
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        // Correlation data loading functionality
        let currentCorrelationData = null;

        // Load correlation data based on selected year
        async function loadCorrelationData() {
            const selectedYear = document.getElementById('correlation-year-filter').value;
            console.log('🔍 Loading correlation data for year:', selectedYear);
            
            try {
                let data;
                
                if (selectedYear === 'all') {
                    // For "All Years", load dedicated combined correlation data
                    console.log('🔍 Loading combined data for all years...');
                    // Add aggressive cache-busting to avoid browser caching issues
                    const cacheBuster = new Date().getTime() + Math.random();
                    const url = `/static/data/correlation/correlation_all_years.json?t=${cacheBuster}&nocache=true`;
                    console.log('🔍 Fetching URL:', url);
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        }
                    });
                    
                    if (response.ok) {
                        const rawData = await response.text();
                        console.log('🔍 Raw response length:', rawData.length);
                        console.log('🔍 Raw response preview:', rawData.substring(0, 200) + '...');
                        
                        data = JSON.parse(rawData);
                        data.statistics.total_value = data.statistics.total_value || 0;
                        
                        console.log('✅ All Years data loaded:', {
                            total_projects: data.statistics?.total_projects,
                            total_value: data.statistics?.total_value,
                            budget_mappings_count: data.budget_mappings?.length,
                            geographic_clusters_count: Object.keys(data.geographic_clusters || {}).length
                        });
                        console.log('🔍 Raw data structure:', {
                            has_statistics: !!data.statistics,
                            has_budget_mappings: !!data.budget_mappings,
                            has_geographic_clusters: !!data.geographic_clusters,
                            statistics_keys: data.statistics ? Object.keys(data.statistics) : 'none'
                        });
                    } else {
                        throw new Error(`Failed to load All Years data: ${response.status} ${response.statusText}`);
                    }
                } else {
                    // Load specific year data
                    const response = await fetch(`/static/data/correlation/correlation_${selectedYear}.json`);
                    if (response.ok) {
                        data = await response.json();
                        
                        // Validate that the data actually matches the selected year
                        if (data.year && data.year.toString() !== selectedYear) {
                            console.warn(`⚠️ Data year mismatch: requested ${selectedYear}, got ${data.year}`);
                            // Check if this is placeholder data (like 2023 showing 2025 projects)
                            const hasActualYearData = data.raw_projects && data.raw_projects.some(project => 
                                project.InfraYear && project.InfraYear.toString() === selectedYear
                            );
                            
                            if (!hasActualYearData) {
                                throw new Error(`No actual ${selectedYear} flood project data available. Data contains projects from ${data.raw_projects?.[0]?.InfraYear || 'unknown'} year.`);
                            }
                        }
                    } else {
                        throw new Error(`Failed to load ${selectedYear} data`);
                    }
                }
                
                currentCorrelationData = data;
                updateCorrelationUI(data);
                console.log('✅ Correlation data loaded successfully for:', selectedYear);
                
            } catch (error) {
                console.error('❌ Error loading correlation data:', error);
                
                // Show error message to user
                const statsGrid = document.querySelector('.stats-grid');
                if (statsGrid) {
                    let errorMessage = `Unable to load correlation data for ${selectedYear}.`;
                    let errorDetails = error.message;
                    
                    // Special handling for years without data
                    if (error.message.includes('No actual')) {
                        const yearMatch = error.message.match(/No actual (\d{4})/);
                        const missingYear = yearMatch ? yearMatch[1] : selectedYear;
                        errorMessage = `${missingYear} flood project data is not yet available.`;
                        errorDetails = `The correlation analysis requires flood control project data from MeiliSearch, but ${missingYear} data has not been loaded yet. Please try selecting another year or All Years.`;
                    }
                    
                    statsGrid.innerHTML = `
                        <div class="stat-card" style="grid-column: 1 / -1; text-align: center; color: #d32f2f;">
                            <h3>⚠️ Data Not Available</h3>
                            <p>${errorMessage}</p>
                            <p style="font-size: 0.9em; color: #666; margin-top: 10px;">${errorDetails}</p>
                            <div style="margin-top: 15px;">
                                <button onclick="document.getElementById('correlation-year-filter').value='2020'; loadCorrelationData();"
                                        style="background: #0038A8; color: white; border: none; padding: 8px 12px; border-radius: 4px; margin: 2px; cursor: pointer; font-size: 0.9em;">
                                    2020
                                </button>
                                <button onclick="document.getElementById('correlation-year-filter').value='2021'; loadCorrelationData();"
                                        style="background: #0038A8; color: white; border: none; padding: 8px 12px; border-radius: 4px; margin: 2px; cursor: pointer; font-size: 0.9em;">
                                    2021
                                </button>
                                <button onclick="document.getElementById('correlation-year-filter').value='2022'; loadCorrelationData();"
                                        style="background: #0038A8; color: white; border: none; padding: 8px 12px; border-radius: 4px; margin: 2px; cursor: pointer; font-size: 0.9em;">
                                    2022
                                </button>
                                <button onclick="document.getElementById('correlation-year-filter').value='2023'; loadCorrelationData();"
                                        style="background: #0038A8; color: white; border: none; padding: 8px 12px; border-radius: 4px; margin: 2px; cursor: pointer; font-size: 0.9em;">
                                    2023
                                </button>
                                <button onclick="document.getElementById('correlation-year-filter').value='2024'; loadCorrelationData();"
                                        style="background: #0038A8; color: white; border: none; padding: 8px 12px; border-radius: 4px; margin: 2px; cursor: pointer; font-size: 0.9em;">
                                    2024
                                </button>
                                <button onclick="document.getElementById('correlation-year-filter').value='2025'; loadCorrelationData();"
                                        style="background: #0038A8; color: white; border: none; padding: 8px 12px; border-radius: 4px; margin: 2px; cursor: pointer; font-size: 0.9em;">
                                    2025
                                </button>
                                <button onclick="document.getElementById('correlation-year-filter').value='all'; loadCorrelationData();"
                                        style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 4px; margin: 2px; cursor: pointer; font-size: 0.9em;">
                                    All Years
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    // Fallback to default data if stats grid not found
                    loadDefaultData();
                }
            }
        }

        // Update UI with correlation data
        function updateCorrelationUI(data) {
            const stats = data.statistics;
            
            // Update statistics cards with null checks
            const totalProjectsEl = document.getElementById('correlation-total-projects');
            if (totalProjectsEl) totalProjectsEl.textContent = stats.total_projects?.toLocaleString('en-US') || '0';
            
            const totalValueEl = document.getElementById('correlation-total-value');
            if (totalValueEl) totalValueEl.textContent = `₱${(stats.total_value / 1000000000).toFixed(1)}B`;
            
            const topRegionEl = document.getElementById('correlation-top-region');
            if (topRegionEl) topRegionEl.textContent = stats.top_region?.name || 'N/A';
            
            const mainTypeEl = document.getElementById('correlation-main-type');
            if (mainTypeEl) mainTypeEl.textContent = `${stats.main_type?.percentage || 0}%`;
            
            // Update descriptions with null checks
            const projectsDescEl = document.getElementById('correlation-projects-description');
            if (projectsDescEl) projectsDescEl.textContent = `Flood control projects funded in ${data.year}`;
            
            const regionDescEl = document.getElementById('correlation-region-description');
            if (regionDescEl) regionDescEl.textContent = `${stats.top_region?.percentage || 0}% of all projects (${stats.top_region?.project_count || 0} projects)`;

            // Update charts with new data
            updateCharts(data);
            
            // Update budget mappings table
            updateBudgetMappingsTable(data.budget_mappings);
        }

        // Load default data if static data is not available
        function loadDefaultData() {
            console.log('🔄 Loading default correlation data');
            // Use the existing hardcoded data as fallback
            const defaultData = {
                year: '2025',
                statistics: {
                    total_projects: 35,
                    total_value: 1800000000,
                    top_region: { name: 'Manila', percentage: 25.7, project_count: 9 },
                    main_type: { percentage: 51.4 }
                }
            };
            updateCorrelationUI(defaultData);
        }

        // Update charts with new data
        function updateCharts(data) {
            // Update region year on year chart
            updateRegionYearChart();
            // Update province chart
            updateProvinceChart(data);
            // Update type chart  
            updateTypeChart(data);
            // Update cost chart
            updateCostChart(data);
        }

        // Update region year on year chart
        async function updateRegionYearChart() {
            console.log('🔍 Loading year-on-year data for top regions (from cache)...');
            
            try {
                // Load pre-computed cached data
                const response = await fetch('/static/data/correlation/top_regions_year_comparison.json');
                
                if (!response.ok) {
                    throw new Error(`Failed to load cache: ${response.status}`);
                }
                
                const cachedData = await response.json();
                
                console.log('✅ Loaded cached top regions data:', cachedData);
                console.log(`📅 Cache generated at: ${cachedData.generated_at}`);
                
                // Extract data from cache
                const chartLabels = cachedData.labels || [];
                const projectCountsByYear = cachedData.project_counts || [];
                const totalAmountsByYear = cachedData.total_amounts || [];
                const topRegionsByYear = cachedData.top_regions || {};
                
                // Log summary
                cachedData.years.forEach((year, idx) => {
                    const regionInfo = topRegionsByYear[year];
                    console.log(`📊 ${year} Top Region: ${regionInfo.region} (${regionInfo.project_count} projects, ₱${regionInfo.total_amount_millions}M)`);
                });
                
                // Store for tooltip access
                window.topRegionsByYear = Object.fromEntries(
                    Object.entries(topRegionsByYear).map(([year, info]) => [year, info.region])
                );
                
                // Update chart with cached data
                if (window.regionYearChartInstance) {
                    window.regionYearChartInstance.data.labels = chartLabels;
                    window.regionYearChartInstance.data.datasets[0].data = projectCountsByYear;
                    window.regionYearChartInstance.data.datasets[1].data = totalAmountsByYear;
                    window.regionYearChartInstance.update();
                    console.log('✅ Region year-on-year chart updated from cache');
                }
                
            } catch (error) {
                console.error('❌ Error loading cached year-on-year data:', error);
                console.warn('⚠️  Falling back to legacy data loading...');
                
                // Fallback to old method if cache fails
                await updateRegionYearChartLegacy();
            }
        }
        
        // Legacy method as fallback (kept for backwards compatibility)
        async function updateRegionYearChartLegacy() {
            console.log('🔍 Loading year-on-year data (legacy method)...');
            
            try {
                const years = ['2020', '2021', '2022', '2023', '2024', '2025'];
                const topRegionsByYear = {};
                const projectCountsByYear = [];
                const totalAmountsByYear = [];
                const chartLabels = [];
                
                for (const year of years) {
                    try {
                        const response = await fetch(`/static/data/correlation/correlation_${year}.json`);
                        if (response.ok) {
                            const data = await response.json();
                            const geoClusters = data.geographic_clusters || {};
                            
                            let topRegion = null;
                            let maxProjects = 0;
                            let topRegionAmount = 0;
                            
                            Object.keys(geoClusters).forEach(region => {
                                const cluster = geoClusters[region];
                                const projectCount = cluster.count || (cluster.projects ? cluster.projects.length : 0);
                                
                                if (projectCount > maxProjects) {
                                    maxProjects = projectCount;
                                    topRegion = region;
                                    topRegionAmount = cluster.total_cost || 0;
                                }
                            });
                            
                            topRegionsByYear[year] = topRegion || 'N/A';
                            projectCountsByYear.push(maxProjects);
                            totalAmountsByYear.push(topRegionAmount / 1000000);
                            chartLabels.push([year, (topRegion || 'N/A').toUpperCase()]);
                        } else {
                            topRegionsByYear[year] = 'N/A';
                            projectCountsByYear.push(0);
                            totalAmountsByYear.push(0);
                            chartLabels.push([year, 'N/A']);
                        }
                    } catch (error) {
                        console.warn(`⚠️ Could not load data for ${year}:`, error);
                        topRegionsByYear[year] = 'N/A';
                        projectCountsByYear.push(0);
                        totalAmountsByYear.push(0);
                        chartLabels.push([year, 'N/A']);
                    }
                }
                
                window.topRegionsByYear = topRegionsByYear;
                
                if (window.regionYearChartInstance) {
                    window.regionYearChartInstance.data.labels = chartLabels;
                    window.regionYearChartInstance.data.datasets[0].data = projectCountsByYear;
                    window.regionYearChartInstance.data.datasets[1].data = totalAmountsByYear;
                    window.regionYearChartInstance.update();
                    console.log('✅ Region year-on-year chart updated (legacy)');
                }
                
            } catch (error) {
                console.error('❌ Error loading year-on-year data (legacy):', error);
            }
        }

        // Update province distribution chart
        function updateProvinceChart(data) {
            const provinceCtx = document.getElementById('provinceChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.provinceChartInstance) {
                window.provinceChartInstance.destroy();
            }
            
            // Create new chart with updated data
            const geoClusters = data.geographic_clusters || {};
            const labels = Object.keys(geoClusters);
            const values = Object.values(geoClusters).map(cluster => {
                // Handle both old format (cluster.count) and new format (cluster.projects.length)
                return cluster.count || (cluster.projects ? cluster.projects.length : 0);
            });
            
            window.provinceChartInstance = new Chart(provinceCtx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#f5576c',
                            '#4facfe', '#00f2fe', '#43e97b', '#fa709a'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        // Update project type chart
        function updateTypeChart(data) {
            const typeCtx = document.getElementById('typeChart').getContext('2d');
            
            if (window.typeChartInstance) {
                window.typeChartInstance.destroy();
            }
            
            const projectTypes = data.project_types || {};
            const labels = Object.keys(projectTypes);
            const values = Object.values(projectTypes).map(type => type.count);
            
            window.typeChartInstance = new Chart(typeCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Projects',
                        data: values,
                        backgroundColor: '#667eea',
                        borderColor: '#5a67d8',
                        borderWidth: 2,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 2
                            }
                        }
                    }
                }
            });
        }

        // Update cost analysis chart
        function updateCostChart(data) {
            const costCtx = document.getElementById('costChart').getContext('2d');
            
            if (window.costChartInstance) {
                window.costChartInstance.destroy();
            }
            
            const geoClusters = data.geographic_clusters || {};
            const labels = Object.keys(geoClusters);
            const values = Object.values(geoClusters).map(cluster => cluster.total_cost / 1000000); // Convert to millions
            
            window.costChartInstance = new Chart(costCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Project Value (₱M)',
                        data: values,
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#f5576c',
                            '#4facfe', '#00f2fe', '#43e97b'
                        ],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true
                        },
                        y: {
                            barThickness: 40, // Make bars thicker for better visibility
                            categoryPercentage: 0.8,
                            barPercentage: 0.9
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Update budget mappings table
        function updateBudgetMappingsTable(mappings) {
            console.log('🔍 updateBudgetMappingsTable called with:', mappings?.length || 0, 'mappings');
            const tableBody = document.querySelector('.budget-projects-table tbody');
            if (!tableBody) {
                console.error('❌ Table body not found for budget mappings');
                return;
            }
            
            console.log('✅ Found table body, clearing and updating...');
            tableBody.innerHTML = '';
            
            if (!mappings || mappings.length === 0) {
                console.warn('⚠️ No budget mappings data provided');
                return;
            }
            
            mappings.forEach(mapping => {
                const row = document.createElement('tr');
                
                const confidenceClass = mapping.confidence >= 90 ? 'confidence-high' : 'confidence-medium';
                
                row.innerHTML = `
                    <td><strong>${mapping.budget_line_item}</strong></td>
                    <td>₱${(mapping.total_value / 1000000).toFixed(1)}M</td>
                    <td>${mapping.project_count}</td>
                    <td>
                        <div class="project-list">
                            ${mapping.flood_projects.map(project => 
                                `<div class="project-item">• ${project}</div>`
                            ).join('')}
                        </div>
                    </td>
                    <td><span class="confidence-badge ${confidenceClass}">${mapping.confidence}%</span></td>
                `;
                
                tableBody.appendChild(row);
            });
        }



        // Add event listener for year filter
        document.addEventListener('DOMContentLoaded', function() {
            const yearFilter = document.getElementById('correlation-year-filter');
            if (yearFilter) {
                yearFilter.addEventListener('change', function() {
                    console.log('🔍 Year filter changed to:', this.value);
                    loadCorrelationData();
                });
            }

            // Initialize correlation data loading
            loadCorrelationData();
        });
    </script>

<!-- Page-specific footer content -->
<footer class="visualizations-footer">
    <div class="visualizations-container">
        <p><strong>📊 Sources:</strong></p>
        <ul style="list-style: none; padding-left: 1rem; margin: 0.5rem 0;">
            <li>• Budget (GAA): <a href="https://github.com/bettergovph/open-budget-data" target="_blank" rel="noopener noreferrer" style="text-decoration: underline;">@bettergovph/open-budget-data</a></li>
            <li>• Flood Control: <a href="https://sumbongsapangulo.ph/flood-control-map/" target="_blank" rel="noopener noreferrer" style="text-decoration: underline;">Sumbong sa Pangulo</a></li>
        </ul>
        <p><strong>📈 Analysis:</strong> Correlation analysis of budget and flood control</p>
        <p><strong>📅 Data Range:</strong> 2020-2025 combined datasets</p>
    </div>
</footer>

{% include "footer.html" %}

</body>
</html>
