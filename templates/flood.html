<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flood Control Projects - BetterGovPH</title>

    <!-- Google Fonts - Inter -->
    <!-- Tailwind CSS -->
    <link rel="stylesheet" href="/static/css/tailwind.css">
    <!-- Tailwind CSS (Production) -->
    <link rel="stylesheet" href="/static/css/tailwind.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">


    <script src="/static/js/chart.js"></script>
    <!-- D3.js for network visualizations -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Leaflet for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- BetterGovPH Metadata -->
    <meta name="description" content="Flood Control Infrastructure Projects - Government Data Analysis Platform">
    <meta name="keywords" content="flood control, infrastructure, DPWH, government projects, Philippines, public works">
    <meta name="author" content="BetterGovPH">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ og_url | default(value='https://visualizations.bettergov.ph/') }}">
    <meta property="og:title" content="Flood Control Projects - BetterGovPH">
    <meta property="og:description" content="Government Data Analysis Platform for Flood Control Infrastructure Projects">
    <meta property="og:image" content="/static/images/gov_logo.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://visualizations.bettergov.ph/">
    <meta property="twitter:title" content="Flood Control Projects - BetterGovPH">
    <meta property="twitter:description" content="Government Data Analysis Platform for Flood Control Infrastructure Projects">
    <meta property="twitter:image" content="/static/images/gov_logo.png">

    <style>
        body {
            font-family: 'Inter', sans-serif !important;
            margin: 0;
            padding: 0;
            background: white !important;
            color: black !important;
            min-height: 100vh;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .flood-title {
                font-size: 2rem;
            }
            
            .flood-subtitle {
                font-size: 1rem;
            }
            
            .flood-container {
                padding: 0 0.5rem;
            }
            
            .flood-tabs {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .flood-tab {
                padding: 8px 12px;
                font-size: 0.9rem;
                flex: 1;
                min-width: 80px;
            }
            
            .statistics-grid {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
            
            .contractor-stats {
                grid-template-columns: 1fr !important;
            }
            
            .feature-grid {
                grid-template-columns: 1fr !important;
            }
            
            /* Table responsiveness */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 600px;
            }
            
            /* Button groups */
            .button-group {
                flex-direction: column;
                gap: 10px;
            }
            
            .button-group > div {
                width: 100%;
            }
            
            .button-group input,
            .button-group select,
            .button-group button {
                width: 100%;
                margin: 5px 0;
            }
            
            /* Chart containers */
            .chart-container {
                height: 250px !important;
            }
            
            /* Map container */
            #map {
                height: 300px !important;
            }
            
            /* Pagination */
            .pagination-info {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            /* Form controls */
            .form-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .form-controls > div {
                width: 100%;
                margin: 5px 0;
            }
        }
        
        @media (max-width: 480px) {
            .flood-title {
                font-size: 1.5rem;
            }
            
            .flood-subtitle {
                font-size: 0.9rem;
            }
            
            .flood-tab {
                padding: 6px 8px;
                font-size: 0.8rem;
            }
            
            .stat-card {
                padding: 15px !important;
            }
            
            .stat-card h4 {
                font-size: 1rem !important;
            }
            
            .stat-card p {
                font-size: 1.5rem !important;
            }
            
            /* Contractor table on mobile */
            table th,
            table td {
                padding: 8px 4px !important;
                font-size: 0.8rem;
            }
            
            /* Hide some columns on very small screens */
            .hide-mobile {
                display: none !important;
            }
        }



/* Style the main content area */
.container, .main-content {
    background: rgba(255, 255, 255, 0.95) !important;
    border-radius: 10px !important;
    padding: 20px !important;
    margin-top: 0 !important;
    margin-left: auto !important;
    margin-right: auto !important;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2) !important;
}

/* BetterGovPH theme colors */
h1, h2, h3, h4, h5, h6 {
    color: #0038A8 !important;
}

/* Loading spinner animation */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Budget tab button styling */
.budget-tab-btn {
    text-decoration: none;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-bottom: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px 8px 0 0;
    cursor: pointer;
    font-weight: 600;
    color: #666;
    transition: all 0.3s ease;
    position: relative;
    display: inline-block;
}

.budget-tab-btn:hover:not(.disabled) {
    background: #e9ecef;
    color: #333;
    text-decoration: none;
}

.budget-tab-btn.active {
    background: white;
    color: #667eea;
    border-color: #667eea;
    border-bottom: 2px solid white;
    margin-bottom: -2px;
    z-index: 1;
    text-decoration: none;
}

/* Style buttons with consistent blue theme (excluding tab buttons) */
.btn, button:not(.budget-tab-btn) {
    background: #2563eb !important; /* bg-blue-600 */
    color: white !important;
    border: none !important;
    border-radius: 4px !important;
    padding: 8px 16px !important;
    cursor: pointer !important;
    font-size: 14px !important;
    transition: all 0.2s ease !important;
}

.btn:hover, button:not(.budget-tab-btn):hover {
    background: #1d4ed8 !important; /* hover:bg-blue-700 */
    transform: translateY(-1px) !important;
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3) !important;
}

/* Tab content visibility */
.tab-content,
.budget-tab-panel {
    display: none;
}

.tab-content.active,
.budget-tab-panel.active {
    display: block !important;
}

/* Region tooltip styling */
.region-tooltip {
    font-size: 12px !important;
    padding: 4px 8px !important;
    max-width: 120px !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
}
</style>

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="{{ og_url | default(value='https://visualizations.bettergov.ph/') }}">
<meta property="og:title" content="Flood Control Projects - BetterGovPH">
<meta property="og:description" content="Government Data Analysis Platform for Flood Control Infrastructure Projects">
<meta property="og:image" content="/static/images/gov_logo.png">

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url" content="https://visualizations.bettergov.ph/">
<meta property="twitter:title" content="Flood Control Projects - BetterGovPH">
<meta property="twitter:description" content="Government Data Analysis Platform for Flood Control Infrastructure Projects">
<meta property="twitter:image" content="/static/images/gov_logo.png">
</head>
<body>
<!-- BetterGovPH Navigation Bar -->
<nav class="visualizations-nav py-4 px-6 bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
        <div class="flex items-center">
            <a href="https://bettergov.ph" class="flex items-center">
                <img src="https://raw.githubusercontent.com/bettergovph/logo/main/png/BetterGov_Horizontal-Black.png"
                     alt="BetterGov.ph"
                     class="h-12 mr-3">
                
            </a>
            <a href="/" class="text-xl font-bold text-black hover:text-gray-600">Data Visualizations</a>
        </div>
        <div class="hidden md:flex space-x-6">
            <a href="/" class="text-black hover:text-gray-600 font-medium transition">Home</a>
            <a href="/nep" class="text-black hover:text-gray-600 font-medium transition">NEP</a>
            <a href="/budget" class="text-black hover:text-gray-600 font-medium transition">Budget</a>
            <a href="/flood" class="text-black hover:text-gray-600 font-medium transition border-b-2 border-black">Flood Control</a>
            <a href="/dime" class="text-black hover:text-gray-600 font-medium transition">DIME</a>
            <a href="/map" class="text-black hover:text-gray-600 font-medium transition">Map</a>
            <a href="/budget-nep-correlation" class="text-black hover:text-gray-600 font-medium transition">NEP-Budget</a>
            <a href="/budget-flood-correlation" class="text-black hover:text-gray-600 font-medium transition">Budget-Flood</a>
            <a href="/flood-dime-correlation" class="text-black hover:text-gray-600 font-medium transition">Flood-DIME</a>
        </div>
        <div class="md:hidden">
            <button class="text-black focus:outline-none" onclick="toggleMobileMenu()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
        </div>
    </div>
    <!-- Mobile menu (hidden by default) -->
    <div id="mobileMenu" class="hidden mt-4 px-4 space-y-2">
        <a href="/" class="block text-black hover:text-gray-600 font-medium py-2">Home</a>
        <a href="/nep" class="block text-black hover:text-gray-600 font-medium py-2">NEP</a>
        <a href="/budget" class="block text-black hover:text-gray-600 font-medium py-2">Budget</a>
        <a href="/flood" class="block text-black hover:text-gray-600 font-medium py-2 border-b-2 border-black">Flood Control</a>
        <a href="/dime" class="block text-black hover:text-gray-600 font-medium py-2">DIME</a>
        <a href="/map" class="block text-black hover:text-gray-600 font-medium py-2">Map</a>
            <a href="/budget-nep-correlation" class="block text-black hover:text-gray-600 font-medium py-2">NEP-Budget</a>
        <a href="/budget-flood-correlation" class="block text-black hover:text-gray-600 font-medium py-2">Budget-Flood</a>
        <a href="/flood-dime-correlation" class="block text-black hover:text-gray-600 font-medium py-2">Flood-DIME</a>
    </div>
</nav>

<script>
function toggleMobileMenu() {
    const menu = document.getElementById('mobileMenu');
    menu.classList.toggle('hidden');
}
</script>

<!-- Flood Control Projects Section -->
<div style="padding: 6rem;">
<section class="flood-section">
    <div class="flood-container">
        <div class="flood-header">
        </div>

        <div class="flood-content">
            
            <!-- Flood Control Tabs -->
            <div class="budget-tabs">
                <div class="flex border-b-2 border-gray-200 mb-4 gap-2">
                    <a href="#visual" class="budget-tab-btn active bg-white text-blue-600 border-blue-600 border-t border-l border-r px-6 py-3 rounded-t-lg cursor-pointer font-semibold transition-all duration-300 relative -mb-0.5 z-10" data-tab="visual">üìä Visual</a>
                    <a href="#table" class="budget-tab-btn bg-gray-100 text-gray-600 border-gray-300 border px-6 py-3 rounded-t-lg cursor-pointer font-semibold transition-all duration-300 hover:bg-gray-200" data-tab="table">üìã Table</a>
                    <a href="#contractors" class="budget-tab-btn bg-gray-100 text-gray-600 border-gray-300 border px-6 py-3 rounded-t-lg cursor-pointer font-semibold transition-all duration-300 hover:bg-gray-200" data-tab="contractors">üë• Contractors</a>
                    <a href="#contractors-web" class="budget-tab-btn bg-gray-100 text-gray-600 border-gray-300 border px-6 py-3 rounded-t-lg cursor-pointer font-semibold transition-all duration-300 hover:bg-gray-200" data-tab="contractors-web">üï∏Ô∏è Contractors Web</a>
                    <a href="#sec" class="budget-tab-btn bg-gray-100 text-gray-600 border-gray-300 border px-6 py-3 rounded-t-lg cursor-pointer font-semibold transition-all duration-300 hover:bg-gray-200" data-tab="sec">üèõÔ∏è SEC</a>
                </div>
                <div class="budget-tab-content">
            
                    <div id="visual-tab" class="budget-tab-panel active">
                <!-- Statistics Cards -->
                <div class="statistics-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 mb-8">
                    <div class="stat-card bg-white p-5 rounded-lg shadow-lg text-center">
                        <h3 class="text-blue-900 m-0 mb-2 text-lg">Total Projects</h3>
                        <p id="total-projects" class="text-3xl font-bold text-red-600 m-0"></p>
                    </div>
                    <div class="stat-card bg-white p-5 rounded-lg shadow-lg text-center">
                        <h3 class="text-blue-900 m-0 mb-2 text-lg">Total Cost</h3>
                        <p id="total-cost" class="text-3xl font-bold text-red-600 m-0"></p>
                    </div>
                    <div class="stat-card bg-white p-5 rounded-lg shadow-lg text-center">
                        <h3 class="text-blue-900 m-0 mb-2 text-lg">Unique Contractors</h3>
                        <p id="unique-contractors" class="text-3xl font-bold text-red-600 m-0"></p>
                    </div>
                </div>
            
                <!-- Charts Section -->
                <div class="charts-grid" style="display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 30px;">
                    <!-- Top Contractors - Full Width -->
                    <div class="chart-container" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: #0038A8; margin: 0;">Top Contractors</h3>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <span id="visual-contractors-page-info" style="color: #666; font-size: 0.9em;"></span>
                                <button id="visual-contractors-prev" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8em;" disabled>‚Üê Previous</button>
                                <button id="visual-contractors-next" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8em;" disabled>Next ‚Üí</button>
                            </div>
                        </div>
                        <canvas id="contractorsChart" width="800" height="600"></canvas>
                    </div>
                    
                    <!-- Projects Heat Map - Full Width -->
                    <div class="chart-container bg-white p-5 rounded-lg shadow-lg">
                        <h3 class="text-blue-900 m-0 mb-4">Projects Heat Map <span class="text-sm text-gray-600">(Click to view detailed map)</span></h3>
                        <canvas id="regionsChart" width="1000" height="750" class="cursor-pointer border border-gray-300 rounded w-full max-w-full"></canvas>
                    </div>
                    
                    <!-- Contractor Distribution - Full Width -->
                    <div class="chart-container bg-white p-5 rounded-lg shadow-lg">
                        <h3 class="text-blue-900 m-0 mb-4">Contractor Project Distribution <span class="text-sm text-gray-600">(Standard Deviation Analysis)</span></h3>
                        <canvas id="contractorDistributionChart" width="800" height="300"></canvas>
                        <div class="mt-4 text-sm text-gray-600">
                            <p class="my-1"><strong>Average Projects per Contractor:</strong> <span id="dist-avg-projects">-</span></p>
                            <p class="my-1"><strong>Standard Deviation:</strong> <span id="dist-std-dev">-</span></p>
                            <p class="my-1"><strong>Contractors Beyond 3 SD:</strong> <span id="dist-beyond-3sd">-</span> <span class="text-red-600">(Highly Unusual)</span></p>
                        </div>
                    </div>
                    
                    <!-- Other Charts - Two columns -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div class="chart-container bg-white p-5 rounded-lg shadow-lg">
                            <h3 class="text-blue-900 m-0 mb-4">Types of Work</h3>
                            <canvas id="workTypesChart" width="400" height="200"></canvas>
                        </div>
                        <div class="chart-container bg-white p-5 rounded-lg shadow-lg">
                            <h3 class="text-blue-900 m-0 mb-4">Most Expensive Projects</h3>
                            <canvas id="expensiveProjectsChart" width="400" height="200"></canvas>
                        </div>
                        <div class="chart-container bg-white p-5 rounded-lg shadow-lg">
                            <h3 class="text-blue-900 m-0 mb-4">Projects by Year</h3>
                            <canvas id="yearlyChart" width="400" height="200"></canvas>
                        </div>
                        <div class="chart-container bg-white p-5 rounded-lg shadow-lg">
                            <h3 class="text-blue-900 m-0 mb-4">üí∞ Total Budget by Year</h3>
                            <canvas id="budgetByYearChart" width="400" height="200"></canvas>
                            <div class="mt-2 text-sm text-gray-600">
                                <p class="my-1"><strong>Total Budget:</strong> <span id="total-budget-amount">‚Ç±0</span></p>
                                <p class="my-1"><strong>Average per Project:</strong> <span id="avg-budget-per-project">‚Ç±0</span></p>
                                <p class="my-1"><strong>Highest Year:</strong> <span id="highest-budget-year">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- DPWH & SEC Data Source -->
                <div style="background: #e9ecef; padding: 15px; border-radius: 6px; margin-top: 20px; font-size: 0.9em; color: #495057;">
                    <p style="color: #666; font-size: 0.9em; margin: 0;">
                        <strong>Source:</strong> Department of Public Works and Highways (DPWH) Flood Control Information System, Securities and Exchange Commission (SEC) Philippines<br>
                        <strong>Total Projects:</strong> 9,855 flood control projects nationwide<br>
                        <strong>Data Range:</strong> 2016-2024 infrastructure projects
                    </p>
                    <p>&copy; 2025 BetterGovPH. All Rights Reserved.</p>
                    <p><a href="https://github.com/bettergovph/open-data-visualization" target="_blank" rel="noopener noreferrer">View Source on GitHub</a></p>
                    <p>@<a href="https://github.com/bettergovph/open-data-visualization" target="_blank" rel="noopener noreferrer">https://github.com/bettergovph/open-data-visualization</a></p>
                    <p>Maintainer: @<a href="https://github.com/joebertj" target="_blank" rel="noopener noreferrer">https://github.com/joebertj</a></p>
                    <p>For: BetterGov.PH</p>
                </div>
            </div>
            
                    <div id="table-tab" class="budget-tab-panel">
                <!-- Table view with real data -->
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div class="button-group" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #0038A8; margin: 0;">üìã Project Table View</h3>
                        <div style="display: flex; gap: 10px;">
                            <button id="export-table-csv" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                üìä Export CSV
                            </button>
                            <button id="refresh-table-data" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                üîÑ Refresh
                            </button>
                        </div>
            </div>
            
                    <!-- Table Search and Filters -->
                    <div class="table-filters bg-gray-50 p-5 rounded-lg mb-5">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <!-- Project Search with Autocomplete -->
                            <div class="filter-group">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">üîç Project Search</label>
                                <input type="text" id="table-project-search" placeholder="Search projects..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                <div id="project-autocomplete" style="display: none; position: absolute; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; width: 100%; box-shadow: 0 2px 10px rgba(0,0,0,0.1);"></div>
            </div>
            
                            <!-- Contractor Search with Autocomplete -->
                            <div class="filter-group">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">üë• Contractor</label>
                                <input type="text" id="table-contractor-filter" placeholder="Search contractors..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                <div id="contractor-autocomplete" style="display: none; position: absolute; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; width: 100%; box-shadow: 0 2px 10px rgba(0,0,0,0.1);"></div>
            </div>
                            
                            <!-- Region Filter -->
                            <div class="filter-group">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">üó∫Ô∏è Region</label>
                                <select id="table-region-filter" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                    <option value="">All Regions</option>
                                </select>
        </div>

                            <!-- Year Filter -->
                            <div class="filter-group">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">üìÖ Year</label>
                                <select id="table-year-filter" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                    <option value="">All Years</option>
                                </select>
                            </div>
                            
                            <!-- Type of Work Filter -->
                            <div class="filter-group">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">üîß Type of Work</label>
                                <select id="table-type-filter" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                    <option value="">All Types</option>
                                </select>
                            </div>
                            
                            <!-- Cost Range Filter -->
                            <div class="filter-group">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">üí∞ Cost Range (‚Ç±)</label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                                    <input type="number" id="table-cost-min" placeholder="Min" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                    <input type="number" id="table-cost-max" placeholder="Max" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sort and Actions -->
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 15px;">
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <label style="font-weight: 600; color: #333;">üìä Sort by:</label>
                                <select id="table-sort" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                    <option value="ContractCost">Cost (High to Low)</option>
                                    <option value="ContractCost-asc">Cost (Low to High)</option>
                                    <option value="InfraYear">Year (Newest)</option>
                                    <option value="InfraYear-asc">Year (Oldest)</option>
                                    <option value="ProjectDescription">Project Name</option>
                                    <option value="Region">Region</option>
                                    <option value="Contractor">Contractor</option>
                                </select>
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button id="clear-table-filters" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                                    üóëÔ∏è Clear Filters
                                </button>
                                <button id="export-table-csv" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                                    üìä Export CSV
                                </button>
                            </div>
                        </div>
                    </div>
            
                    <!-- Table Container -->
                    <div class="table-responsive" style="overflow-x: auto; border: 1px solid #ddd; border-radius: 4px;">
                        <table id="projects-table" style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead style="background: #0038A8; color: white;">
                                <tr>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">Project</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">Region</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">Year</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">Type</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 1px solid #ddd;" class="hide-mobile">Cost</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;" class="hide-mobile">Contractor</th>
                                </tr>
                            </thead>
                            <tbody id="projects-table-body">
                                <tr>
                                    <td colspan="6" style="padding: 40px; text-align: center; color: #666;">
                                        <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                                            <div style="font-size: 24px; animation: spin 2s linear infinite;">‚ü≥</div>
                                            <div>Loading data...</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
        </div>

                    <!-- Table Pagination -->
                    <div class="pagination-info" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                        <div style="color: #666; font-size: 14px;">
                            Showing <span id="table-showing">0</span> of <span id="table-total">0</span> projects
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button id="table-prev" style="padding: 8px 12px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;" disabled>
                                ‚Üê Previous
                            </button>
                            <span id="table-page-info" style="padding: 0 15px; font-size: 14px;">Page 1</span>
                            <button id="table-next" style="padding: 8px 12px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;" disabled>
                                Next ‚Üí
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- DPWH Data Source -->
                <div style="background: #e9ecef; padding: 15px; border-radius: 6px; margin-top: 20px; font-size: 0.9em; color: #495057;">
                    <p style="color: #666; font-size: 0.9em; margin: 0;">
                        <strong>Source:</strong> Department of Public Works and Highways (DPWH) Flood Control Information System<br>
                        <strong>Total Projects:</strong> 9,855 flood control projects nationwide<br>
                        <strong>Data Range:</strong> 2016-2024 infrastructure projects
                    </p>
                </div>
            </div>
            
                    <div id="contractors-tab" class="budget-tab-panel">
                <!-- Contractors Analysis -->
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h3 style="color: #0038A8; margin: 0 0 20px 0;">üë• Contractor Analysis</h3>
                    <p style="color: #666; margin: 0 0 20px 0;">Analyze contractor performance, project counts, and spending patterns</p>
                    
                    <!-- Contractor Statistics -->
                    <div class="contractor-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="stat-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <h4 style="color: #0038A8; margin: 0 0 5px 0; font-size: 1.2em;">Total Contractors</h4>
                            <p id="total-contractors-count" style="font-size: 2em; font-weight: bold; color: #28a745; margin: 0;"></p>
                        </div>
                        <div class="stat-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <h4 style="color: #0038A8; margin: 0 0 5px 0; font-size: 1.2em;">Top Contractor</h4>
                            <p id="top-contractor-name" style="font-size: 1.1em; font-weight: bold; color: #dc3545; margin: 0;"></p>
                        </div>
                        <div class="stat-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <h4 style="color: #0038A8; margin: 0 0 5px 0; font-size: 1.2em;">Avg Projects/Contractor</h4>
                            <p id="avg-projects-per-contractor" style="font-size: 2em; font-weight: bold; color: #ffc107; margin: 0;">Loading...</p>
                        </div>
                        <div class="stat-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <h4 style="color: #0038A8; margin: 0 0 5px 0; font-size: 1.2em;">Avg Cost/Project</h4>
                            <p id="avg-cost-per-project" style="font-size: 2em; font-weight: bold; color: #17a2b8; margin: 0;">Loading...</p>
                        </div>
                    </div>

                    <!-- Contractor Controls -->
                    <div class="form-controls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label for="contractor-search" style="font-weight: 600; color: #0038A8;">Search:</label>
                            <input type="text" id="contractor-search" placeholder="Search contractors..." style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; width: 200px;">
                            <button id="refresh-contractor-data" style="background: #0038A8; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">üîÑ Refresh</button>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label for="contractor-sort" style="font-weight: 600; color: #0038A8;">Sort by:</label>
                            <select id="contractor-sort" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="suspicion-desc">Suspicion Score (High to Low)</option>
                                <option value="suspicion-asc">Suspicion Score (Low to High)</option>
                                <option value="projects-desc">Projects (High to Low)</option>
                                <option value="projects-asc">Projects (Low to High)</option>
                                <option value="cost-desc">Total Cost (High to Low)</option>
                                <option value="cost-asc">Total Cost (Low to High)</option>
                                <option value="avg-cost-desc">Avg Cost/Project (High to Low)</option>
                                <option value="avg-cost-asc">Avg Cost/Project (Low to High)</option>
                                <option value="name-asc">Name (A to Z)</option>
                                <option value="name-desc">Name (Z to A)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Contractor Table -->
                    <div class="table-responsive" style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600; color: #0038A8;">Contractor Name</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6; font-weight: 600; color: #0038A8;">SEC Status</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 2px solid #dee2e6; font-weight: 600; color: #0038A8;">Projects</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 2px solid #dee2e6; font-weight: 600; color: #0038A8;">Total Cost</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 2px solid #dee2e6; font-weight: 600; color: #0038A8;">Avg Cost/Project</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6; font-weight: 600; color: #0038A8;">Suspicion Score</th>
                                </tr>
                            </thead>
                            <tbody id="contractors-table-body">
                                <tr>
                                    <td colspan="6" style="padding: 40px; text-align: center; color: #666;">
                                        <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                                            <div style="font-size: 24px;">üìä</div>
                                            <div>Loading contractor data...</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Contractor Pagination -->
                    <div class="pagination-info" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span id="contractors-showing">0</span> of <span id="contractors-total">0</span> contractors
                            <span id="contractors-page-info" style="margin-left: 10px; color: #666;"></span>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button id="contractors-prev" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;" disabled>‚Üê Previous</button>
                            <button id="contractors-next" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;" disabled>Next ‚Üí</button>
                        </div>
                    </div>
                </div>
                
                <!-- DPWH Data Source -->
                <div style="background: #e9ecef; padding: 15px; border-radius: 6px; margin-top: 20px; font-size: 0.9em; color: #495057;">
                    <p style="color: #666; font-size: 0.9em; margin: 0;">
                        <strong>Source:</strong> Department of Public Works and Highways (DPWH) Flood Control Information System<br>
                        <strong>Total Projects:</strong> 9,855 flood control projects nationwide<br>
                        <strong>Data Range:</strong> 2016-2024 infrastructure projects
                    </p>
                </div>
            </div>
            
                    <div id="contractors-web-tab" class="budget-tab-panel">
                <!-- Contractors Web - Joint Venture Network -->
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h3 style="color: #0038A8; margin: 0 0 20px 0;">üï∏Ô∏è Joint Venture Network</h3>
                    <p style="color: #666; margin: 0 0 20px 0;">Visualize relationships between companies through joint ventures. Each connection represents a shared project.</p>
                    
                    <!-- Network Statistics -->
                    <div class="network-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="stat-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <h4 style="color: #0038A8; margin: 0 0 5px 0; font-size: 1.2em;">Total JVs</h4>
                            <p id="jv-total-count" style="font-size: 2em; font-weight: bold; color: #28a745; margin: 0;">Loading...</p>
                        </div>
                        <div class="stat-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <h4 style="color: #0038A8; margin: 0 0 5px 0; font-size: 1.2em;">Unique Companies</h4>
                            <p id="jv-companies-count" style="font-size: 2em; font-weight: bold; color: #dc3545; margin: 0;">Loading...</p>
                        </div>
                        <div class="stat-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <h4 style="color: #0038A8; margin: 0 0 5px 0; font-size: 1.2em;">Total JV Value</h4>
                            <p id="jv-total-value" style="font-size: 2em; font-weight: bold; color: #ffc107; margin: 0;">Loading...</p>
                        </div>
                        <div class="stat-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <h4 style="color: #0038A8; margin: 0 0 5px 0; font-size: 1.2em;">Avg JV Value</h4>
                            <p id="jv-avg-value" style="font-size: 2em; font-weight: bold; color: #17a2b8; margin: 0;">Loading...</p>
                        </div>
                    </div>

                    <!-- Network Controls -->
                    <div class="form-controls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label for="network-search" style="font-weight: 600; color: #0038A8;">Search Company:</label>
                            <input type="text" id="network-search" placeholder="Filter by company name..." style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; width: 250px;">
                            <button id="network-reset" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">üîÑ Reset</button>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-weight: 600; color: #0038A8;">
                                <input type="checkbox" id="network-show-labels" checked> Show Labels
                            </label>
                            <button id="network-zoom-in" style="background: #0038A8; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">‚ûï Zoom In</button>
                            <button id="network-zoom-out" style="background: #0038A8; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">‚ûñ Zoom Out</button>
                        </div>
                    </div>

                    <!-- Network Visualization -->
                    <div style="position: relative; background: #fafafa; border: 2px solid #ddd; border-radius: 8px; overflow: hidden;">
                        <div id="network-graph" style="width: 100%; height: 700px; position: relative;"></div>
                        <div id="network-tooltip" style="position: absolute; display: none; background: white; border: 2px solid #0038A8; border-radius: 6px; padding: 10px; font-size: 0.9em; pointer-events: none; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.2);"></div>
                    </div>

                    <!-- Legend -->
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h4 style="color: #0038A8; margin: 0 0 10px 0;">Legend:</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 20px; height: 20px; background: #4CAF50; border-radius: 50%; border: 2px solid #2E7D32;"></div>
                                <span style="color: #666;">Company (Few JVs)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 20px; height: 20px; background: #FFC107; border-radius: 50%; border: 2px solid #FFA000;"></div>
                                <span style="color: #666;">Company (3-4 JVs)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 20px; height: 20px; background: #FF5722; border-radius: 50%; border: 2px solid #D32F2F;"></div>
                                <span style="color: #666;">Company (5-9 JVs)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 20px; height: 20px; background: #E91E63; border-radius: 50%; border: 2px solid #C2185B;"></div>
                                <span style="color: #666;">Company (10+ JVs)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 20px; height: 20px; background: #FF9800; border-radius: 50%; border: 2px solid #F57C00;"></div>
                                <span style="color: #666;">Joint Venture Project</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 40px; height: 3px; background: #2196F3;"></div>
                                <span style="color: #666;">JV Connection</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 40px; height: 2px; background: #FF5722; border-top: 2px dashed #FF5722;"></div>
                                <span style="color: #666;">‚ö†Ô∏è Similar Names</span>
                            </div>
                        </div>
                        <p style="margin-top: 10px; color: #666; font-size: 0.9em;">
                            <strong>Note:</strong> Node size = total contract value. Hover over nodes/lines for details. Click and drag to explore. Dashed red lines indicate potentially same company with different names.
                        </p>
                    </div>
                </div>
                
                <!-- DPWH Data Source -->
                <div style="background: #e9ecef; padding: 15px; border-radius: 6px; margin-top: 20px; font-size: 0.9em; color: #495057;">
                    <p style="color: #666; font-size: 0.9em; margin: 0;">
                        <strong>Source:</strong> Department of Public Works and Highways (DPWH) Flood Control Information System<br>
                        <strong>Joint Ventures:</strong> 386 identified partnerships (12.87% of all projects)<br>
                        <strong>Analysis:</strong> Companies connected through joint venture relationships
                    </p>
                </div>
            </div>
            
                    <div id="sec-tab" class="budget-tab-panel">
                <!-- SEC Data Analysis -->
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h3 style="color: #0038A8; margin: 0 0 20px 0;">üèõÔ∏è SEC Data Analysis</h3>
                    <p style="color: #666; margin: 0 0 20px 0;">Analyze contractor SEC registration data and identify contractors without SEC information</p>
                    
                    <!-- SEC Statistics -->
                    <div class="sec-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="stat-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <h4 style="color: #0038A8; margin: 0 0 5px 0; font-size: 1.2em;">Total Contractors</h4>
                            <p id="sec-total-contractors-count" style="font-size: 2em; font-weight: bold; color: #007bff; margin: 0;">Loading...</p>
                        </div>
                        <div class="stat-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <h4 style="color: #0038A8; margin: 0 0 5px 0; font-size: 1.2em;">Total SEC Records</h4>
                            <p id="total-sec-count" style="font-size: 2em; font-weight: bold; color: #28a745; margin: 0;">Loading...</p>
                        </div>
                        <div class="stat-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <h4 style="color: #0038A8; margin: 0 0 5px 0; font-size: 1.2em;">Without SEC Data</h4>
                            <p id="without-sec-count" style="font-size: 2em; font-weight: bold; color: #dc3545; margin: 0;">Loading...</p>
                        </div>
                        <div class="stat-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <h4 style="color: #0038A8; margin: 0 0 5px 0; font-size: 1.2em;">Coverage Rate</h4>
                            <p id="sec-coverage-rate" style="font-size: 2em; font-weight: bold; color: #ffc107; margin: 0;">Loading...</p>
                        </div>
                    </div>

                    <!-- Contractors Without SEC Data -->
                    <div class="chart-container" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
                        <h3 style="color: #dc3545; margin: 0 0 15px 0;">‚ö†Ô∏è Contractors Without SEC Data</h3>
                        <div id="contractorsWithoutSec" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                            <!-- Contractors without SEC data will be populated here -->
                        </div>
                    </div>

                    <!-- DPWH & SEC Data Information -->
                    <div style="background: #e9ecef; padding: 15px; border-radius: 6px; margin-top: 20px; font-size: 0.9em; color: #495057;">
                        <p style="color: #666; font-size: 0.9em; margin: 0;">
                            <strong>Source:</strong> Department of Public Works and Highways (DPWH) Flood Control Information System, Securities and Exchange Commission (SEC) Philippines<br>
                            <strong>Total Projects:</strong> 9,855 flood control projects nationwide<br>
                            <strong>Data Range:</strong> 2016-2024 infrastructure projects
                        </p>
                    </div>
                </div>
            </div>
                </div>
            </div>


    </div>

        </div>
    </div>
</section>
</div>

<script>
    // Flood Control Dashboard JavaScript
    class FloodControlDashboard {
        constructor() {
            this.currentPage = 0;
            this.pageSize = 20;
            this.currentFilters = {};
            this.currentQuery = '';
            
            // Progressive loading state
            this.loadedProjects = [];
            this.isLoading = false;
            this.isLoadingMore = false;
            this.initialLoadDone = false;
            this.progressiveLoadingStarted = false;
            this.progressiveLoadingCancelled = false;
            this.progressiveInterval = null;
            this.globalOffset = 10; // Start from offset 10 since we already have first 10 items
            
            this.init();
        }

        async init() {
        console.log('üèõÔ∏è BetterGovPH Flood Control Platform Loaded');
        
            // Load initial data
            await this.loadStatistics();
            await this.loadFilterOptions();
            
            // Setup event listeners
            this.setupEventListeners();
        
        // Add hover effects to feature cards
        document.querySelectorAll('.feature-card').forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-5px)';
            });
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });
        }

        setupEventListeners() {
            // Search button - check if exists
            const searchButton = document.getElementById('search-button');
            if (searchButton) {
                searchButton.addEventListener('click', () => {
                    this.performSearch();
                });
            }

            // Clear filters button - check if exists
            const clearFiltersButton = document.getElementById('clear-filters');
            if (clearFiltersButton) {
                clearFiltersButton.addEventListener('click', () => {
                    this.clearFilters();
                });
            }

            // Export button - check if exists
            const exportButton = document.getElementById('export-data');
            if (exportButton) {
                exportButton.addEventListener('click', () => {
                    this.exportData();
                });
            }

            // Show All button (in search controls) - check if exists
            const showAllButton = document.getElementById('show-all-button');
            if (showAllButton) {
                showAllButton.addEventListener('click', () => {
                    this.loadAllProjects();
                });
            }

            // Show All button (in warning section) - check if exists
            const showAllWarningButton = document.getElementById('show-all-button-warning');
            if (showAllWarningButton) {
                showAllWarningButton.addEventListener('click', () => {
                    this.loadAllProjects();
                });
            }

            // Enter key in search input - check if exists
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.performSearch();
                    }
                });
            }

            // Filter change events - check if exists
            const regionFilter = document.getElementById('table-region-filter');
            if (regionFilter) {
                regionFilter.addEventListener('change', () => {
                    this.updateProvinces();
                    this.performSearch();
                });
            }

            const provinceFilter = document.getElementById('province-filter');
            if (provinceFilter) {
                provinceFilter.addEventListener('change', () => {
                    this.performSearch();
                });
            }

            const yearFilter = document.getElementById('table-year-filter');
            if (yearFilter) {
                yearFilter.addEventListener('change', () => {
                    this.performSearch();
                });
            }

            // Pagination - check if exists
            const prevPage = document.getElementById('prev-page');
            if (prevPage) {
                prevPage.addEventListener('click', () => {
                    this.changePage(-1);
                });
            }

            const nextPage = document.getElementById('next-page');
            if (nextPage) {
                nextPage.addEventListener('click', () => {
                    this.changePage(1);
                });
            }
        }

        async loadStatistics() {
            console.log('üîç Loading flood control statistics...');
            
            // Get the elements from the Visual tab
            const totalProjectsEl = document.querySelector('#visual-tab #total-projects');
            const totalCostEl = document.querySelector('#visual-tab #total-cost');
            const uniqueContractorsEl = document.querySelector('#visual-tab #unique-contractors');
            
            if (!totalProjectsEl || !totalCostEl || !uniqueContractorsEl) {
                console.error('‚ùå Statistics elements not found');
                return;
            }
            
            // Load from API
            console.log('üîÑ Loading statistics from API...');
            try {
                const response = await fetch('/api/flood/statistics');
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ Statistics loaded from API:', data);
                    
                    totalProjectsEl.textContent = data.totalProjects.toLocaleString('en-PH');
                    totalCostEl.textContent = `‚Ç±${data.totalCost.toLocaleString('en-PH')}`;
                    uniqueContractorsEl.textContent = data.uniqueContractors.toLocaleString('en-PH');
                    
                    // Store actual total for table pagination
                    actualTotalProjects = data.totalProjects;
                    return;
                } else {
                    throw new Error(`API returned ${response.status}`);
                }
                
            } catch (error) {
                console.error('‚ùå Failed to load statistics from API:', error);
                
                // Show loading state instead of error
                console.log('üîÑ Showing loading state while data loads');
                totalProjectsEl.textContent = 'Loading...';
                totalProjectsEl.style.color = '#6c757d';
                totalCostEl.textContent = 'Loading...';
                totalCostEl.style.color = '#6c757d';
                uniqueContractorsEl.textContent = 'Loading...';
                uniqueContractorsEl.style.color = '#6c757d';
            }
        }

        async loadFilterOptions() {
            let staticData = null;
            
            // Load region mapping data first
            try {
                const mappingResponse = await fetch('/static/data/region-mapping.json');
                if (mappingResponse.ok) {
                    this.regionData = await mappingResponse.json();
                    console.log('üìç Region mapping data loaded:', this.regionData);
                }
            } catch (error) {
                console.error('Failed to load region mapping:', error);
            }
            
            try {
                // Load regions from cached data
                const regionsResponse = await fetch('/static/data/flood_control_data.json');
                if (regionsResponse.ok) {
                    const data = await regionsResponse.json();
                    
                    // Load regions for table filter
                    const tableRegionSelect = document.getElementById('table-region-filter');
                    if (tableRegionSelect && data.regions) {
                        data.regions.forEach(region => {
                            const option = document.createElement('option');
                            option.value = region.value;
                        
                            // Add project count if available in mapping data
                            const projectCount = this.regionData?.regionTotals?.[region];
                            const displayText = projectCount ? `${region} (${projectCount.toLocaleString('en-PH')} projects)` : region;
                            option.textContent = displayText;
                            
                            tableRegionSelect.appendChild(option);
                        });
                    }
                    
                    // Load regions for map filter
                    const mapRegionSelect = document.getElementById('map-region-filter');
                    if (mapRegionSelect && data.regions) {
                        data.regions.forEach(region => {
                            const option = document.createElement('option');
                            option.value = region.value;
                            option.textContent = region.value;
                            mapRegionSelect.appendChild(option);
                        });
                    }
                } else {
                    throw new Error('API not available');
                }

                // Load years from cached data
                const yearsResponse = await fetch('/static/data/flood_control_data.json');
                if (yearsResponse.ok) {
                    const data = await yearsResponse.json();
                    
                    // Load years for table filter
                    const tableYearSelect = document.getElementById('table-year-filter');
                    if (tableYearSelect && data.years) {
                        Object.keys(data.years).sort().reverse().forEach(year => {
                            const option = document.createElement('option');
                            option.value = year;
                            option.textContent = year;
                            tableYearSelect.appendChild(option);
                        });
                    }
                    
                    // Load years for map filter
                    const mapYearSelect = document.getElementById('map-year-filter');
                    if (mapYearSelect && data.years) {
                        Object.keys(data.years).sort().reverse().forEach(year => {
                            const option = document.createElement('option');
                            option.value = year;
                            option.textContent = year;
                            mapYearSelect.appendChild(option);
                        });
                    }
                } else {
                    throw new Error('API not available');
                }
            } catch (error) {
                console.error('Failed to load filter options from API:', error);
                
                // Fallback to static data
                try {
                    const response = await fetch('/static/data/flood_control_data.json');
                    staticData = await response.json();
                    
                    // Load regions from static data for table filter
                    const tableRegionSelect = document.getElementById('table-region-filter');
                    if (tableRegionSelect && staticData.regions) {
                        staticData.regions.forEach(region => {
                            const option = document.createElement('option');
                            option.value = region.value;
                            option.textContent = region.value;
                            tableRegionSelect.appendChild(option);
                        });
                    }
                    
                    // Load regions from static data for map filter
                    const mapRegionSelect = document.getElementById('map-region-filter');
                    if (mapRegionSelect && staticData.regions) {
                        staticData.regions.forEach(region => {
                            const option = document.createElement('option');
                            option.value = region.value;
                            option.textContent = region.value;
                            mapRegionSelect.appendChild(option);
                        });
                    }

                    // Load years from static data for table filter
                    const tableYearSelect = document.getElementById('table-year-filter');
                    if (tableYearSelect && staticData.years) {
                        staticData.years.sort((a, b) => b.value.localeCompare(a.value)).forEach(year => {
                            const option = document.createElement('option');
                            option.value = year.value;
                            option.textContent = year.value;
                            tableYearSelect.appendChild(option);
                        });
                    }
                    
                    // Load years from static data for map filter
                    const mapYearSelect = document.getElementById('map-year-filter');
                    if (mapYearSelect && staticData.years) {
                        staticData.years.sort((a, b) => b.value.localeCompare(a.value)).forEach(year => {
                            const option = document.createElement('option');
                            option.value = year.value;
                            option.textContent = year.value;
                            mapYearSelect.appendChild(option);
                        });
                    }
                    
                } catch (staticError) {
                    console.error('Failed to load static filter options:', staticError);
                }
            }
        }

        async updateProvinces() {
            const region = document.getElementById('table-region-filter').value;
            const provinceSelect = document.getElementById('province-filter');
            
            // Clear existing options except "All Provinces"
            provinceSelect.innerHTML = '<option value="">All Provinces</option>';
            
            if (region) {
                try {
                    const response = await fetch(`/api/flood/lookup/provinces?region=${encodeURIComponent(region)}`);
                    const provincesData = await response.json();
                    
                    provincesData.provinces.forEach(province => {
                        const option = document.createElement('option');
                        option.value = province;
                        option.textContent = province;
                        provinceSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('Failed to load provinces:', error);
                }
            }
        }

        async performSearch() {
            // Get current filters - define outside try/catch to ensure scope
            const filters = {
                query: document.getElementById('search-input').value,
                region: document.getElementById('table-region-filter').value,
                province: document.getElementById('province-filter').value,
                year: document.getElementById('table-year-filter').value
            };

            try {
                // Build query string
                const params = new URLSearchParams();
                if (filters.query) params.append('q', filters.query);
                if (filters.region) params.append('region', filters.region);
                if (filters.province) params.append('province', filters.province);
                if (filters.year) params.append('year', filters.year);
                params.append('limit', this.pageSize);
                params.append('offset', this.currentPage * this.pageSize);

                const response = await fetch(`/api/flood/projects?${params}`);
                
                if (response.ok) {
                    const data = await response.json();
                    this.displayResults(data);
                    this.updatePagination(data.totalHits);
                    return;
                } else {
                    throw new Error('API not available');
                }

            } catch (error) {
                console.error('Search failed, trying static data:', error);
                
                // Fallback to static data
                try {
                    const response = await fetch('/static/data/flood_control_data.json');
                    const staticData = await response.json();
                    
                    // Simple filtering of static data
                    let filteredProjects = staticData.projects;
                    
                    // Apply filters
                    if (filters.query) {
                        const query = filters.query.toLowerCase();
                        filteredProjects = filteredProjects.filter(project => 
                            project.ProjectDescription?.toLowerCase().includes(query) ||
                            project.Region?.toLowerCase().includes(query) ||
                            project.Province?.toLowerCase().includes(query) ||
                            project.Municipality?.toLowerCase().includes(query)
                        );
                    }
                    
                    if (filters.region) {
                        filteredProjects = filteredProjects.filter(project => 
                            project.Region === filters.region
                        );
                    }
                    
                    if (filters.year) {
                        filteredProjects = filteredProjects.filter(project => 
                            project.InfraYear === filters.year
                        );
                    }
                    
                    // Simulate API response format
                    const mockData = {
                        projects: filteredProjects,
                        totalHits: filteredProjects.length,
                        processingTimeMs: 0,
                        query: filters.query,
                        facetsDistribution: {}
                    };
                    
                    this.displayResults(mockData);
                    this.updatePagination(mockData.totalHits);
                    
                } catch (staticError) {
                    console.error('Static data search failed:', staticError);
                    this.displayError('Loading search results... Please wait a moment.');
                }
            }
        }

        displayResults(data) {
            const container = document.getElementById('projects-container');
            const resultsCount = document.getElementById('results-count');
            
            resultsCount.textContent = `${data.totalHits.toLocaleString('en-PH')} projects found`;
            
            if (data.projects.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>üîç No projects found matching your criteria</p>
                        <p>Try adjusting your search terms or filters</p>
                    </div>
                `;
                return;
            }

            const projectsHtml = data.projects.map(project => `
                <div class="project-card" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 15px; background: #fafafa;">
                    <h4 style="color: #0038A8; margin: 0 0 10px 0; font-size: 1.1em;">${this.escapeHtml(project.ProjectDescription || 'No Description')}</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 0.9em; color: #666;">
                        <div><strong>Region:</strong> ${this.escapeHtml(project.Region || 'N/A')}</div>
                        <div><strong>Province:</strong> ${this.escapeHtml(project.Province || 'N/A')}</div>
                        <div><strong>Municipality:</strong> ${this.escapeHtml(project.Municipality || 'N/A')}</div>
                        <div><strong>Year:</strong> ${this.escapeHtml(project.InfraYear || 'N/A')}</div>
                        <div><strong>Type of Work:</strong> ${this.escapeHtml(project.TypeofWork || 'N/A')}</div>
                        <div><strong>Contractor:</strong> ${this.escapeHtml(project.Contractor || 'N/A')}</div>
                        <div><strong>Cost:</strong> ${project.ContractCost ? `‚Ç±${parseFloat(project.ContractCost).toLocaleString('en-PH')}` : 'N/A'}</div>
                        <div><strong>DEO:</strong> ${this.escapeHtml(project.DistrictEngineeringOffice || 'N/A')}</div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = projectsHtml;
        }

        displayError(message) {
            const container = document.getElementById('projects-container');
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #dc3545;">
                    <p>‚ùå ${message}</p>
                </div>
            `;
        }

        updatePagination(totalHits) {
            const pagination = document.getElementById('pagination');
            const pageInfo = document.getElementById('page-info');
            const prevButton = document.getElementById('prev-page');
            const nextButton = document.getElementById('next-page');

            const totalPages = Math.ceil(totalHits / this.pageSize);
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'block';
            pageInfo.textContent = `Page ${this.currentPage + 1} of ${totalPages}`;
            
            prevButton.disabled = this.currentPage === 0;
            nextButton.disabled = this.currentPage >= totalPages - 1;
            
            prevButton.style.opacity = prevButton.disabled ? '0.5' : '1';
            nextButton.style.opacity = nextButton.disabled ? '0.5' : '1';
        }

        changePage(direction) {
            this.currentPage += direction;
            this.performSearch();
        }

        clearFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('table-region-filter').value = '';
            document.getElementById('province-filter').value = '';
            document.getElementById('table-year-filter').value = '';
            this.currentPage = 0;
            this.performSearch();
        }

        async exportData() {
            try {
                const filters = {
                    query: document.getElementById('search-input').value,
                    region: document.getElementById('table-region-filter').value,
                    province: document.getElementById('province-filter').value,
                    year: document.getElementById('table-year-filter').value
                };

                const params = new URLSearchParams();
                if (filters.query) params.append('q', filters.query);
                if (filters.region) params.append('region', filters.region);
                if (filters.province) params.append('province', filters.province);
                if (filters.year) params.append('year', filters.year);
                params.append('format', 'csv');

                const response = await fetch(`/api/flood/export?${params}`);
                const blob = await response.blob();
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `flood_control_projects_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

            } catch (error) {
                console.error('Export failed:', error);
                alert('Export failed. Please try again.');
            }
        }

        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Progressive loading methods based on BetterGov implementation
        async startProgressiveLoading() {
            if (this.progressiveLoadingStarted || this.progressiveLoadingCancelled) {
                return;
            }
            this.progressiveLoadingStarted = true;

            const loadMore = async () => {
                if (this.isLoadingMore || this.progressiveLoadingCancelled) return;

                this.isLoadingMore = true;

                try {
                    const currentOffset = this.globalOffset;
                    const currentPage = Math.floor(currentOffset / 10) + 1;

                    // Build query parameters for progressive loading
                    const params = new URLSearchParams();
                    params.append('limit', '10');
                    params.append('offset', currentOffset.toString());

                    const response = await fetch(`/api/flood/projects?${params}`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        const newProjects = data.projects || [];

                        // Add new projects to loaded projects
                        this.loadedProjects = [...this.loadedProjects, ...newProjects];
                        
                        // Update display with new projects
                        this.displayProgressiveResults();

                        // Check if we should continue loading
                        if (currentOffset >= data.totalHits || newProjects.length < 10) {
                            console.log('Progressive loading completed - reached end of data');
                            return;
                        }

                        this.globalOffset += 1000; // Jump 1000 items (100 pages) for faster loading

                        // Schedule next load only if not cancelled
                        if (!this.progressiveLoadingCancelled) {
                            setTimeout(loadMore, 1000); // 1 second delay
                        }
                    }
                } catch (error) {
                    console.error('Error loading more projects:', error);
                } finally {
                    this.isLoadingMore = false;
                }
            };

            // Start the chain only if not cancelled
            if (!this.progressiveLoadingCancelled) {
                setTimeout(loadMore, 1000);
            }
        }

        async loadAllProjects() {
            // Cancel all ongoing operations
            this.progressiveLoadingCancelled = true;
            this.progressiveLoadingStarted = false;
            this.isLoadingMore = false;

            // Clear any existing timeouts/intervals
            if (this.progressiveInterval) {
                clearInterval(this.progressiveInterval);
                this.progressiveInterval = null;
            }

            // Reset states
            this.isLoading = true;
            this.loadedProjects = [];

            // Reset loading flags
            this.initialLoadDone = false;
            this.progressiveLoadingCancelled = false;

            try {
                // Load first batch of 200 projects
                const params = new URLSearchParams();
                params.append('limit', '200');
                params.append('offset', '0');

                const response = await fetch(`/api/flood/projects?${params}`);
                
                if (response.ok) {
                    const data = await response.json();
                    const allProjects = data.projects || [];
                    this.loadedProjects = allProjects;

                    // Use region mapping data for better performance
                    const totalHits = this.regionData?.globalTotal || data.totalHits || 0;
                    const totalPages = this.regionData?.globalTotalPages || Math.ceil(totalHits / 200);

                    if (totalPages > 1 && totalHits > 200) {
                        let currentPage = 2;
                        this.progressiveLoadingStarted = true;

                        const loadMore = async () => {
                            if (this.isLoadingMore || this.progressiveLoadingCancelled) return;

                            this.isLoadingMore = true;

                            try {
                                const pageParams = new URLSearchParams();
                                pageParams.append('limit', '200');
                                pageParams.append('offset', ((currentPage - 1) * 200).toString());

                                const response = await fetch(`/api/flood/projects?${pageParams}`);
                                
                                if (response.ok) {
                                    const data = await response.json();
                                    const newProjects = data.projects || [];

                                    if (newProjects.length > 0 && !this.progressiveLoadingCancelled) {
                                        this.loadedProjects = [...this.loadedProjects, ...newProjects];
                                        this.displayProgressiveResults();
                                        currentPage++;

                                        if (currentPage <= totalPages && !this.progressiveLoadingCancelled) {
                                            setTimeout(loadMore, 1000); // 1 second delay
                                        }
                                    }
                                }
                            } catch (error) {
                                console.error('Error loading more projects:', error);
                            } finally {
                                this.isLoadingMore = false;
                            }
                        };

                        setTimeout(loadMore, 1000);
                    }

                    console.log('Show All clicked - progressive loading started');
                }
            } catch (error) {
                console.error('Error loading global data:', error);
            } finally {
                this.isLoading = false;
            }
        }

        displayProgressiveResults() {
            const container = document.getElementById('projects-container');
            const resultsCount = document.getElementById('results-count');
            
            if (!container) return;

            // Update results count
            if (resultsCount) {
                resultsCount.textContent = `Showing ${this.loadedProjects.length.toLocaleString('en-PH')} projects`;
            }

            // Display projects
            if (this.loadedProjects.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>üîç No projects found matching your criteria</p>
                    </div>
                `;
                return;
            }

            // Create project cards
            const projectsHtml = this.loadedProjects.map((project, index) => `
                <div class="project-card" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 15px; background: #fafafa; transition: all 0.3s ease;">
                    <h4 style="color: #0038A8; margin: 0 0 10px 0; font-size: 1.1em;">${this.escapeHtml(project.ProjectDescription || 'Unnamed Project')}</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 0.9em;">
                        <div><strong>Region:</strong> ${this.escapeHtml(project.Region || 'N/A')}</div>
                        <div><strong>Province:</strong> ${this.escapeHtml(project.Province || 'N/A')}</div>
                        <div><strong>Municipality:</strong> ${this.escapeHtml(project.Municipality || 'N/A')}</div>
                        <div><strong>Year:</strong> ${this.escapeHtml(project.InfraYear || 'N/A')}</div>
                        <div><strong>Type of Work:</strong> ${this.escapeHtml(project.TypeofWork || 'N/A')}</div>
                        <div><strong>Contractor:</strong> ${this.escapeHtml(project.Contractor || 'N/A')}</div>
                        <div><strong>Cost:</strong> ${project.ContractCost ? `‚Ç±${parseFloat(project.ContractCost).toLocaleString('en-PH')}` : 'N/A'}</div>
                        <div><strong>DEO:</strong> ${this.escapeHtml(project.DistrictEngineeringOffice || 'N/A')}</div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = projectsHtml;

            // Add loading indicator if still loading more
            if (this.isLoadingMore) {
                const totalProjects = this.regionData?.globalTotal || 9855;
                const progressPercent = Math.min((this.loadedProjects.length / totalProjects) * 100, 100);
                
                container.innerHTML += `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <p>üìä Loading more projects... (${this.loadedProjects.length.toLocaleString('en-PH')} of ${totalProjects.toLocaleString('en-PH')} loaded)</p>
                        <div style="width: 100%; height: 4px; background: #f0f0f0; border-radius: 2px; margin-top: 10px;">
                            <div style="width: ${progressPercent}%; height: 100%; background: linear-gradient(135deg, #0038A8 0%, #CE1126 100%); border-radius: 2px; transition: width 0.3s ease;"></div>
                        </div>
                        <p style="font-size: 0.8em; margin-top: 5px; color: #888;">
                            Progress: ${progressPercent.toFixed(1)}% complete
                        </p>
                    </div>
                `;
            }
        }
    }

    // Initialize dashboard when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize dashboard first
        const dashboard = new FloodControlDashboard();
        
        // Wait a bit for dashboard to fully initialize, then setup tabs
        setTimeout(() => {
            initializeTabs();
            
            // Set initial tab state - hide all tabs except visual
            const tabContents = document.querySelectorAll('.budget-tab-panel');
            tabContents.forEach(content => {
                if (content.id === 'visual-tab') {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            
            console.log('üîß Tabs initialized successfully');
        }, 100);
        
        initializeCharts();
        initializeMap();
        initializeTable();
        initializeContractors(); // Initialize contractor data
        setupEventListeners(); // Setup all button event listeners
    });

    // Setup all event listeners for buttons
    function setupEventListeners() {
        // Table-specific button event listeners
        const exportTableCsv = document.getElementById('export-table-csv');
        if (exportTableCsv) exportTableCsv.addEventListener('click', exportTableToCSV);
        
        const refreshTableDataBtn = document.getElementById('refresh-table-data');
        if (refreshTableDataBtn) refreshTableDataBtn.addEventListener('click', refreshTableData);
        
        const tablePrev = document.getElementById('table-prev');
        if (tablePrev) tablePrev.addEventListener('click', () => changeTablePage(-1));
        
        const tableNext = document.getElementById('table-next');
        if (tableNext) tableNext.addEventListener('click', () => changeTablePage(1));
        
        // Table filter event listeners
        const tableProjectSearch = document.getElementById('table-project-search');
        if (tableProjectSearch) {
            tableProjectSearch.addEventListener('input', () => {
                applyTableFilters();
                renderTable();
                setupProjectAutocomplete();
            });
        }
        
        const tableContractorFilter = document.getElementById('table-contractor-filter');
        if (tableContractorFilter) {
            tableContractorFilter.addEventListener('input', () => {
                applyTableFilters();
                renderTable();
                setupContractorAutocomplete();
            });
        }
        
        // Dropdown filters
        const tableRegionFilter = document.getElementById('table-region-filter');
        if (tableRegionFilter) tableRegionFilter.addEventListener('change', () => { applyTableFilters(); renderTable(); });
        
        const tableYearFilter = document.getElementById('table-year-filter');
        if (tableYearFilter) tableYearFilter.addEventListener('change', () => { applyTableFilters(); renderTable(); });
        
        const tableTypeFilter = document.getElementById('table-type-filter');
        if (tableTypeFilter) tableTypeFilter.addEventListener('change', () => { applyTableFilters(); renderTable(); });
        
        // Cost range filters
        const tableCostMin = document.getElementById('table-cost-min');
        if (tableCostMin) tableCostMin.addEventListener('input', () => { applyTableFilters(); renderTable(); });
        
        const tableCostMax = document.getElementById('table-cost-max');
        if (tableCostMax) tableCostMax.addEventListener('input', () => { applyTableFilters(); renderTable(); });
        
        const tableSort = document.getElementById('table-sort');
        if (tableSort) tableSort.addEventListener('change', renderTable);
        
        // Clear filters button
        const clearTableFilters = document.getElementById('clear-table-filters');
        if (clearTableFilters) {
            clearTableFilters.addEventListener('click', () => {
                document.getElementById('table-project-search').value = '';
                document.getElementById('table-contractor-filter').value = '';
                document.getElementById('table-region-filter').value = '';
                document.getElementById('table-year-filter').value = '';
                document.getElementById('table-type-filter').value = '';
                document.getElementById('table-cost-min').value = '';
                document.getElementById('table-cost-max').value = '';
                applyTableFilters();
                renderTable();
            });
        }
        
        // Map-specific button event listeners (will be set up after functions are defined)
        
        const refreshMapDataBtn = document.getElementById('refresh-map-data');
        if (refreshMapDataBtn) refreshMapDataBtn.addEventListener('click', refreshMapData);
        
        const mapRegionFilter = document.getElementById('map-region-filter');
        if (mapRegionFilter) mapRegionFilter.addEventListener('change', filterMapByRegion);
        
        const mapYearFilter = document.getElementById('map-year-filter');
        if (mapYearFilter) mapYearFilter.addEventListener('change', filterMapByYear);
        
        const mapWorkTypeFilter = document.getElementById('map-work-type-filter');
        if (mapWorkTypeFilter) mapWorkTypeFilter.addEventListener('change', filterMapByWorkType);
        
        // Contractor-specific button event listeners
        const refreshContractorDataBtn = document.getElementById('refresh-contractor-data');
        if (refreshContractorDataBtn) refreshContractorDataBtn.addEventListener('click', refreshContractorData);
        
        const contractorSearch = document.getElementById('contractor-search');
        if (contractorSearch) {
            contractorSearch.addEventListener('input', () => {
                applyContractorFilters();
                renderContractors();
            });
        }
        
        const contractorSort = document.getElementById('contractor-sort');
        if (contractorSort) contractorSort.addEventListener('change', renderContractors);
        
        const contractorsPrev = document.getElementById('contractors-prev');
        if (contractorsPrev) contractorsPrev.addEventListener('click', () => changeContractorPage(-1));
        
        const contractorsNext = document.getElementById('contractors-next');
        if (contractorsNext) contractorsNext.addEventListener('click', () => changeContractorPage(1));
        
        // Visual contractors chart pagination event listeners
        const visualContractorsPrev = document.getElementById('visual-contractors-prev');
        if (visualContractorsPrev) visualContractorsPrev.addEventListener('click', () => changeVisualContractorPage(-1));
        
        const visualContractorsNext = document.getElementById('visual-contractors-next');
        if (visualContractorsNext) visualContractorsNext.addEventListener('click', () => changeVisualContractorPage(1));
    }

    // Table functionality
    let currentTablePage = 0;
    const tablePageSize = 20;
    let allTableProjects = []; // Store all projects for table filtering/sorting
    let actualTotalProjects = 9855; // Store actual total from statistics
    let filteredTableProjects = []; // Store filtered projects for pagination

    async function initializeTable() {
        console.log('üîç Initializing table data...');
        
        // Update status
        updateTableStatus('Loading data...');
        
        try {
            const response = await fetch('/api/flood/projects?limit=1000'); // Start with 1000 projects
            if (response.ok) {
                const data = await response.json();
                allTableProjects = data.projects || [];
                console.log('‚úÖ Table data loaded from API:', allTableProjects.length, 'projects');
                updateTableStatus(`Loaded ${allTableProjects.length} projects from API`);
                createExpensiveProjectsChart();
            } else {
                throw new Error(`API returned ${response.status}`);
            }
        } catch (error) {
            console.error('‚ùå Error loading table data:', error);
            
            // Try static data fallback
            try {
                const staticResponse = await fetch('/static/data/flood_control_data.json');
                if (staticResponse.ok) {
                    const staticData = await staticResponse.json();
                    allTableProjects = staticData.projects || [];
                    console.log('‚úÖ Table data loaded from static fallback:', allTableProjects.length, 'projects');
                    updateTableStatus(`Loaded ${allTableProjects.length} projects from static data`);
                    createExpensiveProjectsChart();
                } else {
                    throw new Error('Static data also failed');
                }
            } catch (staticError) {
                console.error('‚ùå Static data fallback failed:', staticError);
                allTableProjects = [];
                updateTableStatus('Loading data...');
            }
        }
        
        // Populate filter dropdowns
        populateTableFilters();
        
        // Set default sort to cost descending
        const sortSelect = document.getElementById('table-sort');
        if (sortSelect) {
            sortSelect.value = 'ContractCost';
        }
        
        // Apply current filters and render
        applyTableFilters();
        renderTable();
        
        // Populate expensive projects from table data
        populateExpensiveProjectsFromTableData();
    }
    
    function updateTableStatus(message) {
        const statusElement = document.querySelector('#table-showing');
        if (statusElement) {
            statusElement.textContent = message;
        }
    }
    
    function applyTableFilters() {
        const projectSearch = document.getElementById('table-project-search')?.value.toLowerCase() || '';
        const contractorFilter = document.getElementById('table-contractor-filter')?.value.toLowerCase() || '';
        const regionFilter = document.getElementById('table-region-filter')?.value || '';
        const yearFilter = document.getElementById('table-year-filter')?.value || '';
        const typeFilter = document.getElementById('table-type-filter')?.value || '';
        const costMin = parseFloat(document.getElementById('table-cost-min')?.value) || 0;
        const costMax = parseFloat(document.getElementById('table-cost-max')?.value) || Infinity;
        
        console.log('üîç Applying filters:', { projectSearch, contractorFilter, regionFilter, yearFilter, typeFilter, costMin, costMax });
        
        console.log('üìä Total projects before filtering:', allTableProjects.length);
        if (yearFilter) {
            const sampleYears = allTableProjects.slice(0, 5).map(p => ({ infraYear: p.InfraYear, type: typeof p.InfraYear }));
            console.log('üìÖ Sample years in data:', sampleYears);
        }
        
        filteredTableProjects = allTableProjects.filter(project => {
            // Project search filter
            if (projectSearch && !project.ProjectDescription?.toLowerCase().includes(projectSearch)) {
                return false;
            }
            
            // Contractor filter
            if (contractorFilter && !project.Contractor?.toLowerCase().includes(contractorFilter)) {
                return false;
            }
            
            // Region filter
            if (regionFilter && project.Region !== regionFilter) {
                return false;
            }
            
            // Year filter - convert both to strings for comparison
            if (yearFilter && String(project.InfraYear) !== String(yearFilter)) {
                return false;
            }
            
            // Type filter
            if (typeFilter && project.TypeofWork !== typeFilter) {
                return false;
            }
            
            // Cost range filter
            const projectCost = parseFloat(project.ContractCost || 0);
            if (projectCost < costMin || projectCost > costMax) {
                return false;
            }
            
            return true;
        });
        
        // Reset to first page when filters change
        currentTablePage = 0;
    }
    
    // Autocomplete functions
    function setupProjectAutocomplete() {
        const input = document.getElementById('table-project-search');
        const autocomplete = document.getElementById('project-autocomplete');
        if (!input || !autocomplete) return;
        
        const searchTerm = input.value.toLowerCase();
        if (searchTerm.length < 2) {
            autocomplete.style.display = 'none';
            return;
        }
        
        // Get unique project descriptions that match
        const matches = [...new Set(allTableProjects
            .filter(p => p.ProjectDescription?.toLowerCase().includes(searchTerm))
            .map(p => p.ProjectDescription)
            .slice(0, 10))];
        
        if (matches.length > 0) {
            autocomplete.innerHTML = matches.map(match => 
                `<div class="autocomplete-item" style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;" onclick="selectProjectSuggestion('${match.replace(/'/g, "\\'")}')">${match}</div>`
            ).join('');
            autocomplete.style.display = 'block';
        } else {
            autocomplete.style.display = 'none';
        }
    }
    
    function setupContractorAutocomplete() {
        const input = document.getElementById('table-contractor-filter');
        const autocomplete = document.getElementById('contractor-autocomplete');
        if (!input || !autocomplete) return;
        
        const searchTerm = input.value.toLowerCase();
        if (searchTerm.length < 2) {
            autocomplete.style.display = 'none';
            return;
        }
        
        // Get unique contractors that match
        const matches = [...new Set(allTableProjects
            .filter(p => p.Contractor?.toLowerCase().includes(searchTerm))
            .map(p => p.Contractor)
            .slice(0, 10))];
        
        if (matches.length > 0) {
            autocomplete.innerHTML = matches.map(match => 
                `<div class="autocomplete-item" style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;" onclick="selectContractorSuggestion('${match.replace(/'/g, "\\'")}')">${match}</div>`
            ).join('');
            autocomplete.style.display = 'block';
        } else {
            autocomplete.style.display = 'none';
        }
    }
    
    function selectProjectSuggestion(value) {
        document.getElementById('table-project-search').value = value;
        document.getElementById('project-autocomplete').style.display = 'none';
        applyTableFilters();
        renderTable();
    }
    
    function selectContractorSuggestion(value) {
        document.getElementById('table-contractor-filter').value = value;
        document.getElementById('contractor-autocomplete').style.display = 'none';
        applyTableFilters();
        renderTable();
    }
    
    // Populate filter dropdowns
    function populateTableFilters() {
        // Populate regions
        const regionSelect = document.getElementById('table-region-filter');
        if (regionSelect) {
            const regions = [...new Set(allTableProjects.map(p => p.Region).filter(Boolean))].sort();
            regions.forEach(region => {
                const option = document.createElement('option');
                option.value = region;
                option.textContent = region;
                regionSelect.appendChild(option);
            });
        }
        
        // Populate years
        const yearSelect = document.getElementById('table-year-filter');
        if (yearSelect) {
            const years = [...new Set(allTableProjects.map(p => p.InfraYear).filter(Boolean))].sort((a, b) => {
                // Convert to numbers for proper sorting, handle string years
                const yearA = parseInt(String(a)) || 0;
                const yearB = parseInt(String(b)) || 0;
                return yearB - yearA; // Newest first
            });
            console.log('üìÖ Available years for filter:', years);
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = String(year); // Ensure value is string
                option.textContent = String(year);
                yearSelect.appendChild(option);
            });
        }
        
        // Populate types
        const typeSelect = document.getElementById('table-type-filter');
        if (typeSelect) {
            const types = [...new Set(allTableProjects.map(p => p.TypeofWork).filter(Boolean))].sort();
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeSelect.appendChild(option);
            });
        }
    }
    
    function renderTable() {
        const tableBody = document.getElementById('projects-table-body');
        const tableShowing = document.getElementById('table-showing');
        const tableTotal = document.getElementById('table-total');
        const tablePageInfo = document.getElementById('table-page-info');
        const tablePrevBtn = document.getElementById('table-prev');
        const tableNextBtn = document.getElementById('table-next');

        if (!tableBody) return;

        // Apply sorting
        const sortValue = document.getElementById('table-sort')?.value || 'ProjectDescription';
        const sortedProjects = [...filteredTableProjects].sort((a, b) => {
            if (sortValue === 'ContractCost') {
                return parseFloat(b.ContractCost || 0) - parseFloat(a.ContractCost || 0);
            } else if (sortValue === 'ContractCost-asc') {
                return parseFloat(a.ContractCost || 0) - parseFloat(b.ContractCost || 0);
            } else if (sortValue === 'InfraYear') {
                return parseInt(b.InfraYear || 0) - parseInt(a.InfraYear || 0);
            } else if (sortValue === 'InfraYear-asc') {
                return parseInt(a.InfraYear || 0) - parseInt(b.InfraYear || 0);
            } else {
                const valA = a[sortValue] || '';
                const valB = b[sortValue] || '';
                return valA.localeCompare(valB);
            }
        });

        const totalProjects = sortedProjects.length;
        const totalPages = Math.ceil(totalProjects / tablePageSize);

        const start = currentTablePage * tablePageSize;
        const end = start + tablePageSize;
        const projectsToDisplay = sortedProjects.slice(start, end);

        let html = '';
        if (projectsToDisplay.length === 0) {
            html = `
                <tr>
                    <td colspan="6" style="padding: 40px; text-align: center; color: #dc3545;">
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                            <div style="font-size: 24px;">‚ö†Ô∏è</div>
                            <div>No projects found matching your criteria.</div>
                        </div>
                    </td>
                </tr>
            `;
        } else {
            html = projectsToDisplay.map(project => `
                <tr>
                    <td style="padding: 12px; border-bottom: 1px solid #eee;">${escapeHtml(project.ProjectDescription || 'N/A')}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee;">${escapeHtml(project.Region || 'N/A')}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee;">${escapeHtml(project.InfraYear || 'N/A')}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee;">${escapeHtml(project.TypeofWork || 'N/A')}</td>
                    <td style="padding: 12px; text-align: right; border-bottom: 1px solid #eee;">${project.ContractCost ? `‚Ç±${parseFloat(project.ContractCost).toLocaleString('en-PH')}` : 'N/A'}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee;">${escapeHtml(project.Contractor || 'N/A')}</td>
                </tr>
            `).join('');
        }
        tableBody.innerHTML = html;

        // Update pagination info
        const showingCount = Math.min(end, filteredTableProjects.length);
        const totalCount = (filteredTableProjects.length === 1000) ? actualTotalProjects : filteredTableProjects.length;
        
        tableShowing.textContent = showingCount.toLocaleString('en-PH');
        tableTotal.textContent = totalCount.toLocaleString('en-PH');
        tablePageInfo.textContent = `Page ${currentTablePage + 1} of ${totalPages || 1}`;

        tablePrevBtn.disabled = currentTablePage === 0;
        tableNextBtn.disabled = currentTablePage >= totalPages - 1;
    }

    function exportTableToCSV() {
        console.log('üìä Exporting table to CSV...');
        
        if (allTableProjects.length === 0) {
            alert('No data to export');
            return;
        }
        
        let csvContent = "data:text/csv;charset=utf-8,";
        const headers = ["Project Description", "Region", "Province", "Year", "Type of Work", "Cost", "Contractor"];
        csvContent += headers.join(",") + "\n";

        allTableProjects.forEach(project => {
            const row = [
                `"${project.ProjectDescription || 'N/A'}"`,
                `"${project.Region || 'N/A'}"`,
                `"${project.Province || 'N/A'}"`,
                `"${project.InfraYear || 'N/A'}"`,
                `"${project.TypeofWork || 'N/A'}"`,
                `"${project.ContractCost ? parseFloat(project.ContractCost).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).replace(/‚Ç±|,/g, '') : 'N/A'}"`,
                `"${project.Contractor || 'N/A'}"`
            ];
            csvContent += row.join(",") + "\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "flood_control_projects.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function refreshTableData() {
        console.log('üîÑ Refreshing table data...');
        currentTablePage = 0;
        initializeTable();
    }

    function changeTablePage(direction) {
        const totalProjects = filteredTableProjects.length;
        const totalPages = Math.ceil(totalProjects / tablePageSize);
        currentTablePage = Math.max(0, Math.min(totalPages - 1, currentTablePage + direction));
        renderTable();
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Map functionality
    let mapInstance = null;
    let mapMarkers = [];
    let allMapProjects = [];
    let filteredMapProjects = [];

    async function loadAllMapProjects() {
        console.log('‚ö†Ô∏è Loading all map projects with warning...');
        
        // Show confirmation dialog with warning
        const confirmed = confirm(
            '‚ö†Ô∏è WARNING: Loading all 9,855 projects may:\n' +
            '‚Ä¢ Take several minutes to load\n' +
            '‚Ä¢ Impact browser performance\n' +
            '‚Ä¢ Use significant memory\n\n' +
            'Continue anyway?'
        );
        
        if (!confirmed) return;
        
        updateMapStatus('Loading all projects... This may take several minutes.');
        
        try {
            // Load all projects in batches
            const batchSize = 1000;
            let offset = 0;
            let totalLoaded = 0;
            
            while (true) {
                const response = await fetch(`/api/flood/projects?limit=${batchSize}&offset=${offset}`);
                if (response.ok) {
                    const data = await response.json();
                    const projects = data.projects || [];
                    
                    if (projects.length === 0) break;
                    
                    allMapProjects = allMapProjects.concat(projects);
                    totalLoaded += projects.length;
                    
                    updateMapStatus(`Loaded ${totalLoaded} projects...`);
                    
                    // Break if we got fewer projects than requested (end of data)
                    if (projects.length < batchSize) break;
                    
                    offset += batchSize;
                } else {
                    throw new Error(`API returned ${response.status}`);
                }
            }
            
            console.log(`‚úÖ Loaded ${allMapProjects.length} projects for map`);
            updateMapStatus(`Loaded ${allMapProjects.length} projects successfully`);
            
            // Apply current filters and render markers
            applyMapFilters();
            renderMapMarkers();
            
        } catch (error) {
            console.error('‚ùå Failed to load all map projects:', error);
            updateMapStatus('Loading all projects...');
        }
    }

    async function refreshMapData() {
        console.log('üîÑ Refreshing map data...');
        
        // Clear existing markers
        mapMarkers.forEach(marker => mapInstance.removeLayer(marker));
        mapMarkers = [];
        allMapProjects = [];
        
        // Load fresh data
        await loadAllMapProjects();
    }

    function filterMapByRegion() {
        const region = document.getElementById('map-region-filter')?.value;
        console.log('üó∫Ô∏è Filtering map by region:', region);
        applyMapFilters();
        renderMapMarkers();
    }

    function filterMapByYear() {
        const year = document.getElementById('map-year-filter')?.value;
        console.log('üó∫Ô∏è Filtering map by year:', year);
        applyMapFilters();
        renderMapMarkers();
    }

    function filterMapByWorkType() {
        const workType = document.getElementById('map-work-type-filter')?.value;
        console.log('üó∫Ô∏è Filtering map by work type:', workType);
        applyMapFilters();
        renderMapMarkers();
    }
    
    function applyMapFilters() {
        const region = document.getElementById('map-region-filter')?.value || '';
        const year = document.getElementById('map-year-filter')?.value || '';
        const workType = document.getElementById('map-work-type-filter')?.value || '';
        
        filteredMapProjects = allMapProjects.filter(project => {
            if (region && project.Region !== region) return false;
            if (year && project.InfraYear !== year) return false;
            if (workType && project.TypeofWork !== workType) return false;
            return true;
        });
        
        console.log(`üó∫Ô∏è Filtered to ${filteredMapProjects.length} projects`);
    }
    
    function renderMapMarkers() {
        // Clear existing markers
        mapMarkers.forEach(marker => mapInstance.removeLayer(marker));
        mapMarkers = [];
        
        if (!mapInstance) return;
        
        // Add markers for filtered projects (limit to 1000 for performance)
        const projectsToShow = filteredMapProjects.slice(0, 1000);
        
        projectsToShow.forEach(project => {
            // For now, we'll use approximate coordinates based on region
            // In a real implementation, you'd have actual coordinates
            const coords = getApproximateCoordinates(project.Region, project.Province);
            
            if (coords) {
                const marker = L.marker([coords.lat, coords.lng])
                    .addTo(mapInstance)
                    .bindPopup(`
                        <b>${project.ProjectDescription || 'N/A'}</b><br>
                        <strong>Region:</strong> ${project.Region || 'N/A'}<br>
                        <strong>Province:</strong> ${project.Province || 'N/A'}<br>
                        <strong>Year:</strong> ${project.InfraYear || 'N/A'}<br>
                        <strong>Type:</strong> ${project.TypeofWork || 'N/A'}<br>
                        <strong>Cost:</strong> ‚Ç±${project.ContractCost ? parseFloat(project.ContractCost).toLocaleString('en-PH') : 'N/A'}<br>
                        <strong>Contractor:</strong> ${project.Contractor || 'N/A'}
                    `);
                
                mapMarkers.push(marker);
            }
        });
        
        updateMapStatus(`${mapMarkers.length} markers displayed (${filteredMapProjects.length} total projects)`);
    }
    
    function getApproximateCoordinates(region, province) {
        // Approximate coordinates for major regions/provinces
        const coordinates = {
            'National Capital Region': { lat: 14.5995, lng: 120.9842 },
            'Region III': { lat: 15.4700, lng: 120.9500 },
            'Region IV-A': { lat: 14.4791, lng: 121.1900 },
            'Region IV-B': { lat: 13.9319, lng: 121.6178 },
            'Region V': { lat: 13.1394, lng: 123.7393 },
            'Region VI': { lat: 10.7202, lng: 122.5621 },
            'Region VII': { lat: 10.3157, lng: 123.8854 },
            'Region VIII': { lat: 11.2444, lng: 125.0058 },
            'Region IX': { lat: 8.1574, lng: 123.8854 },
            'Region X': { lat: 8.4800, lng: 124.6475 },
            'Region XI': { lat: 7.0731, lng: 125.6128 },
            'Region XII': { lat: 6.6919, lng: 124.8478 },
            'Region XIII': { lat: 8.7500, lng: 125.5000 },
            'Cordillera Administrative Region': { lat: 16.4023, lng: 120.5960 },
            'Autonomous Region in Muslim Mindanao': { lat: 7.1907, lng: 124.2460 }
        };
        
        return coordinates[region] || coordinates['National Capital Region'];
    }
    
    // Region click functionality with accurate GeoJSON boundaries
    let regionGeoJSONLayer = null;
    let regionMapping = {};
    
    async function addRegionClickFunctionality() {
        if (!mapInstance) return;
        
        try {
            // Load region mapping data
            const mappingResponse = await fetch('/static/data/region-mapping.json');
            if (mappingResponse.ok) {
                const mappingData = await mappingResponse.json();
                regionMapping = mappingData.regionMapping;
                console.log('üìç Region mapping loaded:', regionMapping);
            }
            
            // Load accurate GeoJSON boundaries
            const geoJsonResponse = await fetch('/static/data/philippines-regions.json');
            if (geoJsonResponse.ok) {
                const geoJsonData = await geoJsonResponse.json();
                
                // Add GeoJSON layer with accurate boundaries
                regionGeoJSONLayer = L.geoJSON(geoJsonData, {
                    style: {
                        color: '#0038A8',
                        weight: 2,
                        opacity: 0.8,
                        fillColor: '#0038A8',
                        fillOpacity: 0.1
                    },
                    onEachFeature: function(feature, layer) {
                        const regionName = feature.properties.name;
                        const meilisearchRegion = regionMapping[regionName] || regionName;
                        
                        // Bind tooltip
                        layer.bindTooltip(`Click ${regionName}`, {
                            permanent: false,
                            direction: 'center',
                            className: 'region-tooltip'
                        });
                        
                        // Add click handler
                        layer.on('click', function(e) {
                            console.log(`üó∫Ô∏è Region clicked: ${regionName} (${meilisearchRegion})`);
                            loadRegionProjects(meilisearchRegion);
                        });
                        
                        // Add hover effects
                        layer.on('mouseover', function(e) {
                            this.setStyle({
                                fillOpacity: 0.3,
                                weight: 3
                            });
                        });
                        
                        layer.on('mouseout', function(e) {
                            this.setStyle({
                                fillOpacity: 0.1,
                                weight: 2
                            });
                        });
                    }
                }).addTo(mapInstance);
                
                console.log('‚úÖ Accurate region boundaries loaded');
            } else {
                console.error('Failed to load GeoJSON data');
            }
        } catch (error) {
            console.error('Error loading region data:', error);
        }
    }
    
    // Progressive loading state for map
    let loadedProjects = [];
    let isLoading = false;
    let isLoadingMore = false;
    let initialLoadDone = false;
    let progressiveLoadingStarted = false;
    let progressiveLoadingCancelled = false;
    let regionProgressiveLoadingCancelled = false;
    let showAllMode = false; // Flag to indicate "Show All" is active
    let progressiveInterval = null;
    let globalOffset = 0; // Start from offset 0
    let regionData = null;

    async function loadRegionProjects(regionName) {
        console.log(`üó∫Ô∏è Loading projects for region: ${regionName}`);
        
        // Cancel global progressive loading when region is clicked
        progressiveLoadingCancelled = true;
        
        // Update status
        updateMapStatus(`Loading projects for ${regionName}...`);
        
        // Clear existing markers
        mapMarkers.forEach(marker => mapInstance.removeLayer(marker));
        mapMarkers = [];
        
        // Stop any existing progressive loading
        if (progressiveInterval) {
            clearInterval(progressiveInterval);
            progressiveInterval = null;
        }
        
        // Reset progressive loading state (exact copy from bettergov)
        progressiveLoadingStarted = false;
        progressiveLoadingCancelled = false; // Cancel global progressive loading
        regionProgressiveLoadingCancelled = false; // Reset region cancellation flag
        globalOffset = 0;
        isLoadingMore = false;
        loadedProjects = [];
        
        try {
            // Load initial batch of 100 projects for the region
            const response = await fetch(`/api/flood/projects?region=${encodeURIComponent(regionName)}&limit=100&offset=0`);
            if (response.ok) {
                const data = await response.json();
                const projects = data.projects || [];
                
                console.log(`‚úÖ Loaded initial ${projects.length} projects for ${regionName}`);
                loadedProjects = projects;
                
                // Add markers for initial projects
                addMarkersToMap(projects);
                
                // Load region totals for progressive loading
                if (!regionData) {
                    try {
                        const mappingResponse = await fetch('/static/data/region-mapping.json');
                        if (mappingResponse.ok) {
                            regionData = await mappingResponse.json();
                            console.log('üó∫Ô∏è Region data loaded:', regionData);
                        }
                    } catch (error) {
                        console.error('Failed to load region mapping:', error);
                    }
                }
                
                // Start progressive loading if we got a full batch and there are more
                const regionTotalHits = regionData?.regionTotals?.[regionName] || data.totalHits || 1000;
                const regionTotalPages = Math.ceil(regionTotalHits / 100);
                
                console.log(`üó∫Ô∏è Region ${regionName}: ${projects.length} loaded, ${regionTotalHits} total, ${regionTotalPages} pages`);
                
                // Debug the condition (exact copy from bettergov)
                console.log(`üó∫Ô∏è Debug progressive loading condition for ${regionName}:`);
                console.log(`  - projects.length === 100: ${projects.length === 100}`);
                console.log(`  - regionTotalPages > 1: ${regionTotalPages > 1}`);
                console.log(`  - regionTotalHits > 100: ${regionTotalHits > 100}`);
                console.log(`  - !progressiveLoadingStarted: ${!progressiveLoadingStarted}`);
                
                if (projects.length === 100 && regionTotalPages > 1 && regionTotalHits > 100 && !progressiveLoadingStarted) {
                    console.log(`üó∫Ô∏è Starting progressive loading for ${regionName}`);
                    startRegionProgressiveLoading(regionName, regionTotalPages, regionTotalHits);
                } else {
                    console.log(`üó∫Ô∏è No progressive loading needed for ${regionName} (${projects.length}/${regionTotalHits})`);
                }
                
                updateMapStatus(`${mapMarkers.length} projects loaded for ${regionName}${regionTotalPages > 1 ? ' (loading more...)' : ''}`);
                
            } else {
                throw new Error(`API returned ${response.status}`);
            }
            
        } catch (error) {
            console.error(`‚ùå Failed to load projects for ${regionName}:`, error);
            updateMapStatus(`Loading projects for ${regionName}...`);
        }
    }
    
    function startRegionProgressiveLoading(regionName, totalPages, totalHits) {
        if (progressiveLoadingStarted) return;
        
        progressiveLoadingStarted = true;
        let regionPage = 2; // Start from page 2 (since we already have page 1)
        
        const loadMoreRegion = async () => {
            console.log(`üó∫Ô∏è loadMoreRegion called for ${regionName}: page ${regionPage}/${totalPages}, isLoadingMore: ${isLoadingMore}, regionProgressiveLoadingCancelled: ${regionProgressiveLoadingCancelled}`);
            
            if (isLoadingMore || regionProgressiveLoadingCancelled) {
                console.log(`üó∫Ô∏è loadMoreRegion early return: isLoadingMore=${isLoadingMore}, regionProgressiveLoadingCancelled=${regionProgressiveLoadingCancelled}`);
                return;
            }
            
            console.log(`üó∫Ô∏è Starting loadMoreRegion with regionPage=${regionPage}`);
            setIsLoadingMore(true);
            
            try {
                const response = await fetch(`/api/flood/projects?region=${encodeURIComponent(regionName)}&limit=100&offset=${(regionPage - 1) * 100}`);
                const data = await response.json();
                const newProjects = data.projects || [];
                
                console.log(`üó∫Ô∏è Loading page ${regionPage}/${totalPages} for ${regionName}: ${newProjects.length} projects, total loaded: ${loadedProjects.length}/${totalHits}`);
                
                // Use JSON totals as source of truth, not API response (exact copy from bettergov)
                if (regionPage >= totalPages || loadedProjects.length >= totalHits) {
                    // Reached region limits, stopping progressive loading
                    console.log(`üó∫Ô∏è Stopping progressive loading for ${regionName}: page ${regionPage}/${totalPages}, loaded ${loadedProjects.length}/${totalHits}`);
                    updateMapStatus(`${loadedProjects.length} projects loaded for ${regionName} (complete)`);
                } else if (regionPage === totalPages) {
                    // Special handling for last page - might have fewer than 100 items
                    loadedProjects = [...loadedProjects, ...newProjects];
                    addMarkersToMap(newProjects);
                    console.log(`üó∫Ô∏è Last page loaded for ${regionName}: ${loadedProjects.length} total`);
                    updateMapStatus(`${loadedProjects.length} projects loaded for ${regionName} (complete)`);
                } else {
                    loadedProjects = [...loadedProjects, ...newProjects];
                    addMarkersToMap(newProjects);
                    regionPage += 1; // Move to next page sequentially
                    
                    console.log(`üó∫Ô∏è Continuing progressive loading for ${regionName}: next page ${regionPage}`);
                    // Schedule next load (with minimal delay)
                    console.log(`üó∫Ô∏è Scheduling next region loadMoreRegion call...`);
                    setIsLoadingMore(false); // Reset flag before recursive call
                    setTimeout(() => {
                        if (!regionProgressiveLoadingCancelled) {
                            loadMoreRegion();
                        }
                    }, 50); // Minimal delay to prevent interference
                    return; // Exit early to avoid finally block
                }
            } catch (error) {
                console.error('Error loading more region projects:', error);
                setIsLoadingMore(false);
            }
        };
        
        // Start the progressive loading chain (instant)
        loadMoreRegion();
    }
    
    // Region centroids for fallback when specific coordinates aren't available
    const regionCentroids = {
        'Region I': [16.5, 120.5],
        'Region II': [17.5, 121.5],
        'Region III': [15.0, 120.5],
        'Region IV-A': [14.0, 121.0],
        'Region IV-B': [12.0, 121.0],
        'Region V': [13.0, 123.5],
        'Region VI': [11.0, 122.5],
        'Region VII': [10.0, 123.5],
        'Region VIII': [11.5, 125.0],
        'Region IX': [8.0, 123.0],
        'Region X': [8.5, 124.5],
        'Region XI': [7.0, 125.5],
        'Region XII': [6.5, 124.5],
        'Region XIII': [9.0, 125.5],
        'NCR': [14.6, 121.0],
        'CAR': [16.5, 120.8],
        'BARMM': [7.0, 124.0]
    };

    function addMarkersToMap(projects) {
        let markersAdded = 0;
        let projectsWithoutCoords = 0;
        const regionCounts = {};
        
        console.log('üó∫Ô∏è Adding markers for', projects.length, 'projects');
        console.log('üó∫Ô∏è Sample project data:', projects[0]);
        
        projects.forEach(project => {
            if (project.Latitude && project.Longitude) {
                const lat = parseFloat(project.Latitude);
                const lng = parseFloat(project.Longitude);
                
                if (!isNaN(lat) && !isNaN(lng) && lat !== 0 && lng !== 0) {
                    const marker = L.marker([lat, lng], {
                        icon: L.icon({
                            iconUrl: '/static/images/leaflet/marker-icon.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowUrl: '/static/images/leaflet/marker-shadow.png',
                            shadowSize: [41, 41]
                        })
                    }).addTo(mapInstance)
                    .bindPopup(`
                        <div style="min-width: 200px;">
                            <h3 style="font-weight: bold; margin-bottom: 8px;">${project.ProjectDescription || 'Unnamed Project'}</h3>
                            <p><strong>Region:</strong> ${project.Region || 'N/A'}</p>
                            <p><strong>Province:</strong> ${project.Province || 'N/A'}</p>
                            <p><strong>Municipality:</strong> ${project.Municipality || 'N/A'}</p>
                            <p><strong>Contractor:</strong> ${project.Contractor || 'N/A'}</p>
                            <p><strong>Cost:</strong> ‚Ç±${project.ContractCost ? parseFloat(project.ContractCost).toLocaleString('en-PH') : 'N/A'}</p>
                            <p><strong>Year:</strong> ${project.InfraYear || 'N/A'}</p>
                        </div>
                    `);
                    
                    mapMarkers.push(marker);
                    markersAdded++;
                } else {
                    projectsWithoutCoords++;
                }
            } else {
                // Fallback: use region centroid if no specific coordinates
                const region = project.Region;
                if (region && regionCentroids[region]) {
                    const [lat, lng] = regionCentroids[region];
                    regionCounts[region] = (regionCounts[region] || 0) + 1;
                    
                    // Add slight offset for multiple projects in same region
                    const offset = (regionCounts[region] - 1) * 0.01;
                    const adjustedLat = lat + offset;
                    const adjustedLng = lng + offset;
                    
                    const marker = L.marker([adjustedLat, adjustedLng], {
                        icon: L.icon({
                            iconUrl: '/static/images/leaflet/marker-icon.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowUrl: '/static/images/leaflet/marker-shadow.png',
                            shadowSize: [41, 41]
                        })
                    }).addTo(mapInstance)
                    .bindPopup(`
                        <div style="min-width: 200px;">
                            <h3 style="font-weight: bold; margin-bottom: 8px;">${project.ProjectDescription || 'Unnamed Project'}</h3>
                            <p><strong>Region:</strong> ${project.Region || 'N/A'}</p>
                            <p><strong>Province:</strong> ${project.Province || 'N/A'}</p>
                            <p><strong>Municipality:</strong> ${project.Municipality || 'N/A'}</p>
                            <p><strong>Contractor:</strong> ${project.Contractor || 'N/A'}</p>
                            <p><strong>Cost:</strong> ‚Ç±${project.ContractCost ? parseFloat(project.ContractCost).toLocaleString('en-PH') : 'N/A'}</p>
                            <p><strong>Year:</strong> ${project.InfraYear || 'N/A'}</p>
                            <p><em style="color: #666; font-size: 0.9em;">üìç Location approximated to region center</em></p>
                        </div>
                    `);
                    
                    mapMarkers.push(marker);
                    markersAdded++;
                } else {
                    projectsWithoutCoords++;
                }
            }
        });
        
        console.log(`üìç Map markers: ${markersAdded} added, ${projectsWithoutCoords} without coordinates`);
        
        // If no markers were added, show a message
        if (markersAdded === 0 && projects.length > 0) {
            console.warn('‚ö†Ô∏è No projects have coordinate data - markers cannot be displayed');
            updateMapStatus(`Loaded ${projects.length} projects, but no coordinate data available for map markers`);
        } else if (markersAdded > 0) {
            updateMapStatus(`Added ${markersAdded} markers to map${projectsWithoutCoords > 0 ? ` (${projectsWithoutCoords} without coordinates)` : ''}`);
        }
    }
    
    function setIsLoadingMore(loading) {
        isLoadingMore = loading;
        // Update UI to show loading state
        const statusElement = document.getElementById('map-data-status');
        if (statusElement && loading) {
            statusElement.textContent = statusElement.textContent + ' (loading more...)';
        }
    }
    
    function updateMapStatus(message) {
        const statusElement = document.getElementById('map-data-status');
        if (statusElement) {
            statusElement.textContent = message;
        }
        
        // Update marker count display
        const markerCountElement = document.getElementById('map-marker-count');
        if (markerCountElement) {
            markerCountElement.textContent = mapMarkers.length;
        }
    }

    // Contractor functionality
    let currentContractorPage = 0;
    const contractorPageSize = 20;
    let allContractors = []; // Store all contractors for filtering/sorting
    let filteredContractors = []; // Store filtered contractors for pagination
    
    // Visual contractors chart pagination
    let currentVisualContractorPage = 0;
    const visualContractorPageSize = 25;
    let allVisualContractors = []; // Store all contractors for visual chart

    async function initializeContractors() {
        console.log('üë• Initializing contractor data...');
        
        try {
            // Load from cached contractor stats (instant loading!)
            console.log('üîÑ Loading contractor data from cache...');
            const cacheResponse = await fetch('/static/data/contractor_stats_cache.json');
            
            if (!cacheResponse.ok) {
                throw new Error('Contractor stats cache not available');
            }
            
            const cacheData = await cacheResponse.json();
            console.log('‚úÖ Loaded cached contractor data:', cacheData.contractors.length, 'contractors');
            
            // Store all contractor data in memory (lightweight, just metadata)
            allContractors = cacheData.contractors.map(c => ({
                name: c.name,
                projects: c.projects,
                totalCost: c.total_cost,
                avgCostPerProject: c.avg_cost_per_project,
                suspicionScore: c.suspicion_score || 0,
                performance: c.suspicion
            }));
            
            console.log('‚úÖ Contractor data loaded from cache:', allContractors.length, 'contractors');
            console.log('üíæ Cache benefits: Instant load, no API batching, ~2400 contractors ready');
        } catch (error) {
            console.error('‚ùå Error loading contractor data:', error);
            allContractors = [];
        }
        
        // Update contractor statistics
        console.log('üìä Updating contractor statistics with', allContractors.length, 'contractors');
        updateContractorStatistics();
        
        
        // Apply current filters and render
        console.log('üîÑ Applying filters and rendering contractors...');
        applyContractorFilters();
        renderContractors();
        }

    async function processContractorData(contractors, counts = {}) {
    // Fetch actual project data to calculate real costs
    console.log('üìä Fetching project data to calculate actual costs...');
    
    try {
        // Fetch all projects to get accurate cost data
        const response = await fetch('/api/flood/projects?limit=10000');
        if (response.ok) {
            const data = await response.json();
            console.log('‚úÖ Fetched', data.projects.length, 'projects for cost calculation');
            return processContractorDataFromProjects(data.projects);
        } else {
            throw new Error(`Failed to fetch projects: ${response.status}`);
        }
    } catch (error) {
        console.error('‚ùå Failed to fetch projects for cost calculation:', error);
        
        // Fallback: use counts data with estimated costs
        console.log('‚ö†Ô∏è Using estimated costs based on project counts');
        const processedContractors = [];
        
        for (const contractorName of contractors) {
            const projectCount = counts[contractorName] || 0;
            
            // Determine suspicion level based on project count (more projects = more suspicious)
            let suspicion = 'Normal';
            if (projectCount >= 50) {
                suspicion = 'High';
            } else if (projectCount >= 20) {
                suspicion = 'Medium';
            } else if (projectCount >= 10) {
                suspicion = 'Low';
            }
            
            processedContractors.push({
                name: contractorName,
                projects: projectCount,
                totalCost: 0,
                avgCostPerProject: 0,
                performance: suspicion
            });
        }
        
        return processedContractors;
    }
    }

    async function processContractorDataFromProjects(projects) {
    // Process projects to get contractor statistics
    console.log('üí∞ Processing', projects.length, 'projects for cost calculation');
    const contractorMap = new Map();
    
    projects.forEach((project, index) => {
        const contractorName = project.Contractor || 'Unknown';
        
        // Parse cost - handle both number and string formats
        let cost = 0;
        if (typeof project.ContractCost === 'number') {
            cost = project.ContractCost;
        } else if (typeof project.ContractCost === 'string') {
            cost = parseFloat(project.ContractCost.replace(/[‚Ç±,\s]/g, '')) || 0;
        }
        
        // Debug first few entries
        if (index < 3) {
            console.log('üí∞ Sample project:', contractorName, 'Cost:', cost, 'Original:', project.ContractCost);
        }
        
        if (!contractorMap.has(contractorName)) {
            contractorMap.set(contractorName, {
                name: contractorName,
                projects: 0,
                totalCost: 0,
                avgCostPerProject: 0,
                performance: 'Normal'
            });
        }
        
        const contractor = contractorMap.get(contractorName);
        contractor.projects++;
        contractor.totalCost += cost;
    });
    
    console.log('üí∞ Processed contractors:', contractorMap.size);
    
    // Calculate average cost per project and suspicion level
    const contractors = Array.from(contractorMap.values());
    contractors.forEach(contractor => {
        contractor.avgCostPerProject = contractor.totalCost / contractor.projects;
        
        // Suspicion level based on project count (more projects = more suspicious)
        if (contractor.projects >= 50) {
            contractor.performance = 'High';
        } else if (contractor.projects >= 20) {
            contractor.performance = 'Medium';
        } else if (contractor.projects >= 10) {
            contractor.performance = 'Low';
        } else {
            contractor.performance = 'Normal';
        }
    });
    
    return contractors;
    }

    async function updateContractorStatistics() {
        console.log('üìä updateContractorStatistics called with', allContractors.length, 'contractors');
        console.log('üìä allContractors:', allContractors);
        
        if (allContractors.length === 0) {
            console.log('‚ö†Ô∏è No contractors data available');
            document.getElementById('total-contractors-count').textContent = 'No Data';
            document.getElementById('top-contractor-name').textContent = 'No Data';
            document.getElementById('avg-projects-per-contractor').textContent = 'No Data';
            document.getElementById('avg-cost-per-project').textContent = 'No Data';
            return;
        }
        
        // Fetch actual total contractors count from statistics API
        try {
            const statsResponse = await fetch('/api/flood/statistics');
            if (statsResponse.ok) {
                const stats = await statsResponse.json();
                const actualTotalContractors = stats.uniqueContractors;
                const actualTotalProjects = stats.totalProjects;
                const actualTotalCost = stats.totalCost;
                
                console.log('üìä Actual total contractors from API:', actualTotalContractors);
                document.getElementById('total-contractors-count').textContent = actualTotalContractors.toLocaleString('en-PH');
                
                // Calculate average projects per contractor using actual totals
                const avgProjects = Math.round(actualTotalProjects / actualTotalContractors);
                console.log('üìä Average projects per contractor:', avgProjects, '(', actualTotalProjects, '/', actualTotalContractors, ')');
                document.getElementById('avg-projects-per-contractor').textContent = avgProjects.toLocaleString('en-PH');
                
                // Calculate average cost per project using actual totals
                const avgCostPerProject = Math.round(actualTotalCost / actualTotalProjects);
                console.log('üìä Average cost per project:', avgCostPerProject, '(', actualTotalCost, '/', actualTotalProjects, ')');
                document.getElementById('avg-cost-per-project').textContent = '‚Ç±' + avgCostPerProject.toLocaleString('en-PH');
            } else {
                throw new Error('Failed to fetch statistics');
            }
        } catch (error) {
            console.error('‚ùå Failed to fetch accurate contractor statistics:', error);
            // Fallback to displayed contractors count
            document.getElementById('total-contractors-count').textContent = allContractors.length.toLocaleString('en-PH');
            const totalProjects = allContractors.reduce((sum, contractor) => sum + contractor.projects, 0);
            const totalCost = allContractors.reduce((sum, contractor) => sum + contractor.totalCost, 0);
            const avgProjects = Math.round(totalProjects / allContractors.length);
            const avgCostPerProject = Math.round(totalCost / totalProjects);
            document.getElementById('avg-projects-per-contractor').textContent = avgProjects.toLocaleString('en-PH');
            document.getElementById('avg-cost-per-project').textContent = '‚Ç±' + avgCostPerProject.toLocaleString('en-PH');
        }
        
        // Top contractor by project count (from displayed contractors)
        const topContractor = allContractors.reduce((prev, current) => 
            (prev.projects > current.projects) ? prev : current
        );
        console.log('üìä Top contractor:', topContractor);
        document.getElementById('top-contractor-name').textContent = topContractor.name;
    }

    function applyContractorFilters() {
        const searchTerm = document.getElementById('contractor-search')?.value.toLowerCase() || '';
        
        filteredContractors = allContractors.filter(contractor => {
            if (!searchTerm) return true;
            return contractor.name?.toLowerCase().includes(searchTerm);
        });
        
        console.log(`üîç Contractor filters applied: ${filteredContractors.length} contractors match "${searchTerm}"`);
        
        // Reset to first page when filters change
        currentContractorPage = 0;
    }

// Top 50 processed contractors (contractors 1-50 that have been processed with AHK)
const TOP_50_PROCESSED_CONTRACTORS = [
    "11-16 CONSTRUCTION",
    "A D  GONZALES JR  CONSTRUCTION & TRADING CO  INC",
    "A D  PENDON CONSTRUCTION & SUPPLY  INC",
    "A.C. SOLIVEN CONSTRUCTION & GENERAL MERCHANDISE",
    "ALPHA & OMEGA GEN  CONTRACTOR & DEVELOPMENT CORP",
    "AMETHYST HORIZON BUILDERS AND GEN  CONTRACTOR AND",
    "BICOL GOLDROCK CONSTRUCTION CORPORATION",
    "BMK CONSTRUCTION CORPORATION  FORMERLY B M K  CONS",
    "CENTERWAYS CONSTRUCTION AND DEVELOPMENT INC",
    "CIVIL ENGINEERING",
    "CONSTRUCTION GROUP",
    "D T  RECIO INCORPORATED",
    "DALCON CONSTRUCTION   EGB CONSTRUCTION CORPORATION",
    "DEVELOPMENT CORP",
    "DPWH REGIONAL OFFICE",
    "E  F  CHUA CONSTRUCTION  INC",
    "EIGHT J'S CONSTRUCTION SERVICES",
    "EQUI-PARCO CONSTRUCTION COMPANY   TRIPARCO DEVELOP",
    "FLORDES CONSTRUCTION & TRADING CORP",
    "FLORDES CONSTRUCTION & TRADING CORP. (FORMERLY FLO",
    "GENESIS88 CONSTRUCTION INC",
    "GREAT PACIFIC BUILDERS AND GEN  CONTRACTOR INC",
    "HAPPY ALL3 BUILDERS CORPORATION   EQUI-PARCO CONST",
    "HI-TONE CONSTRUCTION & DEVELOPMENT CORP",
    "INFRASTRUCTURE CORP",
    "JAGONBUILD CONSTRUCTION CORP",
    "JTC CRUZ CONSTRUCTION CO   INC",
    "L R  TIQUI BUILDERS  INC",
    "LEGACY CONSTRUCTION CORPORATION",
    "LEGACY CONSTRUCTION CORPORATION  FORMERLY  LEGACY",
    "M3 KONSTRACT CORPORATION",
    "M3 KONSTRACT CORPORATION (FORMERLY:MARGARITA CONSTRUCTION)",
    "MARGARITA CONSTRUCTION",
    "ME 3 CONSTRUCTION   EQUI-PARCO CONSTRUCTION COMPAN",
    "MG SAMIDAN CONSTRUCTION",
    "PRIVATE CONTRACTOR A",
    "PRIVATE CONTRACTOR B",
    "PUBLIC WORKS CO",
    "QM BUILDERS",
    "QUIRANTE CONSTRUCTION",
    "QUIRANTE CONSTRUCTION CORPORATION",
    "RAMISES CONSTRUCTION   EQUI-PARCO CONSTRUCTION COM",
    "RJIR ENTERPRISES CORPORATION",
    "ROAD EDGE TRADING & DEVELOPMENT SERVICES",
    "ROYAL CROWN MONARCH CONSTRUCTION & SUPPLIES CORP",
    "ROYAL CROWN MONARCH CONSTRUCTION & SUPPLIES CORP.",
    "SILVERWOLVES CONSTRUCTION CORPORATION",
    "ST  MATTHEW GEN  CONTRACTOR & DEVELOPMENT CORP",
    "ST  TIMOTHY CONSTRUCTION CORPORATION",
    "STO  CRISTO CONSTRUCTION & TRADING",
    "STO  CRISTO CONSTRUCTION & TRADING INC",
    "STO. CRISTO CONSTRUCTION & TRADING INC. (FOR: STO. CRISTO CONSTRUCTION & TRADING)",
    "SUNWEST  INC",
    "SUNWEST  INC   FORMERLY  SUNWEST CONSTRUCTION & DE",
    "SUNWEST CONSTRUCTION & DEVELOPMENT CORPORATION",
    "TOPNOTCH CATALYST BUILDERS INC",
    "TRIPLE 8 CONST  & SUPPLY",
    "TRIPLE 8 CONSTRUCTION & SUPPLY  INC",
    "TRIPLE 8 CONSTRUCTION & SUPPLY INC",
    "TRIPLE 8 CONSTRUCTION & SUPPLY, INC. (FORMERLY TRIPLE 8 CONST. & SUPPLY)",
    "V B  MANUBAY CONSTRUCTION",
    "VEN RAY CONSTRUCTION CORPORATION",
    "VILLAR GENERAL CONSTRUCTION AND SUPPLIES",
    "WAWAO BUILDERS",
    "YPR GEN  CONTRACTOR AND CONSTRUCTION SUPPLY INC",
];

// Helper function to normalize contractor names for better matching
function normalizeContractorName(name) {
    if (!name) return '';
    
    return name.toLowerCase()
        .replace(/[.,]/g, ' ')  // Replace periods and commas with spaces
        .replace(/\s+/g, ' ')   // Replace multiple spaces with single space
        .replace(/\binc\b/g, 'inc')  // Normalize "inc" variations
        .replace(/\bcorp\b/g, 'corp')  // Normalize "corp" variations
        .replace(/\bco\b/g, 'co')     // Normalize "co" variations
        .trim();
}

// Helper function to check if a contractor is in the top 50 processed list
function isInTop50Processed(contractorName) {
    const normalizedName = normalizeContractorName(contractorName);
    
    return TOP_50_PROCESSED_CONTRACTORS.some(processed => {
        const normalizedProcessed = normalizeContractorName(processed);
        
        // Try multiple matching strategies with improved logic
        // Strategy 1: Exact match
        if (normalizedName === normalizedProcessed) {
            return true;
        }
        
        // Strategy 2: One contains the other (for cases like "L.R. TIQUI BUILDERS, INC." vs "L R  TIQUI BUILDERS  INC")
        if (normalizedName.includes(normalizedProcessed) || normalizedProcessed.includes(normalizedName)) {
            return true;
        }
        
        // Strategy 3: Word-based matching (at least 3 significant words match)
        const nameWords = normalizedName.split(' ').filter(w => w.length > 2);
        const processedWords = normalizedProcessed.split(' ').filter(w => w.length > 2);
        
        if (nameWords.length >= 3 && processedWords.length >= 3) {
            const matchingWords = nameWords.filter(nameWord =>
                processedWords.some(procWord =>
                    nameWord.includes(procWord) || procWord.includes(nameWord)
                )
            );
            
            // If at least 3 words match, consider it a match
            if (matchingWords.length >= Math.min(3, nameWords.length - 1)) {
                return true;
            }
        }
        
        // Strategy 4: Handle common variations (INC vs INCORPORATED, CORP vs CORPORATION)
        const nameVariations = [
            normalizedName.replace(/\binc\b/g, 'incorporated'),
            normalizedName.replace(/\bincorporated\b/g, 'inc'),
            normalizedName.replace(/\bcorp\b/g, 'corporation'),
            normalizedName.replace(/\bcorporation\b/g, 'corp'),
            normalizedName.replace(/\bco\b/g, 'company'),
            normalizedName.replace(/\bcompany\b/g, 'co')
        ];
        
        const processedVariations = [
            normalizedProcessed.replace(/\binc\b/g, 'incorporated'),
            normalizedProcessed.replace(/\bincorporated\b/g, 'inc'),
            normalizedProcessed.replace(/\bcorp\b/g, 'corporation'),
            normalizedProcessed.replace(/\bcorporation\b/g, 'corp'),
            normalizedProcessed.replace(/\bco\b/g, 'company'),
            normalizedProcessed.replace(/\bcompany\b/g, 'co')
        ];
        
        // Check if any variation matches
        for (const nameVar of nameVariations) {
            for (const procVar of processedVariations) {
                if (nameVar === procVar || nameVar.includes(procVar) || procVar.includes(nameVar)) {
                    return true;
                }
            }
        }
        
        return false;
    });
}

// Get SEC status for contractor (synchronous version for table rendering)
function getContractorSecStatusSync(contractorName) {
    if (!window.secDataCache) {
        // If no cached SEC data, show "Loading..." to indicate data is being fetched
        return '<span style="padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: 600; color: #6c757d; background-color: #f8f9fa; border: 1px solid #dee2e6;">‚è≥ Loading...</span>';
    }
    
    const contractors = window.secDataCache.contractors || [];
    const summary = window.secDataCache.summary || {};
    
    console.log('üîç Checking SEC status for:', contractorName);
    console.log('üìä Available contractors:', contractors.length);
    
    // Normalize the input contractor name
    const normalizedContractorName = normalizeContractorName(contractorName);
    
    // Try multiple matching strategies for better accuracy
    let matchingContractor = null;
    
        // Strategy 1: Exact match with normalized original_contractor_name (prioritize entries with SEC data)
        const exactMatches = contractors.filter(c => 
            c.original_contractor_name && 
            normalizeContractorName(c.original_contractor_name) === normalizedContractorName
        );
        matchingContractor = exactMatches.find(c => c.sec_number && c.sec_number.trim() !== '') || exactMatches[0];
        
        // Strategy 2: Exact match with normalized company_name (prioritize entries with SEC data)
        if (!matchingContractor) {
            const companyMatches = contractors.filter(c => 
                c.company_name && 
                normalizeContractorName(c.company_name) === normalizedContractorName
            );
            matchingContractor = companyMatches.find(c => c.sec_number && c.sec_number.trim() !== '') || companyMatches[0];
        }
        
        // Strategy 3: Partial match (contractor name contains original name) - prioritize SEC data
        if (!matchingContractor) {
            const partialMatches = contractors.filter(c => 
                c.original_contractor_name && 
                normalizedContractorName.includes(normalizeContractorName(c.original_contractor_name))
            );
            matchingContractor = partialMatches.find(c => c.sec_number && c.sec_number.trim() !== '') || partialMatches[0];
        }
        
        // Strategy 4: Reverse partial match (original name contains contractor name) - prioritize SEC data
        if (!matchingContractor) {
            const reverseMatches = contractors.filter(c => 
                c.original_contractor_name && 
                normalizeContractorName(c.original_contractor_name).includes(normalizedContractorName)
            );
            matchingContractor = reverseMatches.find(c => c.sec_number && c.sec_number.trim() !== '') || reverseMatches[0];
        }
        
        // Strategy 5: Company name partial match - prioritize SEC data
        if (!matchingContractor) {
            const companyPartialMatches = contractors.filter(c => 
                c.company_name && 
                (normalizedContractorName.includes(normalizeContractorName(c.company_name)) ||
                 normalizeContractorName(c.company_name).includes(normalizedContractorName))
            );
            matchingContractor = companyPartialMatches.find(c => c.sec_number && c.sec_number.trim() !== '') || companyPartialMatches[0];
        }
        
        // Strategy 6: Word-based matching (check if key words match) - prioritize SEC data
        if (!matchingContractor) {
            const contractorWords = normalizedContractorName.split(' ').filter(w => w.length > 2);
            const wordMatches = contractors.filter(c => {
                if (!c.original_contractor_name && !c.company_name) return false;
                
                const secWords = normalizeContractorName(c.original_contractor_name || c.company_name).split(' ').filter(w => w.length > 2);
                
                // Check if at least 3 key words match
                const matchingWords = contractorWords.filter(word => 
                    secWords.some(secWord => 
                        secWord.includes(word) || word.includes(secWord)
                    )
                );
                
                return matchingWords.length >= Math.min(3, contractorWords.length - 1);
            });
            matchingContractor = wordMatches.find(c => c.sec_number && c.sec_number.trim() !== '') || wordMatches[0];
        }
    
    console.log('üéØ Matching contractor found:', matchingContractor);
    
    if (matchingContractor) {
        if (matchingContractor.sec_number && matchingContractor.sec_number.trim() !== '') {
            console.log('‚úÖ Has SEC data:', matchingContractor.sec_number);
            return '<span style="padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: 600; color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb;">‚úÖ Has SEC</span>';
        } else {
            console.log('‚ùå No SEC data found for processed contractor');
            return '<span style="padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: 600; color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb;">‚ùå Missing</span>';
        }
    } else {
        // Check if this contractor is in the top 50 processed contractors
        if (isInTop50Processed(contractorName)) {
            // This is a top 50 contractor that was processed but has no SEC data
            console.log('‚ùå Top 50 contractor processed but no SEC data found');
            return '<span style="padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: 600; color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb;">‚ùå Missing</span>';
        } else {
            // This is a contractor 51-2409 that hasn't been processed yet
            console.log('‚è≥ Contractor not in processed list (contractors 51-2409)');
            return '<span style="padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: 600; color: #6c757d; background-color: #f8f9fa; border: 1px solid #dee2e6;">‚è≥ Unprocessed</span>';
        }
    }
}

    function renderContractors() {
        const tableBody = document.getElementById('contractors-table-body');
        const contractorsShowing = document.getElementById('contractors-showing');
        const contractorsTotal = document.getElementById('contractors-total');
        const contractorsPageInfo = document.getElementById('contractors-page-info');
        const contractorsPrev = document.getElementById('contractors-prev');
        const contractorsNext = document.getElementById('contractors-next');

        if (!tableBody) return;
        
        console.log(`üìä Rendering contractors: page ${currentContractorPage + 1}, filtered: ${filteredContractors.length}, all: ${allContractors.length}`);

        // Apply sorting
        const sortValue = document.getElementById('contractor-sort')?.value || 'suspicion-desc';
        const sortedContractors = [...filteredContractors].sort((a, b) => {
            switch (sortValue) {
                case 'suspicion-desc':
                    return b.suspicionScore - a.suspicionScore;
                case 'suspicion-asc':
                    return a.suspicionScore - b.suspicionScore;
                case 'projects-desc':
                    return b.projects - a.projects;
                case 'projects-asc':
                    return a.projects - b.projects;
                case 'cost-desc':
                    return b.totalCost - a.totalCost;
                case 'cost-asc':
                    return a.totalCost - b.totalCost;
                case 'avg-cost-desc':
                    return b.avgCostPerProject - a.avgCostPerProject;
                case 'avg-cost-asc':
                    return a.avgCostPerProject - b.avgCostPerProject;
                case 'name-asc':
                    return a.name.localeCompare(b.name);
                case 'name-desc':
                    return b.name.localeCompare(a.name);
                default:
                    return b.suspicionScore - a.suspicionScore;
            }
        });

        const totalContractors = sortedContractors.length;
        const totalPages = Math.ceil(totalContractors / contractorPageSize);

        const start = currentContractorPage * contractorPageSize;
        const end = start + contractorPageSize;
        const contractorsToDisplay = sortedContractors.slice(start, end);

        let html = '';
        if (contractorsToDisplay.length === 0) {
            html = `
                <tr>
                    <td colspan="6" style="padding: 40px; text-align: center; color: #dc3545;">
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                            <div style="font-size: 24px;">‚ö†Ô∏è</div>
                            <div>No contractors found matching your criteria.</div>
                        </div>
                    </td>
                </tr>
            `;
        } else {
            html = contractorsToDisplay.map(contractor => {
                const score = contractor.suspicionScore || 0;
                const scoreColor = score >= 75 ? '#dc3545' : 
                                   score >= 50 ? '#ffc107' : 
                                   score >= 25 ? '#17a2b8' : 
                                   score <= 9 ? '#28a745' : '#6c757d';
                
                // Check SEC status for this contractor
                const secStatus = getContractorSecStatusSync(contractor.name);
                
                return `
                <tr>
                    <td style="padding: 12px; border-bottom: 1px solid #eee; font-weight: 600;">
                        <span onclick="showSecData('${escapeHtml(contractor.name)}')" 
                              style="color: #0038A8; cursor: pointer; text-decoration: underline; font-weight: 600;"
                              onmouseover="this.style.color='#007bff'" 
                              onmouseout="this.style.color='#0038A8'"
                              title="Click to view SEC data">
                            ${escapeHtml(contractor.name)}
                        </span>
                    </td>
                    <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee;">
                        ${secStatus}
                    </td>
                    <td style="padding: 12px; text-align: right; border-bottom: 1px solid #eee;">${contractor.projects.toLocaleString('en-PH')}</td>
                    <td style="padding: 12px; text-align: right; border-bottom: 1px solid #eee;">‚Ç±${contractor.totalCost.toLocaleString('en-PH')}</td>
                    <td style="padding: 12px; text-align: right; border-bottom: 1px solid #eee;">‚Ç±${Math.round(contractor.avgCostPerProject).toLocaleString('en-PH')}</td>
                    <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee;">
                        <span style="padding: 6px 12px; border-radius: 12px; font-size: 1em; font-weight: 700; color: white; background-color: ${scoreColor};">
                            ${score.toFixed(1)}
                        </span>
                    </td>
                </tr>
            `;
            }).join('');
        }
        tableBody.innerHTML = html;

        // Update pagination info
        contractorsShowing.textContent = Math.min(end, totalContractors).toLocaleString();
        contractorsTotal.textContent = totalContractors.toLocaleString();
        contractorsPageInfo.textContent = `Page ${currentContractorPage + 1} of ${totalPages || 1}`;

        contractorsPrev.disabled = currentContractorPage === 0;
        contractorsNext.disabled = currentContractorPage >= totalPages - 1;
        
        console.log(`üìÑ Pagination: ${contractorsShowing.textContent} of ${contractorsTotal.textContent}, page ${currentContractorPage + 1}/${totalPages}, prev: ${contractorsPrev.disabled}, next: ${contractorsNext.disabled}`);
    }

    function refreshContractorData() {
        console.log('üîÑ Refreshing contractor data...');
    currentContractorPage = 0;
    initializeContractors();
    }

    function changeContractorPage(direction) {
    const totalContractors = filteredContractors.length;
    const totalPages = Math.ceil(totalContractors / contractorPageSize);
    currentContractorPage = Math.max(0, Math.min(totalPages - 1, currentContractorPage + direction));
    renderContractors();
    }

    // Tab functionality moved outside class scope
    
    // Tab functionality
    function initializeTabs() {
        console.log('üîß Initializing tabs...');
        const tabs = document.querySelectorAll('.budget-tab-btn');
        const tabContents = document.querySelectorAll('.budget-tab-panel');
        
        console.log('üîç Found tabs:', tabs.length);
        console.log('üîç Found tab contents:', tabContents.length);

        if (tabs.length === 0) {
            console.error('‚ùå No tabs found! Check if .budget-tab-btn elements exist in DOM');
            return;
        }

        tabs.forEach((tab, index) => {
            console.log(`üîß Setting up tab ${index + 1}:`, tab.getAttribute('data-tab'));
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                const targetTab = tab.getAttribute('data-tab');
                console.log('üîÑ Tab clicked:', targetTab);
                switchTab(targetTab);
            });
        });
        
        console.log('‚úÖ Tab initialization complete');
    }

    // Chart initialization
    function initializeCharts() {
    // Show error state for charts when data is not available
    const chartContainers = document.querySelectorAll('.chart-container');
    chartContainers.forEach(container => {
        const canvas = container.querySelector('canvas');
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#dc3545';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Data Not Available', canvas.width / 2, canvas.height / 2);
            ctx.fillText('API connection failed', canvas.width / 2, canvas.height / 2 + 25);
        }
    });
    
    // Try to load real data for charts
    loadChartData();
    }
    
    async function loadChartData() {
    try {
        console.log('üîç Loading chart data from API...');
        const response = await fetch('/api/flood/statistics');
        if (response.ok) {
            const data = await response.json();
            console.log('‚úÖ Chart data loaded from API:', data);
            createRealCharts(data);
            return;
        }
    } catch (error) {
        console.error('‚ùå Failed to load chart data from API:', error);
    }
    
    console.log('‚ö†Ô∏è No chart data available - showing error state');
    }
    
    function createRealCharts(data) {
    // Clear existing charts
    Chart.helpers.each(Chart.instances, function(instance) {
        instance.destroy();
    });

    // Yearly Chart - Use statistics data
    const yearlyCtx = document.getElementById('yearlyChart');
    if (yearlyCtx && data.years) {
        // Use years from statistics
        const yearsArray = Object.entries(data.years)
            .map(([year, count]) => ({ year: year, count: count }))
            .sort((a, b) => parseInt(a.year) - parseInt(b.year));
        
        new Chart(yearlyCtx, {
            type: 'bar',
            data: {
                labels: yearsArray.map(item => item.year),
                datasets: [{
                    label: 'Projects',
                    data: yearsArray.map(item => item.count),
                    backgroundColor: '#0038A8',
                    borderColor: '#002a7a',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Budget by Year Chart
    const budgetByYearCtx = document.getElementById('budgetByYearChart');
    if (budgetByYearCtx && data.years) {
        // Calculate budget totals by year from available data
        const budgetByYear = {};
        let totalBudget = data.totalCost || 0;
        let totalProjects = data.totalProjects || 0;
        
        // Use mostExpensiveProjects to estimate budget distribution by year
        if (data.mostExpensiveProjects && Array.isArray(data.mostExpensiveProjects)) {
            data.mostExpensiveProjects.forEach(project => {
                const year = project.year || 'Unknown';
                const budget = parseFloat(project.contractCost) || 0;
                
                if (!budgetByYear[year]) {
                    budgetByYear[year] = { total: 0, count: 0 };
                }
                
                budgetByYear[year].total += budget;
                budgetByYear[year].count += 1;
            });
        }
        
        // If we don't have enough data from mostExpensiveProjects, estimate from total cost and project counts
        const yearsArray = Object.entries(data.years)
            .map(([year, count]) => ({ year: year, count: count }))
            .sort((a, b) => parseInt(a.year) - parseInt(b.year));
        
        // Calculate average cost per project
        const avgCostPerProject = totalProjects > 0 ? totalBudget / totalProjects : 0;
        
        // Fill in missing years with estimated budget based on project count
        yearsArray.forEach(yearData => {
            if (!budgetByYear[yearData.year]) {
                budgetByYear[yearData.year] = {
                    total: yearData.count * avgCostPerProject,
                    count: yearData.count
                };
            }
        });
        
        // Convert to array and sort by year
        const budgetArray = Object.entries(budgetByYear)
            .map(([year, data]) => ({ year: year, total: data.total, count: data.count }))
            .sort((a, b) => parseInt(a.year) - parseInt(b.year));
        
        // Update summary statistics
        const totalBudgetElement = document.getElementById('total-budget-amount');
        const avgBudgetElement = document.getElementById('avg-budget-per-project');
        const highestYearElement = document.getElementById('highest-budget-year');
        
        if (totalBudgetElement) {
            totalBudgetElement.textContent = '‚Ç±' + totalBudget.toLocaleString('en-PH', { 
                minimumFractionDigits: 0, 
                maximumFractionDigits: 0 
            });
        }
        
        if (avgBudgetElement && totalProjects > 0) {
            avgBudgetElement.textContent = '‚Ç±' + avgCostPerProject.toLocaleString('en-PH', { 
                minimumFractionDigits: 0, 
                maximumFractionDigits: 0 
            });
        }
        
        if (highestYearElement && budgetArray.length > 0) {
            const highestYear = budgetArray.reduce((max, current) => 
                current.total > max.total ? current : max
            );
            highestYearElement.textContent = `${highestYear.year} (‚Ç±${highestYear.total.toLocaleString('en-PH', { 
                minimumFractionDigits: 0, 
                maximumFractionDigits: 0 
            })})`;
        }
        
        new Chart(budgetByYearCtx, {
            type: 'line',
            data: {
                labels: budgetArray.map(item => item.year),
                datasets: [{
                    label: 'Total Budget (‚Ç±)',
                    data: budgetArray.map(item => item.total),
                    backgroundColor: 'rgba(0, 56, 168, 0.1)',
                    borderColor: '#0038A8',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#0038A8',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: '#0038A8',
                            font: {
                                size: 12,
                                weight: 'bold'
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed.y;
                                const year = budgetArray[context.dataIndex];
                                return [
                                    `Year: ${year.year}`,
                                    `Total Budget: ‚Ç±${value.toLocaleString('en-PH', { 
                                        minimumFractionDigits: 2, 
                                        maximumFractionDigits: 2 
                                    })}`,
                                    `Projects: ${year.count}`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '‚Ç±' + (value / 1000000).toFixed(1) + 'M';
                            },
                            color: '#666'
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#666'
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
    }

    // Regions Heat Map - Philippine Map
    if (data.regions) {
        createPhilippineHeatMap(data.regions);
    }

    // Work Types Chart - Use statistics data
    const workTypesCtx = document.getElementById('workTypesChart');
    if (workTypesCtx && data.typesOfWork) {
        // Use typesOfWork from statistics
        const typesArray = Object.entries(data.typesOfWork)
            .map(([type, count]) => ({ type: type, count: count }))
            .sort((a, b) => b.count - a.count)
            .slice(0, 15);
        
        console.log(`üìä Work Types chart: ${typesArray.length} types to display`);
        console.log('üìä Top 5 work types:', typesArray.slice(0, 5).map(t => `${t.type} (${t.count})`));
        
        new Chart(workTypesCtx, {
            type: 'pie',
            data: {
                labels: typesArray.map(item => item.type.length > 20 ? item.type.substring(0, 20) + '...' : item.type),
                datasets: [{
                    label: 'Projects',
                    data: typesArray.map(item => item.count),
                    backgroundColor: [
                        '#dc3545', '#fd7e14', '#ffc107', '#28a745', '#17a2b8',
                        '#6f42c1', '#e83e8c', '#20c997', '#fd7e14', '#6c757d',
                        '#343a40', '#007bff', '#6610f2', '#e74c3c', '#f39c12'
                    ],
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 1.5,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0,0,0,0.1)'
                        }
                    },
                    y: {
                        ticks: {
                            maxRotation: 0,
                            minRotation: 0,
                            font: {
                                size: 10,
                                weight: 'bold'
                            },
                            color: '#333',
                            maxTicksLimit: typesArray.length,
                            stepSize: 1,
                            callback: function(value, index, values) {
                                if (index < typesArray.length) {
                                    return typesArray[index].type;
                                }
                                return '';
                            }
                        },
                        grid: {
                            display: false
                        }
                    }
                },
                layout: {
                    padding: {
                        left: 10,
                        right: 50,
                        top: 10,
                        bottom: 10
                    }
                }
            }
        });
    }

    // Contractors Chart - Use statistics data with pagination
    const contractorsCtx = document.getElementById('contractorsChart');
    if (contractorsCtx && data.topContractors) {
        // Store all contractors for pagination (filter out invalid names)
        allVisualContractors = Object.entries(data.topContractors)
            .filter(([contractor, count]) => {
                // Filter out invalid contractor names
                return contractor && 
                       contractor.trim() !== '' && 
                       !contractor.toLowerCase().includes('.txt') &&
                       !contractor.toLowerCase().includes('.json') &&
                       contractor.length > 2 &&
                       count > 0;
            })
            .map(([contractor, count]) => ({
                contractor: contractor, 
                count: count
            }))
            .sort((a, b) => b.count - a.count);
        
        // Get contractors for current page
        const start = currentVisualContractorPage * visualContractorPageSize;
        const end = start + visualContractorPageSize;
        const contractorsArray = allVisualContractors.slice(start, end);
        
        console.log(`üìä Contractors chart: ${contractorsArray.length} contractors to display`);
        console.log('üìä Top 5 contractors:', contractorsArray.slice(0, 5).map(c => `${c.contractor} (${c.count})`));
        
        // Use the new render function
        renderVisualContractorsChart();
    }
    
    // Function to update visual contractors pagination
    function updateVisualContractorsPagination() {
        const pageInfo = document.getElementById('visual-contractors-page-info');
        const prevBtn = document.getElementById('visual-contractors-prev');
        const nextBtn = document.getElementById('visual-contractors-next');
        
        if (!pageInfo || !prevBtn || !nextBtn) return;
        
        const totalContractors = allVisualContractors.length;
        const totalPages = Math.ceil(totalContractors / visualContractorPageSize);
        const currentPage = currentVisualContractorPage + 1;
        
        // Update page info
        const start = currentVisualContractorPage * visualContractorPageSize + 1;
        const end = Math.min(start + visualContractorPageSize - 1, totalContractors);
        pageInfo.textContent = `Page ${currentPage} of ${totalPages} (${start}-${end} of ${totalContractors})`;
        
        // Update button states
        prevBtn.disabled = currentVisualContractorPage === 0;
        nextBtn.disabled = currentVisualContractorPage >= totalPages - 1;
        
        if (prevBtn.disabled) {
            prevBtn.style.background = '#dee2e6';
            prevBtn.style.color = '#6c757d';
        } else {
            prevBtn.style.background = '#0038A8';
            prevBtn.style.color = 'white';
        }
        
        if (nextBtn.disabled) {
            nextBtn.style.background = '#dee2e6';
            nextBtn.style.color = '#6c757d';
        } else {
            nextBtn.style.background = '#0038A8';
            nextBtn.style.color = 'white';
        }
    }
    
    // Function to change visual contractors page
    function changeVisualContractorPage(direction) {
        const totalPages = Math.ceil(allVisualContractors.length / visualContractorPageSize);
        const newPage = Math.max(0, Math.min(totalPages - 1, currentVisualContractorPage + direction));
        
        if (newPage !== currentVisualContractorPage) {
            currentVisualContractorPage = newPage;
            
            // Re-render the contractors chart
            if (window.contractorsChart) {
                window.contractorsChart.destroy();
            }
            
            // Recreate the chart with new data
            renderVisualContractorsChart();
        }
    }
    
    // Function to render visual contractors chart (extracted from main chart logic)
    function renderVisualContractorsChart() {
        const contractorsCtx = document.getElementById('contractorsChart');
        if (!contractorsCtx || !allVisualContractors.length) return;
        
        // Get contractors for current page
        const start = currentVisualContractorPage * visualContractorPageSize;
        const end = start + visualContractorPageSize;
        const contractorsArray = allVisualContractors.slice(start, end);
        
        window.contractorsChart = new Chart(contractorsCtx, {
            type: 'bar',
            data: {
                labels: contractorsArray.map(item => item.contractor.length > 40 ? item.contractor.substring(0, 40) + '...' : item.contractor),
                datasets: [{
                    label: 'Top Contractors',
                    data: contractorsArray.map(item => item.count),
                    backgroundColor: '#0038A8',
                    borderColor: '#CE1126',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y', // This makes it horizontal bar chart
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 1.5, // Width to height ratio for horizontal bars
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    },
                    y: {
                        display: true,
                        ticks: {
                            maxTicksLimit: 50
                        }
                    }
                },
                layout: {
                    padding: {
                        left: 10,
                        right: 50,
                        top: 10,
                        bottom: 10
                    }
                }
            }
        });
        
        // Add click functionality
        contractorsCtx.onclick = function(event) {
            const rect = contractorsCtx.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            const chartArea = window.contractorsChart.chartArea;
            const barHeight = (chartArea.bottom - chartArea.top) / contractorsArray.length;
            const clickedBarIndex = Math.floor((y - chartArea.top) / barHeight);
            
            if (clickedBarIndex >= 0 && clickedBarIndex < contractorsArray.length) {
                const contractorName = contractorsArray[clickedBarIndex].contractor;
                console.log('üîç Visual contractor clicked:', contractorName);
                
                // Switch to contractors tab and filter by this contractor
                switchTab('contractors');
                document.getElementById('contractor-search').value = contractorName;
                renderContractors();
            }
        };
        
        // Add hover functionality
        contractorsCtx.onmousemove = function(event) {
            const rect = contractorsCtx.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            const chartArea = window.contractorsChart.chartArea;
            const barHeight = (chartArea.bottom - chartArea.top) / contractorsArray.length;
            const hoveredBarIndex = Math.floor((y - chartArea.top) / barHeight);
            
            if (hoveredBarIndex >= 0 && hoveredBarIndex < contractorsArray.length) {
                const contractorName = contractorsArray[hoveredBarIndex].contractor;
                showContractorHoverTooltip(event, contractorName);
            } else {
                hideContractorHoverTooltip();
            }
        };
        
        // Update pagination
        updateVisualContractorsPagination();
        
        // Hide tooltip when mouse leaves chart
        contractorsCtx.onmouseleave = function() {
            hideContractorHoverTooltip();
        };
        
        // Make chart cursor pointer
        contractorsCtx.style.cursor = 'pointer';
    }

    // Most Expensive Projects Chart - will be populated from table data
    // This will be called after table data is loaded

    // Most Expensive Projects Chart
    const expensiveProjectsCtx = document.getElementById('expensiveProjectsChart');
    if (expensiveProjectsCtx && data.mostExpensiveProjects) {
        // Take top 10 most expensive projects
        const expensiveProjects = data.mostExpensiveProjects.slice(0, 10);
        
        new Chart(expensiveProjectsCtx, {
            type: 'bar',
            data: {
                labels: expensiveProjects.map(project => 
                    project.ProjectDescription.length > 30 ? 
                    project.ProjectDescription.substring(0, 30) + '...' : 
                    project.ProjectDescription
                ),
                datasets: [{
                    label: 'Contract Cost (‚Ç±)',
                    data: expensiveProjects.map(project => project.ContractCost),
                    backgroundColor: '#dc3545',
                    borderColor: '#c82333',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '‚Ç±' + (value / 1000000).toFixed(1) + 'M';
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Contractor Distribution Chart
    createContractorDistributionChart();
    }
    
    async function createContractorDistributionChart() {
        const distCtx = document.getElementById('contractorDistributionChart');
        if (!distCtx) return;
        
        try {
            // Load contractor stats cache
            const response = await fetch('/static/data/contractor_stats_cache.json');
            if (!response.ok) {
                console.log('‚ö†Ô∏è Contractor stats cache not available');
                return;
            }
            
            const cacheData = await response.json();
            const stats = cacheData.statistics;
            const distribution = stats.distribution;
            
            // Update distribution stats display
            document.getElementById('dist-avg-projects').textContent = stats.avg_projects_per_contractor;
            document.getElementById('dist-std-dev').textContent = stats.std_dev;
            document.getElementById('dist-beyond-3sd').textContent = distribution.beyond_3sd;
            
            // Create distribution chart
            new Chart(distCtx, {
                type: 'bar',
                data: {
                    labels: [
                        'Within 1 SD\n(Normal Range)',
                        'Within 2 SD\n(Moderately Unusual)',
                        'Within 3 SD\n(Unusual)',
                        'Beyond 3 SD\n(Highly Unusual)'
                    ],
                    datasets: [{
                        label: 'Number of Contractors',
                        data: [
                            distribution.within_1sd,
                            distribution.within_2sd,
                            distribution.within_3sd,
                            distribution.beyond_3sd
                        ],
                        backgroundColor: [
                            '#28a745', // Green - Normal
                            '#ffc107', // Yellow - Moderately unusual
                            '#fd7e14', // Orange - Unusual
                            '#dc3545'  // Red - Highly unusual
                        ],
                        borderColor: [
                            '#1e7e34',
                            '#d39e00',
                            '#dc6903',
                            '#c82333'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: `Average: ${stats.avg_projects_per_contractor} projects | Standard Deviation: ${stats.std_dev}`,
                            font: {
                                size: 12
                            },
                            color: '#666'
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    const total = stats.total_contractors;
                                    const value = context.parsed.y;
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${value} contractors (${percentage}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Contractors',
                                font: {
                                    weight: 'bold'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });
            
            console.log('‚úÖ Contractor distribution chart created');
        } catch (error) {
            console.error('‚ùå Failed to create contractor distribution chart:', error);
        }
    }

    function createExpensiveProjectsChart() {
    const expensiveProjectsCtx = document.getElementById('expensiveProjectsChart');
    if (!expensiveProjectsCtx || !allTableProjects || allTableProjects.length === 0) {
        return;
    }

    // Extract city/province names from project descriptions and prepare chart data
    const expensiveProjects = allTableProjects
        .filter(project => project.ContractCost && project.ContractCost > 0)
        .sort((a, b) => parseFloat(b.ContractCost) - parseFloat(a.ContractCost))
        .slice(0, 10) // Take top 10 most expensive
        .map(project => {
            // Extract location from project name (look for city/province names)
            let location = project.Region || 'Unknown';
            
            // Try to extract city/province from project name
            const projectName = project.ProjectDescription || '';
            if (projectName.includes('Tarlac')) location = 'Tarlac';
            else if (projectName.includes('Occidental Mindoro')) location = 'Occidental Mindoro';
            else if (projectName.includes('Ilocos Sur')) location = 'Ilocos Sur';
            else if (projectName.includes('La Union')) location = 'La Union';
            else if (projectName.includes('Palawan')) location = 'Palawan';
            else if (projectName.includes('Zambales')) location = 'Zambales';
            else if (projectName.includes('Bataraza')) location = 'Bataraza';
            else if (projectName.includes('Puerto Princesa')) location = 'Puerto Princesa';
            else if (projectName.includes('Aborlan')) location = 'Aborlan';
            else if (projectName.includes('Narra')) location = 'Narra';
            else if (projectName.includes('Brooke\'s Point')) location = 'Brooke\'s Point';
            
            return {
                location: location,
                cost: parseFloat(project.ContractCost) / 1000000, // Convert to millions
                originalCost: project.ContractCost,
                projectName: projectName,
                projectDescription: projectName
            };
        })
        .reduce((acc, project) => {
            // Handle duplicates by adding unique words from description (max 3 words total)
            let finalLocation = project.location;
            let counter = 1;
            
            // Check if location already exists
            while (acc.some(existing => existing.location === finalLocation)) {
                // Extract unique words from project description (prefer common nouns like dike, bridge, canal, etc.)
                const words = project.projectDescription
                    ?.toLowerCase()
                    ?.replace(/[^\w\s]/g, ' ')
                    ?.split(/\s+/) || []
                    .filter(word => word.length > 3 && !['project', 'flood', 'control', 'protection', 'river', 'bank', 'shore', 'road', 'works', 'system', 'structure', 'construction', 'development', 'improvement', 'rehabilitation', 'repair', 'maintenance'].includes(word));
                
                if (words.length > 0 && counter <= words.length) {
                    // Limit to 2 additional words max (3 total including province)
                    const additionalWords = words.slice(0, 2);
                    finalLocation = `${project.location} (${additionalWords.join(' ')})`;
                } else {
                    finalLocation = `${project.location} (${counter})`;
                }
                counter++;
            }
            
            acc.push({
                ...project,
                location: finalLocation
            });
            
            return acc;
        }, []);

    new Chart(expensiveProjectsCtx, {
        type: 'bar',
        data: {
            labels: expensiveProjects.map(item => item.location),
            datasets: [{
                label: 'Cost (‚Ç±M)',
                data: expensiveProjects.map(item => item.cost),
                backgroundColor: '#dc3545',
                borderColor: '#c82333',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2.0,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    callbacks: {
                        label: function(context) {
                            const project = expensiveProjects[context.dataIndex];
                            return `Cost: ‚Ç±${project.originalCost.toLocaleString('en-PH')}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '‚Ç±' + value + 'M';
                        }
                    },
                    grid: {
                        display: true,
                        color: 'rgba(0,0,0,0.1)'
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 0,
                        font: {
                            size: 11
                        }
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
    }

    function createPhilippineHeatMap(regionsData) {
    const regionsCtx = document.getElementById('regionsChart');
    if (!regionsCtx) return;

    // Load Philippine GeoJSON data and use live statistics
    Promise.all([
        fetch('/static/data/philippines-regions.json').then(r => r.json()),
        fetch('/static/data/region-mapping.json').then(r => r.json())
    ])
        .then(([geoJsonData, mappingData]) => {
            console.log('üó∫Ô∏è GeoJSON data loaded:', geoJsonData.features.length, 'features');
            console.log('üó∫Ô∏è Sample feature properties:', geoJsonData.features[0]?.properties);
            console.log('üó∫Ô∏è Region mapping loaded:', mappingData.regionMapping);
            console.log('üó∫Ô∏è Live regions data:', regionsData);
            
            // Use the live statistics data instead of static mapping
            const regionCosts = {};
            Object.entries(regionsData).forEach(([regionCode, count]) => {
                regionCosts[regionCode] = count * 1000000; // Convert count to approximate cost
            });
            console.log('üó∫Ô∏è Using live region statistics:', regionsData);
            console.log('üó∫Ô∏è Region III cost:', regionCosts['Region III']);
            console.log('üó∫Ô∏è NCR cost:', regionCosts['National Capital Region']);
            console.log('üó∫Ô∏è All region costs:', regionCosts);

            // Get min and max costs for color scaling
            const costs = Object.values(regionCosts);
        const minCost = Math.min(...costs);
            const maxCost = Math.max(...costs);
            const costRange = maxCost - minCost;

            // Canvas setup
            const canvas = regionsCtx;
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, width, height);

            // Calculate bounds of the Philippines
            let minLat = Infinity, maxLat = -Infinity;
            let minLng = Infinity, maxLng = -Infinity;

            geoJsonData.features.forEach(feature => {
                if (feature.geometry.type === 'MultiPolygon') {
                    feature.geometry.coordinates.forEach(polygon => {
                        polygon.forEach(ring => {
                            ring.forEach(coord => {
                                const [lng, lat] = coord;
                                minLat = Math.min(minLat, lat);
                                maxLat = Math.max(maxLat, lat);
                                minLng = Math.min(minLng, lng);
                                maxLng = Math.max(maxLng, lng);
                            });
                        });
                    });
                }
            });

            // Calculate scale and offset to fit Philippines in canvas
            const scaleX = (width - 40) / (maxLng - minLng);
            const scaleY = (height - 40) / (maxLat - minLat);
            const scale = Math.min(scaleX, scaleY);
            const offsetX = (width - (maxLng - minLng) * scale) / 2 - minLng * scale;
            const offsetY = (height - (maxLat - minLat) * scale) / 2 - minLat * scale;

            // Function to convert coordinates to canvas position
            const toCanvasCoords = (lng, lat) => ({
                x: lng * scale + offsetX,
                y: height - (lat * scale + offsetY) // Flip Y axis
            });

            // Function to get color based on project count ranges
            const getColor = (cost) => {
                // Convert cost back to project count (cost = count * 1000000)
                const projectCount = cost / 1000000;
                
                // Color grading based on project count ranges
                if (projectCount >= 1500) return '#8B0000';        // Dark red (1500+ projects)
                else if (projectCount >= 1200) return '#B22222';    // Fire brick (1200-1499 projects)
                else if (projectCount >= 1000) return '#DC143C';    // Crimson red (1000-1199 projects)
                else if (projectCount >= 800) return '#FF4500';     // Orange red (800-999 projects)
                else if (projectCount >= 600) return '#FF6347';    // Tomato (600-799 projects)
                else if (projectCount >= 400) return '#FF7F50';     // Coral (400-599 projects)
                else if (projectCount >= 200) return '#FFA500';     // Orange (200-399 projects)
                else if (projectCount >= 100) return '#FFD700';     // Gold (100-199 projects)
                else if (projectCount >= 50) return '#FFD700';      // Gold (50-99 projects)
                else if (projectCount >= 10) return '#FFF8DC';      // Cornsilk (10-49 projects)
                else if (projectCount > 0) return '#FFFACD';         // Lemon chiffon (1-9 projects)
                else return '#F0F0F0';                                // Light gray (0 projects)
            };

            // Use the loaded region mapping
            const regionMapping = mappingData.regionMapping;

            // Draw each region
            geoJsonData.features.forEach(feature => {
                let regionName = feature.properties.name || feature.properties.NAME_1;
                console.log(`üó∫Ô∏è Processing region: ${regionName}`);
                
                // Map GeoJSON name to Region code to get the cost
                let cost = 0;
                if (regionMapping[regionName]) {
                    const regionCode = regionMapping[regionName];
                    cost = regionCosts[regionCode] || 0;
                    console.log(`üó∫Ô∏è Mapped ${regionName} ‚Üí ${regionCode} with cost ‚Ç±${cost.toLocaleString()}`);
                    
                    // Special debugging for missing regions
                    if (regionName === 'Central Luzon' || regionName === 'National Capital Region') {
                        console.log(`üîç SPECIAL DEBUG for ${regionName}:`, {
                            regionName,
                            regionCode,
                            cost,
                            regionMappingExists: !!regionMapping[regionName],
                            regionCostExists: !!regionCosts[regionCode],
                            regionMappingValue: regionMapping[regionName],
                            regionCostValue: regionCosts[regionCode],
                            allRegionCosts: Object.keys(regionCosts),
                            allRegionMappings: Object.keys(regionMapping)
                        });
                    }
                } else {
                    console.log(`üó∫Ô∏è No mapping found for region: ${regionName}`);
                }
                
                const color = getColor(cost);
                
                // Debug logging
                if (cost > 0) {
                    console.log(`üó∫Ô∏è Region: ${regionName}, Cost: ‚Ç±${cost.toLocaleString()}, Color: ${color}`);
                }

                ctx.fillStyle = color;
                ctx.strokeStyle = '#666666';
                ctx.lineWidth = 1;

                if (feature.geometry.type === 'MultiPolygon') {
                    feature.geometry.coordinates.forEach(polygon => {
                        polygon.forEach(ring => {
                            ctx.beginPath();
                            ring.forEach((coord, index) => {
                                const { x, y } = toCanvasCoords(coord[0], coord[1]);
                                if (index === 0) {
                                    ctx.moveTo(x, y);
                                } else {
                                    ctx.lineTo(x, y);
                                }
                            });
                            ctx.closePath();
                            ctx.fill();
                            ctx.stroke();
                        });
                    });
                } else if (feature.geometry.type === 'Polygon') {
                    feature.geometry.coordinates.forEach(ring => {
                        ctx.beginPath();
                        ring.forEach((coord, index) => {
                            const { x, y } = toCanvasCoords(coord[0], coord[1]);
                            if (index === 0) {
                                ctx.moveTo(x, y);
                            } else {
                                ctx.lineTo(x, y);
                            }
                        });
                        ctx.closePath();
                        ctx.fill();
                        ctx.stroke();
                    });
                }
            });

            // Add region labels for high-cost regions
            const highCostRegions = Object.entries(regionCosts)
                .filter(([region, cost]) => cost > minCost + (costRange * 0.7))
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            ctx.fillStyle = '#333';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';

            highCostRegions.forEach(([region, cost], index) => {
                // Find center of region for label placement
                const feature = geoJsonData.features.find(f => 
                    (f.properties.name || f.properties.NAME_1) === region
                );
                
                if (feature && feature.geometry.type === 'MultiPolygon') {
                    // Calculate approximate center
                    let totalLat = 0, totalLng = 0, pointCount = 0;
                    
                    feature.geometry.coordinates.forEach(polygon => {
                        polygon.forEach(ring => {
                            ring.forEach(coord => {
                                totalLng += coord[0];
                                totalLat += coord[1];
                                pointCount++;
                            });
                        });
                    });
                    
                    if (pointCount > 0) {
                        const centerLng = totalLng / pointCount;
                        const centerLat = totalLat / pointCount;
                        const { x, y } = toCanvasCoords(centerLng, centerLat);
                        
                        ctx.fillText(region, x, y - 5);
                        ctx.fillText(`‚Ç±${(cost / 1000000000).toFixed(1)}B`, x, y + 5);
                    }
                }
            });

            // Add legend
            const legendX = width - 120;
            const legendY = 20;
            const legendWidth = 100;
            const legendHeight = 180;
            
            // Legend background
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.fillRect(legendX, legendY, legendWidth, legendHeight);
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            ctx.strokeRect(legendX, legendY, legendWidth, legendHeight);
            
            // Legend title
            ctx.fillStyle = '#333';
            ctx.font = 'bold 10px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Project Count', legendX + legendWidth/2, legendY + 15);
            
            // Legend items - based on actual project count ranges
            const legendColors = [
                { color: '#8B0000', label: '1500+' },
                { color: '#B22222', label: '1200-1499' },
                { color: '#DC143C', label: '1000-1199' },
                { color: '#FF4500', label: '800-999' },
                { color: '#FF6347', label: '600-799' },
                { color: '#FF7F50', label: '400-599' },
                { color: '#FFA500', label: '200-399' },
                { color: '#FFD700', label: '100-199' },
                { color: '#FFF8DC', label: '10-99' },
                { color: '#FFFACD', label: '1-9' },
                { color: '#F0F0F0', label: '0' }
            ];
            
            ctx.font = '9px Arial';
            ctx.textAlign = 'left';
            
            legendColors.forEach((item, index) => {
                const itemY = legendY + 25 + (index * 16);
                
                // Color box
                ctx.fillStyle = item.color;
                ctx.fillRect(legendX + 5, itemY - 5, 10, 10);
                ctx.strokeStyle = '#333';
                ctx.strokeRect(legendX + 5, itemY - 5, 10, 10);
                
                // Label
                ctx.fillStyle = '#333';
                ctx.fillText(item.label, legendX + 20, itemY + 2);
            });

            console.log('üó∫Ô∏è Philippine heat map created with', Object.keys(regionCosts).length, 'regions');
        })
        .catch(error => {
            console.error('‚ùå Failed to load Philippine GeoJSON:', error);
            // Fallback to simple text
            regionsCtx.parentElement.innerHTML = `
                <h3 style="color: #0038A8; margin: 0 0 15px 0;">Projects Heat Map</h3>
                <div style="color: #666; font-style: italic; text-align: center; padding: 40px;">
                    Loading Philippine map...
                </div>
            `;
        });

        // Make heat map clickable ‚Üí switch to Map tab
        if (!regionsCtx.dataset.clickBound) {
            regionsCtx.addEventListener('click', () => {
                const mapTabBtn = document.querySelector('.flood-tab[data-tab="map"]');
                if (mapTabBtn) {
                    mapTabBtn.click();
                } else {
                    // Fallback: manually activate map tab
                    const tabs = document.querySelectorAll('.flood-tab');
                    const contents = document.querySelectorAll('.tab-content');
                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));
                    const mapBtn = document.querySelector('[data-tab="map"]');
                    const mapContent = document.getElementById('map-tab');
                    if (mapBtn && mapContent) {
                        mapBtn.classList.add('active');
                        mapContent.classList.add('active');
                    }
                }
            });
            regionsCtx.dataset.clickBound = '1';
        }
    }

    function populateExpensiveProjects(projects) {
    const container = document.getElementById('expensive-projects-list');
    if (!container) return;

    if (!projects || projects.length === 0) {
        container.innerHTML = '<p style="color: #666; font-style: italic;">No expensive projects data available</p>';
        return;
    }

    const listHTML = projects.map(project => {
        const cost = project.contractCost ? 
            new Intl.NumberFormat('en-PH', {
                style: 'currency',
                currency: 'PHP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(project.contractCost) : 'N/A';
        
        // Limit project name to 5 words
        const projectName = project.projectName || 'N/A';
        const shortName = projectName.split(' ').slice(0, 5).join(' ') + (projectName.split(' ').length > 5 ? '...' : '');
        
        return `
            <div style="border-bottom: 1px solid #eee; padding: 10px 0; margin-bottom: 8px;">
                <div style="font-weight: bold; color: #0038A8; margin-bottom: 4px;">
                    ${shortName}
                </div>
                <div style="font-size: 14px; color: #666; margin-bottom: 2px;">
                    <strong>Cost:</strong> ${cost}
                </div>
                <div style="font-size: 12px; color: #888;">
                    <strong>Contractor:</strong> ${project.contractor || 'N/A'} | 
                    <strong>Location:</strong> ${project.location || 'N/A'} | 
                    <strong>Year:</strong> ${project.year || 'N/A'}
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = listHTML;
    }

    function populateExpensiveProjectsFromTableData() {
    const container = document.getElementById('expensive-projects-list');
    if (!container) return;

    if (!allTableProjects || allTableProjects.length === 0) {
        container.innerHTML = '<p style="color: #666; font-style: italic;">No project data available</p>';
        return;
    }

    // Sort projects by ContractCost descending and take top 10
    const expensiveProjects = allTableProjects
        .filter(project => project.ContractCost && project.ContractCost > 0)
        .sort((a, b) => parseFloat(b.ContractCost) - parseFloat(a.ContractCost))
        .slice(0, 10);

    if (expensiveProjects.length === 0) {
        container.innerHTML = '<p style="color: #666; font-style: italic;">No expensive projects data available</p>';
        return;
    }

    const listHTML = expensiveProjects.map(project => {
        const cost = project.ContractCost ? 
            new Intl.NumberFormat('en-PH', {
                style: 'currency',
                currency: 'PHP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(parseFloat(project.ContractCost)) : 'N/A';
        
        return `
            <div style="border-bottom: 1px solid #eee; padding: 10px 0; margin-bottom: 8px;">
                <div style="font-weight: bold; color: #0038A8; margin-bottom: 4px;">
                    ${project.ProjectName || 'N/A'}
                </div>
                <div style="font-size: 14px; color: #666; margin-bottom: 2px;">
                    <strong>Cost:</strong> ${cost}
                </div>
                <div style="font-size: 12px; color: #888;">
                    <strong>Contractor:</strong> ${project.Contractor || 'N/A'} | 
                    <strong>Location:</strong> ${project.Location || 'N/A'} | 
                    <strong>Year:</strong> ${project.InfraYear || 'N/A'}
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = listHTML;
    }

    function startGlobalProgressiveLoading() {
    if (progressiveLoadingStarted || progressiveLoadingCancelled) return;
    
    progressiveLoadingStarted = true;
    
    const loadMore = async () => {
        console.log(`üó∫Ô∏è loadMore called: isLoadingMore=${isLoadingMore}, progressiveLoadingCancelled=${progressiveLoadingCancelled}`);
        if (isLoadingMore || progressiveLoadingCancelled) {
            console.log(`üó∫Ô∏è loadMore early return: isLoadingMore=${isLoadingMore}, progressiveLoadingCancelled=${progressiveLoadingCancelled}`);
            return;
        }
        
        console.log(`üó∫Ô∏è Starting loadMore with offset=${globalOffset}`);
        setIsLoadingMore(true);
        
        try {
            const currentOffset = globalOffset;
            const currentPage = Math.floor(currentOffset / 10) + 1;
            
            const response = await fetch(`/api/flood/projects?limit=10&offset=${currentOffset}`);
            const data = await response.json();
            const newProjects = data.projects || [];
            
            // Get totals from regionData if available, otherwise use API response
            const globalTotal = regionData?.globalTotal || data.totalHits || 10000;
            const globalTotalPages = regionData?.globalTotalPages || Math.ceil(globalTotal / 10);
            
            console.log(`üó∫Ô∏è Global progressive loading: offset=${currentOffset}, page=${currentPage}/${globalTotalPages}, projects=${newProjects.length}, total=${loadedProjects.length}/${globalTotal}`);
            
            if (loadedProjects.length >= globalTotal || currentPage >= globalTotalPages) {
                // Reached maximum projects or pages, stopping progressive loading
                console.log(`üó∫Ô∏è Progressive loading complete: ${loadedProjects.length}/${globalTotal} projects loaded`);
                updateMapStatus(`${loadedProjects.length} projects loaded (progressive loading complete)`);
            } else if (currentPage === globalTotalPages) {
                // Special handling for last page - might have fewer than 10 items
                loadedProjects = [...loadedProjects, ...newProjects];
                addMarkersToMap(newProjects);
                console.log(`üó∫Ô∏è Last page loaded: ${loadedProjects.length} total projects`);
                updateMapStatus(`${loadedProjects.length} projects loaded (progressive loading complete)`);
            } else {
                loadedProjects = [...loadedProjects, ...newProjects];
                addMarkersToMap(newProjects);
                globalOffset += 1000; // Jump 1000 items (100 pages) for faster loading
                
                console.log(`üó∫Ô∏è Progressive loading: ${loadedProjects.length} total projects loaded, next offset: ${globalOffset}`);
                
                // Schedule next load only if not cancelled and not in "Show All" mode (with minimal delay)
                if (!progressiveLoadingCancelled && !showAllMode) {
                    console.log(`üó∫Ô∏è Scheduling next global loadMore call...`);
                    setIsLoadingMore(false); // Reset flag before recursive call
                    setTimeout(() => {
                        if (!progressiveLoadingCancelled && !showAllMode) {
                            loadMore();
                        }
                    }, 50); // Minimal delay to prevent interference
                    return; // Exit early to avoid finally block
                } else {
                    console.log(`üó∫Ô∏è Progressive loading cancelled or Show All mode active, stopping`);
                    setIsLoadingMore(false);
                }
            }
        } catch (error) {
            console.error('Error loading more projects:', error);
            setIsLoadingMore(false);
        }
    };
    
    // Start the chain only if not cancelled (with minimal delay)
    if (!progressiveLoadingCancelled) {
        setTimeout(() => {
            if (!progressiveLoadingCancelled) {
                loadMore();
            }
        }, 100); // Minimal delay to prevent interference
    }
    }

    // Load initial 10 projects with optimized slow loading (like bettergov)
    async function loadInitialMapData() {
    if (initialLoadDone || isLoading) return;
    
    isLoading = true;
    initialLoadDone = true;
    
    try {
        console.log('üîç Loading initial map data...');
        const response = await fetch('/api/flood/projects?limit=10&offset=0');
        if (response.ok) {
            const data = await response.json();
            const projects = data.projects || [];
            
            console.log(`‚úÖ Loaded initial ${projects.length} projects`);
            loadedProjects = projects;
            
            // Add markers for initial projects
            addMarkersToMap(projects);
            
            updateMapStatus(`Map initialized with ${projects.length} projects. Loading more automatically...`);
            
            // Start progressive loading after initial load (instant)
            startGlobalProgressiveLoading();
            
        } else {
            throw new Error(`API returned ${response.status}`);
        }
    } catch (error) {
        console.error('‚ùå Failed to load initial map data:', error);
        updateMapStatus('Loading initial map data...');
    } finally {
        isLoading = false;
    }
    }

    // Function to load all projects progressively (for Show All button)
    // Must be defined BEFORE initializeMap() so it exists when event listener is attached
    window.loadAllProjects = async function loadAllProjects() {
        console.log(`üó∫Ô∏è Loading all projects (Show All)`);
        
        // Show warning confirmation
        const confirmed = confirm(
            '‚ö†Ô∏è WARNING: Loading all 9,855 projects may:\n' +
            '‚Ä¢ Overwhelm your browser and cause it to freeze\n' +
            '‚Ä¢ Consume significant memory and CPU resources\n' +
            '‚Ä¢ Take several minutes to complete\n' +
            '‚Ä¢ Make your device unresponsive\n\n' +
            'Continue anyway?'
        );
        
        if (!confirmed) return;
        
        // Cancel any existing progressive loading (both initial page load and region loading)
        progressiveLoadingCancelled = true;
        regionProgressiveLoadingCancelled = true;
        showAllMode = true; // Activate "Show All" mode to prevent initial page load from interfering
        
        // Wait a moment to ensure any in-flight requests complete
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Update status
        updateMapStatus(`Loading all projects...`);
        
        // Clear existing markers
        mapMarkers.forEach(marker => mapInstance.removeLayer(marker));
        mapMarkers = [];
        
        // Stop any existing progressive loading
        if (progressiveInterval) {
            clearInterval(progressiveInterval);
            progressiveInterval = null;
        }
        
        // Reset progressive loading state for "Show All" loading
        progressiveLoadingStarted = false;
        globalOffset = 0;
        isLoadingMore = false;
        loadedProjects = [];
        
        // Reset cancellation flag now that we've successfully cancelled initial page load
        // This allows "Show All" progressive loading to proceed
        progressiveLoadingCancelled = false;
        // Keep region cancellation flag true since we're loading all projects (not region-specific)
        
        try {
            // Load initial batch of 100 projects (all projects, no region filter)
            const response = await fetch(`/api/flood/projects?limit=100&offset=0`);
            if (response.ok) {
                const data = await response.json();
                const projects = data.projects || [];
                
                console.log(`‚úÖ Loaded initial ${projects.length} projects for all projects`);
                loadedProjects = projects;
                
                // Add markers for initial projects
                addMarkersToMap(projects);
                
                // Start progressive loading if we got a full batch and there are more
                const totalHits = data.totalHits || 9855; // Use known total or API response
                const totalPages = Math.ceil(totalHits / 100);
                
                console.log(`üó∫Ô∏è All projects: ${projects.length} loaded, ${totalHits} total, ${totalPages} pages`);
                
                // Debug the condition (same pattern as region loading)
                console.log(`üó∫Ô∏è Debug progressive loading condition for all projects:`);
                console.log(`  - projects.length === 100: ${projects.length === 100}`);
                console.log(`  - totalPages > 1: ${totalPages > 1}`);
                console.log(`  - totalHits > 100: ${totalHits > 100}`);
                console.log(`  - !progressiveLoadingStarted: ${!progressiveLoadingStarted}`);
                
                if (projects.length === 100 && totalPages > 1 && totalHits > 100 && !progressiveLoadingStarted) {
                    console.log(`üó∫Ô∏è Starting progressive loading for all projects`);
                    startAllProjectsProgressiveLoading(totalPages, totalHits);
                } else {
                    console.log(`üó∫Ô∏è No progressive loading needed for all projects (${projects.length}/${totalHits})`);
                }
                
                updateMapStatus(`${mapMarkers.length} projects loaded${totalPages > 1 ? ' (loading more...)' : ''}`);
                
            } else {
                throw new Error(`API returned ${response.status}`);
            }
            
        } catch (error) {
            console.error(`‚ùå Failed to load all projects:`, error);
            updateMapStatus(`Error loading all projects...`);
        }
    }
    
    function startAllProjectsProgressiveLoading(totalPages, totalHits) {
        if (progressiveLoadingStarted) return;
        
        progressiveLoadingStarted = true;
        let currentOffset = 100; // Start from offset 100 (since we already loaded 0-99)
        
        const loadMoreAllProjects = async () => {
            console.log(`üó∫Ô∏è loadMoreAllProjects called: offset ${currentOffset}, isLoadingMore: ${isLoadingMore}, progressiveLoadingCancelled: ${progressiveLoadingCancelled}`);
            
            if (isLoadingMore || progressiveLoadingCancelled) {
                console.log(`üó∫Ô∏è loadMoreAllProjects early return: isLoadingMore=${isLoadingMore}, progressiveLoadingCancelled=${progressiveLoadingCancelled}`);
                return;
            }
            
            // Stop if we've already loaded all projects
            if (loadedProjects.length >= totalHits) {
                console.log(`üó∫Ô∏è All projects loaded: ${loadedProjects.length}/${totalHits}`);
                updateMapStatus(`${loadedProjects.length} projects loaded (complete)`);
                setIsLoadingMore(false);
                return;
            }
            
            console.log(`üó∫Ô∏è Starting loadMoreAllProjects with offset=${currentOffset}`);
            setIsLoadingMore(true);
            
            try {
                const response = await fetch(`/api/flood/projects?limit=100&offset=${currentOffset}`);
                const data = await response.json();
                const newProjects = data.projects || [];
                
                console.log(`üó∫Ô∏è Loading offset ${currentOffset}: ${newProjects.length} projects, total loaded: ${loadedProjects.length}/${totalHits}`);
                
                if (newProjects.length === 0) {
                    // No more projects to load
                    console.log(`üó∫Ô∏è No more projects, stopping at ${loadedProjects.length}/${totalHits}`);
                    updateMapStatus(`${loadedProjects.length} projects loaded (complete)`);
                    setIsLoadingMore(false);
                    return;
                }
                
                // Add new projects
                loadedProjects = [...loadedProjects, ...newProjects];
                addMarkersToMap(newProjects);
                
                // Check if we've loaded all projects
                if (loadedProjects.length >= totalHits) {
                    console.log(`üó∫Ô∏è All ${loadedProjects.length} projects loaded (complete)`);
                    updateMapStatus(`${loadedProjects.length} projects loaded (complete)`);
                    setIsLoadingMore(false);
                    return;
                }
                
                // Move to next batch
                currentOffset += 100;
                
                console.log(`üó∫Ô∏è Continuing progressive loading: next offset ${currentOffset}, loaded ${loadedProjects.length}/${totalHits}`);
                updateMapStatus(`${loadedProjects.length} projects loaded (loading more...)`);
                
                // Schedule next load (with minimal delay)
                setIsLoadingMore(false); // Reset flag before recursive call
                setTimeout(() => {
                    if (!progressiveLoadingCancelled) {
                        loadMoreAllProjects();
                    }
                }, 50); // Minimal delay to prevent interference
            } catch (error) {
                console.error('Error loading more projects:', error);
                setIsLoadingMore(false);
            }
        };
        
        // Start the progressive loading chain (instant)
        loadMoreAllProjects();
    }

    // Map initialization
    function initializeMap() {
    const mapContainer = document.getElementById('map');
    if (mapContainer) {
        // Ensure container is visible and has dimensions
        if (mapContainer.offsetWidth === 0 || mapContainer.offsetHeight === 0) {
            console.warn('Map container has no dimensions, retrying in 100ms...');
            setTimeout(initializeMap, 100);
            return;
        }
        
            // Initialize Leaflet map centered on Philippines with optimal view for wider container
            mapInstance = L.map('map', {
                preferCanvas: false,
                renderer: L.canvas()
            }).setView([12.2, 121.8], 6.2);
        
        // Add OpenStreetMap tiles with proper configuration for better loading
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19,
            minZoom: 3,
            subdomains: ['a', 'b', 'c'],
            tileSize: 256,
            zoomOffset: 0,
            crossOrigin: true,
            bounds: [[4.5, 116], [21, 127]], // Philippines bounds
            maxBounds: [[4.5, 116], [21, 127]] // Restrict panning to Philippines area
        }).addTo(mapInstance);
        
            // Set map bounds to fit Philippines properly in larger container
            mapInstance.fitBounds([[4.5, 116], [21, 127]], {
                padding: [30, 30],
                maxZoom: 6.5
            });
        
        // Add fallback tile layer for better reliability
        const fallbackLayer = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors (Fallback)',
            maxZoom: 19,
            minZoom: 3
        });
        
        // Add error handling for tile loading
        mapInstance.on('tileerror', function(e) {
            console.warn('Tile loading error:', e);
        });
        
        // Show initial state
        updateMapStatus('Map initialized. Loading initial data...');
        
        // Force map to resize and invalidate size
        setTimeout(() => {
            if (mapInstance) {
                mapInstance.invalidateSize();
                console.log('‚úÖ Map invalidated and resized');
            }
        }, 100);
        
        // Add region click functionality with accurate boundaries
        addRegionClickFunctionality();
        
        // Load initial map data (10 projects with progressive loading)
        loadInitialMapData();
        
        // Load filter options for map
        loadMapFilterOptions();
        
        // Set up Show All button event listener
        const showAllMap = document.getElementById('show-all-map');
        if (showAllMap) {
            showAllMap.addEventListener('click', window.loadAllProjects);
            console.log('‚úÖ Show All button event listener attached');
        } else {
            console.error('‚ùå Show All button not found');
        }
    }
    
    async function loadMapFilterOptions() {
    try {
        // Load regions
        const regionsResponse = await fetch('/api/flood/lookup/regions');
        if (regionsResponse.ok) {
            const regionsData = await regionsResponse.json();
            const regionSelect = document.getElementById('map-region-filter');
            if (regionSelect) {
                regionSelect.innerHTML = '<option value="">All Regions</option>';
                regionsData.regions.forEach(region => {
                    const option = document.createElement('option');
                    option.value = region;
                    option.textContent = region;
                    regionSelect.appendChild(option);
                });
            }
        }
        
        // Load years
        const yearsResponse = await fetch('/api/flood/lookup/years');
        if (yearsResponse.ok) {
            const yearsData = await yearsResponse.json();
            const yearSelect = document.getElementById('map-year-filter');
            if (yearSelect) {
                yearSelect.innerHTML = '<option value="">All Years</option>';
                yearsData.years.sort((a, b) => parseInt(b) - parseInt(a)).forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                });
            }
        }
        
        // Load work types
        const workTypesResponse = await fetch('/api/flood/lookup/types-of-work');
        if (workTypesResponse.ok) {
            const workTypesData = await workTypesResponse.json();
            const workTypeSelect = document.getElementById('map-work-type-filter');
            if (workTypeSelect) {
                workTypeSelect.innerHTML = '<option value="">All Work Types</option>';
                workTypesData.types_of_work.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    workTypeSelect.appendChild(option);
                });
            }
        }
        
        console.log('‚úÖ Map filter options loaded');
    } catch (error) {
        console.error('‚ùå Failed to load map filter options:', error);
    }
    }
    
    function createRealMapMarkers(map, data) {
        // Remove error message if data loads successfully
        const errorDiv = map.getContainer().querySelector('div[style*="position: absolute"]');
        if (errorDiv) {
            errorDiv.remove();
        }
        
        // Add real markers if we have project data with coordinates
        if (data.projects && Array.isArray(data.projects)) {
            data.projects.forEach(project => {
                // Only add markers if we have coordinate data
                // For now, just show that data is loading
                console.log('üìç Would add marker for project:', project.ProjectDescription);
            });
        }
    }
}

// Contractor popup functionality
let contractorDatabase = null;
let contractorMapping = null;

// Load contractor database and mapping
async function loadContractorDatabase() {
    try {
        // Load SEC database
        const dbResponse = await fetch('/static/sec_contractors_database.json');
        if (dbResponse.ok) {
            contractorDatabase = await dbResponse.json();
            console.log('‚úÖ Contractor database loaded:', contractorDatabase.summary);
        } else {
            console.log('‚ö†Ô∏è Contractor database not found, popups will show limited info');
        }
        
        // Load manual mapping
        const mappingResponse = await fetch('/static/contractor_sec_mapping.json');
        if (mappingResponse.ok) {
            contractorMapping = await mappingResponse.json();
            console.log('‚úÖ Contractor mapping loaded:', Object.keys(contractorMapping.mapping).length, 'mappings');
        } else {
            console.log('‚ö†Ô∏è Contractor mapping not found, using fallback matching');
        }
    } catch (error) {
        console.log('‚ö†Ô∏è Error loading contractor database:', error);
    }
}

// Show contractor popup
function showContractorPopup(contractorName) {
    console.log('üîç Showing popup for contractor:', contractorName);
    console.log('üîç Contractor database available:', contractorDatabase ? 'Yes' : 'No');
    
    // Create popup HTML
    let popupHTML = `
        <div id="contractor-popup" style="
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 2px solid #0038A8;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 10000;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="color: #0038A8; margin: 0;">üè¢ Contractor Information</h3>
                <button onclick="closeContractorPopup()" style="
                    background: #dc3545;
                    color: white;
                    border: none;
                    border-radius: 50%;
                    width: 30px;
                    height: 30px;
                    cursor: pointer;
                    font-size: 16px;
                ">√ó</button>
            </div>
            <div id="contractor-content">
                <p><strong>Contractor:</strong> ${contractorName}</p>
                <p><em>Loading SEC information...</em></p>
            </div>
        </div>
        <div id="contractor-overlay" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
        " onclick="closeContractorPopup()"></div>
    `;
    
    // Add to page
    document.body.insertAdjacentHTML('beforeend', popupHTML);
    
    // Load contractor data
    loadContractorData(contractorName);
}

// Load contractor data from database
function loadContractorData(contractorName) {
    console.log('üîç Loading contractor data for:', contractorName);
    const contentDiv = document.getElementById('contractor-content');
    
    if (!contractorDatabase) {
        console.log('‚ö†Ô∏è Contractor database not available');
        contentDiv.innerHTML = `
            <p><strong>Contractor:</strong> ${contractorName}</p>
            <p><em>SEC database not available. Run the contractor search automation to populate data.</em></p>
        `;
        return;
    }
    
    console.log('üîç Searching in database with', contractorDatabase.contractors.length, 'contractors');
    
    let contractor = null;
    
    // First try manual mapping if available
    if (contractorMapping && contractorMapping.mapping[contractorName]) {
        const mappedName = contractorMapping.mapping[contractorName];
        console.log('üîç Using manual mapping:', contractorName, '->', mappedName);
        
        contractor = contractorDatabase.contractors.find(c => 
            c.original_contractor_name === mappedName
        );
        
        if (contractor) {
            console.log('üîç Found via manual mapping:', contractor.original_contractor_name);
        }
    }
    
    // If manual mapping didn't work, try fallback matching
    if (!contractor) {
        console.log('üîç Manual mapping failed, trying fallback matching');
        contractor = contractorDatabase.contractors.find(c => {
            const originalName = c.original_contractor_name?.toLowerCase() || '';
            const companyName = c.company_name?.toLowerCase() || '';
            const searchName = contractorName.toLowerCase();
            
            // Try exact match first
            if (originalName === searchName || companyName === searchName) {
                return true;
            }
            
            // Try partial matches
            if (originalName.includes(searchName) || companyName.includes(searchName)) {
                return true;
            }
            
            // Try reverse match (search name contains database name)
            if (searchName.includes(originalName) || searchName.includes(companyName)) {
                return true;
            }
            
            // Try matching just the main part (before parentheses)
            const mainPart = searchName.split('(')[0].trim();
            if (originalName.includes(mainPart) || companyName.includes(mainPart)) {
                return true;
            }
            
            // Try matching against original_contractor_name more aggressively
            if (originalName && originalName !== 'n/a' && originalName !== '') {
                // Try exact match with original name
                if (originalName === searchName) {
                    return true;
                }
                
                // Try partial match with original name
                if (originalName.includes(searchName) || searchName.includes(originalName)) {
                    return true;
                }
                
                // Try matching main parts
                const originalMainPart = originalName.split('(')[0].trim();
                const searchMainPart = searchName.split('(')[0].trim();
                if (originalMainPart === searchMainPart || 
                    originalMainPart.includes(searchMainPart) || 
                    searchMainPart.includes(originalMainPart)) {
                    return true;
                }
            }
            
            return false;
        });
    }
    
    console.log('üîç Found contractor:', contractor ? 'Yes' : 'No');
    if (contractor) {
        console.log('üîç Matched contractor:', contractor.original_contractor_name, '->', contractor.company_name);
    }
    
    if (contractor) {
        contentDiv.innerHTML = `
            <p><strong>Contractor:</strong> ${contractorName}</p>
            <hr style="margin: 15px 0;">
            <h4 style="color: #0038A8; margin: 10px 0 5px 0;">SEC Registration Details:</h4>
            <p><strong>Company Name:</strong> ${contractor.company_name || 'N/A'}</p>
            <p><strong>SEC Number:</strong> ${contractor.sec_number || 'N/A'}</p>
            <p><strong>Date Registered:</strong> ${contractor.date_registered || 'N/A'}</p>
            <p><strong>Registered Address:</strong> ${contractor.registered_address || 'N/A'}</p>
            <p><strong>Secondary License Details:</strong> ${contractor.secondary_license_details || 'N/A'}</p>
            <p><strong>Reportorial Submissions:</strong> ${contractor.reportorial_submissions ? contractor.reportorial_submissions.substring(0, 200) + '...' : 'N/A'}</p>
        `;
    } else {
        contentDiv.innerHTML = `
            <p><strong>Contractor:</strong> ${contractorName}</p>
            <p style="color: #dc3545;"><em>No SEC registration information found for this contractor.</em></p>
            <p style="color: #dc3545;"><small>Run the contractor search automation to check SEC database.</small></p>
        `;
    }
}

// Close contractor popup
function closeContractorPopup() {
    const popup = document.getElementById('contractor-popup');
    const overlay = document.getElementById('contractor-overlay');
    if (popup) popup.remove();
    if (overlay) overlay.remove();
}

// Show SEC data modal for contractor
async function showSecData(contractorName) {
    console.log('üèõÔ∏è Showing SEC data for contractor:', contractorName);
    
    // Create modal HTML
    const modalHTML = `
        <div id="sec-modal-overlay" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
        " onclick="closeSecModal()">
            <div id="sec-modal" style="
                background: white;
                border-radius: 8px;
                padding: 30px;
                max-width: 800px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                position: relative;
                margin: 20px;
            " onclick="event.stopPropagation()">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #0038A8; margin: 0; font-size: 1.5em;">üèõÔ∏è SEC Data</h2>
                    <button onclick="closeSecModal()" style="
                        background: none;
                        border: none;
                        font-size: 24px;
                        cursor: pointer;
                        color: #666;
                        padding: 5px;
                    ">&times;</button>
                </div>
                <div id="sec-modal-content" style="
                    border: 1px solid #ddd;
                    border-radius: 6px;
                    padding: 20px;
                    background: #f8f9fa;
                ">
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>
                        <div>Loading SEC data...</div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Load SEC data
    await loadSecModalData(contractorName);
}

// Load SEC data for modal
async function loadSecModalData(contractorName) {
    const contentDiv = document.getElementById('sec-modal-content');
    
    try {
        // Load SEC database
        const response = await fetch('/static/sec_contractors_database.json');
        if (!response.ok) {
            throw new Error('Failed to load SEC database');
        }
        
        const secData = await response.json();
        const contractors = secData.contractors || [];
        
                // Find matching contractor using improved logic (same as corrected table)
                let matchingContractor = null;
                
                // Load mapping data for better matching
                const mappingResponse = await fetch('/static/contractor_sec_mapping.json');
                let contractorMapping = { mapping: {} };
                if (mappingResponse.ok) {
                    contractorMapping = await mappingResponse.json();
                }
                
                // Normalize the input contractor name
                const normalizedContractorName = normalizeContractorName(contractorName);
                
                // Strategy 1: Exact match with normalized original_contractor_name (prioritize entries with SEC data)
                const exactMatches = contractors.filter(c => 
                    c.original_contractor_name && 
                    normalizeContractorName(c.original_contractor_name) === normalizedContractorName
                );
                matchingContractor = exactMatches.find(c => c.sec_number && c.sec_number.trim() !== '') || exactMatches[0];
                
                // Strategy 2: Exact match with normalized company_name (prioritize entries with SEC data)
                if (!matchingContractor) {
                    const companyMatches = contractors.filter(c => 
                        c.company_name && 
                        normalizeContractorName(c.company_name) === normalizedContractorName
                    );
                    matchingContractor = companyMatches.find(c => c.sec_number && c.sec_number.trim() !== '') || companyMatches[0];
                }
                
                // Strategy 3: Try mapped name (prioritize entries with SEC data)
                if (!matchingContractor && contractorMapping.mapping[contractorName]) {
                    const mappedName = contractorMapping.mapping[contractorName];
                    const mappedMatches = contractors.filter(c => 
                        c.original_contractor_name && 
                        normalizeContractorName(c.original_contractor_name) === normalizeContractorName(mappedName)
                    );
                    matchingContractor = mappedMatches.find(c => c.sec_number && c.sec_number.trim() !== '') || mappedMatches[0];
                }
                
                // Strategy 4: Partial match (contractor name contains original name) - prioritize SEC data
                if (!matchingContractor) {
                    const partialMatches = contractors.filter(c => 
                        c.original_contractor_name && 
                        normalizedContractorName.includes(normalizeContractorName(c.original_contractor_name))
                    );
                    matchingContractor = partialMatches.find(c => c.sec_number && c.sec_number.trim() !== '') || partialMatches[0];
                }
                
                // Strategy 5: Reverse partial match (original name contains contractor name) - prioritize SEC data
                if (!matchingContractor) {
                    const reverseMatches = contractors.filter(c => 
                        c.original_contractor_name && 
                        normalizeContractorName(c.original_contractor_name).includes(normalizedContractorName)
                    );
                    matchingContractor = reverseMatches.find(c => c.sec_number && c.sec_number.trim() !== '') || reverseMatches[0];
                }
                
                // Strategy 6: Company name partial match - prioritize SEC data
                if (!matchingContractor) {
                    const companyPartialMatches = contractors.filter(c => 
                        c.company_name && 
                        (normalizedContractorName.includes(normalizeContractorName(c.company_name)) ||
                         normalizeContractorName(c.company_name).includes(normalizedContractorName))
                    );
                    matchingContractor = companyPartialMatches.find(c => c.sec_number && c.sec_number.trim() !== '') || companyPartialMatches[0];
                }
                
                // Strategy 7: Word-based matching (check if key words match) - prioritize SEC data
                if (!matchingContractor) {
                    const contractorWords = normalizedContractorName.split(' ').filter(w => w.length > 2);
                    const wordMatches = contractors.filter(c => {
                        if (!c.original_contractor_name && !c.company_name) return false;
                        
                        const secWords = normalizeContractorName(c.original_contractor_name || c.company_name).split(' ').filter(w => w.length > 2);
                        
                        // Check if at least 3 key words match
                        const matchingWords = contractorWords.filter(word => 
                            secWords.some(secWord => 
                                secWord.includes(word) || word.includes(secWord)
                            )
                        );
                        
                        return matchingWords.length >= Math.min(3, contractorWords.length - 1);
                    });
                    matchingContractor = wordMatches.find(c => c.sec_number && c.sec_number.trim() !== '') || wordMatches[0];
                }
        
        console.log('üîç SEC search result for', contractorName, ':', matchingContractor);
        
        if (matchingContractor && matchingContractor.sec_number && matchingContractor.sec_number.trim() !== '') {
            // Show SEC data
            contentDiv.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <h3 style="color: #0038A8; margin: 0 0 10px 0; font-size: 1.2em;">Company Information</h3>
                    <p style="margin: 5px 0;"><strong>Company Name:</strong> ${escapeHtml(matchingContractor.company_name || 'N/A')}</p>
                    <p style="margin: 5px 0;"><strong>SEC Number:</strong> ${escapeHtml(matchingContractor.sec_number || 'N/A')}</p>
                    <p style="margin: 5px 0;"><strong>Date Registered:</strong> ${escapeHtml(matchingContractor.date_registered || 'N/A')}</p>
                    <p style="margin: 5px 0;"><strong>Registered Address:</strong> ${escapeHtml(matchingContractor.registered_address || 'N/A')}</p>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <h3 style="color: #0038A8; margin: 0 0 10px 0; font-size: 1.2em;">License Details</h3>
                    <p style="margin: 5px 0; line-height: 1.4;">${escapeHtml(matchingContractor.secondary_license_details || 'N/A')}</p>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <h3 style="color: #0038A8; margin: 0 0 10px 0; font-size: 1.2em;">Additional Information</h3>
                    <p style="margin: 5px 0;"><strong>Original Contractor Name:</strong> ${escapeHtml(matchingContractor.original_contractor_name || 'N/A')}</p>
                    <p style="margin: 5px 0;"><strong>Source File:</strong> ${escapeHtml(matchingContractor.source_file || 'N/A')}</p>
                    <p style="margin: 5px 0;"><strong>Parsed At:</strong> ${escapeHtml(matchingContractor.parsed_at || 'N/A')}</p>
                </div>
                
                <div style="background: #e9ecef; padding: 15px; border-radius: 4px; margin-top: 15px;">
                    <h4 style="color: #0038A8; margin: 0 0 10px 0;">üìã Reportorial Submissions</h4>
                    <div style="max-height: 200px; overflow-y: auto; font-size: 0.9em; line-height: 1.4;">
                        ${escapeHtml(matchingContractor.reportorial_submissions || 'No additional information available.')}
                    </div>
                </div>
            `;
        } else {
            // Check if this contractor is in our processed list but has no SEC data (missing)
            const isProcessedButMissing = contractors.find(c => 
                c.original_contractor_name && 
                c.original_contractor_name.toLowerCase() === contractorName.toLowerCase()
            );
            
            if (isProcessedButMissing) {
                // This contractor was processed but has no SEC data - it's confirmed missing
                contentDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                        <h3 style="color: #dc3545; margin: 0 0 10px 0;">Confirmed Missing SEC Data</h3>
                        <p style="color: #666; margin: 0 0 15px 0;">
                            Contractor: <strong>${escapeHtml(contractorName)}</strong>
                        </p>
                        <p style="color: #666; font-size: 0.9em;">
                            This contractor was processed but no SEC registration data was found. 
                            This contractor may not be registered with the SEC.
                        </p>
                    </div>
                `;
            } else {
                // This contractor hasn't been processed yet - it's unprocessed
                contentDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚è≥</div>
                        <h3 style="color: #6c757d; margin: 0 0 10px 0;">Unprocessed Contractor</h3>
                        <p style="color: #666; margin: 0 0 15px 0;">
                            Contractor: <strong>${escapeHtml(contractorName)}</strong>
                        </p>
                        <p style="color: #666; font-size: 0.9em;">
                            This contractor has not been processed for SEC data yet. 
                            SEC data will be available after processing.
                        </p>
                    </div>
                `;
            }
        }
        
    } catch (error) {
        console.error('‚ùå Error loading SEC data:', error);
        contentDiv.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                <h3 style="color: #dc3545; margin: 0 0 10px 0;">Error Loading SEC Data</h3>
                <p style="color: #666; margin: 0;">
                    Failed to load SEC database. Please try again later.
                </p>
            </div>
        `;
    }
}

// Close SEC modal
function closeSecModal() {
    const modal = document.getElementById('sec-modal-overlay');
    if (modal) modal.remove();
}

// Show contractor hover tooltip with SEC details
function showContractorHoverTooltip(event, contractorName) {
    // Remove existing tooltip
    hideContractorHoverTooltip();
    
    // Find contractor data for tooltip
    let contractor = null;
    if (contractorDatabase && contractorMapping) {
        // Try manual mapping first
        if (contractorMapping.mapping[contractorName]) {
            const mappedName = contractorMapping.mapping[contractorName];
            contractor = contractorDatabase.contractors.find(c => 
                c.original_contractor_name === mappedName
            );
        }
        
        // Fallback to fuzzy matching
        if (!contractor) {
            contractor = contractorDatabase.contractors.find(c => {
                const originalName = c.original_contractor_name?.toLowerCase() || '';
                const companyName = c.company_name?.toLowerCase() || '';
                const searchName = contractorName.toLowerCase();
                
                // Try exact match first
                if (originalName === searchName || companyName === searchName) {
                    return true;
                }
                
                // Try partial matches
                if (originalName.includes(searchName) || companyName.includes(searchName)) {
                    return true;
                }
                
                // Try reverse match (search name contains database name)
                if (searchName.includes(originalName) || searchName.includes(companyName)) {
                    return true;
                }
                
                // Try matching just the main part (before parentheses)
                const mainPart = searchName.split('(')[0].trim();
                if (originalName.includes(mainPart) || companyName.includes(mainPart)) {
                    return true;
                }
                
                // Try matching against original_contractor_name more aggressively
                if (originalName && originalName !== 'n/a' && originalName !== '') {
                    // Try exact match with original name
                    if (originalName === searchName) {
                        return true;
                    }
                    
                    // Try partial match with original name
                    if (originalName.includes(searchName) || searchName.includes(originalName)) {
                        return true;
                    }
                    
                    // Try matching main parts
                    const originalMainPart = originalName.split('(')[0].trim();
                    const searchMainPart = searchName.split('(')[0].trim();
                    if (originalMainPart === searchMainPart || 
                        originalMainPart.includes(searchMainPart) || 
                        searchMainPart.includes(originalMainPart)) {
                        return true;
                    }
                }
                
                return false;
            });
        }
    }
    
    // Create tooltip HTML with actual SEC data
    const tooltipHTML = `
        <div id="contractor-hover-tooltip" style="
            position: fixed;
            background: white;
            border: 2px solid #0038A8;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-width: 300px;
            font-size: 14px;
            pointer-events: none;
        ">
            <div style="color: #0038A8; font-weight: bold; margin-bottom: 8px;">
                üè¢ ${contractorName}
            </div>
            ${contractor ? `
                <div style="color: #666; margin-bottom: 5px;">
                    <strong>Company Name:</strong> ${contractor.company_name || 'N/A'}
                </div>
                <div style="color: #666; margin-bottom: 5px;">
                    <strong>SEC Number:</strong> ${contractor.sec_number || 'N/A'}
                </div>
                <div style="color: #666; margin-bottom: 5px;">
                    <strong>Date Registered:</strong> ${contractor.date_registered || 'N/A'}
                </div>
                <div style="color: #666; margin-bottom: 5px;">
                    <strong>Address:</strong> ${contractor.registered_address ? contractor.registered_address.substring(0, 100) + '...' : 'N/A'}
                </div>
            ` : `
                <div style="color: #dc3545; margin-bottom: 5px;">
                    <strong>Company Name:</strong> <span style="color: #dc3545;">Not found</span>
                </div>
                <div style="color: #dc3545; margin-bottom: 5px;">
                    <strong>SEC Number:</strong> <span style="color: #dc3545;">Not found</span>
                </div>
                <div style="color: #dc3545; margin-bottom: 5px;">
                    <strong>Date Registered:</strong> <span style="color: #dc3545;">Not found</span>
                </div>
                <div style="color: #dc3545; margin-bottom: 5px;">
                    <strong>Address:</strong> <span style="color: #dc3545;">Not found</span>
                </div>
            `}
            <div style="color: #666; font-size: 12px; margin-top: 8px;">
                üí° Click for full details
            </div>
        </div>
    `;
    
    // Add tooltip to page
    document.body.insertAdjacentHTML('beforeend', tooltipHTML);
    
    // Position tooltip near mouse cursor
    const tooltip = document.getElementById('contractor-hover-tooltip');
    const rect = tooltip.getBoundingClientRect();
    const x = event.clientX + 10;
    const y = event.clientY - rect.height - 10;
    
    // Adjust if tooltip would go off screen
    const adjustedX = x + rect.width > window.innerWidth ? event.clientX - rect.width - 10 : x;
    const adjustedY = y < 0 ? event.clientY + 10 : y;
    
    tooltip.style.left = adjustedX + 'px';
    tooltip.style.top = adjustedY + 'px';
}

// Hide contractor hover tooltip
function hideContractorHoverTooltip() {
    const tooltip = document.getElementById('contractor-hover-tooltip');
    if (tooltip) {
        tooltip.remove();
    }
}

// Load contractors without SEC data
async function loadContractorsWithoutSec() {
    const container = document.getElementById('contractorsWithoutSec');
    if (!container) return;
    
    try {
        // Load SEC database to get contractors without SEC data
        const response = await fetch('/static/sec_contractors_database.json');
        if (!response.ok) {
            throw new Error('Failed to load SEC database');
        }
        
        const secData = await response.json();
        const contractors = secData.contractors || [];
        
        // Use summary data for accurate count
        const summary = secData.summary || {};
        const withoutSecCount = summary.contractors_with_zero_results || 0;
        
        // Get contractors without SEC data for display
        // Show all contractors without SEC data, but limit to a reasonable number for display
        const contractorsWithoutSec = contractors.filter(c => !c.sec_number || c.sec_number.trim() === '');
        
        // Limit to first 20 contractors without SEC data for display (to avoid overwhelming the UI)
        const displayLimit = 20;
        const contractorsToShow = contractorsWithoutSec.slice(0, displayLimit);
        
        console.log('üìã Contractors without SEC data:', withoutSecCount, '(from summary), actual filtered:', contractorsWithoutSec.length);
        
        container.innerHTML = '';
        
        if (contractorsToShow.length === 0) {
            container.innerHTML = `
                <div style="
                    background: #d4edda;
                    border: 2px solid #28a745;
                    border-radius: 8px;
                    padding: 20px;
                    text-align: center;
                    grid-column: 1 / -1;
                ">
                    <div style="font-size: 24px; margin-bottom: 10px;">‚úÖ</div>
                    <h4 style="color: #28a745; margin: 0 0 10px 0;">All Contractors Have SEC Data</h4>
                    <p style="color: #155724; margin: 0;">Great news! All processed contractors have SEC registration data.</p>
                </div>
            `;
        } else {
            // Show total count if we're limiting the display
            if (contractorsWithoutSec.length > displayLimit) {
                container.innerHTML += `
                    <div style="
                        background: #f8f9fa;
                        border: 2px solid #6c757d;
                        border-radius: 8px;
                        padding: 15px;
                        margin-bottom: 15px;
                        text-align: center;
                        grid-column: 1 / -1;
                    ">
                        <h4 style="color: #6c757d; margin: 0 0 5px 0;">Showing ${displayLimit} of ${contractorsWithoutSec.length} contractors without SEC data</h4>
                        <p style="color: #6c757d; margin: 0; font-size: 0.9em;">Use the contractor table above to see all contractors and their SEC status</p>
                    </div>
                `;
            }
            
            contractorsToShow.forEach(contractor => {
                const contractorName = contractor.original_contractor_name || contractor.company_name || 'Unknown Contractor';
                const cardHTML = `
                    <div style="
                        background: #fff3cd;
                        border: 2px solid #dc3545;
                        border-radius: 8px;
                        padding: 15px;
                        text-align: center;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='#f8d7da'" onmouseout="this.style.background='#fff3cd'"
                       onclick="showSecData('${escapeHtml(contractorName)}')">
                        <h4 style="color: #dc3545; margin: 0 0 10px 0; font-size: 1.1em;">${escapeHtml(contractorName)}</h4>
                        <p style="color: #856404; margin: 0; font-size: 0.9em;">
                            <strong>Original Name:</strong> ${escapeHtml(contractor.original_contractor_name || 'N/A')}<br>
                            <span style="color: #dc3545; font-weight: bold;">‚ö†Ô∏è No SEC Data Found</span><br>
                            <small style="color: #666;">Click to view details</small>
                        </p>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', cardHTML);
            });
        }
        
    } catch (error) {
        console.error('‚ùå Error loading contractors without SEC data:', error);
        container.innerHTML = `
            <div style="
                background: #f8d7da;
                border: 2px solid #dc3545;
                border-radius: 8px;
                padding: 20px;
                text-align: center;
                grid-column: 1 / -1;
            ">
                <div style="font-size: 24px; margin-bottom: 10px;">‚ùå</div>
                <h4 style="color: #dc3545; margin: 0 0 10px 0;">Error Loading Data</h4>
                <p style="color: #721c24; margin: 0;">Failed to load contractors without SEC data. Please try again later.</p>
            </div>
        `;
    }
}

// Load SEC data for SEC tab
async function loadSecData() {
    console.log('üèõÔ∏è Loading SEC data...');
    
    try {
        // Get SEC data from SEC database first
        const secResponse = await fetch('/static/sec_contractors_database.json');
        console.log('üîç SEC database response status:', secResponse.status, secResponse.statusText);
        
        if (secResponse.ok) {
            const secData = await secResponse.json();
            console.log('‚úÖ SEC database loaded:', secData);
            
            // Cache SEC data for synchronous access in contractor table
            window.secDataCache = secData;
            
            // Use corrected summary data from SEC database
            const summary = secData.summary || {};
            const withSecData = summary.contractors_with_sec_data || 0;
            const withoutSecData = summary.contractors_with_zero_results || 0;
            const totalProcessedContractors = summary.total_contractors || 0;
            
            console.log('üìä SEC stats from database:', { 
                totalProcessedContractors, 
                withSecData, 
                withoutSecData,
                secDatabaseSize: secData.contractors.length 
            });
            
            // Try to get MeiliSearch stats for total contractor count (all contractors in system)
            let totalSystemContractors = 0;
            let coverageRate = 0;
            
            try {
                const statsResponse = await fetch('/api/flood/statistics');
                if (statsResponse.ok) {
                    const statsData = await statsResponse.json();
                    totalSystemContractors = statsData.uniqueContractors || 0;
                    console.log('‚úÖ MeiliSearch stats loaded:', statsData);
                } else {
                    console.warn('‚ö†Ô∏è MeiliSearch stats failed, using fallback count');
                    // Use a reasonable fallback - total processed contractors + estimated unprocessed
                    totalSystemContractors = totalProcessedContractors + 2359; // 50 processed + 2359 unprocessed
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è MeiliSearch stats error, using fallback count:', error);
                // Use a reasonable fallback - total processed contractors + estimated unprocessed
                totalSystemContractors = totalProcessedContractors + 2359; // 50 processed + 2359 unprocessed
            }
            
            // Calculate coverage rate based on total system contractors
            coverageRate = totalSystemContractors > 0 ? Math.round((withSecData / totalSystemContractors) * 100) : 0;
            
            console.log('üìä Final SEC stats:', { 
                totalSystemContractors, 
                totalProcessedContractors,
                withSecData, 
                withoutSecData, 
                coverageRate
            });
            
            document.getElementById('sec-total-contractors-count').textContent = totalSystemContractors.toLocaleString('en-PH');
            document.getElementById('total-sec-count').textContent = withSecData.toLocaleString('en-PH');
            document.getElementById('without-sec-count').textContent = withoutSecData.toLocaleString('en-PH');
            document.getElementById('sec-coverage-rate').textContent = coverageRate + '%';
            
                    console.log('‚úÖ SEC statistics updated');
                    
                    // Refresh contractor table to show updated SEC status
                    if (typeof renderContractors === 'function') {
                        console.log('üîÑ Refreshing contractor table with SEC data...');
                        renderContractors();
                    }
                } else {
                    console.error('‚ùå Failed to load SEC database - Status:', secResponse.status, secResponse.statusText);
                    document.getElementById('sec-total-contractors-count').textContent = 'File Not Found';
                    document.getElementById('total-sec-count').textContent = 'File Not Found';
                    document.getElementById('without-sec-count').textContent = 'File Not Found';
                    document.getElementById('sec-coverage-rate').textContent = 'File Not Found';
                }
    } catch (error) {
        console.error('‚ùå Error loading SEC data:', error);
        document.getElementById('sec-total-contractors-count').textContent = 'Load Error';
        document.getElementById('total-sec-count').textContent = 'Load Error';
        document.getElementById('without-sec-count').textContent = 'Load Error';
        document.getElementById('sec-coverage-rate').textContent = 'Load Error';
    }
}

// Tab switching logic
function switchTab(tabName, updateHash = true) {
    // Remove active class from all tabs and content
    document.querySelectorAll('.budget-tab-btn').forEach(tab => {
        tab.classList.remove('active', 'bg-white', 'text-blue-600', 'border-blue-600', 'border-t', 'border-l', 'border-r', '-mb-0.5', 'z-10');
        tab.classList.add('bg-gray-100', 'text-gray-600', 'border-gray-300');
    });
    document.querySelectorAll('.budget-tab-panel').forEach(content => {
        content.classList.remove('active');
    });

    // Add active class to selected tab
    const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
    if (activeTab) {
        activeTab.classList.add('active', 'bg-white', 'text-blue-600', 'border-blue-600', 'border-t', 'border-l', 'border-r', '-mb-0.5', 'z-10');
        activeTab.classList.remove('bg-gray-100', 'text-gray-600', 'border-gray-300');
    }
    
    // Show corresponding content
    const activeContent = document.getElementById(`${tabName}-tab`);
    if (activeContent) {
        activeContent.classList.add('active');
    }
    
    // Update URL hash (without triggering hashchange event)
    if (updateHash && window.location.hash !== `#${tabName}`) {
        history.replaceState(null, null, `#${tabName}`);
    }
    
    // Load data specific to the tab
    switch(tabName) {
        case 'sec':
            loadSecData();
            loadContractorsWithoutSec();
            break;
        case 'contractors':
            // Ensure SEC data is loaded for contractor status display
            if (!window.secDataCache) {
                loadSecData();
            }
            if (typeof renderContractors === 'function') {
                renderContractors();
            }
            break;
        case 'contractors-web':
            // Render network graph
            console.log('üï∏Ô∏è Contractors Web tab activated via switchTab');
            if (networkData && networkData.nodes && networkData.nodes.length > 0) {
                console.log('‚úÖ Rendering network graph with existing data');
                renderNetworkGraph(networkData);
            } else {
                console.log('‚ö†Ô∏è Network data not ready, initializing from switchTab...');
                // Initialize network data if not loaded
                initializeNetworkGraph().then(() => {
                    console.log('Network init complete from switchTab');
                    if (networkData && networkData.nodes && networkData.nodes.length > 0) {
                        console.log('‚úÖ Rendering network graph after init from switchTab');
                        renderNetworkGraph(networkData);
                    } else {
                        console.error('‚ùå Network data still not available after init from switchTab');
                    }
                }).catch(error => {
                    console.error('‚ùå Error initializing network from switchTab:', error);
                });
            }
            break;
        case 'visual':
            // Load visual data if needed
            break;
        case 'table':
            // Load table data if needed
            break;
        case 'contractors':
            // Load contractors data if needed
            console.log('üë• Contractors tab activated - checking data');
            if (allContractors.length === 0) {
                console.log('üîÑ No contractor data, initializing...');
                initializeContractors();
            } else {
                console.log('‚úÖ Contractor data already loaded:', allContractors.length, 'contractors');
                renderContractors();
            }
            break;
        case 'contractors-web':
            // Load contractors web data if needed
            console.log('üï∏Ô∏è Contractors Web tab activated - rendering network');
            if (networkData && networkData.nodes && networkData.nodes.length > 0) {
                renderNetworkGraph(networkData);
            } else {
                console.log('‚ö†Ô∏è Network data not ready, initializing...');
                initializeNetworkGraph().then(() => {
                    if (networkData && networkData.nodes && networkData.nodes.length > 0) {
                        console.log('‚úÖ Rendering network graph after init from switchTab');
                        renderNetworkGraph(networkData);
                    } else {
                        console.error('‚ùå Network data still not available after init from switchTab');
                    }
                }).catch(error => {
                    console.error('‚ùå Error initializing network from switchTab:', error);
                });
            }
            break;
        case 'sec':
            // Load SEC data if needed
            console.log('üèõÔ∏è SEC tab activated - loading SEC data');
            loadSecData();
            break;
    }
}

// Add click event listeners to tab buttons
document.addEventListener('DOMContentLoaded', function() {
    loadContractorDatabase();
    loadContractorsWithoutSec();

    // Tab click handlers are now set up by initializeTabs() function
    
    // Handle URL hash on page load
    function loadTabFromHash() {
        const hash = window.location.hash.substring(1); // Remove the #
        const validTabs = ['visual', 'table', 'contractors', 'contractors-web', 'sec'];
        
        if (hash && validTabs.includes(hash)) {
            switchTab(hash, false); // Don't update hash since we're loading from it
        }
    }
    
    // Load tab from hash on page load
    loadTabFromHash();
    
    // Handle browser back/forward buttons
    window.addEventListener('hashchange', function() {
        loadTabFromHash();
    });
    
    // Add pagination button event listeners
    const contractorsPrev = document.getElementById('contractors-prev');
    const contractorsNext = document.getElementById('contractors-next');
    
    if (contractorsPrev) {
        contractorsPrev.addEventListener('click', function() {
            changeContractorPage(-1);
        });
    }
    
    if (contractorsNext) {
        contractorsNext.addEventListener('click', function() {
            changeContractorPage(1);
        });
    }
    
    // Load SEC data on page load
    loadSecData();
    
    // Initialize network graph
    initializeNetworkGraph();
});

// Network Graph for Joint Ventures
let networkGraph = null;
let networkData = { nodes: [], links: [] };
let zoomLevel = 1;

async function initializeNetworkGraph() {
    try {
        // Load joint venture data
        const response = await fetch('/static/data/flood_control_data.json');
        const data = await response.json();
        
        // Process joint ventures
        const jointVentures = data.projects.filter(p => p.Contractor && p.Contractor.includes(' / '));
        
        // Build network data
        networkData = buildNetworkData(jointVentures);
        
        // Update statistics
        updateJVStatistics(jointVentures, networkData);
        
        // Setup controls
        setupNetworkControls();
        
    } catch (error) {
        console.error('‚ùå Error initializing network graph:', error);
    }
}

// Extract proper name (remove common business terms)
function extractProperName(companyName) {
    // Common business terms to remove
    const commonTerms = [
        'CONSTRUCTION', 'CONST', 'CONST.', 'CONSTR',
        'BUILDERS', 'BUILDER',
        'TRADING', 'TRADE',
        'CORPORATION', 'CORP', 'CORP.',
        'INCORPORATED', 'INC', 'INC.',
        'COMPANY', 'CO', 'CO.',
        'SUPPLY', 'SUPPLIES',
        'DEVELOPMENT', 'DEV', 'DEVT', "DEV'T",
        'ENTERPRISES', 'ENTERPRISE',
        'SERVICES', 'SERVICE',
        'CONTRACTORS', 'CONTRACTOR',
        'GENERAL', 'GEN', 'GEN.',
        'ENGINEERING',
        'FORMERLY', 'FOR:', 'FOR.',
        'LIMITED', 'LTD', 'LTD.',
        'AND', '&',
        'THE'
    ];
    
    // Split by spaces and filter out common terms
    const words = companyName.toUpperCase().split(/[\s\-\/]+/);
    const properWords = words.filter(word => {
        // Remove punctuation
        const cleaned = word.replace(/[^A-Z0-9]/g, '');
        // Keep if not in common terms and has substance
        return cleaned.length > 0 && !commonTerms.includes(cleaned);
    });
    
    return properWords.join(' ').trim();
}

// Fuzzy matching function (now uses proper names only)
function fuzzyMatch(str1, str2, threshold = 0.7) {
    // Extract proper names first
    const name1 = extractProperName(str1);
    const name2 = extractProperName(str2);
    
    // Don't match if either name is too short after extraction
    if (name1.length < 3 || name2.length < 3) return false;
    
    // Normalize strings for comparison
    const normalize = (s) => s.toLowerCase().replace(/[^a-z0-9]/g, '');
    const s1 = normalize(name1);
    const s2 = normalize(name2);
    
    // Calculate similarity ratio
    let matches = 0;
    const len = Math.min(s1.length, s2.length);
    const maxLen = Math.max(s1.length, s2.length);
    
    for (let i = 0; i < len; i++) {
        if (s1[i] === s2[i]) matches++;
    }
    
    // Simple Levenshtein-like similarity
    const similarity = matches / maxLen;
    return similarity >= threshold;
}

function buildNetworkData(jointVentures) {
    const nodes = new Map();
    const links = new Map(); // Use Map to prevent duplicate links
    const companyProjects = new Map();
    const jvProjectLists = new Map();
    
    // Process each joint venture
    jointVentures.forEach((jv) => {
        const contractor = jv.Contractor;
        const parts = contractor.split(' / ');
        
        if (parts.length >= 2) {
            const company1 = parts[0].trim();
            const company2 = parts[1].trim();
            const cost = parseFloat(jv.ContractCost) || 0;
            
            // Add companies as nodes (only once each)
            if (!nodes.has(company1)) {
                nodes.set(company1, { 
                    id: company1, 
                    type: 'company', 
                    value: 0, 
                    projects: 0, 
                    jvCount: 0 
                });
                companyProjects.set(company1, []);
            }
            if (!nodes.has(company2)) {
                nodes.set(company2, { 
                    id: company2, 
                    type: 'company', 
                    value: 0, 
                    projects: 0, 
                    jvCount: 0 
                });
                companyProjects.set(company2, []);
            }
            
            // Add JV as node (only once per unique partnership)
            const jvId = `JV: ${contractor}`;
            
            if (!nodes.has(jvId)) {
                nodes.set(jvId, { 
                    id: jvId, 
                    type: 'jv', 
                    value: 0,
                    projects: 0,
                    contractor: contractor,
                    partner1: company1,
                    partner2: company2
                });
                jvProjectLists.set(jvId, []);
                
                // Add links (only once per JV partnership)
                const linkKey1 = `${company1}‚Üí${jvId}`;
                const linkKey2 = `${jvId}‚Üí${company2}`;
                
                links.set(linkKey1, { 
                    source: company1, 
                    target: jvId, 
                    value: 0, 
                    linkType: 'jv' 
                });
                links.set(linkKey2, { 
                    source: jvId, 
                    target: company2, 
                    value: 0, 
                    linkType: 'jv' 
                });
            }
            
            // Accumulate values for existing JV node
            const jvNode = nodes.get(jvId);
            jvNode.value += cost;
            jvNode.projects += 1;
            jvProjectLists.get(jvId).push(jv);
            
            // Update company node values
            nodes.get(company1).value += cost;
            nodes.get(company1).projects += 1;
            nodes.get(company1).jvCount += 1;
            
            nodes.get(company2).value += cost;
            nodes.get(company2).projects += 1;
            nodes.get(company2).jvCount += 1;
            
            // Track projects
            companyProjects.get(company1).push(jv);
            companyProjects.get(company2).push(jv);
            
            // Update link values
            const linkKey1 = `${company1}‚Üí${jvId}`;
            const linkKey2 = `${jvId}‚Üí${company2}`;
            links.get(linkKey1).value += cost;
            links.get(linkKey2).value += cost;
        }
    });
    
    // Add project lists to nodes
    nodes.forEach((node, id) => {
        if (node.type === 'company') {
            node.projectList = companyProjects.get(id) || [];
        } else if (node.type === 'jv') {
            node.projectList = jvProjectLists.get(id) || [];
        }
    });
    
    // Fuzzy matching - only between company nodes (not JV nodes)
    const companyNodes = Array.from(nodes.values()).filter(n => n.type === 'company');
    
    for (let i = 0; i < companyNodes.length; i++) {
        for (let j = i + 1; j < companyNodes.length; j++) {
            const company1 = companyNodes[i].id;
            const company2 = companyNodes[j].id;
            
            // Check if they fuzzy match (75% similarity threshold)
            if (fuzzyMatch(company1, company2, 0.75)) {
                const fuzzyLinkKey = [company1, company2].sort().join('‚Üí');
                
                // Add dashed link for fuzzy match (if not already exists)
                if (!links.has(fuzzyLinkKey)) {
                    links.set(fuzzyLinkKey, { 
                        source: company1, 
                        target: company2, 
                        value: 0, 
                        linkType: 'fuzzy',
                        similarity: 'high'
                    });
                }
            }
        }
    }
    
    return {
        nodes: Array.from(nodes.values()),
        links: Array.from(links.values())
    };
}

function renderNetworkGraph(data) {
    console.log('üé® Starting to render network graph with data:', {
        nodes: data.nodes ? data.nodes.length : 0,
        links: data.links ? data.links.length : 0
    });

    const container = document.getElementById('network-graph');
    if (!container) {
        console.error('‚ùå Network graph container not found');
        return;
    }

    // Clear previous graph
    container.innerHTML = '';

    const width = container.clientWidth;
    const height = 700;

    console.log('üìê Container dimensions:', { width, height });
    
    // Create SVG
    const svg = d3.select('#network-graph')
        .append('svg')
        .attr('width', width)
        .attr('height', height)
        .style('background', '#fafafa');
    
    // Add zoom behavior
    const g = svg.append('g');
    const zoom = d3.zoom()
        .scaleExtent([0.1, 4])
        .on('zoom', (event) => {
            g.attr('transform', event.transform);
            zoomLevel = event.transform.k;
        });
    
    svg.call(zoom);
    
    // Create force simulation
    const simulation = d3.forceSimulation(data.nodes)
        .force('link', d3.forceLink(data.links).id(d => d.id).distance(100))
        .force('charge', d3.forceManyBody().strength(-300))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(d => Math.sqrt(d.value) / 500 + 20));
    
    // Create links
    const link = g.append('g')
        .selectAll('line')
        .data(data.links)
        .enter()
        .append('line')
        .attr('stroke', d => d.linkType === 'fuzzy' ? '#FF5722' : '#2196F3')
        .attr('stroke-opacity', d => d.linkType === 'fuzzy' ? 0.8 : 0.6)
        .attr('stroke-width', d => {
            if (d.linkType === 'fuzzy') return 2;
            return Math.sqrt(d.value) / 1000 + 1;
        })
        .attr('stroke-dasharray', d => d.linkType === 'fuzzy' ? '5,5' : '0')
        .style('cursor', d => d.linkType === 'fuzzy' ? 'pointer' : 'default')
        .on('mouseover', function(event, d) {
            if (d.linkType === 'fuzzy') {
                showLinkTooltip(event, d);
            }
        })
        .on('mouseout', function(event, d) {
            if (d.linkType === 'fuzzy') {
                hideTooltip();
            }
        });
    
    // Create nodes
    const node = g.append('g')
        .selectAll('circle')
        .data(data.nodes)
        .enter()
        .append('circle')
        .attr('r', d => {
            if (d.type === 'jv') {
                // JV nodes: smaller, based on single project value
                return Math.sqrt(d.value) / 800 + 6;
            } else {
                // Company nodes: larger, based on total value
                return Math.sqrt(d.value) / 500 + 10;
            }
        })
        .attr('fill', d => {
            if (d.type === 'jv') {
                return '#FF9800'; // Orange for JV nodes
            } else {
                // Color companies based on number of JVs they're in
                const jvCount = d.jvCount || 0;
                if (jvCount >= 10) return '#E91E63'; // Pink for very highly connected
                if (jvCount >= 5) return '#FF5722'; // Deep orange for highly connected
                if (jvCount >= 3) return '#FFC107'; // Amber for moderately connected
                return '#4CAF50'; // Green for few connections
            }
        })
        .attr('stroke', d => {
            if (d.type === 'jv') {
                return '#F57C00';
            } else {
                const jvCount = d.jvCount || 0;
                if (jvCount >= 10) return '#C2185B';
                if (jvCount >= 5) return '#D32F2F';
                if (jvCount >= 3) return '#FFA000';
                return '#2E7D32';
            }
        })
        .attr('stroke-width', 2)
        .style('cursor', 'pointer')
        .call(d3.drag()
            .on('start', dragstarted)
            .on('drag', dragged)
            .on('end', dragended))
        .on('mouseover', showTooltip)
        .on('mouseout', hideTooltip);
    
    // Create labels - full names, centered
    const labels = g.append('g')
        .selectAll('text')
        .data(data.nodes)
        .enter()
        .append('text')
        .attr('text-anchor', 'middle')
        .attr('dominant-baseline', 'middle')
        .attr('class', 'network-label')
        .style('pointer-events', 'none')
        .style('font-weight', '600')
        .style('fill', '#333')
        .style('font-size', d => d.type === 'jv' ? '8px' : '9px')
        .text(d => {
            if (d.type === 'jv') {
                // Show full JV contractor name (e.g., "COMPANY A / COMPANY B")
                return d.contractor;
            } else {
                // Show full company name
                return d.id;
            }
        });
    
    // Update positions on tick
    simulation.on('tick', () => {
        link
            .attr('x1', d => d.source.x)
            .attr('y1', d => d.source.y)
            .attr('x2', d => d.target.x)
            .attr('y2', d => d.target.y);
        
        node
            .attr('cx', d => d.x)
            .attr('cy', d => d.y);
        
        labels
            .attr('x', d => d.x)
            .attr('y', d => d.y);
    });
    
    // Store for controls
    networkGraph = { svg, g, simulation, zoom, labels, nodes: data.nodes };
    
    // Drag functions
    function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }
    
    function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
    }
    
    function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }
    
    // Tooltip functions
    function showTooltip(event, d) {
        const tooltip = document.getElementById('network-tooltip');
        const projects = d.projects || 0;
        const value = d.value || 0;
        
        let content = '';
        
        if (d.type === 'jv') {
            // Joint Venture node
            content = `<strong style="color: #FF9800;">Joint Venture</strong><br>`;
            content += `<strong>${d.contractor}</strong><br>`;
            content += `Value: ‚Ç±${value.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}<br>`;
            content += `Partners: ${d.partner1} & ${d.partner2}`;
        } else {
            // Company node
            content = `<strong style="color: #4CAF50;">${d.id}</strong><br>`;
            content += `JV Projects: ${d.jvCount || 0}<br>`;
            content += `Total JV Value: ‚Ç±${value.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}<br>`;
            content += `Type: Company`;
        }
        
        tooltip.innerHTML = content;
        tooltip.style.display = 'block';
        tooltip.style.left = (event.pageX + 10) + 'px';
        tooltip.style.top = (event.pageY + 10) + 'px';
    }
    
    function showLinkTooltip(event, d) {
        const tooltip = document.getElementById('network-tooltip');
        
        let content = `<strong style="color: #FF5722;">‚ö†Ô∏è Potential Same Company</strong><br>`;
        content += `${d.source.id || d.source}<br>`;
        content += `‚âà<br>`;
        content += `${d.target.id || d.target}<br>`;
        content += `<em>Similar names detected</em>`;
        
        tooltip.innerHTML = content;
        tooltip.style.display = 'block';
        tooltip.style.left = (event.pageX + 10) + 'px';
        tooltip.style.top = (event.pageY + 10) + 'px';
    }
    
    function hideTooltip() {
        const tooltip = document.getElementById('network-tooltip');
        tooltip.style.display = 'none';
    }
}

function updateJVStatistics(jointVentures, networkData) {
    const totalJVs = jointVentures.length;
    const uniqueCompanies = networkData.nodes.filter(n => n.type === 'company').length;
    const totalValue = jointVentures.reduce((sum, jv) => sum + (parseFloat(jv.ContractCost) || 0), 0);
    const avgValue = totalJVs > 0 ? totalValue / totalJVs : 0;
    
    document.getElementById('jv-total-count').textContent = totalJVs.toLocaleString();
    document.getElementById('jv-companies-count').textContent = uniqueCompanies.toLocaleString();
    document.getElementById('jv-total-value').textContent = '‚Ç±' + (totalValue / 1e9).toFixed(2) + 'B';
    document.getElementById('jv-avg-value').textContent = '‚Ç±' + (avgValue / 1e6).toFixed(2) + 'M';
}

function setupNetworkControls() {
    // Search/filter
    const searchInput = document.getElementById('network-search');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            if (query.length < 3 && query.length > 0) return; // Wait for at least 3 characters
            
            if (query.length === 0) {
                renderNetworkGraph(networkData); // Show all
            } else {
                // Filter nodes containing the search term
                const filteredNodes = networkData.nodes.filter(n => 
                    n.id.toLowerCase().includes(query)
                );
                const filteredNodeIds = new Set(filteredNodes.map(n => n.id));
                
                // Filter links that connect filtered nodes
                const filteredLinks = networkData.links.filter(l => 
                    filteredNodeIds.has(l.source.id || l.source) && 
                    filteredNodeIds.has(l.target.id || l.target)
                );
                
                renderNetworkGraph({ nodes: filteredNodes, links: filteredLinks });
            }
        });
    }
    
    // Reset button
    const resetBtn = document.getElementById('network-reset');
    if (resetBtn) {
        resetBtn.addEventListener('click', () => {
            document.getElementById('network-search').value = '';
            renderNetworkGraph(networkData);
        });
    }
    
    // Show labels toggle
    const showLabelsCheckbox = document.getElementById('network-show-labels');
    if (showLabelsCheckbox) {
        showLabelsCheckbox.addEventListener('change', (e) => {
            const labels = document.querySelectorAll('.network-label');
            labels.forEach(label => {
                label.style.display = e.target.checked ? 'block' : 'none';
            });
        });
    }
    
    // Zoom controls
    const zoomInBtn = document.getElementById('network-zoom-in');
    const zoomOutBtn = document.getElementById('network-zoom-out');
    
    if (zoomInBtn && networkGraph) {
        zoomInBtn.addEventListener('click', () => {
            networkGraph.svg.transition().duration(300).call(
                networkGraph.zoom.scaleBy, 1.3
            );
        });
    }
    
    if (zoomOutBtn && networkGraph) {
        zoomOutBtn.addEventListener('click', () => {
            networkGraph.svg.transition().duration(300).call(
                networkGraph.zoom.scaleBy, 0.7
            );
        });
    }
    
    // Render initial graph
    renderNetworkGraph(networkData);
}
</script>

</body>
</html>
