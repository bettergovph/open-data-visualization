<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEC Contractors - BetterGovPH</title>

    <!-- Google Fonts - Inter -->
    <!-- Tailwind CSS -->
    <link rel="stylesheet" href="/static/css/tailwind.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="/static/js/chart.js"></script>

    <!-- BetterGovPH Metadata -->
    <meta name="description" content="SEC Contractors Database - Government Data Analysis Platform">
    <meta name="keywords" content="SEC, contractors, verification, government projects, Philippines, transparency">
    <meta name="author" content="BetterGovPH">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://visualizations.bettergov.ph/contractors">
    <meta property="og:title" content="SEC Contractors - BetterGovPH">
    <meta property="og:description" content="Verify contractor legitimacy through Securities and Exchange Commission registration data">
    <meta property="og:image" content="/static/images/gov_logo.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://visualizations.bettergov.ph/contractors">
    <meta property="twitter:title" content="SEC Contractors - BetterGovPH">
    <meta property="twitter:description" content="Verify contractor legitimacy through Securities and Exchange Commission registration data">
    <meta property="twitter:image" content="/static/images/gov_logo.png">

    <style>
        body {
            font-family: 'Inter', sans-serif !important;
            margin: 0;
            padding: 0;
            background: white !important;
            color: black !important;
            min-height: 100vh;
        }

        /* Tab styles */
        .budget-tab-panel {
            display: none;
        }
        
        .budget-tab-panel.active {
            display: block;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .statistics-grid {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
            
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 600px;
            }
        }

        /* Pulsing animation for suspicious contractors */
        @keyframes pulse-warning {
            0%, 100% { 
                background-color: #fff3cd; 
                border-color: #ffeaa7;
                transform: scale(1);
            }
            50% { 
                background-color: #ffd93d; 
                border-color: #ffb700;
                transform: scale(1.05);
            }
        }

        .pulse-warning {
            animation: pulse-warning 2s ease-in-out infinite;
        }
    </style>
</head>
<body>

<!-- Navigation -->
<nav class="visualizations-nav py-4 px-6 bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
        <div class="flex items-center">
            <a href="https://bettergov.ph" class="flex items-center">
                <img src="https://raw.githubusercontent.com/bettergovph/logo/main/png/BetterGov_Horizontal-Black.png"
                     alt="BetterGov.ph"
                     class="h-12 mr-3">
                
            </a>
            <a href="/" class="text-xl font-bold text-black hover:text-gray-600">Data Visualizations</a>
        </div>
        <div class="hidden md:flex space-x-6">
            <a href="/" class="text-black hover:text-gray-600 font-medium transition">Home</a>
            <a href="/nep" class="text-black hover:text-gray-600 font-medium transition">NEP</a>
            <a href="/budget" class="text-black hover:text-gray-600 font-medium transition">Budget</a>
            <a href="/flood" class="text-black hover:text-gray-600 font-medium transition">Flood Control</a>
            <a href="/dime" class="text-black hover:text-gray-600 font-medium transition">DIME</a>
            <a href="/map" class="text-black hover:text-gray-600 font-medium transition">Map</a>
            <a href="/contractors" class="text-black hover:text-gray-600 font-medium transition border-b-2 border-black">Contractors</a>
            <div class="relative" onmouseenter="this.querySelector('.dropdown-menu').classList.remove('hidden')" onmouseleave="this.querySelector('.dropdown-menu').classList.add('hidden')">
                <a href="/correlation" class="text-black hover:text-gray-600 font-medium transition">Correlation ‚ñæ</a>
                <div class="dropdown-menu absolute hidden bg-white shadow-lg rounded-md mt-2 py-2 w-48" style="z-index: 50;">
                    <a href="/budget-nep-correlation" class="block px-4 py-2 text-black" style="border-radius: 4px; margin: 2px 4px; transition: all 0.2s;" onmouseover="this.style.background='#dbeafe'; this.style.color='#2563eb';" onmouseout="this.style.background='transparent'; this.style.color='black';">NEP-Budget</a>
                    <a href="/budget-flood-correlation" class="block px-4 py-2 text-black" style="border-radius: 4px; margin: 2px 4px; transition: all 0.2s;" onmouseover="this.style.background='#dbeafe'; this.style.color='#2563eb';" onmouseout="this.style.background='transparent'; this.style.color='black';">Budget-Flood</a>
                    <a href="/flood-dime-correlation" class="block px-4 py-2 text-black" style="border-radius: 4px; margin: 2px 4px; transition: all 0.2s;" onmouseover="this.style.background='#dbeafe'; this.style.color='#2563eb';" onmouseout="this.style.background='transparent'; this.style.color='black';">Flood-DIME</a>
                </div>
            </div>
        </div>
        <div class="md:hidden">
            <button class="text-black focus:outline-none" onclick="toggleMobileMenu()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
        </div>
    </div>
    <!-- Mobile menu (hidden by default) -->
    <div id="mobileMenu" class="hidden mt-4 px-4 space-y-2">
        <a href="/" class="block text-black hover:text-gray-600 font-medium py-2">Home</a>
        <a href="/nep" class="block text-black hover:text-gray-600 font-medium py-2">NEP</a>
        <a href="/budget" class="block text-black hover:text-gray-600 font-medium py-2">Budget</a>
        <a href="/flood" class="block text-black hover:text-gray-600 font-medium py-2">Flood Control</a>
        <a href="/dime" class="block text-black hover:text-gray-600 font-medium py-2">DIME</a>
        <a href="/map" class="block text-black hover:text-gray-600 font-medium py-2">Map</a>
        <a href="/contractors" class="block text-black hover:text-gray-600 font-medium py-2 border-b-2 border-black">Contractors</a>
        <a href="/correlation" class="block text-black hover:text-gray-600 font-medium py-2">Correlation</a>
        <a href="/budget-nep-correlation" class="block text-black hover:text-gray-600 font-medium py-2 pl-4">‚Üí NEP-Budget</a>
        <a href="/budget-flood-correlation" class="block text-black hover:text-gray-600 font-medium py-2 pl-4">‚Üí Budget-Flood</a>
        <a href="/flood-dime-correlation" class="block text-black hover:text-gray-600 font-medium py-2 pl-4">‚Üí Flood-DIME</a>
    </div>
</nav>

<script>
function toggleMobileMenu() {
    const menu = document.getElementById('mobileMenu');
    menu.classList.toggle('hidden');
}
</script>

<!-- Main Content -->
<div style="padding: 6rem;">
<section>
    <div style="max-width: 1400px; margin: 0 auto;">
        
        <!-- Tabs -->
        <div class="budget-tabs">
            <div class="flex border-b-2 border-gray-200 mb-4 gap-2">
                <a href="#visual" class="budget-tab-btn active bg-white text-blue-600 border-blue-600 border-t border-l border-r px-6 py-3 rounded-t-lg cursor-pointer font-semibold transition-all duration-300 relative -mb-0.5 z-10" data-tab="visual">üìä Visual</a>
                <a href="#table" class="budget-tab-btn bg-gray-100 text-gray-600 border-gray-300 border px-6 py-3 rounded-t-lg cursor-pointer font-semibold transition-all duration-300 hover:bg-gray-200" data-tab="table">üìã Table</a>
                <a href="#sec" class="budget-tab-btn bg-gray-100 text-gray-600 border-gray-300 border px-6 py-3 rounded-t-lg cursor-pointer font-semibold transition-all duration-300 hover:bg-gray-200" data-tab="sec">üèõÔ∏è SEC</a>
            </div>
            <div class="budget-tab-content">

                <!-- VISUAL TAB -->
                <div id="visual-tab" class="budget-tab-panel active">
                    <!-- SEC Statistics -->
                    <div class="statistics-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">
                        <div class="stat-card bg-white p-5 rounded-lg shadow-lg text-center">
                            <h3 class="text-gray-600 m-0 mb-2 text-sm font-medium">Total Contractors</h3>
                            <p id="total-contractors" class="text-4xl font-bold text-blue-600 m-0">Loading...</p>
                            <p class="text-xs text-gray-500 mt-1">In system</p>
                        </div>
                        <div class="stat-card bg-white p-5 rounded-lg shadow-lg text-center">
                            <h3 class="text-gray-600 m-0 mb-2 text-sm font-medium">Processed</h3>
                            <p id="processed-contractors" class="text-4xl font-bold text-cyan-600 m-0">Loading...</p>
                            <p class="text-xs text-gray-500 mt-1">From scraping</p>
                        </div>
                        <div class="stat-card bg-green-50 p-5 rounded-lg shadow-lg text-center border-2 border-green-200">
                            <h3 class="text-green-700 m-0 mb-2 text-sm font-medium">‚úÖ With SEC Data</h3>
                            <p id="with-sec" class="text-4xl font-bold text-green-600 m-0">Loading...</p>
                            <p class="text-xs text-green-600 mt-1">Verified</p>
                        </div>
                        <div class="stat-card bg-yellow-50 p-5 rounded-lg shadow-lg text-center border-2 border-yellow-300">
                            <h3 class="text-yellow-700 m-0 mb-2 text-sm font-medium">‚ö†Ô∏è NO SEC Results</h3>
                            <p id="suspicious" class="text-4xl font-bold text-yellow-700 m-0">Loading...</p>
                            <p class="text-xs text-yellow-700 mt-1">Suspicious</p>
                        </div>
                    </div>

                    <!-- Top Contractors Chart -->
                    <div class="chart-container" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: #0038A8; margin: 0;">Top Contractors by Project Count</h3>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <span id="contractors-page-info" style="color: #666; font-size: 0.9em;"></span>
                                <button id="contractors-prev" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8em;" disabled>‚Üê Previous</button>
                                <button id="contractors-next" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8em;" disabled>Next ‚Üí</button>
                            </div>
                        </div>
                        <canvas id="contractorsChart" width="800" height="600"></canvas>
                    </div>
                </div>

                <!-- TABLE TAB -->
                <div id="table-tab" class="budget-tab-panel">
                    <!-- Contractor Table -->
                    <div style="background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 32px;">
                        <h2 style="font-size: 1.5rem; font-weight: 600; color: black; margin-bottom: 24px;">üìã Contractor Database</h2>
                        
                        <!-- Search filter -->
                        <div style="margin-bottom: 20px;">
                            <input 
                                type="text" 
                                id="contractor-search" 
                                placeholder="Search contractor name..." 
                                style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;"
                                onkeyup="filterContractors()"
                            />
                        </div>
                        
                        <!-- Pagination controls -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div style="color: #666; font-size: 0.9em;">
                                Showing <span id="table-page-info">0</span> of <span id="table-total">0</span> contractors
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button id="table-prev" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;" disabled>‚Üê Previous</button>
                                <button id="table-next" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;" disabled>Next ‚Üí</button>
                            </div>
                        </div>

                        <div class="table-responsive" style="overflow-x: auto;">
                            <table style="min-width: 100%; border-collapse: collapse;">
                                <thead style="background: #f9fafb;">
                                    <tr>
                                        <th style="padding: 12px 16px; text-align: left; font-size: 0.75rem; font-weight: 500; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #e5e7eb;">#</th>
                                        <th style="padding: 12px 16px; text-align: left; font-size: 0.75rem; font-weight: 500; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #e5e7eb;">Contractor Name</th>
                                        <th style="padding: 12px 16px; text-align: left; font-size: 0.75rem; font-weight: 500; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #e5e7eb;">SEC Number</th>
                                        <th style="padding: 12px 16px; text-align: left; font-size: 0.75rem; font-weight: 500; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #e5e7eb;">Status</th>
                                        <th style="padding: 12px 16px; text-align: left; font-size: 0.75rem; font-weight: 500; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #e5e7eb;">Address</th>
                                    </tr>
                                </thead>
                                <tbody id="contractors-table" style="background: white;">
                                    <tr>
                                        <td colspan="5" style="padding: 24px; text-align: center; color: #6b7280;">Loading contractors...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- SEC TAB -->
                <div id="sec-tab" class="budget-tab-panel">
                    <!-- SEC Data Analysis -->
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h3 style="color: #0038A8; margin: 0 0 20px 0;">üèõÔ∏è SEC Data Analysis</h3>
                        <p style="color: #666; margin: 0 0 20px 0;">Analyze contractor SEC registration data and identify contractors without SEC information</p>
                        
                        <!-- SEC Statistics -->
                        <div class="sec-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div class="stat-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                                <h4 style="color: #0038A8; margin: 0 0 5px 0; font-size: 1.1em;">Total Contractors</h4>
                                <p id="sec-total-contractors-count" style="font-size: 2em; font-weight: bold; color: #007bff; margin: 0;">Loading...</p>
                                <p style="font-size: 0.7em; color: #6c757d; margin: 5px 0 0 0;">In system</p>
                            </div>
                            <div class="stat-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                                <h4 style="color: #0038A8; margin: 0 0 5px 0; font-size: 1.1em;">Processed</h4>
                                <p id="sec-processed-count" style="font-size: 2em; font-weight: bold; color: #17a2b8; margin: 0;">Loading...</p>
                                <p style="font-size: 0.7em; color: #6c757d; margin: 5px 0 0 0;">From database</p>
                            </div>
                            <div class="stat-card" style="background: #d4edda; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #c3e6cb;">
                                <h4 style="color: #155724; margin: 0 0 5px 0; font-size: 1.1em;">‚úÖ With SEC Data</h4>
                                <p id="total-sec-count" style="font-size: 2em; font-weight: bold; color: #28a745; margin: 0;">Loading...</p>
                                <p style="font-size: 0.7em; color: #155724; margin: 5px 0 0 0;">Verified</p>
                            </div>
                            <div class="stat-card" style="background: #fff3cd; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #ffeaa7;">
                                <h4 style="color: #856404; margin: 0 0 5px 0; font-size: 1.1em;">‚ö†Ô∏è NO SEC Results</h4>
                                <p id="suspicious-sec-count" style="font-size: 2em; font-weight: bold; color: #856404; margin: 0;">Loading...</p>
                                <p style="font-size: 0.7em; color: #856404; margin: 5px 0 0 0;">Suspicious</p>
                            </div>
                        </div>

                        <!-- Contractors Without SEC Data -->
                        <div class="chart-container" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
                            <h3 style="color: #dc3545; margin: 0 0 15px 0;">‚ö†Ô∏è Contractors Without SEC Data</h3>
                            <div id="contractorsWithoutSec" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                                <!-- Contractors without SEC data will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>
</section>
</div>

<!-- Page-specific footer content -->
<footer class="visualizations-footer">
    <div class="visualizations-container">
        <p><strong>üìä Data Sources:</strong> DIME, PhilGEPS, Flood Control (DPWH) - All contractors across all government projects</p>
        <p><strong>üîç Verification:</strong> SEC Philippines - Validates contractor legitimacy and registration</p>
        <p><strong>üìà Total Contractors:</strong> <span id="footer-total">Loading...</span> contractors in system</p>
        <p><strong>‚úÖ Verified:</strong> <span id="footer-verified">Loading...</span> with SEC registration data</p>
    </div>
</footer>

<script>
// Global data
let allContractors = [];
let filteredContractors = [];
let allContractorsByProject = [];
let currentChartPage = 0;
let currentTablePage = 0;
const chartPageSize = 50;
const tablePageSize = 10;

// Tab switching
function switchTab(tabName) {
    document.querySelectorAll('.budget-tab-btn').forEach(tab => {
        tab.classList.remove('active', 'bg-white', 'text-blue-600', 'border-blue-600', 'border-t', 'border-l', 'border-r', '-mb-0.5', 'z-10');
        tab.classList.add('bg-gray-100', 'text-gray-600', 'border-gray-300');
    });
    document.querySelectorAll('.budget-tab-panel').forEach(content => {
        content.classList.remove('active');
    });

    const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
    if (activeTab) {
        activeTab.classList.add('active', 'bg-white', 'text-blue-600', 'border-blue-600', 'border-t', 'border-l', 'border-r', '-mb-0.5', 'z-10');
        activeTab.classList.remove('bg-gray-100', 'text-gray-600', 'border-gray-300');
    }
    
    const activeContent = document.getElementById(`${tabName}-tab`);
    if (activeContent) {
        activeContent.classList.add('active');
    }
}

// Initialize tabs
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.budget-tab-btn');
    tabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
            e.preventDefault();
            const targetTab = tab.getAttribute('data-tab');
            switchTab(targetTab);
        });
    });
});

// Load and process contractors data
async function loadContractors() {
    try {
        // Use PostgreSQL API endpoint
        const response = await fetch('/api/contractors/sec');
        const data = await response.json();
        
        allContractors = data.contractors || [];
        filteredContractors = allContractors;  // Initialize filtered list
        
        // Update statistics (Visual tab)
        const summary = data.summary || {};
        document.getElementById('total-contractors').textContent = (summary.total_contractors || 0).toLocaleString();
        document.getElementById('processed-contractors').textContent = (summary.total_contractors || 0).toLocaleString();
        document.getElementById('with-sec').textContent = (summary.with_sec_data || 0).toLocaleString();
        document.getElementById('suspicious').textContent = (summary.suspicious_no_results || 0).toLocaleString();
        
        // Update SEC tab statistics
        document.getElementById('sec-total-contractors-count').textContent = (summary.total_contractors || 0).toLocaleString();
        document.getElementById('sec-processed-count').textContent = (summary.total_contractors || 0).toLocaleString();
        document.getElementById('total-sec-count').textContent = (summary.with_sec_data || 0).toLocaleString();
        document.getElementById('suspicious-sec-count').textContent = (summary.suspicious_no_results || 0).toLocaleString();
        
        // Update footer statistics
        document.getElementById('footer-total').textContent = (summary.total_contractors || 0).toLocaleString();
        document.getElementById('footer-verified').textContent = (summary.with_sec_data || 0).toLocaleString();
        
        // Load contractors without SEC for SEC tab
        loadContractorsWithoutSec();
        
        // Count projects per contractor from flood data
        await loadContractorProjectCounts();
        
        // Render chart and table
        renderContractorsChart();
        renderContractorsTable();
        
    } catch (error) {
        console.error('Error loading contractors:', error);
        document.getElementById('total-contractors').textContent = 'Error';
        document.getElementById('processed-contractors').textContent = 'Error';
        document.getElementById('with-sec').textContent = 'Error';
        document.getElementById('suspicious').textContent = 'Error';
    }
}

// Load contractors without SEC data for SEC tab
function loadContractorsWithoutSec() {
    const container = document.getElementById('contractorsWithoutSec');
    const contractorsWithoutSec = allContractors.filter(c => !c.sec_number || c.sec_number.trim() === '');
    
    // Limit to first 20 for display
    const displayLimit = 20;
    const contractorsToShow = contractorsWithoutSec.slice(0, displayLimit);
    
    container.innerHTML = '';
    
    if (contractorsToShow.length === 0) {
        container.innerHTML = `
            <div style="
                background: #d4edda;
                border: 2px solid #28a745;
                border-radius: 8px;
                padding: 20px;
                text-align: center;
                grid-column: 1 / -1;">
                <strong>‚úÖ All contractors have SEC data!</strong>
            </div>
        `;
    } else {
        contractorsToShow.forEach(contractor => {
            const contractorCard = document.createElement('div');
            contractorCard.style.cssText = 'background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px;';
            
            const isNO_SEC_RESULTS = contractor.status === 'NO_SEC_RESULTS';
            
            contractorCard.innerHTML = `
                <div style="font-weight: bold; color: #856404; margin-bottom: 8px; font-size: 1.1em;">
                    ${contractor.contractor_name}
                </div>
                ${isNO_SEC_RESULTS ? `
                    <div style="color: #721c24; background: #f8d7da; padding: 8px; border-radius: 4px; margin-bottom: 8px; font-size: 0.9em; border: 1px solid #f5c6cb;">
                        <strong>‚ö†Ô∏è NO SEC RESULTS - SUSPICIOUS</strong><br>
                        <span style="font-size: 0.85em;">This contractor was searched in the SEC database but yielded zero results.</span>
                    </div>
                ` : `
                    <div style="color: #856404; font-size: 0.9em;">
                        ‚ö†Ô∏è SEC information not yet available
                    </div>
                `}
            `;
            
            container.appendChild(contractorCard);
        });
        
        if (contractorsWithoutSec.length > displayLimit) {
            const moreInfo = document.createElement('div');
            moreInfo.style.cssText = 'background: #e9ecef; border-radius: 8px; padding: 15px; text-align: center; grid-column: 1 / -1;';
            moreInfo.innerHTML = `<em>Showing first ${displayLimit} of ${contractorsWithoutSec.length} contractors without SEC data</em>`;
            container.appendChild(moreInfo);
        }
    }
}

// Load contractor project counts from flood data
async function loadContractorProjectCounts() {
    try {
        const response = await fetch('/api/flood/statistics');
        const data = await response.json();
        
        // Use contractor data from the statistics API
        const contractorCounts = data.contractorDistribution || {};
        
        allContractorsByProject = Object.entries(contractorCounts)
            .map(([contractor, count]) => ({ contractor, count }))
            .sort((a, b) => b.count - a.count);
            
    } catch (error) {
        console.error('Error loading contractor project counts:', error);
        allContractorsByProject = [];
    }
}

// Render contractors chart
function renderContractorsChart() {
    const ctx = document.getElementById('contractorsChart');
    if (!ctx || !allContractorsByProject.length) return;
    
    const start = currentChartPage * chartPageSize;
    const end = start + chartPageSize;
    const contractors = allContractorsByProject.slice(start, end);
    
    if (window.contractorsChart) {
        window.contractorsChart.destroy();
    }
    
    window.contractorsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: contractors.map(item => item.contractor.length > 40 ? item.contractor.substring(0, 40) + '...' : item.contractor),
            datasets: [{
                label: 'Project Count',
                data: contractors.map(item => item.count),
                backgroundColor: '#0038A8',
                borderColor: '#CE1126',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 1.5,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                },
                y: {
                    display: true,
                    ticks: {
                        maxTicksLimit: 50
                    }
                }
            }
        }
    });
    
    // Update pagination info and buttons
    const totalPages = Math.ceil(allContractorsByProject.length / chartPageSize);
    document.getElementById('contractors-page-info').textContent = `Page ${currentChartPage + 1} of ${totalPages}`;
    document.getElementById('contractors-prev').disabled = currentChartPage === 0;
    document.getElementById('contractors-next').disabled = currentChartPage >= totalPages - 1;
}

// Filter contractors by search input
function filterContractors() {
    const searchInput = document.getElementById('contractor-search').value.toLowerCase();
    
    if (!searchInput) {
        filteredContractors = allContractors;
    } else {
        filteredContractors = allContractors.filter(contractor => {
            const name = (contractor.original_contractor_name || contractor.company_name || contractor.contractor_name || '').toLowerCase();
            return name.includes(searchInput);
        });
    }
    
    // Reset to first page when filtering
    currentTablePage = 0;
    renderContractorsTable();
}

// Render contractors table
function renderContractorsTable() {
    const tbody = document.getElementById('contractors-table');
    const start = currentTablePage * tablePageSize;
    const end = start + tablePageSize;
    const contractors = filteredContractors.slice(start, end);
    
    tbody.innerHTML = '';
    
    if (contractors.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="padding: 24px; text-align: center; color: #6b7280;">No contractors found</td></tr>';
        document.getElementById('table-page-info').textContent = '0';
        document.getElementById('table-total').textContent = filteredContractors.length;
        document.getElementById('table-prev').disabled = true;
        document.getElementById('table-next').disabled = true;
        return;
    }
    
    contractors.forEach((contractor, index) => {
        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid #e5e7eb';
        if (contractor.status === 'NO_SEC_RESULTS') {
            row.style.background = '#fefce8';
        }
        
        const secNumber = contractor.sec_number || '-';
        const address = contractor.registered_address || contractor.address || '-';
        
        const statusBadge = contractor.sec_number && contractor.sec_number.trim() !== '' ? 
            `<span style="padding: 4px 12px; background: #dcfce7; color: #166534; font-size: 0.75rem; border-radius: 9999px; font-weight: 600;">‚úÖ Verified</span>` :
            contractor.status === 'NO_SEC_RESULTS' ?
            `<span class="pulse-warning" style="padding: 4px 12px; background: #fff3cd; color: #854d0e; font-size: 0.75rem; border-radius: 9999px; font-weight: 600; border: 1px solid #fde047;">‚ö†Ô∏è Suspicious</span>` :
            `<span style="padding: 4px 12px; background: #fee2e2; color: #991b1b; font-size: 0.75rem; border-radius: 9999px; font-weight: 600;">‚ùå Missing</span>`;
        
        row.innerHTML = `
            <td style="padding: 16px; font-size: 0.875rem; color: #111827; white-space: nowrap;">${start + index + 1}</td>
            <td style="padding: 16px; font-size: 0.875rem; font-weight: 500; color: #111827;">${contractor.original_contractor_name || contractor.company_name || contractor.contractor_name}</td>
            <td style="padding: 16px; font-size: 0.875rem; color: #111827; white-space: nowrap;">${secNumber}</td>
            <td style="padding: 16px; font-size: 0.875rem;">${statusBadge}</td>
            <td style="padding: 16px; font-size: 0.875rem; color: #6b7280;">${address.substring(0, 100)}${address.length > 100 ? '...' : ''}</td>
        `;
        
        tbody.appendChild(row);
    });
    
    // Update pagination
    const totalPages = Math.ceil(filteredContractors.length / tablePageSize);
    document.getElementById('table-page-info').textContent = `${start + 1}-${Math.min(end, filteredContractors.length)}`;
    document.getElementById('table-total').textContent = filteredContractors.length;
    document.getElementById('table-prev').disabled = currentTablePage === 0;
    document.getElementById('table-next').disabled = currentTablePage >= totalPages - 1;
}

// Pagination for chart
document.getElementById('contractors-prev').addEventListener('click', function() {
    if (currentChartPage > 0) {
        currentChartPage--;
        renderContractorsChart();
    }
});

document.getElementById('contractors-next').addEventListener('click', function() {
    const totalPages = Math.ceil(allContractorsByProject.length / chartPageSize);
    if (currentChartPage < totalPages - 1) {
        currentChartPage++;
        renderContractorsChart();
    }
});

// Pagination for table
document.getElementById('table-prev').addEventListener('click', function() {
    if (currentTablePage > 0) {
        currentTablePage--;
        renderContractorsTable();
    }
});

document.getElementById('table-next').addEventListener('click', function() {
    const totalPages = Math.ceil(allContractors.length / tablePageSize);
    if (currentTablePage < totalPages - 1) {
        currentTablePage++;
        renderContractorsTable();
    }
});

// Load on page load
loadContractors();
</script>

{% include "footer.html" %}

</body>
</html>
