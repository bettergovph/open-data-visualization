<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEC Contractors - BetterGovPH</title>

    <!-- Google Fonts - Inter -->
    <!-- Tailwind CSS -->
    <link rel="stylesheet" href="/static/css/tailwind.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="/static/js/chart.js"></script>

    <!-- BetterGovPH Metadata -->
    <meta name="description" content="SEC Contractors Database - Government Data Analysis Platform">
    <meta name="keywords" content="SEC, contractors, verification, government projects, Philippines, transparency">
    <meta name="author" content="BetterGovPH">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://visualizations.bettergov.ph/contractors">
    <meta property="og:title" content="SEC Contractors - BetterGovPH">
    <meta property="og:description" content="Verify contractor legitimacy through Securities and Exchange Commission registration data">
    <meta property="og:image" content="/static/images/gov_logo.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://visualizations.bettergov.ph/contractors">
    <meta property="twitter:title" content="SEC Contractors - BetterGovPH">
    <meta property="twitter:description" content="Verify contractor legitimacy through Securities and Exchange Commission registration data">
    <meta property="twitter:image" content="/static/images/gov_logo.png">

    <style>
        body {
            font-family: 'Inter', sans-serif !important;
            margin: 0;
            padding: 0;
            background: white !important;
            color: black !important;
            min-height: 100vh;
        }

        /* Tab styles */
        .budget-tab-panel {
            display: none;
        }
        
        .budget-tab-panel.active {
            display: block;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .statistics-grid {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
            
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 600px;
            }
        }

        /* Pulsing animation for suspicious contractors */
        @keyframes pulse-warning {
            0%, 100% { 
                background-color: #fff3cd; 
                border-color: #ffeaa7;
                transform: scale(1);
            }
            50% { 
                background-color: #ffd93d; 
                border-color: #ffb700;
                transform: scale(1.05);
            }
        }

        .pulse-warning {
            animation: pulse-warning 2s ease-in-out infinite;
        }
    </style>
</head>
<body>

<!-- Navigation -->
<nav class="visualizations-nav py-4 px-6 bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
        <div class="flex items-center">
            <a href="https://bettergov.ph" class="flex items-center">
                <img src="https://raw.githubusercontent.com/bettergovph/logo/main/png/BetterGov_Horizontal-Black.png"
                     alt="BetterGov.ph"
                     class="h-12 mr-3">
                
            </a>
            <a href="/" class="text-xl font-bold text-black hover:text-gray-600">Data Visualizations</a>
        </div>
        <div class="hidden md:flex space-x-6">
            <a href="/" class="text-black hover:text-gray-600 font-medium transition">Home</a>
            <a href="/nep" class="text-black hover:text-gray-600 font-medium transition">NEP</a>
            <a href="/budget" class="text-black hover:text-gray-600 font-medium transition">Budget</a>
            <a href="/flood" class="text-black hover:text-gray-600 font-medium transition">Flood Control</a>
            <a href="/dime" class="text-black hover:text-gray-600 font-medium transition">DIME</a>
            <a href="/map" class="text-black hover:text-gray-600 font-medium transition">Map</a>
            <a href="/contractors" class="text-black hover:text-gray-600 font-medium transition border-b-2 border-black">Contractors</a>
            <div class="relative" onmouseenter="this.querySelector('.dropdown-menu').classList.remove('hidden')" onmouseleave="this.querySelector('.dropdown-menu').classList.add('hidden')">
                <a href="/correlation" class="text-black hover:text-gray-600 font-medium transition">Correlation ‚ñæ</a>
                <div class="dropdown-menu absolute hidden bg-white shadow-lg rounded-md mt-2 py-2 w-48" style="z-index: 50;">
                    <a href="/budget-nep-correlation" class="block px-4 py-2 text-black" style="border-radius: 4px; margin: 2px 4px; transition: all 0.2s;" onmouseover="this.style.background='#dbeafe'; this.style.color='#2563eb';" onmouseout="this.style.background='transparent'; this.style.color='black';">NEP-Budget</a>
                    <a href="/budget-flood-correlation" class="block px-4 py-2 text-black" style="border-radius: 4px; margin: 2px 4px; transition: all 0.2s;" onmouseover="this.style.background='#dbeafe'; this.style.color='#2563eb';" onmouseout="this.style.background='transparent'; this.style.color='black';">Budget-Flood</a>
                    <a href="/flood-dime-correlation" class="block px-4 py-2 text-black" style="border-radius: 4px; margin: 2px 4px; transition: all 0.2s;" onmouseover="this.style.background='#dbeafe'; this.style.color='#2563eb';" onmouseout="this.style.background='transparent'; this.style.color='black';">Flood-DIME</a>
                </div>
            </div>
        </div>
        <div class="md:hidden">
            <button class="text-black focus:outline-none" onclick="toggleMobileMenu()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
        </div>
    </div>
    <!-- Mobile menu (hidden by default) -->
    <div id="mobileMenu" class="hidden mt-4 px-4 space-y-2">
        <a href="/" class="block text-black hover:text-gray-600 font-medium py-2">Home</a>
        <a href="/nep" class="block text-black hover:text-gray-600 font-medium py-2">NEP</a>
        <a href="/budget" class="block text-black hover:text-gray-600 font-medium py-2">Budget</a>
        <a href="/flood" class="block text-black hover:text-gray-600 font-medium py-2">Flood Control</a>
        <a href="/dime" class="block text-black hover:text-gray-600 font-medium py-2">DIME</a>
        <a href="/map" class="block text-black hover:text-gray-600 font-medium py-2">Map</a>
        <a href="/contractors" class="block text-black hover:text-gray-600 font-medium py-2 border-b-2 border-black">Contractors</a>
        <a href="/correlation" class="block text-black hover:text-gray-600 font-medium py-2">Correlation</a>
        <a href="/budget-nep-correlation" class="block text-black hover:text-gray-600 font-medium py-2 pl-4">‚Üí NEP-Budget</a>
        <a href="/budget-flood-correlation" class="block text-black hover:text-gray-600 font-medium py-2 pl-4">‚Üí Budget-Flood</a>
        <a href="/flood-dime-correlation" class="block text-black hover:text-gray-600 font-medium py-2 pl-4">‚Üí Flood-DIME</a>
    </div>
</nav>

<script>
function toggleMobileMenu() {
    const menu = document.getElementById('mobileMenu');
    menu.classList.toggle('hidden');
}
</script>

<!-- Main Content -->
<div style="padding: 6rem;">
<section>
    <div style="max-width: 1400px; margin: 0 auto;">
        
        <!-- Tabs -->
        <div class="budget-tabs">
            <div class="flex border-b-2 border-gray-200 mb-4 gap-2">
                <a href="#visual" class="budget-tab-btn active bg-white text-blue-600 border-blue-600 border-t border-l border-r px-6 py-3 rounded-t-lg cursor-pointer font-semibold transition-all duration-300 relative -mb-0.5 z-10" data-tab="visual">üìä Visual</a>
                <a href="#table" class="budget-tab-btn bg-gray-100 text-gray-600 border-gray-300 border px-6 py-3 rounded-t-lg cursor-pointer font-semibold transition-all duration-300 hover:bg-gray-200" data-tab="table">üìã Table</a>
                <a href="#sec" class="budget-tab-btn bg-gray-100 text-gray-600 border-gray-300 border px-6 py-3 rounded-t-lg cursor-pointer font-semibold transition-all duration-300 hover:bg-gray-200" data-tab="sec">üèõÔ∏è SEC</a>
            </div>
            <div class="budget-tab-content">

                <!-- VISUAL TAB -->
                <div id="visual-tab" class="budget-tab-panel active">
                    <!-- SEC Statistics -->
                    <div class="statistics-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">
                        <div class="stat-card bg-white p-5 rounded-lg shadow-lg text-center">
                            <h3 class="text-gray-600 m-0 mb-2 text-sm font-medium">Total Contractors</h3>
                            <p id="total-contractors" class="text-4xl font-bold text-blue-600 m-0">Loading...</p>
                            <p class="text-xs text-gray-500 mt-1">In system</p>
                        </div>
                        <div class="stat-card bg-white p-5 rounded-lg shadow-lg text-center">
                            <h3 class="text-gray-600 m-0 mb-2 text-sm font-medium">Processed</h3>
                            <p id="processed-contractors" class="text-4xl font-bold text-cyan-600 m-0">Loading...</p>
                            <p class="text-xs text-gray-500 mt-1">From scraping</p>
                        </div>
                        <div class="stat-card bg-green-50 p-5 rounded-lg shadow-lg text-center border-2 border-green-200">
                            <h3 class="text-green-700 m-0 mb-2 text-sm font-medium">‚úÖ With SEC Data</h3>
                            <p id="with-sec" class="text-4xl font-bold text-green-600 m-0">Loading...</p>
                            <p class="text-xs text-green-600 mt-1">Verified</p>
                        </div>
                        <div class="stat-card bg-yellow-50 p-5 rounded-lg shadow-lg text-center border-2 border-yellow-300">
                            <h3 class="text-yellow-700 m-0 mb-2 text-sm font-medium">‚ö†Ô∏è NO SEC Results</h3>
                            <p id="suspicious" class="text-4xl font-bold text-yellow-700 m-0">Loading...</p>
                            <p class="text-xs text-yellow-700 mt-1">Suspicious</p>
                        </div>
                    </div>

                    <!-- Venn Diagram: Data Sources -->
                    <div class="chart-container" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
                        <h3 style="color: #0038A8; margin: 0 0 15px 0;">üîµüü¢üü° Contractor Data Sources Distribution</h3>
                        <p style="color: #666; margin: 0 0 20px 0;">Venn diagram showing overlap between Flood Control, DIME, and PhilGEPS contractor databases</p>
                        <div style="max-width: 800px; margin: 0 auto;">
                            <canvas id="vennDiagram" width="800" height="500"></canvas>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 20px; font-size: 0.9em;">
                            <div style="background: #e3f2fd; padding: 10px; border-radius: 4px; text-align: center;">
                                <strong style="color: #1976d2;">üîµ Flood Only</strong><br>
                                <span id="venn-flood-only" style="font-size: 1.5em; font-weight: bold; color: #1976d2;">-</span>
                            </div>
                            <div style="background: #e8f5e9; padding: 10px; border-radius: 4px; text-align: center;">
                                <strong style="color: #388e3c;">üü¢ DIME Only</strong><br>
                                <span id="venn-dime-only" style="font-size: 1.5em; font-weight: bold; color: #388e3c;">-</span>
                            </div>
                            <div style="background: #fff9c4; padding: 10px; border-radius: 4px; text-align: center;">
                                <strong style="color: #f57c00;">üü° PhilGEPS Only</strong><br>
                                <span id="venn-philgeps-only" style="font-size: 1.5em; font-weight: bold; color: #f57c00;">-</span>
                            </div>
                            <div style="background: #f3e5f5; padding: 10px; border-radius: 4px; text-align: center;">
                                <strong style="color: #7b1fa2;">üîµüü¢ Flood + DIME</strong><br>
                                <span id="venn-flood-dime" style="font-size: 1.5em; font-weight: bold; color: #7b1fa2;">-</span>
                            </div>
                            <div style="background: #fce4ec; padding: 10px; border-radius: 4px; text-align: center;">
                                <strong style="color: #c2185b;">üîµüü° Flood + PhilGEPS</strong><br>
                                <span id="venn-flood-philgeps" style="font-size: 1.5em; font-weight: bold; color: #c2185b;">-</span>
                            </div>
                            <div style="background: #e0f2f1; padding: 10px; border-radius: 4px; text-align: center;">
                                <strong style="color: #00796b;">üü¢üü° DIME + PhilGEPS</strong><br>
                                <span id="venn-dime-philgeps" style="font-size: 1.5em; font-weight: bold; color: #00796b;">-</span>
                            </div>
                            <div style="background: #ede7f6; padding: 10px; border-radius: 4px; text-align: center;">
                                <strong style="color: #512da8;">üîµüü¢üü° All Three</strong><br>
                                <span id="venn-all-three" style="font-size: 1.5em; font-weight: bold; color: #512da8;">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Top Contractors Chart -->
                    <div class="chart-container" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: #0038A8; margin: 0;">Top Contractors by Project Count</h3>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <span id="contractors-page-info" style="color: #666; font-size: 0.9em;"></span>
                                <button id="contractors-prev" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8em;" disabled>‚Üê Previous</button>
                                <button id="contractors-next" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8em;" disabled>Next ‚Üí</button>
                            </div>
                        </div>
                        <canvas id="contractorsChart" width="800" height="600"></canvas>
                    </div>
                </div>

                <!-- TABLE TAB -->
                <div id="table-tab" class="budget-tab-panel">
                    <!-- Contractor Table -->
                    <div style="background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 32px;">
                        <h2 style="font-size: 1.5rem; font-weight: 600; color: black; margin-bottom: 24px;">üìã Contractor Database</h2>
                        
                        <!-- Search filter -->
                        <div style="margin-bottom: 20px;">
                            <input 
                                type="text" 
                                id="contractor-search" 
                                placeholder="Search contractor name..." 
                                style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;"
                                onkeyup="filterContractors()"
                            />
                        </div>
                        
                        <!-- Pagination controls -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div style="color: #666; font-size: 0.9em;">
                                Showing <span id="table-page-info">0</span> of <span id="table-total">0</span> contractors
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button id="table-prev" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;" disabled>‚Üê Previous</button>
                                <button id="table-next" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;" disabled>Next ‚Üí</button>
                            </div>
                        </div>

                        <div class="table-responsive" style="overflow-x: auto;">
                            <table style="min-width: 100%; border-collapse: collapse;">
                                <thead style="background: #f9fafb;">
                                    <tr>
                                        <th style="padding: 12px 16px; text-align: left; font-size: 0.75rem; font-weight: 500; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #e5e7eb;">#</th>
                                        <th style="padding: 12px 16px; text-align: left; font-size: 0.75rem; font-weight: 500; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #e5e7eb;">Contractor Name</th>
                                        <th style="padding: 12px 16px; text-align: left; font-size: 0.75rem; font-weight: 500; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #e5e7eb;">SEC Number</th>
                                        <th style="padding: 12px 16px; text-align: left; font-size: 0.75rem; font-weight: 500; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #e5e7eb;">Status</th>
                                        <th style="padding: 12px 16px; text-align: left; font-size: 0.75rem; font-weight: 500; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #e5e7eb;">Address</th>
                                    </tr>
                                </thead>
                                <tbody id="contractors-table" style="background: white;">
                                    <tr>
                                        <td colspan="5" style="padding: 24px; text-align: center; color: #6b7280;">Loading contractors...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- SEC TAB -->
                <div id="sec-tab" class="budget-tab-panel">
                    <!-- SEC Data Analysis -->
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h3 style="color: #0038A8; margin: 0 0 20px 0;">üèõÔ∏è SEC Data Analysis</h3>
                        <p style="color: #666; margin: 0 0 20px 0;">Analyze contractor SEC registration data and identify contractors without SEC information</p>
                        
                        <!-- SEC Statistics -->
                        <div class="sec-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div class="stat-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                                <h4 style="color: #0038A8; margin: 0 0 5px 0; font-size: 1.1em;">Total Contractors</h4>
                                <p id="sec-total-contractors-count" style="font-size: 2em; font-weight: bold; color: #007bff; margin: 0;">Loading...</p>
                                <p style="font-size: 0.7em; color: #6c757d; margin: 5px 0 0 0;">In system</p>
                            </div>
                            <div class="stat-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                                <h4 style="color: #0038A8; margin: 0 0 5px 0; font-size: 1.1em;">Processed</h4>
                                <p id="sec-processed-count" style="font-size: 2em; font-weight: bold; color: #17a2b8; margin: 0;">Loading...</p>
                                <p style="font-size: 0.7em; color: #6c757d; margin: 5px 0 0 0;">From database</p>
                            </div>
                            <div class="stat-card" style="background: #d4edda; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #c3e6cb;">
                                <h4 style="color: #155724; margin: 0 0 5px 0; font-size: 1.1em;">‚úÖ With SEC Data</h4>
                                <p id="total-sec-count" style="font-size: 2em; font-weight: bold; color: #28a745; margin: 0;">Loading...</p>
                                <p style="font-size: 0.7em; color: #155724; margin: 5px 0 0 0;">Verified</p>
                            </div>
                            <div class="stat-card" style="background: #fff3cd; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #ffeaa7;">
                                <h4 style="color: #856404; margin: 0 0 5px 0; font-size: 1.1em;">‚ö†Ô∏è NO SEC Results</h4>
                                <p id="suspicious-sec-count" style="font-size: 2em; font-weight: bold; color: #856404; margin: 0;">Loading...</p>
                                <p style="font-size: 0.7em; color: #856404; margin: 5px 0 0 0;">Suspicious</p>
                            </div>
                        </div>

                        <!-- Suspicious Contractors -->
                        <div class="chart-container" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
                            <h3 style="color: #dc3545; margin: 0 0 15px 0;">‚ö†Ô∏è Suspicious Contractors (NO SEC Results)</h3>
                            
                            <!-- Pagination controls -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <div style="color: #666; font-size: 0.9em;">
                                    Showing <span id="sec-page-info">0</span> of <span id="sec-total">0</span> suspicious contractors
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button id="sec-prev" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;" disabled>‚Üê Previous</button>
                                    <button id="sec-next" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;" disabled>Next ‚Üí</button>
                                </div>
                            </div>
                            
                            <div id="contractorsWithoutSec" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                                <!-- Suspicious contractors will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>
</section>
</div>

<!-- Page-specific footer content -->
<footer class="visualizations-footer">
    <div class="visualizations-container">
        <p><strong>üìä Data Sources:</strong> DIME, PhilGEPS, Flood Control (DPWH) - All contractors across all government projects</p>
        <p><strong>üîç Verification:</strong> SEC Philippines - Validates contractor legitimacy and registration</p>
        <p><strong>üìà Total Contractors:</strong> <span id="footer-total">Loading...</span> contractors in system</p>
        <p><strong>‚úÖ Verified:</strong> <span id="footer-verified">Loading...</span> with SEC registration data</p>
    </div>
</footer>

<script>
// Global data
let allContractors = [];
let filteredContractors = [];
let allContractorsByProject = [];
let suspiciousContractors = [];
let currentChartPage = 0;
let currentTablePage = 0;
let currentSecPage = 0;
const chartPageSize = 50;
const tablePageSize = 10;
const secPageSize = 20;

// Tab switching
function switchTab(tabName) {
    document.querySelectorAll('.budget-tab-btn').forEach(tab => {
        tab.classList.remove('active', 'bg-white', 'text-blue-600', 'border-blue-600', 'border-t', 'border-l', 'border-r', '-mb-0.5', 'z-10');
        tab.classList.add('bg-gray-100', 'text-gray-600', 'border-gray-300');
    });
    document.querySelectorAll('.budget-tab-panel').forEach(content => {
        content.classList.remove('active');
    });

    const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
    if (activeTab) {
        activeTab.classList.add('active', 'bg-white', 'text-blue-600', 'border-blue-600', 'border-t', 'border-l', 'border-r', '-mb-0.5', 'z-10');
        activeTab.classList.remove('bg-gray-100', 'text-gray-600', 'border-gray-300');
    }
    
    const activeContent = document.getElementById(`${tabName}-tab`);
    if (activeContent) {
        activeContent.classList.add('active');
    }
}

// Initialize tabs
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.budget-tab-btn');
    tabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
            e.preventDefault();
            const targetTab = tab.getAttribute('data-tab');
            switchTab(targetTab);
        });
    });
});

// Load and process contractors data
async function loadContractors() {
    try {
        // Use PostgreSQL API endpoint
        const response = await fetch('/api/contractors/sec');
        const data = await response.json();
        
        allContractors = data.contractors || [];
        filteredContractors = allContractors;  // Initialize filtered list
        
        // Update statistics (Visual tab)
        const summary = data.summary || {};
        document.getElementById('total-contractors').textContent = (summary.total_contractors || 0).toLocaleString();
        document.getElementById('processed-contractors').textContent = (summary.total_contractors || 0).toLocaleString();
        document.getElementById('with-sec').textContent = (summary.with_sec_data || 0).toLocaleString();
        document.getElementById('suspicious').textContent = (summary.suspicious_no_results || 0).toLocaleString();
        
        // Update SEC tab statistics
        document.getElementById('sec-total-contractors-count').textContent = (summary.total_contractors || 0).toLocaleString();
        document.getElementById('sec-processed-count').textContent = (summary.total_contractors || 0).toLocaleString();
        document.getElementById('total-sec-count').textContent = (summary.with_sec_data || 0).toLocaleString();
        document.getElementById('suspicious-sec-count').textContent = (summary.suspicious_no_results || 0).toLocaleString();
        
        // Update footer statistics
        document.getElementById('footer-total').textContent = (summary.total_contractors || 0).toLocaleString();
        document.getElementById('footer-verified').textContent = (summary.with_sec_data || 0).toLocaleString();
        
        // Load contractors without SEC for SEC tab
        loadContractorsWithoutSec();
        
        // Count projects per contractor from flood data
        await loadContractorProjectCounts();
        
        // Render chart and table
        renderContractorsChart();
        renderContractorsTable();
        
    } catch (error) {
        console.error('Error loading contractors:', error);
        document.getElementById('total-contractors').textContent = 'Error';
        document.getElementById('processed-contractors').textContent = 'Error';
        document.getElementById('with-sec').textContent = 'Error';
        document.getElementById('suspicious').textContent = 'Error';
    }
}

// Load suspicious contractors for SEC tab
function loadContractorsWithoutSec() {
    // Filter only suspicious contractors (NO_SEC_RESULTS status)
    suspiciousContractors = allContractors.filter(c => c.status === 'NO_SEC_RESULTS');
    
    // Render first page
    renderSuspiciousContractors();
}

// Render suspicious contractors with pagination
function renderSuspiciousContractors() {
    const container = document.getElementById('contractorsWithoutSec');
    const start = currentSecPage * secPageSize;
    const end = start + secPageSize;
    const contractorsToShow = suspiciousContractors.slice(start, end);
    
    container.innerHTML = '';
    
    if (suspiciousContractors.length === 0) {
        container.innerHTML = `
            <div style="
                background: #d4edda;
                border: 2px solid #28a745;
                border-radius: 8px;
                padding: 20px;
                text-align: center;
                grid-column: 1 / -1;">
                <strong>‚úÖ No suspicious contractors found!</strong>
            </div>
        `;
        document.getElementById('sec-page-info').textContent = '0';
        document.getElementById('sec-total').textContent = '0';
        document.getElementById('sec-prev').disabled = true;
        document.getElementById('sec-next').disabled = true;
        return;
    }
    
    contractorsToShow.forEach(contractor => {
        const contractorCard = document.createElement('div');
        contractorCard.style.cssText = 'background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px;';
        
        contractorCard.innerHTML = `
            <div style="font-weight: bold; color: #856404; margin-bottom: 8px; font-size: 1.1em;">
                ${contractor.contractor_name}
            </div>
            <div style="color: #721c24; background: #f8d7da; padding: 8px; border-radius: 4px; font-size: 0.9em; border: 1px solid #f5c6cb;">
                <strong>‚ö†Ô∏è NO SEC RESULTS - SUSPICIOUS</strong><br>
                <span style="font-size: 0.85em;">This contractor was searched in the SEC database but yielded zero results.</span>
            </div>
        `;
        
        container.appendChild(contractorCard);
    });
    
    // Update pagination
    const totalPages = Math.ceil(suspiciousContractors.length / secPageSize);
    document.getElementById('sec-page-info').textContent = `${start + 1}-${Math.min(end, suspiciousContractors.length)}`;
    document.getElementById('sec-total').textContent = suspiciousContractors.length;
    document.getElementById('sec-prev').disabled = currentSecPage === 0;
    document.getElementById('sec-next').disabled = currentSecPage >= totalPages - 1;
}

// Load contractor project counts from flood data
async function loadContractorProjectCounts() {
    try {
        const response = await fetch('/api/flood/statistics');
        const data = await response.json();
        
        // Use topContractors from the statistics API
        const topContractors = data.topContractors || {};
        
        allContractorsByProject = Object.entries(topContractors)
            .map(([contractor, count]) => ({ contractor, count }))
            .sort((a, b) => b.count - a.count);
        
        console.log('‚úÖ Loaded contractor project counts:', allContractorsByProject.length, 'contractors');
            
    } catch (error) {
        console.error('Error loading contractor project counts:', error);
        allContractorsByProject = [];
    }
}

// Render contractors chart
function renderContractorsChart() {
    const ctx = document.getElementById('contractorsChart');
    if (!ctx || !allContractorsByProject.length) {
        console.log('‚ö†Ô∏è Cannot render chart - missing context or no data');
        return;
    }
    
    const start = currentChartPage * chartPageSize;
    const end = start + chartPageSize;
    const contractors = allContractorsByProject.slice(start, end);
    
    if (window.contractorsChart && typeof window.contractorsChart.destroy === 'function') {
        window.contractorsChart.destroy();
    }
    
    window.contractorsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: contractors.map(item => item.contractor.length > 40 ? item.contractor.substring(0, 40) + '...' : item.contractor),
            datasets: [{
                label: 'Project Count',
                data: contractors.map(item => item.count),
                backgroundColor: '#0038A8',
                borderColor: '#CE1126',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 1.5,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                },
                y: {
                    display: true,
                    ticks: {
                        maxTicksLimit: 50
                    }
                }
            }
        }
    });
    
    // Add hover and click functionality
    ctx.onmousemove = function(event) {
        const rect = ctx.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        
        const chartArea = window.contractorsChart.chartArea;
        const barHeight = (chartArea.bottom - chartArea.top) / contractors.length;
        const hoveredBarIndex = Math.floor((y - chartArea.top) / barHeight);
        
        if (hoveredBarIndex >= 0 && hoveredBarIndex < contractors.length) {
            const contractorName = contractors[hoveredBarIndex].contractor;
            showContractorHoverTooltip(event, contractorName);
        } else {
            hideContractorHoverTooltip();
        }
    };
    
    ctx.onmouseleave = function() {
        hideContractorHoverTooltip();
    };
    
    ctx.onclick = function(event) {
        const rect = ctx.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        
        const chartArea = window.contractorsChart.chartArea;
        const barHeight = (chartArea.bottom - chartArea.top) / contractors.length;
        const clickedBarIndex = Math.floor((y - chartArea.top) / barHeight);
        
        if (clickedBarIndex >= 0 && clickedBarIndex < contractors.length) {
            const contractorName = contractors[clickedBarIndex].contractor;
            console.log('üîç Visual contractor clicked:', contractorName);
            
            // Switch to table tab and filter by this contractor
            switchTab('table');
            document.getElementById('contractor-search').value = contractorName;
            filterContractors();
        }
    };
    
    ctx.style.cursor = 'pointer';
    
    // Update pagination info and buttons
    const totalPages = Math.ceil(allContractorsByProject.length / chartPageSize);
    document.getElementById('contractors-page-info').textContent = `Page ${currentChartPage + 1} of ${totalPages}`;
    document.getElementById('contractors-prev').disabled = currentChartPage === 0;
    document.getElementById('contractors-next').disabled = currentChartPage >= totalPages - 1;
}

// Filter contractors by search input
function filterContractors() {
    const searchInput = document.getElementById('contractor-search').value.toLowerCase();
    
    if (!searchInput) {
        filteredContractors = allContractors;
    } else {
        filteredContractors = allContractors.filter(contractor => {
            const name = (contractor.original_contractor_name || contractor.company_name || contractor.contractor_name || '').toLowerCase();
            return name.includes(searchInput);
        });
    }
    
    // Reset to first page when filtering
    currentTablePage = 0;
    renderContractorsTable();
}

// Render contractors table
function renderContractorsTable() {
    const tbody = document.getElementById('contractors-table');
    const start = currentTablePage * tablePageSize;
    const end = start + tablePageSize;
    const contractors = filteredContractors.slice(start, end);
    
    tbody.innerHTML = '';
    
    if (contractors.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="padding: 24px; text-align: center; color: #6b7280;">No contractors found</td></tr>';
        document.getElementById('table-page-info').textContent = '0';
        document.getElementById('table-total').textContent = filteredContractors.length;
        document.getElementById('table-prev').disabled = true;
        document.getElementById('table-next').disabled = true;
        return;
    }
    
    contractors.forEach((contractor, index) => {
        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid #e5e7eb';
        if (contractor.status === 'NO_SEC_RESULTS') {
            row.style.background = '#fefce8';
        }
        
        const secNumber = contractor.sec_number || '-';
        const address = contractor.registered_address || contractor.address || '-';
        
        const statusBadge = contractor.sec_number && contractor.sec_number.trim() !== '' ? 
            `<span style="padding: 4px 12px; background: #dcfce7; color: #166534; font-size: 0.75rem; border-radius: 9999px; font-weight: 600;">‚úÖ Verified</span>` :
            contractor.status === 'NO_SEC_RESULTS' ?
            `<span class="pulse-warning" style="padding: 4px 12px; background: #fff3cd; color: #854d0e; font-size: 0.75rem; border-radius: 9999px; font-weight: 600; border: 1px solid #fde047;">‚ö†Ô∏è Suspicious</span>` :
            `<span style="padding: 4px 12px; background: #fee2e2; color: #991b1b; font-size: 0.75rem; border-radius: 9999px; font-weight: 600;">‚ùå Missing</span>`;
        
        row.innerHTML = `
            <td style="padding: 16px; font-size: 0.875rem; color: #111827; white-space: nowrap;">${start + index + 1}</td>
            <td style="padding: 16px; font-size: 0.875rem; font-weight: 500; color: #111827;">${contractor.original_contractor_name || contractor.company_name || contractor.contractor_name}</td>
            <td style="padding: 16px; font-size: 0.875rem; color: #111827; white-space: nowrap;">${secNumber}</td>
            <td style="padding: 16px; font-size: 0.875rem;">${statusBadge}</td>
            <td style="padding: 16px; font-size: 0.875rem; color: #6b7280;">${address.substring(0, 100)}${address.length > 100 ? '...' : ''}</td>
        `;
        
        tbody.appendChild(row);
    });
    
    // Update pagination
    const totalPages = Math.ceil(filteredContractors.length / tablePageSize);
    document.getElementById('table-page-info').textContent = `${start + 1}-${Math.min(end, filteredContractors.length)}`;
    document.getElementById('table-total').textContent = filteredContractors.length;
    document.getElementById('table-prev').disabled = currentTablePage === 0;
    document.getElementById('table-next').disabled = currentTablePage >= totalPages - 1;
}

// Pagination for chart
document.getElementById('contractors-prev').addEventListener('click', function() {
    if (currentChartPage > 0) {
        currentChartPage--;
        renderContractorsChart();
    }
});

document.getElementById('contractors-next').addEventListener('click', function() {
    const totalPages = Math.ceil(allContractorsByProject.length / chartPageSize);
    if (currentChartPage < totalPages - 1) {
        currentChartPage++;
        renderContractorsChart();
    }
});

// Pagination for table
document.getElementById('table-prev').addEventListener('click', function() {
    if (currentTablePage > 0) {
        currentTablePage--;
        renderContractorsTable();
    }
});

document.getElementById('table-next').addEventListener('click', function() {
    const totalPages = Math.ceil(filteredContractors.length / tablePageSize);
    if (currentTablePage < totalPages - 1) {
        currentTablePage++;
        renderContractorsTable();
    }
});

// Pagination for SEC tab
document.getElementById('sec-prev').addEventListener('click', function() {
    if (currentSecPage > 0) {
        currentSecPage--;
        renderSuspiciousContractors();
    }
});

document.getElementById('sec-next').addEventListener('click', function() {
    const totalPages = Math.ceil(suspiciousContractors.length / secPageSize);
    if (currentSecPage < totalPages - 1) {
        currentSecPage++;
        renderSuspiciousContractors();
    }
});

// Show contractor hover tooltip
function showContractorHoverTooltip(event, contractorName) {
    // Remove existing tooltip
    hideContractorHoverTooltip();
    
    // Find contractor data for tooltip
    let contractor = null;
    if (allContractors && allContractors.length > 0) {
        // Try exact match first
        contractor = allContractors.find(c => {
            const names = [
                c.contractor_name?.toLowerCase(),
                c.company_name?.toLowerCase(),
                c.original_contractor_name?.toLowerCase()
            ];
            const searchName = contractorName.toLowerCase();
            return names.some(n => n === searchName);
        });
        
        // Fallback to fuzzy matching
        if (!contractor) {
            contractor = allContractors.find(c => {
                const originalName = c.original_contractor_name?.toLowerCase() || c.contractor_name?.toLowerCase() || '';
                const companyName = c.company_name?.toLowerCase() || '';
                const searchName = contractorName.toLowerCase();
                
                // Try partial matches
                if (originalName.includes(searchName) || companyName.includes(searchName)) {
                    return true;
                }
                
                // Try reverse match (search name contains database name)
                if (searchName.includes(originalName) || searchName.includes(companyName)) {
                    return true;
                }
                
                // Try matching just the main part (before parentheses)
                const mainPart = searchName.split('(')[0].trim();
                if (originalName.includes(mainPart) || companyName.includes(mainPart)) {
                    return true;
                }
                
                return false;
            });
        }
    }
    
    // Create tooltip HTML with actual SEC data
    const tooltipHTML = `
        <div id="contractor-hover-tooltip" style="
            position: fixed;
            background: white;
            border: 2px solid #0038A8;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-width: 300px;
            font-size: 14px;
            pointer-events: none;
        ">
            <div style="color: #0038A8; font-weight: bold; margin-bottom: 8px;">
                üè¢ ${contractorName}
            </div>
            ${contractor && contractor.sec_number ? `
                <div style="color: #666; margin-bottom: 5px;">
                    <strong>Company Name:</strong> ${contractor.company_name || contractor.contractor_name || 'N/A'}
                </div>
                <div style="color: #666; margin-bottom: 5px;">
                    <strong>SEC Number:</strong> ${contractor.sec_number || 'N/A'}
                </div>
                <div style="color: #666; margin-bottom: 5px;">
                    <strong>Date Registered:</strong> ${contractor.date_registered || 'N/A'}
                </div>
                <div style="color: #666; margin-bottom: 5px;">
                    <strong>Address:</strong> ${contractor.address ? contractor.address.substring(0, 100) + '...' : 'N/A'}
                </div>
            ` : contractor && contractor.status === 'NO_SEC_RESULTS' ? `
                <div style="color: #856404; margin-bottom: 5px;">
                    <strong>Status:</strong> <span style="color: #856404;">‚ö†Ô∏è NO SEC RESULTS - SUSPICIOUS</span>
                </div>
                <div style="color: #666; margin-bottom: 5px; font-size: 12px;">
                    This contractor was searched in the SEC database but yielded zero results.
                </div>
            ` : `
                <div style="color: #dc3545; margin-bottom: 5px;">
                    <strong>SEC Number:</strong> <span style="color: #dc3545;">Not yet processed</span>
                </div>
                <div style="color: #666; margin-bottom: 5px; font-size: 12px;">
                    SEC data not yet available for this contractor
                </div>
            `}
            <div style="color: #666; font-size: 12px; margin-top: 8px;">
                üí° Click bar for full details
            </div>
        </div>
    `;
    
    // Add tooltip to page
    document.body.insertAdjacentHTML('beforeend', tooltipHTML);
    
    // Position tooltip near mouse cursor
    const tooltip = document.getElementById('contractor-hover-tooltip');
    const rect = tooltip.getBoundingClientRect();
    const x = event.clientX + 10;
    const y = event.clientY - rect.height - 10;
    
    // Adjust if tooltip would go off screen
    const adjustedX = x + rect.width > window.innerWidth ? event.clientX - rect.width - 10 : x;
    const adjustedY = y < 0 ? event.clientY + 10 : y;
    
    tooltip.style.left = adjustedX + 'px';
    tooltip.style.top = adjustedY + 'px';
}

// Hide contractor hover tooltip
function hideContractorHoverTooltip() {
    const tooltip = document.getElementById('contractor-hover-tooltip');
    if (tooltip) {
        tooltip.remove();
    }
}

// Load and draw Venn diagram
async function loadVennDiagram() {
    try {
        const response = await fetch('/api/contractors/venn');
        const data = await response.json();
        
        if (!data.success) {
            console.error('Failed to load Venn diagram data');
            return;
        }
        
        // Update the stat boxes
        document.getElementById('venn-flood-only').textContent = data.flood_only.toLocaleString();
        document.getElementById('venn-dime-only').textContent = data.dime_only.toLocaleString();
        document.getElementById('venn-philgeps-only').textContent = data.philgeps_only.toLocaleString();
        document.getElementById('venn-flood-dime').textContent = data.flood_dime.toLocaleString();
        document.getElementById('venn-flood-philgeps').textContent = data.flood_philgeps.toLocaleString();
        document.getElementById('venn-dime-philgeps').textContent = data.dime_philgeps.toLocaleString();
        document.getElementById('venn-all-three').textContent = data.all_three.toLocaleString();
        
        // Draw the Venn diagram on canvas
        drawVennDiagram(data);
    } catch (error) {
        console.error('Error loading Venn diagram:', error);
    }
}

function drawVennDiagram(data) {
    const canvas = document.getElementById('vennDiagram');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    // Clear canvas
    ctx.clearRect(0, 0, width, height);
    
    // Circle parameters (3 overlapping circles)
    const radius = 150;
    const centerY = height / 2;
    const offsetX = 80;
    
    const floodCenter = { x: width / 2 - offsetX, y: centerY - 40 };
    const dimeCenter = { x: width / 2 + offsetX, y: centerY - 40 };
    const philgepsCenter = { x: width / 2, y: centerY + 60 };
    
    // Draw circles with transparency
    ctx.globalAlpha = 0.3;
    
    // Flood circle (blue)
    ctx.beginPath();
    ctx.arc(floodCenter.x, floodCenter.y, radius, 0, 2 * Math.PI);
    ctx.fillStyle = '#2196F3';
    ctx.fill();
    
    // DIME circle (green)
    ctx.beginPath();
    ctx.arc(dimeCenter.x, dimeCenter.y, radius, 0, 2 * Math.PI);
    ctx.fillStyle = '#4CAF50';
    ctx.fill();
    
    // PhilGEPS circle (yellow/orange)
    ctx.beginPath();
    ctx.arc(philgepsCenter.x, philgepsCenter.y, radius, 0, 2 * Math.PI);
    ctx.fillStyle = '#FF9800';
    ctx.fill();
    
    // Reset alpha for text
    ctx.globalAlpha = 1.0;
    
    // Draw labels
    ctx.font = 'bold 16px Inter';
    ctx.textAlign = 'center';
    
    // Flood label
    ctx.fillStyle = '#1976D2';
    ctx.fillText('üîµ Flood', floodCenter.x - 60, floodCenter.y - radius - 10);
    ctx.font = '14px Inter';
    ctx.fillText(data.flood_total.toLocaleString(), floodCenter.x - 60, floodCenter.y - radius + 10);
    
    // DIME label
    ctx.font = 'bold 16px Inter';
    ctx.fillStyle = '#388E3C';
    ctx.fillText('üü¢ DIME', dimeCenter.x + 60, dimeCenter.y - radius - 10);
    ctx.font = '14px Inter';
    ctx.fillText(data.dime_total.toLocaleString(), dimeCenter.x + 60, dimeCenter.y - radius + 10);
    
    // PhilGEPS label
    ctx.font = 'bold 16px Inter';
    ctx.fillStyle = '#F57C00';
    ctx.fillText('üü° PhilGEPS', philgepsCenter.x, philgepsCenter.y + radius + 20);
    ctx.font = '14px Inter';
    ctx.fillText(data.philgeps_total.toLocaleString(), philgepsCenter.x, philgepsCenter.y + radius + 40);
    
    // Draw numbers in overlap regions
    ctx.font = 'bold 18px Inter';
    
    // Flood only (left)
    ctx.fillStyle = '#1976D2';
    ctx.fillText(data.flood_only, floodCenter.x - 80, floodCenter.y);
    
    // DIME only (right)
    ctx.fillStyle = '#388E3C';
    ctx.fillText(data.dime_only, dimeCenter.x + 80, dimeCenter.y);
    
    // PhilGEPS only (bottom)
    ctx.fillStyle = '#F57C00';
    ctx.fillText(data.philgeps_only, philgepsCenter.x, philgepsCenter.y + 80);
    
    // Flood + DIME (top middle)
    ctx.fillStyle = '#7B1FA2';
    ctx.fillText(data.flood_dime, width / 2, centerY - 60);
    
    // Flood + PhilGEPS (bottom left)
    ctx.fillStyle = '#C2185B';
    ctx.fillText(data.flood_philgeps, floodCenter.x - 20, philgepsCenter.y - 20);
    
    // DIME + PhilGEPS (bottom right)
    ctx.fillStyle = '#00796B';
    ctx.fillText(data.dime_philgeps, dimeCenter.x + 20, philgepsCenter.y - 20);
    
    // All three (center)
    ctx.fillStyle = '#512DA8';
    ctx.fillText(data.all_three, width / 2, centerY + 10);
}

// Load on page load
loadContractors();
loadVennDiagram();
</script>

{% include "footer.html" %}

</body>
</html>
